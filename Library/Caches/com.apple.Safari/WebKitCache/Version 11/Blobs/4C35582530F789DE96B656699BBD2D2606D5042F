var requirejs,require,define;(function(e){function c(e,t){return f.call(e,t)}function h(e,t){var n,r,i,s,o,a,f,l,c,h,p=t&&t.split("/"),d=u.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(l=0;l<e.length;l+=1){h=e[l];if(h===".")e.splice(l,1),l-=1;else if(h===".."){if(l===1&&(e[2]===".."||e[0]===".."))break;l>0&&(e.splice(l-1,2),l-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(l=n.length;l>0;l-=1){r=n.slice(0,l).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=l;break}}}if(s)break;!a&&v&&v[r]&&(a=v[r],f=l)}!s&&a&&(s=a,o=f),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function p(t,r){return function(){return n.apply(e,l.call(arguments,0).concat([t,r]))}}function d(e){return function(t){return h(t,e)}}function v(e){return function(t){s[e]=t}}function m(n){if(c(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!c(s,n)&&!c(a,n))throw new Error("No "+n);return s[n]}function g(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function y(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice;r=function(e,t){var n,r=g(e),i=r[0];return e=r[1],i&&(i=h(i,t),n=m(i)),i?n&&n.normalize?e=n.normalize(e,d(t)):e=h(e,t):(e=h(e,t),r=g(e),i=r[0],e=r[1],i&&(n=m(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return p(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:y(e)}}},t=function(t,n,u,f){var l,h,d,g,y,b=[],w;f=f||t;if(typeof u=="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){g=r(n[y],f),h=g.f;if(h==="require")b[y]=i.require(t);else if(h==="exports")b[y]=i.exports(t),w=!0;else if(h==="module")l=b[y]=i.module(t);else if(c(s,h)||c(o,h)||c(a,h))b[y]=m(h);else{if(!g.p)throw new Error(t+" missing "+h);g.p.load(g.n,p(f,!0),v(h),{}),b[y]=s[h]}}d=u.apply(s[t],b);if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(d!==e||!w)s[t]=d}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){return typeof s=="string"?i[s]?i[s](o):m(r(s,o).f):(s.splice||(u=s,o.splice?(s=o,o=a,a=null):s=e),o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n)},n.config=function(e){return u=e,u.deps&&n(u.deps,u.callback),n},define=function(e,t,n){t.splice||(n=t,t=[]),!c(s,e)&&!c(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("almond",function(){}),Function.prototype.bind||(Function.prototype.bind=function(e){if(typeof this!="function")throw new TypeError("Function.prototype.bind - binding is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},i=function(){var i=this instanceof r&&e?this:e,s=t.concat(Array.prototype.slice.call(arguments));return n.apply(i,s)};return r.prototype=this.prototype,i.prototype=new r,i}),define("shims/src/bind",function(){}),function(){var bind=function(e,t,n){var r=Array.prototype.slice.call(arguments,2);return function(){var n=r.concat(Array.prototype.slice.call(arguments,0));e.apply(t,n)}};window.console||(window.console={});var console=window.console;if(!console.log)if(window.log4javascript){var log=log4javascript.getDefaultLogger();console.log=bind(log.info,log),console.debug=bind(log.debug,log),console.info=bind(log.info,log),console.warn=bind(log.warn,log),console.error=bind(log.error,log)}else console.log=function(e){};console.debug||(console.debug=console.log),console.info||(console.info=console.log),console.warn||(console.warn=console.log),console.error||(console.error=console.log);if(window["__consoleShimTest__"]!=null||eval("/*@cc_on @_jscript_version <= 9@*/")){var wrap=function(e){var t,n,r,i;e=Array.prototype.slice.call(arguments,0),i=e.shift(),n=e.length;if(n>1&&window.__consoleShimTest__!==!1){typeof e[0]!="string"&&(e.unshift("%o"),n+=1),r=e[0].match(/%[a-z]/g);for(t=r?r.length+1:1;t<n;t+=1)e[0]+=" %o"}Function.apply.call(i,console,e)};console.log=bind(wrap,window,console.log),console.debug=bind(wrap,window,console.debug),console.info=bind(wrap,window,console.info),console.warn=bind(wrap,window,console.warn),console.error=bind(wrap,window,console.error)}console.assert||(console.assert=function(){var e=Array.prototype.slice.call(arguments,0),t=e.shift();t||(e[0]="Assertion failed: "+e[0],console.error.apply(console,e))}),console.dir||(console.dir=console.log),console.dirxml||(console.dirxml=console.log),console.exception||(console.exception=console.error);if(!console.time||!console.timeEnd){var timers={};console.time=function(e){timers[e]=(new Date).getTime()},console.timeEnd=function(e){var t=timers[e];t&&(console.log(e+": "+((new Date).getTime()-t)+"ms"),delete timers[e])}}console.table||(console.table=function(e,t){var n,r,i,s,o,u;if(!e||!(e instanceof Array)||!e.length)return;if(!t||!(t instanceof Array)){t=[];for(u in e[0]){if(!e[0].hasOwnProperty(u))continue;t.push(u)}}for(n=0,r=e.length;n<r;n+=1){i=[];for(s=0,o=t.length;s<o;s+=1)i.push(e[n][t[s]]);Function.apply.call(console.log,console,i)}}),console.clear||(console.clear=function(){}),console.trace||(console.trace=function(){}),console.group||(console.group=function(){}),console.groupCollapsed||(console.groupCollapsed=function(){}),console.groupEnd||(console.groupEnd=function(){}),console.timeStamp||(console.timeStamp=function(){}),console.profile||(console.profile=function(){}),console.profileEnd||(console.profileEnd=function(){}),console.count||(console.count=function(){})}(),define("shims/src/console",function(){}),function(){if("classList"in document.documentElement)return;window._SHIM_addClassListToView=function(e){if("classList"in e.document.documentElement)return;if(!("HTMLElement"in e||"Element"in e))return;var t="classList",n="prototype",r=(e.HTMLElement||e.Element)[n],i=Object,s=String[n].trim||function(){return this.replace(/^\s+|\s+$/g,"")},o=Array[n].indexOf||function(e){var t=0,n=this.length;for(;t<n;t++)if(t in this&&this[t]===e)return t;return-1},u=function(e,t){this.name=e,this.code=DOMException[e],this.message=t},a=function(e,t){if(t==="")throw new u("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(t))throw new u("INVALID_CHARACTER_ERR","String contains an invalid character");return o.call(e,t)},f=function(e){var t=s.call(e.className),n=t?t.split(/\s+/):[],r=0,i=n.length;for(;r<i;r++)this.push(n[r]);this._updateClassName=function(){e.className=this.toString()}},l=f[n]=[],c=function(){return new f(this)};u[n]=Error[n],l.item=function(e){return this[e]||null},l.contains=function(e){return e+="",a(this,e)!==-1},l.add=function(){var e=arguments,t=0,n=e.length,r,i=!1;do r=e[t]+"",a(this,r)===-1&&(this.push(r),i=!0);while(++t<n);i&&this._updateClassName()},l.remove=function(){var e=arguments,t=0,n=e.length,r,i=!1;do{r=e[t]+"";var s=a(this,r);s!==-1&&(this.splice(s,1),i=!0)}while(++t<n);i&&this._updateClassName()},l.toggle=function(e,t){e+="";var n=this.contains(e),r=n?t!==!0&&"remove":t!==!1&&"add";return r&&this[r](e),n},l.toString=function(){return this.join(" ")};if(i.defineProperty){var h={get:c,enumerable:!0,configurable:!0};try{i.defineProperty(r,t,h)}catch(p){p.number===-2146823252&&(h.enumerable=!1,i.defineProperty(r,t,h))}}else i[n].__defineGetter__&&r.__defineGetter__(t,c)},window._SHIM_addClassListToView(window)}(),define("shims/src/classlist",function(){}),function(){function e(){this.buffer=[]}function n(e){this._input=e,this._index=-1,this._buffer=[]}function r(e){this._input=e,this._index=-1,this._buffer=[]}e.prototype.append=function(t){return this.buffer.push(t),this},e.prototype.toString=function i(){return this.buffer.join("")};var t={codex:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var r=new e,i=new n(t);while(i.moveNext()){var s=i.current;i.moveNext();var o=i.current;i.moveNext();var u=i.current,a=s>>2,f=(s&3)<<4|o>>4,l=(o&15)<<2|u>>6,c=u&63;isNaN(o)?l=c=64:isNaN(u)&&(c=64),r.append(this.codex.charAt(a)+this.codex.charAt(f)+this.codex.charAt(l)+this.codex.charAt(c))}return r.toString()},decode:function(t){var n=new e,i,s=new r(t);while(s.moveNext()){var o=s.current;if(o<128)n.append(String.fromCharCode(o));else if(o>191&&o<224)s.moveNext(),i=s.current,n.append(String.fromCharCode((o&31)<<6|i&63));else{s.moveNext(),i=s.current,s.moveNext();var u=s.current;n.append(String.fromCharCode((o&15)<<12|(i&63)<<6|u&63))}}return n.toString()}};n.prototype={current:Number.NaN,moveNext:function(){if(this._buffer.length>0)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=Number.NaN,!1;var e=this._input.charCodeAt(++this._index);return e==13&&this._input.charCodeAt(this._index+1)==10&&(e=10,this._index+=2),e<128?this.current=e:e>127&&e<2048?(this.current=e>>6|192,this._buffer.push(e&63|128)):(this.current=e>>12|224,this._buffer.push(e>>6&63|128),this._buffer.push(e&63|128)),!0}},r.prototype={current:64,moveNext:function(){if(this._buffer.length>0)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=64,!1;var e=t.codex.indexOf(this._input.charAt(++this._index)),n=t.codex.indexOf(this._input.charAt(++this._index)),r=t.codex.indexOf(this._input.charAt(++this._index)),i=t.codex.indexOf(this._input.charAt(++this._index)),s=e<<2|n>>4,o=(n&15)<<4|r>>2,u=(r&3)<<6|i;return this.current=s,r!=64&&this._buffer.push(o),i!=64&&this._buffer.push(u),!0}},window.btoa=function(e){return t.encode(e)},window.atob=function(e){return t.decode(e)}}(),define("shims/src/base64_utf8",function(){}),function(){function e(e,t){t=t||{bubbles:!1,cancelable:!1,detail:undefined};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}if(typeof window.CustomEvent=="function")return!1;e.prototype=window.Event.prototype,window.CustomEvent=e}(),define("shims/src/customevent",function(){}),define("shims/shims",["require","./src/bind","./src/console","./src/classlist","./src/base64_utf8","./src/customevent"],function(e){return e("./src/bind"),e("./src/console"),e("./src/classlist"),e("./src/base64_utf8"),e("./src/customevent"),null}),define("shims",["shims/shims"],function(e){return e}),function(){var Quirks=function(e){return Quirks._.registry[e]?!0:!1};Quirks.has=Quirks,Quirks.add=function(e){var t=[];for(var n=1,r=arguments.length;n<r;++n)t.push(arguments[n]);return this._.registry[e]=this.ask(t)},Quirks.set=function(e,t){if(typeof t=="undefined"||t===null)t=!1;t instanceof Array&&(t=t[1]||!0),this._.survey[e]=t},Quirks.ask=function(){var e=arguments[0];e instanceof Array||(e=Array.prototype.slice.call(arguments,0));for(var t=0,n=e.length;t<n;++t){var r=this._tokenize(""+e[t]),i=!0;for(var s=0,o=r.length;s<o;++s){var u=r[s];i=i&&this._evaluate(u[0],u[1],u[2],u[3])}if(i)return!0}return!1},Quirks.dump=function(){var e=[];e.push("Query types:");for(var t in this._.survey)e.push("  "+t+": "+this._.survey[t]);e.push("Quirks:");for(var t in this._.registry)e.push("  "+t+": "+this._.registry[t]);console.log(e.join("\n"))},Quirks._reset=function(){this._={survey:{"true":!0,"false":!1},registry:{}}},Quirks._tokenize=function(e){var t=e.split(/\s+/),n=[];for(var r=0,i=t.length;r<i;++r){var s=t[r].match(/(!?)([^:=<>]+)([:=<>]*)([^:=<>]*)/);s?n.push([s[2],s[3],s[4],s[1]]):console.warn('No match for sequence: "'+e+'"')}return n},Quirks._evaluate=function(key,op,operand,modifier){var val=this._.survey[key],pass;if(!op)pass=typeof val!="undefined"&&val!==!1;else if(op=="=")pass=""+val==""+operand;else if(op==">=")pass=val!=0&&val>=operand;else if(op=="<=")pass=val!=0&&val<=operand;else if(op==">")pass=val!=0&&val>operand;else if(op=="<")pass=val!=0&&val<operand;else if(op==":")if(key=="quirk")pass=Quirks(operand);else if(key=="function")try{pass=typeof eval(operand)=="function"}catch(e){pass=!1}return typeof pass=="undefined"?(console.warn("No test for %s %s %s",key,op,operand),!1):modifier=="!"?!pass:pass},Quirks._survey=function(e){this._reset(),this.set("kindle3",e.match(/Kindle\/3/)),this.set("nook",e.match(/NOOK/)),this.set("sony-reader",e.match(/Linux;.*EBRD/)),this.set("nintendo",e.match(/NintendoBrowser/)),this.set("webkit",e.match(/WebKit\/([\d\.]+)/)),this.set("gecko",e.match(/Gecko\/([\d\.]+)/)),this.set("trident",e.match(/Trident\/([\d\.]+)/)),this.set("edge",e.match(/Edge\/([\d\.]+)/)),this.set("firefox",e.match(/Firefox\/([\d\.]+)/)),this.set("chrome",e.match(/Chrom(?:e|ium)\/([\d\.]+)/)||e.match(/Cr(?:Mo|iOS)\/([\d\.]+)/)),this.set("iexplore",this.ask("trident")?e.match(/(?:rv:|MSIE )([\d\.]+)/):!1),this.set("safari-build",this.ask("!chrome")?e.match(/Safari\/([\d\.]+)/):!1),this.set("safari",this.ask("safari-build")?e.match(/Version\/([\d\.]+)/):!1),this.set("silk",e.match(/Silk/)),this.set("chromeframe",e.match(/chromeframe/)&&window.externalHost);var t=e.match(/Android\s?([\d\.]+)?/);this.set("android",t||this.ask("sony-reader","silk"));var n=e.match(/OS ([\d_]+).*AppleWebKit.*Mobile/);this.set("ios",n?n[1].replace(/_/g,"."):!1),this.ask("ios")&&!this.ask("safari")&&this.set("safari",this._.survey.ios),this.set("macosx",!n&&e.match(/Mac OS X/)),this.set("windows",e.match(/Windows/)),this.set("blackberry",e.match(/BlackBerry/)),this.set("mobile",e.match(/mobi|tablet|ip(?:ad|hone|od)|android|silk/i)),this.set("ipad",n&&e.match(/iPad/)),this.set("iphone",n&&e.match(/(iPhone|iPod)/)),this.set("android-chrome",this.ask("android chrome")||t&&e.match(/CrMo/)),this.set("android-stock",this.ask("android !android-chrome !firefox")),this.set("ios-standalone",n&&navigator.standalone),this.set("ios-webview",this.ask("ios !safari !ios-standalone")),this.set("ios-uiwebview",this.ask("ios-standalone")),this.set("eink",this.ask("kindle3","sony-reader"))},Quirks._survey(navigator.userAgent),typeof define=="function"&&define.amd?define("quirkbase/quirkbase",[],function(){return Quirks}):typeof exports!="undefined"?exports.Quirkbase=Quirks:window.Quirkbase=Quirks}(),define("quirkbase",["quirkbase/quirkbase"],function(e){return e}),define("core/src/quirks",["require","quirkbase"],function(e){var t=e("quirkbase");return t.add("broken-node-normalize","iexplore","edge"),t.add("broken-fixed-position","ios<5"),t.add("translation-confuses-rects","android-stock android>=4"),t.add("expanding-iframe-widths","android-stock android<4"),t.add("iframe-scrollwidth-expands-to-width","ios-uiwebview","gecko","iexplore"),t.add("missing-multi-column","iexplore<10"),t.add("3d-transform-has-artefacts","iexplore<11"),t.add("scaling-causes-missing-elements","android-stock android>=4","ios>=8"),t.add("css-transition-has-artefacts","false"),t.add("timers-stop-on-lock","webkit>600 ios-standalone"),t.add("translation-flicker","false"),t.add("font-boosting","android>3"),t.add("top-margin-in-scrollheight","gecko"),t.add("table-row-display-none-crash","android-stock android=4.1.2"),t.set("embedded",window.top!=window.self),t.add("referrer-absent-on-doc-write","iexplore embedded","android<4","safari"),t.add("scrolling-transition-bug-417345","webkit !ios !android"),t.add("cors-requires-manual-redirect","safari"),t.add("cors-rules-apply-to-media-src-attributes","safari<8 ios"),t.add("cannot-disable-viewport-scaling","ios>=10 !nautilus"),t}),define("core/src/network",["require"],function(e){var t={online:!0,init:function(){navigator.onLine?t.goOnline():t.goOffline(),t.listenForOffline()},listenForOffline:function(){BIF.listen(window,"online",t.goOnline),BIF.listen(window,"offline",t.goOffline)},deafenForOffline:function(){BIF.deafen(window,"online",t.goOnline),BIF.deafen(window,"offline",t.goOffline)},goOnline:function(){t.online||(t.online=!0,document.getElementsByTagName("html")[0].classList.remove("offline"),BIF.dispatch("bifocal:network","online"))},goOffline:function(){t.online&&(t.online=!1,document.getElementsByTagName("html")[0].classList.add("offline"),BIF.dispatch("bifocal:network","offline"))},sendRequest:function(e,n){var r=null,i=!1,s={req:new XMLHttpRequest,url:e,method:n.method||"GET",headers:n.headers||{},body:n.body};s.headers["X-Dervish-Message"]=BIF.map["-odread-msg-m"],s.method=="POST"&&(s.headers["Content-Type"]=n.contentType||"application/x-www-form-urlencoded"),n.accept&&(s.headers.Accept=n.accept),s.onSuccess=function(){clearTimeout(r),t.requestSuccess(s.req),!i&&typeof n.success=="function"&&n.success(s.req.responseText,s.req),i=!0},s.onFailure=function(e){clearTimeout(r),n.unreliable||t.requestFailure(s.req),!i&&typeof n.failure=="function"&&n.failure(e,s.req),i=!0};if(!BIF.dispatch("network:request",s,!0))return;var o=typeof n.async=="undefined"?!0:n.async;s.req.open(s.method,s.url,o);for(var u in s.headers)s.req.setRequestHeader(u,s.headers[u]);s.req.onreadystatechange=function(e){if(s.req.readyState!=4)return;s.req.status>=200&&s.req.status<300?s.onSuccess():s.onFailure("HTTP status: "+s.req.status)},s.req.onerror=function(e){s.onFailure("XMLHttpRequest error event (asynchronous): "+e)};if(n.timeout){var a=function(){s.req.abort(),s.onFailure("Request timeout")};r=setTimeout(a,n.timeout)}try{s.req.send(s.body)}catch(f){s.onFailure("XMLHttpRequest error (synchronous): "+f)}return s.req},requestFailure:function(e){console.warn("NETWORK: request failed",e)},requestSuccess:function(e){}};return t}),define("core/src/keys",["require"],function(e){var t=function(e,n,r){function u(){l(o.keyDef),BIF.listen(o.doc,o.keyEvent,h)}function a(){o.on=!0}function f(){o.on=!1}function l(e){var t=e.split(" ");o.keyEvent="key"+(t[1]||"up"),t=t[0].split("-");var n=t.pop();n.length==1?(o.charCode=n.charCodeAt(0),o.keyCode=n.toUpperCase().charCodeAt(0)):n[0]=="#"?(o.charCode=parseInt(n.replace(/^#/,"")),o.keyCode=o.charCode):(o.charCode=s.KEYS[n.toUpperCase()],o.keyCode=o.charCode);var r=null;while(r=t.shift()){r=r.toLowerCase();if(r=="shift")o.shiftKey=!0;else if(r=="alt")o.altKey=!0;else if(r=="ctrl")o.ctrlKey=!0;else if(r=="meta"||r=="cmd"){if(o.keyEvent!="keydown"){console.warn(r+" key cannot be registered with "+o.keyEvent);return}o.metaKey=!0}}}function c(e){if(e.type=="keypress"){var t=e.charCode||e.keyCode;if(o.charCode!=t)return!1}else if(o.keyCode!=e.keyCode)return!1;return!!o.shiftKey!=!!e.shiftKey?!1:!!o.altKey!=!!e.altKey?!1:!!o.ctrlKey!=!!e.ctrlKey?!1:!!o.metaKey!=!!e.metaKey?!1:!0}function h(e){if(!o.on||!c(e))return;e.m||(e.m={}),e.m.keyDef=o.keyDef,o.callback(e)}var i={constructor:t},s=i.constants=i.constructor,o=i.properties={doc:r||document,keyDef:e,callback:n,keyEvent:null,on:!0};return i.on=a,i.off=f,u(),i};return t.KEYS={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,HOME:36,END:35,PAGEUP:33,PAGEDOWN:34,INSERT:45},t}),define("common/src/_",["require"],function(e){return{}}),define("common/src/object",["require","./_"],function(e){var t=e("./_");return t.absorb=function(e,n){return t.each(e,function(e,t){n[e]=t}),n},t.mixin=function(e,n){return n.__SHADOWS={},t.each(e,function(e,t){typeof n[e]!="undefined"&&(n.__SHADOWS[e]=n[e]),n[e]=t}),n},t.unmix=function(e,n){return t.each(e,function(e){n[e]=n.__SHADOWS[e],delete n.__SHADOWS[e]}),n},t}),define("common/src/iterable",["require","./_"],function(e){var t=e("./_");return t.each=function(e,n,r){try{if(!e)return;if(t.isList(e))Array.prototype.forEach.call(e,n,r);else{var i=Object.getOwnPropertyNames(e);t.each(i,function(t,s){n.bind(r)(t,e[t],s,i)})}}catch(s){if(s!==t.BreakException)throw s}},t.breakIteration=function(){throw t.BreakException},t.BreakException={reason:"Break out of an iteration loop."},t.excise=function(e,n){if(t.isArray(e)){var r=[],i=0;while(i<e.length)e[i]===n?r=r.concat(e.splice(i,1)):i+=1;return r.length==1?r[0]:r}var s=e[n];return delete e[n],s},t.flatten=function(e,n){return n=n||[],t.isList(e)?t.each(e,function(e){t.flatten(e,n)}):n.push(e),n},t.last=function(e){return e[e.length-1]},t.shuffle=function(e){var t=e.length,n,r;while(0!==t)n=Math.floor(Math.random()*t),t-=1,r=e[t],e[t]=e[n],e[n]=r;return e},t.invertObject=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[e[n]]=n);return t},t.isArray=function(e){return Array.isArray?Array.isArray(e):Object.prototype.toString.call(e)=="[object Array]"},t.isList=function(e){if(t.isArray(e))return!0;var n=Object.prototype.toString.call(e);return n.match(/^\[object (HTMLCollection|NodeList)]$/)?!0:!1},t}),define("common/src/arithmetic",["require","./_"],function(e){var t=e("./_");return t.smoothFloat=function(e,t){var n=Math.pow(10,t||5);return Math.round(e*n)/n},t.numberWithCommas=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},t}),define("common/src/time",["require","./_"],function(e){var t=e("./_");return t.epochMilliseconds=function(){return(new Date).getTime()},t.epochSeconds=function(){return Math.floor(t.epochMilliseconds()/1e3)},t.secondsToUnits=function(e){var t=[{label:"seconds",mod:60},{label:"minutes",mod:60},{label:"hours",mod:24},{label:"days",mod:7},{label:"weeks",mod:52}],n={},r=e;for(i=0,ii=t.length;i<ii;++i){var s=r%t[i].mod;n[t[i].label]=s,r=(r-s)/t[i].mod}return n.years=r,n},t.timestampToUnits=function(e){var t=new Date,n=new Date(e),r={date:n.getDate(),month:n.getMonth(),year:n.getFullYear()},i="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");return r.monthName=i[r.month],t.getFullYear()==r.year&&(r.thisYear=!0),t>n&&t-n<31536e6&&(r.thisPastYear=!0),t.getMonth()==r.month&&r.thisYear&&(r.thisMonth=!0),t.getDate()==r.date&&r.thisMonth&&r.thisYear&&(r.thisDay=!0),r},t.timeUnitsToHumanDate=function(e,t){return t=t||{},e.thisDay&&t.relative!==!1?"Today":!t.year&&(e.thisYear||e.thisPastYear)?[e.date,e.monthName].join(" "):[e.date,e.monthName,e.year].join(" ")},t.timestampToHumanDate=function(e,n){return t.timeUnitsToHumanDate(t.timestampToUnits(e),n)},t}),define("common/src/uuid",["require","./_"],function(e){function n(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)}var t=e("./_");return t.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n)},t}),define("common/src/prefixing",["require","./_"],function(e){var t=e("./_");return t.prefixProperty=function(e,t,n){var r=["-webkit-","-moz-","-ms-",""];if(typeof n=="undefined"||n===null)while(r.length)e.removeProperty(r.shift()+t);else while(r.length)e.setProperty(r.shift()+t,n)},t}),define("common/src/href",["require","./_"],function(e){var t=e("./_");return t.absoluteURL=function(e,t){t=t||document;var n=t.createElement("a");n.setAttribute("href",e);var r=n.href;return r.match(/%/)?r:encodeURI(r)},t.resolvePath=function(e){var t=e.split("/"),n=1;while(n<t.length)t[n]=="."?t.splice(n,1):t[n]==".."&&n>0&&t[n-1]!=".."&&(t.splice(n-1,2),n-=2),n+=1;return t.join("/")},t.expandPath=function(e,n){var r=n.split("/");return r.pop(),t.resolvePath(r.join("/")+"/"+e)},t.parameterizeURL=function(e,t){var n=[];for(var r in t){var i=t[r];if(typeof i!="undefined"&&i!==null&&i!==""){i=i instanceof Array?i:[i];for(var s=0,o=i.length;s<o;++s){var u=i[s];n.push(encodeURIComponent(r)+"="+encodeURIComponent(u))}}}return n.length&&(e+=e.match(/\?/)?"&":"?",e+=n.join("&")),e},t}),define("common/src/assets",["require","./_"],function(e){var t=e("./_");return t.assetPath=function(e,n){if(e.uri)return t.expandPath(n,e.uri);var r="bifocal",i=document.getElementsByTagName("script"),s=i[i.length-1].getAttribute("src"),o=s.split("/"),u=[];while(o.length&&o[0]!=r)u.push(o.shift());var a=e.id.split("/");return!o[0]&&a[0]==r&&a.shift(),u=u.concat(a),t.expandPath(n,u.join("/"))},t}),define("common/src/string",["require","./_"],function(e){var t=e("./_");return t.safe=function(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML},t.decodeEntitiesInString=function(e){var t=document.createElement("div");return t.innerHTML=e,t.firstChild.nodeValue},t.pluralize=function(e){return e+"s"},t.capitalize=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},t.titleize=function(e){var n=["a","an","the","and","but","or","for","nor","as","at","by","for","from","in","into","near","of","on","onto","to"],r=/^[A-Z]+\s*$/,i=new RegExp("^\\s*("+n.join("|")+")\\s$","i");return t.capitalize(e.replace(/([^\W_]+[^\s-]*) */g,function(e){return e.match(i)?e.toLowerCase():e.match(r)?e:e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}))},t.camelize=function(e){return e.replace(/(_\w)/g,function(e){return e[1].toUpperCase()})},t.dasherize=function(e){return e.replace(/[A-Z]/g,function(e,t){return(t!==0?"-":"")+e.toLowerCase()})},t.listToSentence=function(e,t){var n=[];if(typeof t=="function")for(var r=0,i=e.length;r<i;++r){var s=t(e[r],r);typeof s!="undefined"&&n.push(s)}else n=e;return n.length==1?n[0]:n.length==2?n.join(" and "):n.slice(0,-1).join(", ")+", and&nbsp;"+n[n.length-1]},t}),define("common/src/color",["require","./_"],function(e){var t=e("./_");return t.hexToRGB=function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,function(e,t,n,r){return t+t+n+n+r+r});var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return n?[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16)]:null},t.rgbToHex=function(e){var t=function(e){var t=parseInt(e,10).toString(16);return t.length==1?"0"+t:t};return"#"+t(e[0])+t(e[1])+t(e[2])},t.rgbStringToHex=function(e){var n=e.match(/rgba?\((\d+),\s?(\d+),\s?(\d+)/);return t.rgbToHex(n[1],n[2],n[3])},t.rgbToString=function(e){return"rgb("+e.join(",")+")"},t.colorYIQ=function(e){return(e[0]*299+e[1]*587+e[2]*114)/1e3},t.shadeColor=function(e,t){var n=e[0],r=e[1],i=e[2],s=t<0?0:255,o=t<0?t*-1:t;return[Math.round((s-n)*o)+n,Math.round((s-r)*o)+r,Math.round((s-i)*o)+i]},t}),define("common/src/callback",["require","./_"],function(e){var t=e("./_");return t.staggerInvocation=function(e,n,r){var i,s=Infinity,o=function(){s=Infinity,e()};return r=Math.max(n,r||0),function(e){clearTimeout(i);var u=t.epochMilliseconds();s=Math.min(s,u);var a=e?0:s+r;if(u>=a)o();else{var f=Math.min(n,a-u);i=setTimeout(o,f)}}},t}),define("common/src/regexp",["require","./_"],function(e){function n(e){return e[0]+"_"+e[1].toLowerCase()}var t=e("./_");return t.regExpEscape=function(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},t.regExpPunctuation=function(){return"\\u2000-\\u206F\\u2E00-\\u2E7F"+t.regExpEscape("\\'!\"#$%&()*+,-./:;<=>?@[]^_`{|}~")},t.snakeCase=function(e){return e.replace(/([a-z][A-Z])/g,n)},t}),define("common/src/dom_factory",["require","./_","quirkbase"],function(e){var t=e("./_");t.element=function(e,n,r,i,s,o){var u;typeof arguments[0]=="object"?u=arguments[0]:u={tag:e,id:n,parentNode:r,classes:i,html:s,pos:o};var a=document;typeof u.parentNode=="object"&&u.parentNode&&(a=u.parentNode.ownerDocument);var f;return u.namespace=="svg"?f=a.createElementNS("http://www.w3.org/2000/svg",u.tag):f=a.createElement(u.tag||"div"),typeof u.id=="string"&&u.id&&(f.id=u.id),typeof u.className=="string"&&u.className?f.setAttribute("class",u.className):typeof u.classes=="string"&&u.classes&&f.setAttribute("class",u.classes),typeof u.html=="string"&&u.html&&(f.innerHTML=u.html),t.each(u.attributes,function(e,t){typeof t!="undefined"&&t!==null&&f.setAttribute(e,t)}),typeof u.parentNode=="object"&&u.parentNode&&(u.pos=="prepend"&&u.parentNode.firstChild?u.parentNode.insertBefore(f,u.parentNode.firstChild):u.parentNode.appendChild(f)),f},t.iframe=function(e,n){e=e||{},e.tag="iframe",e.attributes=t.absorb({frameborder:"no",scrolling:e.scrolling||"no",width:e.width||0,height:e.height||0},e.attributes||{});var r=t.element(e);return typeof n=="function"&&this._iframeAddHandler(r,"load",n),typeof e.src=="string"&&r.setAttribute("src",e.src),r},t._iframeAddHandler=function(e,n,r){var i=function(){t._iframeRemoveHandler(e,n,i),r(e)};e._handlers=e._handlers||{},e._handlers[n]=e._handlers[n]||[],e._handlers[n].push(i),e.addEventListener?e.addEventListener(n,i,!1):e.attachEvent&&e.attachEvent("on"+n,i)},t._iframeRemoveHandler=function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)},t._iframeRemoveAllHandlers=function(e,n){if(!e._handlers)return;for(var r in e._handlers){if(n&&r!=n)continue;var i=e._handlers[r];while(i&&i.length)t._iframeRemoveHandler(e,r,i.shift())}};var n=e("quirkbase");return t.normalize=function(e){if(!e)return;if(!n("broken-node-normalize"))return e.normalize();if(e.nodeType==3)while(e.nextSibling&&e.nextSibling.nodeType==3)e.nodeValue+=e.nextSibling.nodeValue,e.parentNode.removeChild(e.nextSibling);else t.normalize(e.firstChild);t.normalize(e.nextSibling)},t}),define("common/src/dom_classname",["require","./_"],function(e){var t=e("./_");return t.batonClass=function(e,t,n){n=n||e.ownerDocument.documentElement;var r=n.querySelectorAll("."+t);for(var i=0,s=r.length;i<s;++i){if(r[i]==e)continue;r[i].classList.remove(t)}e.classList.add(t)},t}),define("common/src/dom_selection",["require","./_"],function(e){var t=e("./_");return t.elementSelector=function(e){var t=[];while(e){if(e==e.ownerDocument.documentElement){t.unshift(e.tagName);break}if(e.id){t.unshift("#"+e.id);break}for(var n=1,r=e;r.previousElementSibling;r=r.previousElementSibling,n++);t.unshift(e.tagName+":nth-child("+n+")"),e=e.parentNode}return t.join(" > ")},t.elementClosest=function(e,t){if(typeof e.closest=="function")return e.closest(t);var n=e;while(n.parentNode)n=n.parentNode;var r=n.querySelectorAll(t);while(e&&e.nodeType===1){for(var i=0,s=r.length;i<s;++i)if(r[i]==e)return e;e=e.parentNode}},t}),define("common/src/dom_traversal",["require","./_"],function(e){var t=e("./_");return t.walk=function(e,n){var r=[],i=e;while(i)r.push(i),i=i.firstChild||t._nextInWalk(i);for(var s=0,o=r.length;s<o;++s)try{n(r[s])}catch(u){if(u==="halt")return;throw u}},t._nextInWalk=function(e){return e?e.nextSibling||t._nextInWalk(e.parentNode):null},t.getRangeRects=function(e){var n=[],r=e.startOffset,i=t._nextInWalk(e.endContainer);return t.walk(e.startContainer,function(t){if(t===i)throw"halt";if(!t.childNodes.length){var s=t.ownerDocument.createRange();s.selectNodeContents(t),r&&(s.setStart(t,r),r=0),s.collapsed?Array.prototype.push.apply(n,s.startContainer.getClientRects()):(t===e.endContainer&&s.setEnd(t,e.endOffset),Array.prototype.push.apply(n,s.getClientRects()))}}),n.length||n.push(e.getBoundingClientRect()),n},t}),define("common/src/class",["require","./_"],function(e){var t=e("./_"),n=function(){},r=n.prototype,i="__I_AM_METACLASS__";return n.new=function(){var e=function(e){e!==i&&(this._={},this.$init.apply(this,Array.prototype.slice.call(arguments,0)))};return e.new=this.new,e.prototype=new this(i),e},r.$init=function(){},t.Class=n}),define("common/src/data_class",["require","./_"],function(e){var t=e("./_"),n={};return n.set=function(e,t,n){if(this.get(e,t)!=n){this.clear(e,t);var r=typeof n!="undefined"?"_"+n:"";e.classList.add("data-"+t+r)}},n.get=function(e,t){var n=this._pattern(t);for(var r=0,i=e.classList.length;r<i;++r){var s=e.classList[r].match(n);if(s)return s[2]}},n.clear=function(e,t){var n=this._pattern(t),r=[];for(var i=0,s=e.classList.length;i<s;++i)e.classList[i].match(n)&&r.push(e.classList[i]);while(r.length)e.classList.remove(r.shift())},n.semaphore=function(e){return{set:n.set.bind(n,e),get:n.get.bind(n,e),clear:n.clear.bind(n,e)}},n._pattern=function(e){return new RegExp("^data-"+e+"(_(.*))?$")},t.DataClass=n}),define("common/common",["require","./src/object","./src/iterable","./src/arithmetic","./src/time","./src/uuid","./src/prefixing","./src/href","./src/assets","./src/string","./src/color","./src/callback","./src/regexp","./src/dom_factory","./src/dom_classname","./src/dom_selection","./src/dom_traversal","./src/class","./src/data_class","./src/_"],function(e){return e("./src/object"),e("./src/iterable"),e("./src/arithmetic"),e("./src/time"),e("./src/uuid"),e("./src/prefixing"),e("./src/href"),e("./src/assets"),e("./src/string"),e("./src/color"),e("./src/callback"),e("./src/regexp"),e("./src/dom_factory"),e("./src/dom_classname"),e("./src/dom_selection"),e("./src/dom_traversal"),e("./src/class"),e("./src/data_class"),e("./src/_")}),define("common",["common/common"],function(e){return e}),define("core/src/locator",["require","common"],function(e){var t=e("common"),n=function(){function s(e,t){var n=e.cloneRange();n.startContainer!==n.endContainer&&n.setEnd(n.startContainer,n.startContainer.nodeValue.length);var r=n.startContainer,i={spinePosition:t,elementIndex:c(r),charOffset:0,matchIndex:0,matchString:n.toString()};while(typeof i.elementIndex!="number"&&r.parentNode)r=r.parentNode,i.elementIndex=c(r);var s=l(r),o,u="";while(o=s.shift())o===n.startContainer&&(i.charOffset=u.length+n.startOffset),u+=o.nodeValue;if(i.matchString){var a=-1,f=i.matchString.length;for(;;){a=u.indexOf(i.matchString,a>=0?a+f:0);if(!(a>=0&&a<i.charOffset))break;i.matchIndex+=1}}return i}function o(e,t){var n=h(e.elementIndex,t);if(!n)return null;var r=e.charOffset,i=e.matchIndex,s=e.matchString.length,o=l(n),u="";for(var a=0,f=o.length;a<f;++a)u+=o[a].nodeValue;if(u.substr(r,s)!==e.matchString){r=null;var c=0;while(isFinite(i)){c=u.indexOf(e.matchString,c?c+s:0);if(c<0||(i-=1)<0&&(r=c))break}}var p=n.ownerDocument.createRange();if(typeof r=="number"){while(o.length&&o[0].nodeValue.length<=r)r-=o.shift().nodeValue.length;p.setStart(o[0],r),p.setEnd(o[0],r+s)}else p.selectNode(o[0]),p.__BIF_IMPRECISE=!0;return p}function u(e,t,n){var r=o(e,n),i=o(t,n);return r.setEnd(i.endContainer,i.endOffset),r}function a(e,t){if(p(e))return;var n=e.startContainer.ownerDocument.createElement(t);return e.surroundContents(n),n}function f(e){var n=e.parentNode;while(e.childNodes.length)n.insertBefore(e.firstChild,e);n.removeChild(e),t.normalize(n)}function l(e){if(e.nodeType===3)return[e];var t=[];for(var n=0,r=e.childNodes.length;n<r;++n)t=t.concat(l(e.childNodes[n]));return t}function c(e){try{var t=e.getAttribute("data-loc");if(typeof t=="string"&&t.match(/^\d+$/))return parseInt(t)}catch(n){}}function h(e,t){return t.querySelector('*[data-loc="'+e+'"]')}function p(e){var t=function(e){return e?e.nodeType===document.body.TEXT_NODE?!1:e.tagName.match(/^BIF/)?!1:!0:!0};return e.startContainer===e.endContainer&&e.startOffset===0&&t(e.startContainer.previousSibling)&&t(e.startContainer.nextSibling)&&e.toString().match(/^\s*$/)}var e={constructor:n},r=e.constants=e.constructor,i=e.properties={};return e.rangeToLocator=s,e.locatorToRange=o,e.locatorsToRange=u,e.injectElement=a,e.extractElement=f,e};return n}),define("text",["module"],function(e){var t,n,r,i,s,o=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],u=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,a=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,f=typeof location!="undefined"&&location.href,l=f&&location.protocol&&location.protocol.replace(/\:/,""),c=f&&location.hostname,h=f&&(location.port||undefined),p={},d=e.config&&e.config()||{};t={version:"2.0.10",strip:function(e){if(e){e=e.replace(u,"");var t=e.match(a);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:d.createXhr||function(){var e,t,n;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(t=0;t<3;t+=1){n=o[t];try{e=new ActiveXObject(n)}catch(r){}if(e){o=[n];break}}return e},parseName:function(e){var t,n,r,i=!1,s=e.indexOf("."),o=e.indexOf("./")===0||e.indexOf("../")===0;return s!==-1&&(!o||s>1)?(t=e.substring(0,s),n=e.substring(s+1,e.length)):t=e,r=n||t,s=r.indexOf("!"),s!==-1&&(i=r.substring(s+1)==="strip",r=r.substring(0,s),n?n=r:t=r),{moduleName:t,ext:n,strip:i}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,r,i){var s,o,u,a=t.xdRegExp.exec(e);return a?(s=a[2],o=a[3],o=o.split(":"),u=o[1],o=o[0],(!s||s===n)&&(!o||o.toLowerCase()===r.toLowerCase())&&(!u&&!o||u===i)):!0},finishLoad:function(e,n,r,i){r=n?t.strip(r):r,d.isBuild&&(p[e]=r),i(r)},load:function(e,n,r,i){if(i.isBuild&&!i.inlineText){r();return}d.isBuild=i.isBuild;var s=t.parseName(e),o=s.moduleName+(s.ext?"."+s.ext:""),u=n.toUrl(o),a=d.useXhr||t.useXhr;if(u.indexOf("empty:")===0){r();return}!f||a(u,l,c,h)?t.get(u,function(n){t.finishLoad(e,s.strip,n,r)},function(e){r.error&&r.error(e)}):n([o],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,r)})},write:function(e,n,r,i){if(p.hasOwnProperty(n)){var s=t.jsEscape(p[n]);r.asModule(e+"!"+n,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,n,r,i,s){var o=t.parseName(n),u=o.ext?"."+o.ext:"",a=o.moduleName+u,f=r.toUrl(o.moduleName+u)+".js";t.load(a,r,function(n){var r=function(e){return i(f,e)};r.asModule=function(e,t){return i.asModule(e,f,t)},t.write(e,a,r,s)},s)}};if(d.env==="node"||!d.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node&&!process.versions["node-webkit"])n=require.nodeRequire("fs"),t.get=function(e,t,r){try{var i=n.readFileSync(e,"utf8");i.indexOf("ï»¿")===0&&(i=i.substring(1)),t(i)}catch(s){r(s)}};else if(d.env==="xhr"||!d.env&&t.createXhr())t.get=function(e,n,r,i){var s=t.createXhr(),o;s.open("GET",e,!0);if(i)for(o in i)i.hasOwnProperty(o)&&s.setRequestHeader(o.toLowerCase(),i[o]);d.onXhr&&d.onXhr(s,e),s.onreadystatechange=function(t){var i,o;s.readyState===4&&(i=s.status,i>399&&i<600?(o=new Error(e+" HTTP status: "+i),o.xhr=s,r(o)):n(s.responseText),d.onXhrComplete&&d.onXhrComplete(s,e))},s.send(null)};else if(d.env==="rhino"||!d.env&&typeof Packages!="undefined"&&typeof java!="undefined")t.get=function(e,t){var n,r,i="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),u=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),i)),a="";try{n=new java.lang.StringBuffer,r=u.readLine(),r&&r.length()&&r.charAt(0)===65279&&(r=r.substring(1)),r!==null&&n.append(r);while((r=u.readLine())!==null)n.append(o),n.append(r);a=String(n.toString())}finally{u.close()}t(a)};else if(d.env==="xpconnect"||!d.env&&typeof Components!="undefined"&&Components.classes&&Components.interfaces)r=Components.classes,i=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in r,t.get=function(e,t){var n,o,u,a={};s&&(e=e.replace(/\//g,"\\")),u=new FileUtils.File(e);try{n=r["@mozilla.org/network/file-input-stream;1"].createInstance(i.nsIFileInputStream),n.init(u,1,0,!1),o=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(i.nsIConverterInputStream),o.init(n,"utf-8",n.available(),i.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),o.readString(n.available(),a),o.close(),n.close(),t(a.value)}catch(f){throw new Error((u&&u.path||"")+": "+f)}};return t}),define("text!bifocal/VERSION",[],function(){return"1.6.1-ac\n"}),define("gala/src/events",["require"],function(e){var t={};return t.DEFAULT_DISPATCHER=document.documentElement,t.listen=function(e,n,r,i){return t._listen.apply(t,t._addDispatcher(arguments))},t._listen=function(e,t,n,r){e.addEventListener(t,n,r||!1)},t.deafen=function(e,n,r,i){return t._deafen.apply(t,t._addDispatcher(arguments))},t._deafen=function(e,t,n,r){e.removeEventListener(t,n,r||!1)},t.dispatch=function(e,n,r,i){return t._dispatch.apply(t,t._addDispatcher(arguments))},t._dispatch=function(e,t,n,r){var i=document.createEvent("Events");return i.initEvent(t,!1,r||!1),i.m=n,e.dispatchEvent(i)},t.stop=function(e){return e=e||window.event,e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.cancelBubble=!0,e._gala_prevented=!0,!1},t._addDispatcher=function(e){return e=Array.prototype.slice.call(e,0),typeof e[0]=="string"&&e.unshift(t.DEFAULT_DISPATCHER),e},t}),define("gala/src/quirks",["require","quirkbase"],function(e){var t=e("quirkbase");return t.add("pointer-contact-events-w3",typeof PointerEvent!="undefined"),t.add("pointer-contact-events-ms",(navigator.msPointerEnabled||typeof MSPointerEvent!="undefined")&&!t("pointer-contact-events-w3")),t.add("pointer-contact-events",t("pointer-contact-events-w3")||t("pointer-contact-events-ms")),t.add("has-touch-pointers","ontouchstart"in window?!0:!1),t.add("active-pseudoclass-needs-touchstart","ios<11"),t.add("legacy-ontap","ios-uiwebview"),t}),define("gala/src/constants",["require","./quirks"],function(e){var t=e("./quirks"),n={};return n.TAPPABLE_CLASS="tappable",n.DEFAULT_TOUCH_ACTION="none",n}),define("gala/src/handler",["require","./events"],function(e){var t=e("./events"),n=function(e,n,r,i){var s=t._addDispatcher(arguments);this.element=s[0],this.evtType=s[1],this.callback=s[2],this.useCapture=s[3]},r=n.prototype;return r.listen=function(){if(this.listening)return;return t._listen(this.element,this.evtType,this.callback,this.useCapture),this.listening=!0,this},r.deafen=function(){if(!this.listening)return;return t._deafen(this.element,this.evtType,this.callback,this.useCapture),this.listening=!1,this},n}),function(e,t){typeof exports=="object"&&typeof module!="undefined"?module.exports=t():typeof define=="function"&&define.amd?define("pep/pep",t):e.PointerEventsPolyfill=t()}(this,function(){function n(n,r){r=r||Object.create(null);var i=document.createEvent("Event");i.initEvent(n,r.bubbles||!1,r.cancelable||!1);for(var s=2,o;s<e.length;s++)o=e[s],i[o]=r[o]||t[s];i.buttons=r.buttons||0;var u=0;return r.pressure&&i.buttons?u=r.pressure:u=i.buttons?.5:0,i.x=i.clientX,i.y=i.clientY,i.pointerId=r.pointerId||0,i.width=r.width||0,i.height=r.height||0,i.pressure=u,i.tiltX=r.tiltX||0,i.tiltY=r.tiltY||0,i.twist=r.twist||0,i.tangentialPressure=r.tangentialPressure||0,i.pointerType=r.pointerType||"",i.hwTimestamp=r.hwTimestamp||0,i.isPrimary=r.isPrimary||!1,i}function s(){this.array=[],this.size=0}function b(e,t,n,r){this.addCallback=e.bind(r),this.removeCallback=t.bind(r),this.changedCallback=n.bind(r),m&&(this.observer=new m(this.mutationWatcher.bind(this)))}function w(e){return"body /shadow-deep/ "+E(e)}function E(e){return'[touch-action="'+e+'"]'}function S(e){return"{ -ms-touch-action: "+e+"; touch-action: "+e+"; }"}function k(){if(N){x.forEach(function(e){String(e)===e?(T+=E(e)+S(e)+"\n",C&&(T+=w(e)+S(e)+"\n")):(T+=e.selectors.map(E)+S(e.rule)+"\n",C&&(T+=e.selectors.map(w)+S(e.rule)+"\n"))});var e=document.createElement("style");e.textContent=T,document.head.appendChild(e)}}function V(){if(!window.PointerEvent){window.PointerEvent=n;if(window.navigator.msPointerEnabled){var e=window.navigator.msMaxTouchPoints;Object.defineProperty(window.navigator,"maxTouchPoints",{value:e,enumerable:!0}),l.registerSource("ms",X)}else Object.defineProperty(window.navigator,"maxTouchPoints",{value:0,enumerable:!0}),l.registerSource("mouse",D),window.ontouchstart!==undefined&&l.registerSource("touch",U);l.register(document)}}function G(e){if(!l.pointermap.has(e)){var t=new Error("InvalidPointerId");throw t.name="InvalidPointerId",t}}function Y(e){var t=e.parentNode;while(t&&t!==e.ownerDocument)t=t.parentNode;if(!t){var n=new Error("InvalidStateError");throw n.name="InvalidStateError",n}}function Z(e){var t=l.pointermap.get(e);return t.buttons!==0}function et(){window.Element&&!Element.prototype.setPointerCapture&&Object.defineProperties(Element.prototype,{setPointerCapture:{value:J},releasePointerCapture:{value:K},hasPointerCapture:{value:Q}})}var e=["bubbles","cancelable","view","detail","screenX","screenY","clientX","clientY","ctrlKey","altKey","shiftKey","metaKey","button","relatedTarget","pageX","pageY"],t=[!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,0,0],r=window.Map&&window.Map.prototype.forEach,i=r?Map:s;s.prototype={set:function(e,t){if(t===undefined)return this.delete(e);this.has(e)||this.size++,this.array[e]=t},has:function(e){return this.array[e]!==undefined},"delete":function(e){this.has(e)&&(delete this.array[e],this.size--)},get:function(e){return this.array[e]},clear:function(){this.array.length=0,this.size=0},forEach:function(e,t){return this.array.forEach(function(n,r){e.call(t,n,r,this)},this)}};var o=["bubbles","cancelable","view","detail","screenX","screenY","clientX","clientY","ctrlKey","altKey","shiftKey","metaKey","button","relatedTarget","buttons","pointerId","width","height","pressure","tiltX","tiltY","pointerType","hwTimestamp","isPrimary","type","target","currentTarget","which","pageX","pageY","timeStamp"],u=[!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,0,0,0,0,0,0,0,"",0,!1,"",null,null,0,0,0,0],a={pointerover:1,pointerout:1,pointerenter:1,pointerleave:1},f=typeof SVGElementInstance!="undefined",l={pointermap:new i,eventMap:Object.create(null),captureInfo:Object.create(null),eventSources:Object.create(null),eventSourceList:[],registerSource:function(e,t){var n=t,r=n.events;r&&(r.forEach(function(e){n[e]&&(this.eventMap[e]=n[e].bind(n))},this),this.eventSources[e]=n,this.eventSourceList.push(n))},register:function(e){var t=this.eventSourceList.length;for(var n=0,r;n<t&&(r=this.eventSourceList[n]);n++)r.register.call(r,e)},unregister:function(e){var t=this.eventSourceList.length;for(var n=0,r;n<t&&(r=this.eventSourceList[n]);n++)r.unregister.call(r,e)},contains:function(e,t){try{return e.contains(t)}catch(n){return!1}},down:function(e){e.bubbles=!0,this.fireEvent("pointerdown",e)},move:function(e){e.bubbles=!0,this.fireEvent("pointermove",e)},up:function(e){e.bubbles=!0,this.fireEvent("pointerup",e)},enter:function(e){e.bubbles=!1,this.fireEvent("pointerenter",e)},leave:function(e){e.bubbles=!1,this.fireEvent("pointerleave",e)},over:function(e){e.bubbles=!0,this.fireEvent("pointerover",e)},out:function(e){e.bubbles=!0,this.fireEvent("pointerout",e)},cancel:function(e){e.bubbles=!0,this.fireEvent("pointercancel",e)},leaveOut:function(e){this.out(e),this.propagate(e,this.leave,!1)},enterOver:function(e){this.over(e),this.propagate(e,this.enter,!0)},eventHandler:function(e){if(e._handledByPE)return;var t=e.type,n=this.eventMap&&this.eventMap[t];n&&n(e),e._handledByPE=!0},listen:function(e,t){t.forEach(function(t){this.addEvent(e,t)},this)},unlisten:function(e,t){t.forEach(function(t){this.removeEvent(e,t)},this)},addEvent:function(e,t){e.addEventListener(t,this.boundHandler)},removeEvent:function(e,t){e.removeEventListener(t,this.boundHandler)},makeEvent:function(e,t){this.captureInfo[t.pointerId]&&(t.relatedTarget=null);var r=new n(e,t);return t.preventDefault&&(r.preventDefault=t.preventDefault),r._target=r._target||t.target,r},fireEvent:function(e,t){var n=this.makeEvent(e,t);return this.dispatchEvent(n)},cloneEvent:function(e){var t=Object.create(null),n;for(var r=0;r<o.length;r++)n=o[r],t[n]=e[n]||u[r],f&&(n==="target"||n==="relatedTarget")&&t[n]instanceof SVGElementInstance&&(t[n]=t[n].correspondingUseElement);return e.preventDefault&&(t.preventDefault=function(){e.preventDefault()}),t},getTarget:function(e){var t=this.captureInfo[e.pointerId];if(!t)return e._target;if(e._target===t||!(e.type in a))return t},propagate:function(e,t,n){var r=e.target,i=[];while(r!==document&&!r.contains(e.relatedTarget)){i.push(r),r=r.parentNode;if(!r)return}n&&i.reverse(),i.forEach(function(n){e.target=n,t.call(this,e)},this)},setCapture:function(e,t,r){this.captureInfo[e]&&this.releaseCapture(e,r),this.captureInfo[e]=t,this.implicitRelease=this.releaseCapture.bind(this,e,r),document.addEventListener("pointerup",this.implicitRelease),document.addEventListener("pointercancel",this.implicitRelease);var i=new n("gotpointercapture");i.pointerId=e,i._target=t,r||this.asyncDispatchEvent(i)},releaseCapture:function(e,t){var r=this.captureInfo[e];if(!r)return;this.captureInfo[e]=undefined,document.removeEventListener("pointerup",this.implicitRelease),document.removeEventListener("pointercancel",this.implicitRelease);var i=new n("lostpointercapture");i.pointerId=e,i._target=r,t||this.asyncDispatchEvent(i)},dispatchEvent:function(e){var t=this.getTarget(e);if(t)return t.dispatchEvent(e)},asyncDispatchEvent:function(e){requestAnimationFrame(this.dispatchEvent.bind(this,e))}};l.boundHandler=l.eventHandler.bind(l);var c={shadow:function(e){if(e)return e.shadowRoot||e.webkitShadowRoot},canTarget:function(e){return e&&Boolean(e.elementFromPoint)},targetingShadow:function(e){var t=this.shadow(e);if(this.canTarget(t))return t},olderShadow:function(e){var t=e.olderShadowRoot;if(!t){var n=e.querySelector("shadow");n&&(t=n.olderShadowRoot)}return t},allShadows:function(e){var t=[],n=this.shadow(e);while(n)t.push(n),n=this.olderShadow(n);return t},searchRoot:function(e,t,n){if(e){var r=e.elementFromPoint(t,n),i,s;s=this.targetingShadow(r);while(s){i=s.elementFromPoint(t,n);if(!!i){var o=this.targetingShadow(i);return this.searchRoot(o,t,n)||i}s=this.olderShadow(s)}return r}},owner:function(e){var t=e;while(t.parentNode)t=t.parentNode;return t.nodeType!==Node.DOCUMENT_NODE&&t.nodeType!==Node.DOCUMENT_FRAGMENT_NODE&&(t=document),t},findTarget:function(e){var t=e.clientX,n=e.clientY,r=this.owner(e.target);return r.elementFromPoint(t,n)||(r=document),this.searchRoot(r,t,n)}},h=Array.prototype.forEach.call.bind(Array.prototype.forEach),p=Array.prototype.map.call.bind(Array.prototype.map),d=Array.prototype.slice.call.bind(Array.prototype.slice),v=Array.prototype.filter.call.bind(Array.prototype.filter),m=window.MutationObserver||window.WebKitMutationObserver,g="[touch-action]",y={subtree:!0,childList:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["touch-action"]};b.prototype={watchSubtree:function(e){this.observer&&c.canTarget(e)&&this.observer.observe(e,y)},enableOnSubtree:function(e){this.watchSubtree(e),e===document&&document.readyState!=="complete"?this.installOnLoad():this.installNewSubtree(e)},installNewSubtree:function(e){h(this.findElements(e),this.addElement,this)},findElements:function(e){return e.querySelectorAll?e.querySelectorAll(g):[]},removeElement:function(e){this.removeCallback(e)},addElement:function(e){this.addCallback(e)},elementChanged:function(e,t){this.changedCallback(e,t)},concatLists:function(e,t){return e.concat(d(t))},installOnLoad:function(){document.addEventListener("readystatechange",function(){document.readyState==="complete"&&this.installNewSubtree(document)}.bind(this))},isElement:function(e){return e.nodeType===Node.ELEMENT_NODE},flattenMutationTree:function(e){var t=p(e,this.findElements,this);return t.push(v(e,this.isElement)),t.reduce(this.concatLists,[])},mutationWatcher:function(e){e.forEach(this.mutationHandler,this)},mutationHandler:function(e){if(e.type==="childList"){var t=this.flattenMutationTree(e.addedNodes);t.forEach(this.addElement,this);var n=this.flattenMutationTree(e.removedNodes);n.forEach(this.removeElement,this)}else e.type==="attributes"&&this.elementChanged(e.target,e.oldValue)}};var x=["none","auto","pan-x","pan-y",{rule:"pan-x pan-y",selectors:["pan-x pan-y","pan-y pan-x"]}],T="",N=window.PointerEvent||window.MSPointerEvent,C=!window.ShadowDOMPolyfill&&document.head.createShadowRoot,L=l.pointermap,A=25,O=[1,4,2,8,16],M=!1;try{M=(new MouseEvent("test",{buttons:1})).buttons===1}catch(_){}var D={POINTER_ID:1,POINTER_TYPE:"mouse",events:["mousedown","mousemove","mouseup","mouseover","mouseout"],register:function(e){l.listen(e,this.events)},unregister:function(e){l.unlisten(e,this.events)},lastTouches:[],isEventSimulatedFromTouch:function(e){var t=this.lastTouches,n=e.clientX,r=e.clientY;for(var i=0,s=t.length,o;i<s&&(o=t[i]);i++){var u=Math.abs(n-o.x),a=Math.abs(r-o.y);if(u<=A&&a<=A)return!0}},prepareEvent:function(e){var t=l.cloneEvent(e),n=t.preventDefault;return t.preventDefault=function(){e.preventDefault(),n()},t.pointerId=this.POINTER_ID,t.isPrimary=!0,t.pointerType=this.POINTER_TYPE,t},prepareButtonsForMove:function(e,t){var n=L.get(this.POINTER_ID);t.which===0||!n?e.buttons=0:e.buttons=n.buttons,t.buttons=e.buttons},mousedown:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=L.get(this.POINTER_ID),n=this.prepareEvent(e);M||(n.buttons=O[n.button],t&&(n.buttons|=t.buttons),e.buttons=n.buttons),L.set(this.POINTER_ID,e),!t||t.buttons===0||!0?l.down(n):l.move(n)}},mousemove:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=this.prepareEvent(e);M||this.prepareButtonsForMove(t,e),t.button=-1,L.set(this.POINTER_ID,e),l.move(t)}},mouseup:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=L.get(this.POINTER_ID),n=this.prepareEvent(e);if(!M){var r=O[n.button];n.buttons=t?t.buttons&~r:0,e.buttons=n.buttons}L.set(this.POINTER_ID,e),n.buttons&=~O[n.button],n.buttons===0?l.up(n):l.move(n)}},mouseover:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=this.prepareEvent(e);M||this.prepareButtonsForMove(t,e),t.button=-1,L.set(this.POINTER_ID,e),l.enterOver(t)}},mouseout:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=this.prepareEvent(e);M||this.prepareButtonsForMove(t,e),t.button=-1,l.leaveOut(t)}},cancel:function(e){var t=this.prepareEvent(e);l.cancel(t),this.deactivateMouse()},deactivateMouse:function(){L.delete(this.POINTER_ID)}},P=l.captureInfo,H=c.findTarget.bind(c),B=c.allShadows.bind(c),j=l.pointermap,F=2500,I=200,q="touch-action",R,U={events:["touchstart","touchmove","touchend","touchcancel"],register:function(e){R.enableOnSubtree(e)},unregister:function(){},elementAdded:function(e){var t=e.getAttribute(q),n=this.touchActionToScrollType(t);n&&(e._scrollType=n,l.listen(e,this.events),B(e).forEach(function(e){e._scrollType=n,l.listen(e,this.events)},this))},elementRemoved:function(e){e._scrollType=undefined,l.unlisten(e,this.events),B(e).forEach(function(e){e._scrollType=undefined,l.unlisten(e,this.events)},this)},elementChanged:function(e,t){var n=e.getAttribute(q),r=this.touchActionToScrollType(n),i=this.touchActionToScrollType(t);r&&i?(e._scrollType=r,B(e).forEach(function(e){e._scrollType=r},this)):i?this.elementRemoved(e):r&&this.elementAdded(e)},scrollTypes:{EMITTER:"none",XSCROLLER:"pan-x",YSCROLLER:"pan-y",SCROLLER:/^(?:pan-x pan-y)|(?:pan-y pan-x)|auto$/},touchActionToScrollType:function(e){var t=e,n=this.scrollTypes;if(t==="none")return"none";if(t===n.XSCROLLER)return"X";if(t===n.YSCROLLER)return"Y";if(n.SCROLLER.exec(t))return"XY"},POINTER_TYPE:"touch",firstTouch:null,isPrimaryTouch:function(e){return this.firstTouch===e.identifier},setPrimaryTouch:function(e){if(j.size===0||j.size===1&&j.has(1))this.firstTouch=e.identifier,this.firstXY={X:e.clientX,Y:e.clientY},this.scrolling=!1,this.cancelResetClickCount()},removePrimaryPointer:function(e){e.isPrimary&&(this.firstTouch=null,this.firstXY=null,this.resetClickCount())},clickCount:0,resetId:null,resetClickCount:function(){var e=function(){this.clickCount=0,this.resetId=null}.bind(this);this.resetId=setTimeout(e,I)},cancelResetClickCount:function(){this.resetId&&clearTimeout(this.resetId)},typeToButtons:function(e){var t=0;if(e==="touchstart"||e==="touchmove")t=1;return t},touchToPointer:function(e){var t=this.currentTouchEvent,n=l.cloneEvent(e),r=n.pointerId=e.identifier+2;n.target=P[r]||H(n),n.bubbles=!0,n.cancelable=!0,n.detail=this.clickCount,n.button=0,n.buttons=this.typeToButtons(t.type),n.width=(e.radiusX||e.webkitRadiusX||0)*2,n.height=(e.radiusY||e.webkitRadiusY||0)*2,n.pressure=e.force||e.webkitForce||.5,n.isPrimary=this.isPrimaryTouch(e),n.pointerType=this.POINTER_TYPE,n.altKey=t.altKey,n.ctrlKey=t.ctrlKey,n.metaKey=t.metaKey,n.shiftKey=t.shiftKey;var i=this;return n.preventDefault=function(){i.scrolling=!1,i.firstXY=null,t.preventDefault()},n},processTouches:function(e,t){var n=e.changedTouches;this.currentTouchEvent=e;for(var r=0,i;r<n.length;r++)i=n[r],t.call(this,this.touchToPointer(i))},shouldScroll:function(e){if(this.firstXY){var t,n=e.currentTarget._scrollType;if(n==="none")t=!1;else if(n==="XY")t=!0;else{var r=e.changedTouches[0],i=n,s=n==="Y"?"X":"Y",o=Math.abs(r["client"+i]-this.firstXY[i]),u=Math.abs(r["client"+s]-this.firstXY[s]);t=o>=u}return this.firstXY=null,t}},findTouch:function(e,t){for(var n=0,r=e.length,i;n<r&&(i=e[n]);n++)if(i.identifier===t)return!0},vacuumTouches:function(e){var t=e.touches;if(j.size>=t.length){var n=[];j.forEach(function(e,r){if(r!==1&&!this.findTouch(t,r-2)){var i=e.out;n.push(i)}},this),n.forEach(this.cancelOut,this)}},touchstart:function(e){this.vacuumTouches(e),this.setPrimaryTouch(e.changedTouches[0]),this.dedupSynthMouse(e),this.scrolling||(this.clickCount++,this.processTouches(e,this.overDown))},overDown:function(e){j.set(e.pointerId,{target:e.target,out:e,outTarget:e.target}),l.enterOver(e),l.down(e)},touchmove:function(e){this.scrolling||(this.shouldScroll(e)?(this.scrolling=!0,this.touchcancel(e)):(e.preventDefault(),this.processTouches(e,this.moveOverOut)))},moveOverOut:function(e){var t=e,n=j.get(t.pointerId);if(!n)return;var r=n.out,i=n.outTarget;l.move(t),r&&i!==t.target&&(r.relatedTarget=t.target,t.relatedTarget=i,r.target=i,t.target?(l.leaveOut(r),l.enterOver(t)):(t.target=i,t.relatedTarget=null,this.cancelOut(t))),n.out=t,n.outTarget=t.target},touchend:function(e){this.dedupSynthMouse(e),this.processTouches(e,this.upOut)},upOut:function(e){this.scrolling||(l.up(e),l.leaveOut(e)),this.cleanUpPointer(e)},touchcancel:function(e){this.processTouches(e,this.cancelOut)},cancelOut:function(e){l.cancel(e),l.leaveOut(e),this.cleanUpPointer(e)},cleanUpPointer:function(e){j.delete(e.pointerId),this.removePrimaryPointer(e)},dedupSynthMouse:function(e){var t=D.lastTouches,n=e.changedTouches[0];if(this.isPrimaryTouch(n)){var r={x:n.clientX,y:n.clientY};t.push(r);var i=function(e,t){var n=e.indexOf(t);n>-1&&e.splice(n,1)}.bind(null,t,r);setTimeout(i,F)}}};R=new b(U.elementAdded,U.elementRemoved,U.elementChanged,U);var z=l.pointermap,W=window.MSPointerEvent&&typeof window.MSPointerEvent.MSPOINTER_TYPE_MOUSE=="number",X={events:["MSPointerDown","MSPointerMove","MSPointerUp","MSPointerOut","MSPointerOver","MSPointerCancel","MSGotPointerCapture","MSLostPointerCapture"],register:function(e){l.listen(e,this.events)},unregister:function(e){l.unlisten(e,this.events)},POINTER_TYPES:["","unavailable","touch","pen","mouse"],prepareEvent:function(e){var t=e;return W&&(t=l.cloneEvent(e),t.pointerType=this.POINTER_TYPES[e.pointerType]),t},cleanup:function(e){z.delete(e)},MSPointerDown:function(e){z.set(e.pointerId,e);var t=this.prepareEvent(e);l.down(t)},MSPointerMove:function(e){var t=this.prepareEvent(e);l.move(t)},MSPointerUp:function(e){var t=this.prepareEvent(e);l.up(t),this.cleanup(e.pointerId)},MSPointerOut:function(e){var t=this.prepareEvent(e);l.leaveOut(t)},MSPointerOver:function(e){var t=this.prepareEvent(e);l.enterOver(t)},MSPointerCancel:function(e){var t=this.prepareEvent(e);l.cancel(t),this.cleanup(e.pointerId)},MSLostPointerCapture:function(e){var t=l.makeEvent("lostpointercapture",e);l.dispatchEvent(t)},MSGotPointerCapture:function(e){var t=l.makeEvent("gotpointercapture",e);l.dispatchEvent(t)}},$=window.navigator,J,K,Q;$.msPointerEnabled?(J=function(e){G(e),Y(this),Z(e)&&(l.setCapture(e,this,!0),this.msSetPointerCapture(e))},K=function(e){G(e),l.releaseCapture(e,!0),this.msReleasePointerCapture(e)}):(J=function(t){G(t),Y(this),Z(t)&&l.setCapture(t,this)},K=function(t){G(t),l.releaseCapture(t)}),Q=function(t){return!!l.captureInfo[t]},k(),V(),et();var tt={dispatcher:l,Installer:b,PointerEvent:n,PointerMap:i,targetFinding:c};return tt}),define("pep",["pep/pep"],function(e){return e}),define("gala/src/touch-action",["require","./events"],function(e){var t=e("./events");return t.setTouchAction=function(e,t,n){if(n&&n.override===!1&&e.getAttribute("touch-action"))return;e.setAttribute("touch-action",t),e.style.setProperty("-ms-touch-action",t),e.style.setProperty("touch-action",t)},t}),define("gala/src/contact-handler",["require","pep","./constants","./events","./handler","./quirks","./touch-action"],function(e){var t=function(e,t,n){var r=s._addDispatcher(arguments);this.element=r.shift(),this.callbacks=r.shift(),this.options=r.shift()||{},this._={},this._.handlers={start:[],move:[],end:[],cancel:[]},this._.pointers=[],this._setAppropriateTouchAction(this.element)},n=t.prototype,r=e("pep"),i=e("./constants"),s=e("./events"),o=e("./handler"),u=e("./quirks"),a=e("./touch-action");return n.listen=function(){return this._listenOnCategory(this.element,"start",["pointerdown"]),this},n.deafen=function(){this._deafenHandlers(this._.handlers.start);while(this._.pointers.length)this._removePointer(this._.pointers[0]);return this},n._setAppropriateTouchAction=function(e){var t=i.DEFAULT_TOUCH_ACTION;while(e&&e.getAttribute){var n=e.getAttribute("touch-action")||(e._scrollableAxis?"pan-"+e._scrollableAxis:null);if(n){t=n;break}e=e.parentNode}s.setTouchAction(this.element,t,{override:!1})},n._listenContinue=function(){var e={move:["pointermove"],end:["pointerup"],cancel:["pointercancel"]},t=this.element;this.options.cancelOnLeave&&(e.cancel.push("pointerleave"),typeof this.options.cancelOnLeave.addEventListener=="function"?t=this.options.cancelOnLeave:t=this.element),this._listenOnCategory(t,"move",e.move),this._listenOnCategory(t,"end",e.end),this._listenOnCategory(t,"cancel",e.cancel),this._.continued=!0},n._deafenContinue=function(){this._deafenHandlers(this._.handlers.move),this._deafenHandlers(this._.handlers.end),this._deafenHandlers(this._.handlers.cancel),this._.continued=!1},n._listenOnCategory=function(e,t,n){if(this._.handlers[t].length)return;var r=this["_"+t].bind(this);while(n.length){var i=n.shift(),o=s.on(e,i,r,this.options.capture);this._.handlers[t].push(o)}},n._start=function(e){if(e.button>0)return;this._addPointer(e),this._invokeCallback("start",e)},n._move=function(e){if(!this._updatePointer(e))return;this._invokeCallback("move",e)},n._end=function(e){if(!this._updatePointer(e))return;this._invokeCallback("end",e),this._removePointer(e)},n._cancel=function(e){if(!this._updatePointer(e))return;this._invokeCallback("cancel",e),this._removePointer(e)},n._deafenHandlers=function(e){while(e.length)e.shift().deafen()},n._invokeCallback=function(e,t){t.contactType=e,t.contactPointers=this._.pointers.slice(0),t.contactScale=this._computeScaleOfPointers(),typeof this.callbacks[e]=="function"&&this.callbacks[e](t)},n._addPointer=function(e){this.options.multitouch||this._.pointers.splice(0),e.contactIndex=this._.pointers.length,this._.pointers.push(e),this._.continued||this._listenContinue(),this.options.cancelOnLeave||this.element.setPointerCapture(e.pointerId),delete this._.initialPointerDistance},n._updatePointer=function(e){for(var t=0,n=this._.pointers.length;t<n;++t){var r=this._.pointers[t];if(r.pointerId==e.pointerId)return this._.pointers[t]=e,e.contactIndex=r.contactIndex,!0}return!1},n._removePointer=function(e){try{this.element.releasePointerCapture(e.pointerId)}catch(t){}var n=[];for(var r=0,i=this._.pointers.length;r<i;++r){var s=this._.pointers[r];s.pointerId!=e.pointerId&&n.push(s)}this._.pointers=n,this._.continued&&!this._.pointers.length&&this._deafenContinue()},n._computeScaleOfPointers=function(){if(this._.pointers.length!=2)return 1;var e=function(e){var t=e[1].pageX-e[0].pageX,n=e[1].pageY-e[0].pageY;return Math.sqrt(t*t+n*n)},t=e(this._.pointers),n=this._.initialPointerDistance||t;return this._.initialPointerDistance=n,t/n},t}),define("gala/src/scroll-manager",["require","./events","./quirks","./touch-action"],function(e){var t={},n=e("./events"),r=e("./quirks"),i=e("./touch-action");return t.scrollable=function(e,i){i=i||"y";if(e._scrollableAxis==i)return;e._scrollableAxis=i,e.classList.add("native-scrollable"),e.classList.add("native-scrollable-"+i),n.setTouchAction(e,"pan-"+i),r("legacy-ontap")&&n.on(e,"scroll",function(){t.lastScrollTimestamp=(new Date).getTime()})},t}),define("gala/src/ontap",["require","./events","./constants","./quirks","./contact-handler"],function(e){var t=e("./events"),n=e("./constants"),r=e("./quirks"),i=e("./contact-handler");return t.onTap=function(e,s,o){o=o||{},typeof o.tapClass=="undefined"&&(o.tapClass=n.TAPPABLE_CLASS),o.tapClass&&e.classList.add(o.tapClass),typeof o.ariaRole=="undefined"&&(o.ariaRole="button"),o.ariaRole&&e.setAttribute("role",o.ariaRole),typeof o.propagate=="undefined"&&(o.propagate=!0);var u=function(t){t.tappedElement=e,s(t)},a={};if(!o.propagate||r("active-pseudoclass-needs-touchstart")){var f=function(e){if(o.propagate)return;typeof e.stopPropagation=="function"&&e.stopPropagation()},l=new i(e,{start:f});a.listen=function(){l.listen(),t.listen(e,"click",u)},a.deafen=function(){l.deafen(),t.deafen(e,"click",u)}}else a.listen=function(){t.listen(e,"click",u)},a.deafen=function(){t.deafen(e,"click",u)};return a.listen(),a},t}),define("gala/src/legacy-ontap",["require","./events","./quirks","./constants","./contact-handler","./scroll-manager"],function(e){var t=e("./events"),n=e("./quirks"),r=e("./constants"),i=e("./contact-handler"),s=e("./scroll-manager");if(!n("legacy-ontap"))return t;r.TAP_MAX_CONTACT_DISTANCE=10;var o=null,u={};return u.isTapValid=function(e){if(!o)return!1;if(s.lastScrollTimestamp){var n=o.time-s.lastScrollTimestamp,i=(new Date).getTime()-o.time;if(n<i)return console.log("Ignoring tap due to recent scroll.\nsinceScrollMS: %s is less than tapLengthMS: %s",n,i),t.__LAST_SCROLL=0,!1}if(u.getScrollSignature(o.elem)!=o.scrollSig)return console.log("Ignoring tap because scroll signature differs"),!1;var a=Math.abs(e.pageX-o.coords.x),f=Math.abs(e.pageY-o.coords.y),l=Math.max(a,f);return r.TAP_MAX_CONTACT_DISTANCE<l?(console.log("Ignoring tap because pointer moved too much"),!1):!0},u.handleTap=function(e,t,n){if(!o||o.time!=t)return;var r=u.isTapValid(e);u.cancelTap(),r&&n(e)},u.cancelTap=function(){if(!o)return;o.endTimer&&clearTimeout(o.endTimer),o=null},u.throttleInvocation=function(e,t){var n=0;return function(){var r=new Date,i=t-(r-n);i<=0&&(n=r,e.apply(this,arguments))}},u.getScrollSignature=function(e){var t=0;while(e&&e.style)t+=e.scrollTop+e.scrollLeft,e=e.parentNode;return t},t.onTap=function(e,n,i){n=u.throttleInvocation(n,100),i=i||{},typeof i.tapClass=="undefined"&&(i.tapClass=r.TAPPABLE_CLASS),i.tapClass&&e.classList.add(i.tapClass),i.ariaRole!==null&&e.setAttribute("role",i.ariaRole||"link"),typeof i.propagate=="undefined"&&(i.propagate=!0);var s={start:function(t){i.propagate||t.stopPropagation(),o&&o.elem!=e&&u.cancelTap(),o={elem:e,time:(new Date).getTime(),scrollSig:u.getScrollSignature(e),coords:{x:t.pageX,y:t.pageY},options:i}},move:function(t){if(o&&o.elem!=e)return;u.isTapValid(t)||u.cancelTap()},end:function(r){i.propagate||r.stopPropagation();if(o&&o.elem!=e)return;t.stop(r);if(!u.isTapValid(r))return u.cancelTap();r.tappedElement=r.currentTarget||r.srcElement;var s=u.handleTap.bind(u,r,o.time,n);if(!i.propagate)s();else{var a=r.pointerType=="mouse"?0:50;o.endTimer=setTimeout(s,a)}},cancel:function(t){if(o&&o.elem!=e)return;u.cancelTap()}};return t.onContact(e,s,{cancelOnLeave:!0})},t}),define("gala/src/sugar",["require","./events","./handler","./contact-handler","./scroll-manager"],function(e){function s(e,t){if(e&&typeof e[t]=="function")e[t]();else if(Array.isArray(e))for(var n=0,r=e.length;n<r;++n)e[n][t]();else if(e){var i=Object.getOwnPropertyNames(e);for(var n=0,r=i.length;n<r;++n)e[i[n]][t]()}return e}var t=e("./events"),n=e("./handler"),r=e("./contact-handler"),i=e("./scroll-manager");return t.on=function(e,r,i,o){if(arguments.length<=1)return s(arguments[0],"listen");var u=t._addDispatcher(arguments);return(new n(u[0],u[1],u[2],u[3])).listen()},t.off=function(e){s(e,"deafen")},t.onContact=function(e,t,n){return(new r(e,t,n)).listen()},t.scrollable=function(){i.scrollable.apply(i,arguments)},t}),define("gala/gala",["require","./src/events","./src/constants","./src/handler","./src/contact-handler","./src/scroll-manager","./src/ontap","./src/legacy-ontap","./src/sugar"],function(e){var t=e("./src/events");return t.Constants=e("./src/constants"),t.Handler=e("./src/handler"),t.ContactHandler=e("./src/contact-handler"),t.ScrollManager=e("./src/scroll-manager"),e("./src/ontap"),e("./src/legacy-ontap"),e("./src/sugar"),t}),define("gala",["gala/gala"],function(e){return e}),define("core/src/bif",["require","common","text!bifocal/VERSION","gala","./network"],function(e){var t=e("common"),n=function(){window.BIF={},BIF.version=e("text!bifocal/VERSION").trim(),BIF.events=e("gala"),BIF.map=window.bData||{},BIF.state=r(BIF.map),BIF.elements={},BIF.objects={},BIF.root=document.documentElement,BIF.tData={},t.each(window.tData,function(e,n){BIF.tData[t.dasherize(e)]=n}),BIF.listen=BIF.events.listen,BIF.deafen=BIF.events.deafen,BIF.dispatch=BIF.events.dispatch,BIF.network=e("./network"),BIF.network.init()},r=function(e){var t={};e["-odread-dev"]&&(t.development=e["-odread-dev"],delete e["-odread-dev"]);var n=e["-odread-msg-access"];return typeof n=="undefined"&&(n="f"),t.accessPercent={s:.1,f:1}[n]||Math.max(0,Math.min(n,1)),t.clipboardable=e["-odread-msg-clip"],t.buid=e["-odread-buid"],t};return n}),define("core/src/ignition",["require","./bif"],function(e){var t={};return t.prepare=function(){if(typeof window.BIF=="undefined"){var t=e("./bif");t()}},t.go=function(e){BIF||t.prepare();if(t.replaceURL())return;t.initializer=e,t.register(),t.reveal()},t.register=function(){t.initializer.runSheet.each(function(e,n){var r=t.initializer[n];typeof r=="function"?BIF.listen(e,r):console.warn('Error in RunSheet: ["%s","%s"]',e,n)})},t.reveal=function(){BIF.dispatch("bifocal:intercept",{},!0)?BIF.dispatch("bifocal:reveal"):(BIF.deafen("bifocal:intercept:continue",t.reveal),BIF.listen("bifocal:intercept:continue",t.reveal))},t.replaceURL=function(){if(!window.uData)return;if(location.pathname!="/")return;if(window.uData==location.pathname+location.search)return;if(typeof history.replaceState!="function"||!!window.externalHost){console.warn("Forcing redirect because replaceState unsupported.");try{location.replace(window.uData)}catch(e){location.href=window.uData}return!0}history.replaceState({},"",window.uData)},t.RunSheet=function(){function r(e){for(var t=0,r=n.length;t<r;++t)if(n[t][1]==e)return t}var e={constructor:t.RunSheet},n=Array.prototype.slice.call(arguments);return e.swapMethod=function(e,t){var i=r(e);i>=0&&(n[i][1]=t)},e.removeMethods=function(){var e=Array.prototype.slice.call(arguments);while(e.length>0){var t=r(e.shift());t>=0&&n.splice(t,1)}},e.prepend=function(){n.unshift.apply(n,arguments)},e.append=function(){n.push.apply(n,arguments)},e.insertBefore=function(){var e=Array.prototype.slice.call(arguments),t=r(e.shift());e.unshift(t,0),n.splice.apply(n,e)},e.insertAfter=function(){var e=Array.prototype.slice.call(arguments),t=r(e.shift());e.unshift(t+1,0),n.splice.apply(n,e)},e.each=function(e){for(var t=0,r=n.length;t<r;++t)e(n[t][0],n[t][1])},e},t}),define("core/src/theme",["require","common","./ignition"],function(e){var t=e("common"),n=e("./ignition"),r=t.Class.new(),i=r.prototype;return i.$init=function(){n.prepare(),this._.features=[],this._.results=[],this.runSheet=new n.RunSheet},i.addFeature=function(e,t){if(this._.ignited){var n=this._.features.indexOf(e);return n<0&&(n=this._.features.length,this._.features.push(e)),this._.results[n]?this._.results[n].feature:(this._.results[n]={feature:e(this)},this._.results[n].feature)}this._.features[t?"unshift":"push"](e)},i.removeFeature=function(e){return t.excise(this._.features,e)?!0:!1},i.lightFuse=function(){this._.ignited=!0,t.each(this._.features,this.addFeature,this),n.go(this)},r}),define("core/core",["require","shims","./src/quirks","./src/network","./src/keys","./src/locator","./src/ignition","./src/theme"],function(e){return e("shims"),e("./src/quirks"),{Network:e("./src/network"),Keys:e("./src/keys"),Locator:e("./src/locator"),Ignition:e("./src/ignition"),Theme:e("./src/theme")}}),define("core",["core/core"],function(e){return e}),define("bifocal/themes/read/default/src/parts/quirks",["require","core/src/quirks"],function(e){var t=e("core/src/quirks");return t.add("slow","eink","android-stock","blackberry","nintendo"),t.add("isolated-contact-events","gecko"),t.add("plain-fonts-only","android","kindle3"),t.add("scroll-out-chrome","ios safari"),t.add("glaze-inaccurate-during-translation","ios"),t.add("cannot-disable-native-selection","android-stock android<4"),t.add("zoom-unavailable","android-stock"),t.add("zoom-does-not-resample","ios>=7.1","safari !ios"),t.add("zoom-resamples-after-hide","chrome !ios"),t.add("useless-3d-transforms","android<4","iexplore<12"),t.add("element-from-point-fails-when-obscured","iexplore","edge"),t.add("supply-message-in-referrer","embedded !nautilus"),t.add("measured-mode-available","!mobile !nautilus"),t}),define("text!bifocal/themes/read/default/resources/icons/icon-menu.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='none' stroke-width='1' fill='#000000' fill-rule='evenodd' class='icon-solid'>\n    <rect x='12' y='51' width='41' height='3' />\n    <rect x='12' y='31' width='41' height='3' />\n    <rect x='12' y='11' width='41' height='3' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/icon-back-arrow.text.svg",[],function(){return"<svg viewBox='0 0 32 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='#000000' stroke-width='4' fill='none' fill-rule='evenodd' class='icon-hollow'>\n    <path d='M43.627417,47.627417 L11.627417,47.627417 L11.627417,15.627417 L11.627417,15.627417' transform='translate(27.627417, 31.627417) rotate(-315.000000) translate(-27.627417, -31.627417) ' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/pnl-search.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='#000000' stroke-width='3' fill='none' fill-rule='evenodd' class='icon-hollow'>\n    <path d='M39.875,39.8571429 L52.125,50.1428571' stroke-linecap='round' />\n    <path d='M27.5,44 C35.5081289,44 42,37.5081289 42,29.5 C42,21.4918711 35.5081289,15 27.5,15 C19.4918711,15 13,21.4918711 13,29.5 C13,37.5081289 19.4918711,44 27.5,44 Z' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/icon-search-reset.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='none' stroke-width='1' fill='#000000' fill-rule='evenodd' class='icon-solid'>\n    <path d='M36.406124,31.2731898 L31.4075994,26.2746652 C30.7035437,25.5706095 29.5656955,25.5713889 28.8634114,26.2736731 L28.2353526,26.9017318 C27.5307115,27.606373 27.5335127,28.7430877 28.2363447,29.4459198 L33.2348694,34.4444444 L28.2363447,39.4429691 C27.5335127,40.1458012 27.5307115,41.2825159 28.2353526,41.9871571 L28.8634114,42.6152158 C29.5656955,43.3175 30.7035437,43.3182794 31.4075994,42.6142237 L36.406124,37.6156991 L41.4046487,42.6142237 C42.1087043,43.3182794 43.2465525,43.3175 43.9488367,42.6152158 L44.5768954,41.9871571 C45.2815366,41.2825159 45.2787354,40.1458012 44.5759033,39.4429691 L39.5773787,34.4444444 L44.5759033,29.4459198 C45.2787354,28.7430877 45.2815366,27.606373 44.5768954,26.9017318 L43.9488367,26.2736731 C43.2465525,25.5713889 42.1087043,25.5706095 41.4046487,26.2746652 L36.406124,31.2731898 Z M7,34 C7,31.2330428 16.8028179,18.7957258 16.8028179,18.7957258 C17.9907211,17.2516891 20.5400703,16 22.4818129,16 L53.4718941,16 C55.4204132,16 57,17.5816555 57,19.5338445 L57,48.4661555 C57,50.4178439 55.4136366,52 53.4718941,52 L22.4818129,52 C20.5332938,52 17.9856105,50.7507542 16.8028179,49.2026108 C16.8028179,49.2026108 7,36.7565706 7,34 Z' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/icon-lock.text.svg",[],function(){return"<svg viewBox='0 0 64 63' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='none' stroke-width='1' fill='#000000' fill-rule='evenodd' class='icon-solid'>\n    <rect x='14' y='31' width='35' height='24' rx='3' />\n    <path d='M24,21.9960474 L24,21.9960474 L24,33.0039526 C24,36.3138307 26.6866883,39 29.9998299,39 L33.0001701,39 C36.3176108,39 39,36.3175462 39,33.0039526 L39,21.9960474 C39,18.6861693 36.3133117,16 33.0001701,16 L29.9998299,16 C26.6823892,16 24,18.6824538 24,21.9960474 L24,21.9960474 Z M29.9998299,10 L33.0001701,10 C39.6274932,10 45,15.3729336 45,21.9960474 L45,33.0039526 C45,39.6291866 39.6333872,45 33.0001701,45 L29.9998299,45 C23.3725068,45 18,39.6270664 18,33.0039526 L18,21.9960474 C18,15.3708134 23.3666128,10 29.9998299,10 Z' />\n  </g>\n</svg>\n"}),define("bifocal/themes/read/default/src/parts/iconator",["require","common","text!../../resources/icons/icon-menu.text.svg","text!../../resources/icons/icon-back-arrow.text.svg","text!../../resources/icons/pnl-search.text.svg","text!../../resources/icons/icon-search-reset.text.svg","text!../../resources/icons/icon-lock.text.svg"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.ICONS={menu:e("text!../../resources/icons/icon-menu.text.svg"),"back-arrow":e("text!../../resources/icons/icon-back-arrow.text.svg"),search:e("text!../../resources/icons/pnl-search.text.svg"),"search-reset":e("text!../../resources/icons/icon-search-reset.text.svg"),lock:e("text!../../resources/icons/icon-lock.text.svg")},r.register=function(e,t){this.ICONS[e]=t},r.make=function(e,n,r){var i=t.element({html:this.ICONS[e]}),s=i.querySelector("svg");return s.parentNode.removeChild(s),n&&n.appendChild(s),s.setAttribute("class",((r||"")+" svg-icon").trim()),s},n}),define("core/src/bank/bank-scope-memory",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.COMMIT_DELAY_MS=0,r.$init=function(e,t){this._.name=e,this._.flush={keys:[],timer:null},this._.data=t||this._read()},r.get=function(e){return this._.data[e]},r.set=function(e,t){this._.data[e]=t,this._write(e)},r.load=function(e,t){var n=this.get(e);if(n){var r=new t;return r.deserialize(n),r}},r.dump=function(e,t){this.set(e,t.serialize())},r.flush=function(){this._commit(),this._.flush.keys=[],this._.flush.timer=null},r._read=function(){return{}},r._commit=function(){},r._write=function(e){this._.flush.keys.indexOf(e)<0&&this._.flush.keys.push(e),this._.flush.timer=this._.flush.timer||setTimeout(this.flush.bind(this),this.COMMIT_DELAY_MS)},r._eachFlushKey=function(e){t.each(this._.flush.keys,e,this)},n}),function(e){var t=function(e,n,r){return arguments.length===1?t.get(e):t.set(e,n,r)};t._document=document,t._navigator=navigator,t.defaults={path:"/"},t.get=function(e){return t._cachedDocumentCookie!==t._document.cookie&&t._renewCache(),t._cache[e]},t.set=function(n,r,i){return i=t._getExtendedOptions(i),i.expires=t._getExpiresDate(r===e?-1:i.expires),t._document.cookie=t._generateCookieString(n,r,i),t},t.expire=function(n,r){return t.set(n,e,r)},t._getExtendedOptions=function(n){return{path:n&&n.path||t.defaults.path,domain:n&&n.domain||t.defaults.domain,expires:n&&n.expires||t.defaults.expires,secure:n&&n.secure!==e?n.secure:t.defaults.secure}},t._isValidDate=function(e){return Object.prototype.toString.call(e)==="[object Date]"&&!isNaN(e.getTime())},t._getExpiresDate=function(e,n){n=n||new Date;switch(typeof e){case"number":e=new Date(n.getTime()+e*1e3);break;case"string":e=new Date(e)}if(e&&!t._isValidDate(e))throw new Error("`expires` parameter cannot be converted to a valid Date instance");return e},t._generateCookieString=function(e,t,n){e=encodeURIComponent(e),t=(t+"").replace(/[^!#$&-+\--:<-\[\]-~]/g,encodeURIComponent),n=n||{};var r=e+"="+t;return r+=n.path?";path="+n.path:"",r+=n.domain?";domain="+n.domain:"",r+=n.expires?";expires="+n.expires.toUTCString():"",r+=n.secure?";secure":"",r},t._getCookieObjectFromString=function(n){var r={},i=n?n.split("; "):[];for(var s=0;s<i.length;s++){var o=t._getKeyValuePairFromCookieString(i[s]);r[o.key]===e&&(r[o.key]=o.value)}return r},t._getKeyValuePairFromCookieString=function(e){var t=e.indexOf("=");return t=t<0?e.length:t,{key:decodeURIComponent(e.substr(0,t)),value:decodeURIComponent(e.substr(t+1))}},t._renewCache=function(){t._cache=t._getCookieObjectFromString(t._document.cookie),t._cachedDocumentCookie=t._document.cookie},t._areEnabled=function(){var e="cookies.js",n=t.set(e,1).get(e)==="1";return t.expire(e),n},t.enabled=t._areEnabled(),typeof define=="function"&&define.amd?define("cookies/cookies",[],function(){return t}):typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=t),exports.Cookies=t):window.Cookies=t}(),define("cookies",["cookies/cookies"],function(e){return e}),define("core/src/bank/bank-scope-cookie",["require","./bank-scope-memory","cookies"],function(e){var t=e("./bank-scope-memory"),n=e("cookies"),r=t.new(),i=r.prototype;return i._read=function(){var e={},t=new RegExp("^"+this._.name+":(.+)$");return this._eachRawPair(function(n,r){var i=n.match(t);if(i){var s=i[1];e[s]=JSON.parse(r)}}),e},i._commit=function(){this._eachFlushKey(function(e){var t=this.get(e),r=this._.name+":"+e,i={domain:this._cookieDomain()};if(t===null||typeof t=="undefined")n.expire(r,i);else{i.expires=this._cookieExpires();try{n.set(r,JSON.stringify(t),i)}catch(s){console.warn("[BANK] error stringifying value:",s,r,t)}}})},i._eachRawPair=function(e){var t=document.cookie.split(/; */);for(var r=0,i=t.length;r<i;++r){var s=t[r].split("="),o=decodeURIComponent(s[0]);e(o,n.get(o))}},i._cookieDomain=function(){return location.host.split(".").slice(1).join(".")},i._cookieExpires=function(){return 31536e3},r}),define("core/src/bank/bank-scope-domain",["require","./bank-scope-memory"],function(e){var t=e("./bank-scope-memory"),n=t.new(),r=n.prototype;return r._read=function(){var e={};if(typeof window.localStorage=="undefined")return console.warn("[BANK] localStorage disabled. No persistence for session."),e;var t=new RegExp("^"+this._.name+":(.+)$");return this._eachRawPair(function(n,r){var i=n.match(t);if(i){var s=i[1];e[s]=JSON.parse(r)}}),e},r._commit=function(){if(typeof window.localStorage=="undefined")return;this._eachFlushKey(function(e){var t=this.get(e),n=this._.name+":"+e;if(t===null||typeof t=="undefined")localStorage.removeItem(n);else try{localStorage.setItem(n,JSON.stringify(t))}catch(r){console.warn("[BANK] error stringifying value:",r,n,t)}})},r._eachRawPair=function(e){var t=[];for(var n=0,r=localStorage.length;n<r;++n){var i=localStorage.key(n);typeof i=="string"&&t.push(i)}for(var n=0,r=t.length;n<r;++n)e(t[n],localStorage.getItem(t[n]))},n}),define("bifocal/themes/read/default/src/parts/bank_migrator",["require","common","cookies"],function(e){var t=e("common"),n=e("cookies"),r=t.Class.new(),i=r.prototype;return i.migrate=function(){var e=BIF.bank.title.get("_bank-version");e||(e=this._migrateB1()),BIF.bank.title.set("_bank-version",e)},i._migrateB1=function(){return typeof BIF.bank.global._eachRawPair=="function"&&BIF.bank.global._eachRawPair(function(e,t){if(e=="bp")BIF.bank.title.set("position",JSON.parse(t));else if(e=="rdby")BIF.bank.global.set("rdby",t);else if(e=="pg-spread")BIF.bank.global.set("mode:spread",t);else if(e=="aud-compat")BIF.bank.global.set("audio:incompatible",t);else if(e!="ttrl")return;n.expire(e),n.expire(e,{domain:BIF.bank.global._cookieDomain()})}),typeof BIF.bank.title._eachRawPair=="function"&&BIF.bank.title._eachRawPair(function(e,t){var t=JSON.parse(localStorage.getItem(e));if(e=="audio.vol")BIF.bank.global.set("narration:vol",t);else if(e=="audio.pbr")BIF.bank.global.set("narration:pbr",t);else if(e=="marks")BIF.bank.title.set("marks:list",t);else if(e=="dubs")BIF.bank.title.set("lens:dubs",t);else if(e=="sch-recent")BIF.bank.title.set("search:recent",t);else if(e=="scoreboard")BIF.bank.title.set("scoreboard",t);else{if(e!="acts")return;BIF.bank.title.set("activity:queue",t)}localStorage.removeItem(e)}),"B1"},r}),define("bifocal/themes/read/default/src/parts/codex",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.COVER_RATIO_MIN=.65,r.COVER_RATIO_MAX=1.35,r.COVER_RATIO_DEFAULT=.72,r.DEFAULT_COLOR_UNITS=[72,72,72],r.title=function(){if(this._.title)return this._.title;var e=BIF.map.title.main,t=BIF.map.title.subtitle;return t&&(e=[e,t].join(": ")),this._.title=e},r.byline=function(){if(this._.byline)return this._.byline;var e=[];return t.each(BIF.map.creator,function(t){e.push(t.name)}),this._.byline=e.join(", ")},r.description=function(){if(this._.description)return this._.description;var e=BIF.map.description;return this._.description=e?e.full||e["short"]:""},r.coverColor=function(){return this._.coverColor?this._.coverColor:(BIF.map.cover&&BIF.map.cover.front&&BIF.map.cover.front["-odread-color"]&&(this._.coverColor=BIF.map.cover.front["-odread-color"]),this._.coverColor=this._.coverColor||this.DEFAULT_COLOR_UNITS)},r.coverRatio=function(){if(this._.coverRatio)return this._.coverRatio;var e,t=BIF.map.cover.front;return t&&(e=parseFloat(t["-odread-aspect-ratio"])),e=Math.max(this.COVER_RATIO_MIN,Math.min(e||this.COVER_RATIO_DEFAULT,this.COVER_RATIO_MAX)),this._.coverRatio=e},r.coverPath=function(e){if(this._.coverURL)return this._.coverURL;var t=BIF.map["-odread-furbish-uri"];return t.match(/\?$/)||(t=t+"/"+e+".jpg"),this._.coverURL=t},r.fullyPrepaginated=function(){if(typeof this._.fullyPP=="boolean")return this._.fullyPP;for(var e=0,t=BIF.map.spine.length;e<t;++e)if(BIF.map["spine"][e]["rendition-layout"]!="pre-paginated")return this._.fullyPP=!1;return this._.fullyPP=!0},r.fullyReflowable=function(){if(this._.fullyRF=="boolean")return this._.fullyRF;for(var e=0,t=BIF.map.spine.length;e<t;++e)if(BIF.map["spine"][e]["rendition-layout"]=="pre-paginated")return this._.fullyRF=!1;return this._.fullyRF=!0},r.spreadability=function(){if(typeof this._.spreadType=="number")return this._.spreadType;var e=0,t,n=!0,r=BIF.map.spine.length-1;for(var i=0,s=r;i<s;++i){var o=BIF.map.spine[i];t=0;if(o["rendition-orientation"]=="portrait"||o["rendition-spread"]=="none"||o["rendition-spread"]=="portrait")t=1;else if(o["rendition-orientation"]=="landscape"||o["rendition-spread"]=="both"||o["rendition-spread"]=="landscape")t=2;if(e&&t&&e!=t)return this._.spreadType=0;e=t,n=n&&o["rendition-position"]=="center"}return this._.spreadType=e||(n?1:0)},n}),define("dervish/src/urls",["require","core/src/quirks"],function(e){var t=e("core/src/quirks"),n={};return n.toSrcCORS=function(e,n){if(t("cors-requires-manual-redirect")){e+=(e.match(/\?/)?"&":"?")+"manual_redirect=1";var r=new XMLHttpRequest;return r.addEventListener("load",function(e){n(r.responseText)}),r.addEventListener("error",function(t){console.warn("Error fetching manual redirect:",e,t)}),r.open("GET",e,!0),r.send()}return n(e)},n.toSrcMedia=function(e,n){if(t("cors-rules-apply-to-media-src-attributes")){var r=BIF.map["-odread-msg-m"];r&&(e+=(e.match(/\?/)?"&":"?")+"message="+r,e=(e.match(/^\//)?"":"/")+e,e=location.origin.replace(/(\w+\-\w+)\./,"$1-cors.")+e)}return n(e)},n.uilink=function(e,t){var n=window.bData["-odread-uilinks"]||[];return n[e]||t||""},n}),define("bifocal/themes/read/default/src/parts/brand",["require","common","dervish/src/urls"],function(e){var t=e("common"),n=e("dervish/src/urls"),r=t.Class.new(),i=r.prototype;return i.$init=function(){this._customize.apply(this,arguments)},i.install=function(){t.DataClass.set(BIF.root,"brand",this.tag)},i.get=function(e){return this[e]},i.html=function(e,t){e.innerHTML=this[t]},i._customize=function(){},i._uilink=function(e,t,r){var i=n.uilink(e);return i&&!t?i:i?t.replace(/\{UILINK\}/g,i):r||""},r}),define("text!bifocal/themes/read/default/resources/od-logo.text.svg",[],function(){return'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 518 135" width="130" height="34">\r\n  <g id="OverDrive" fill="#006595">\r\n    <!-- O -->\r\n    <path d="M84.3,34.2c21,0,35.6,14.1,31.5,32.6C111.9,84.6,91.3,99,70,99c-21.3,0-35.5-14.4-31.6-32.2 C42.4,48.4,63.2,34.2,84.3,34.2z M72.4,88.3c14.1,0,27.2-10,29.7-21.5c2.6-12-6.3-21.7-20.2-21.7C68,45,54.7,54.8,52.1,66.7 C49.6,78.2,58.2,88.3,72.4,88.3z" />\r\n    <!-- v -->\r\n    <path d="M118.9,51.1h14.4l6.6,31h0.3l19.4-31h14.6l-32.8,46.7H131L118.9,51.1z" />\r\n    <!-- e -->\r\n    <path d="M177.4,79.4c-0.1,3,3.7,9.6,13.2,9.6c5.9,0,10.8-2.1,14.1-6h14c-5.1,8.4-17.3,16.2-30.4,16.2 c-16.9,0-26.9-11.1-23.9-24.7c2.9-13.2,17.1-25.1,34.7-25.1c18.2,0,25.9,12.5,23.3,24.3c-0.5,2.2-1.3,4.1-2,5.6H177.4z M209.7,70.4 c0.2-7.5-5.5-10.7-12.6-10.7c-5.4,0-13.6,2-18.1,10.7H209.7z" />\r\n    <!-- r -->\r\n    <path d="M231.9,51.1h12.2l-0.9,4.1h0.2c3.2-3,6.3-5.7,13.2-5.7h1.1l-2.4,10.9c-12.2,0.4-14,8.4-14.6,11.2l-5.8,26.3 h-13.3L231.9,51.1z" />\r\n    <!-- d -->\r\n    <path d="M264.3,35.5h16.8c18.2,0,25.2,4.1,28.8,7.2c5.9,5,9,14.3,6.9,24.1c-2.5,11.2-11.7,22-23.6,26.9 c-7.5,3.2-17.2,4-25.5,4h-17.1L264.3,35.5z M266.7,87h2.9c7.4,0,12.3-0.4,18.7-3c8-3.4,13.4-10.5,14.9-17.2 c1.3-6.1-0.5-11.8-4.5-15.3c-4.7-4.4-11.8-5.2-20.4-5.2h-2.6L266.7,87z" />\r\n    <!-- r -->\r\n    <path d="M323.9,51.1h12.2l-0.9,4.1h0.2c3.2-3,6.3-5.7,13.2-5.7h1.1l-2.4,10.9c-12.2,0.4-14,8.4-14.6,11.2l-5.8,26.3 h-13.3L323.9,51.1z" />\r\n    <!-- i -->\r\n    <path d="M352.9,51.1h13.3l-10.3,46.7h-13.3L352.9,51.1z M356.3,35.5h13.3l-2.3,10.3h-13.3L356.3,35.5z" />\r\n    <!-- v -->\r\n    <path d="M368.9,51.1h14.4l6.6,31h0.3l19.4-31h14.6l-32.8,46.7H381L368.9,51.1z" />\r\n    <!-- e -->\r\n    <path d="M428.5,79.4c-0.1,3,3.7,9.6,13.2,9.6c5.9,0,10.8-2.1,14.1-6h14c-5.1,8.4-17.3,16.2-30.4,16.2 c-16.9,0-26.9-11.1-23.9-24.7c2.9-13.2,17.1-25.1,34.7-25.1c18.2,0,25.9,12.5,23.3,24.3c-0.5,2.2-1.3,4.1-2,5.6H428.5z M460.7,70.4 c0.2-7.5-5.5-10.7-12.6-10.7c-5.4,0-13.6,2-18.1,10.7H460.7z" />\r\n    <!-- (R) -->\r\n    <path d="M481.9,49.9c-0.5,2.7-3.1,4.9-5.8,4.9c-2.8,0-4.5-2.2-4-4.9c0.5-2.7,3.1-4.9,5.9-4.9 C480.6,45,482.4,47.3,481.9,49.9z M473.2,49.9c-0.4,2.1,1,3.8,3.1,3.8c2.1,0,4.1-1.7,4.5-3.8c0.4-2.1-0.9-3.8-3.1-3.8 C475.5,46.1,473.6,47.9,473.2,49.9z M477.8,47.2c0.4,0,2,0,1.7,1.5c-0.1,0.6-0.5,1.2-1.3,1.4l0,0c0.7,0.2,0.8,0.7,0.7,1.4 c-0.1,0.9-0.1,1.1-0.1,1.3h-1.2c-0.1-0.2-0.1-0.3,0-1c0.1-0.9,0-1.1-0.8-1.2h-1l-0.4,2.2h-1.1l1-5.6H477.8z M476.1,49.6h1 c0.4,0,1.1,0,1.3-0.9c0-0.6-0.4-0.6-0.8-0.6h-1.1L476.1,49.6z" />\r\n  </g>\r\n</svg>\r\n'}),define("bifocal/themes/read/default/src/parts/brand_overdrive_read",["require","./brand","common","text!../../resources/od-logo.text.svg"],function(e){var t=e("./brand"),n=e("common"),r=t.new(),i=r.prototype;return i.LOGO_SVG=e("text!../../resources/od-logo.text.svg"),i._customize=function(){this.name="OverDrive Read",this.tag="default",this["connect-link"]={},this["connect-link"].icon='<span class="odread-banner">'+i.LOGO_SVG+"</span>",this["panel-title"]="About this reader",this["panel-html"]=['<div class="colophon">',"<h1>OverDrive Read</h1>","<p>","OverDrive Read is an online reader that allows you to","borrow and read books directly in your browser. There is","no download or software required; all you need is a compatible","web browser and an active internet connection.","</p>","<p>","<strong>Need some help?</strong> Check out the",'<em>Tips <span class="amp">&amp;</span> Secrets</em>',"section from the menu, or visit our <a",'href="http://help.overdrive.com/customer/portal/articles/1481574"','target="_blank"',">Getting started</a> page.","</p>","<p>","You can learn more about OverDrive at",'<a href="https://www.overdrive.com" target="_blank">overdrive.com</a>!',"</p>","</div>"].join(" ")},r}),define("bifocal/themes/read/default/src/parts/mode",["require","common","./quirks"],function(e){var t=e("common"),n=e("./quirks"),r=t.Class.new(),i=r.prototype;return i.MEA_AVAILABLE=n("measured-mode-available"),i.MEA_DIMENSIONS={1:{x:800,y:1084},2:{x:1320,y:1052}},i.MEA_MIN_HEIGHT=880,i.SPREAD_BANK_KEY="mode:spread",i.RESIZE_FOLLOWUP_MS=250,i.engage=function(){this._restoreSpread(),BIF.listen(window,"resize",this._onResize.bind(this)),BIF.listen(window,"orientationchange",this._onResize.bind(this)),BIF.listen("bifocal:reader:context",this._onReaderContext.bind(this)),BIF.listen("bifocal:resize:force",this.forceResize.bind(this)),this._listenForVisibilityChanges()},i.spread=function(e){this._.spread=e?2:1,BIF.bank.global.set(this.SPREAD_BANK_KEY,e?2:1),this._applySpreadToContext(),this._announceResize()},i.forceResize=function(){this._chooseMode(),this._ifAreaChanged(this._commenceResize.bind(this))},i._mode=function(e){if(BIF.state.mode!=e){BIF.state.mode=e;var t=BIF.root.classList;t.add(e),t.remove(e=="max"?"mea":"max"),BIF.dispatch("bifocal:mode",e),BIF.dispatch("bifocal:mode:"+e)}},i._chooseMode=function(){var e=this._windowArea(),t=!this.MEA_AVAILABLE||e.width/e.height<=.75||e.height<this.MEA_MIN_HEIGHT;this._mode(t?"max":"mea")},i._onResize=function(e){if(BIF.state.hidden||BIF.state.resizing)return;this.forceResize()},i._commenceResize=function(){this._.lastArea=this._windowArea(),BIF.dispatch("bifocal:mode:resizing",{area:this._.lastArea}),BIF.root.classList.add("resizing"),this._announceResize()},i._announceResize=function(){if(!BIF.state.mode)return;BIF.root.classList.remove("resizing"),this._constrainBookBoundsToSpread(),BIF.dispatch("bifocal:mode:resize",{area:this._.lastArea}),this._.firstSized||(BIF.dispatch("bifocal:sized"),this._.firstSized=!0),clearTimeout(this._.resizeFollowupTimer);var e=this.RESIZE_FOLLOWUP_MS;this._.resizeFollowupTimer=setTimeout(this._onResize.bind(this),e)},i._isKeyboardActive=function(){if(document.activeElement){var e=document.activeElement.tagName.toUpperCase();if(e!="BODY"&&e!="IFRAME")return!0}},i._ifAreaChanged=function(e){if(!this._.lastArea)return e();var t=this._windowArea(),n=this._.lastArea;(t.width!==n.width||t.height!==n.height)&&e()},i._constrainBookBoundsToSpread=function(){var e=BIF.elements.bookSurface,n=BIF.elements.bookPillar,r=BIF.elements.bookBounds,i=this._windowArea();if(BIF.state.mode!="mea"){var s=i.width>i.height?2:1;this._.spread==1&&(s=1),t.DataClass.set(BIF.root,"spread",s);return}var o=e.offsetWidth,u=e.offsetHeight-72,a=this.MEA_DIMENSIONS[this._.spread],f=Math.min(a.x,o),l=Math.min(a.y,u);this._.spread==1&&l<=f?f=l-2:this._.spread==2&&f<=l&&(l=f-2),n.style.setProperty("max-width",f+"px"),r.style.setProperty("max-height",l+"px");var s=this._.spread==2&&f>l?2:1;t.DataClass.set(BIF.root,"spread",s)},i._restoreSpread=function(){var e=(BIF.objects.codex.spreadability()||parseFloat(BIF.bank.global.get(this.SPREAD_BANK_KEY)))===1?!1:!0;this.spread(e)},i._applySpreadToContext=function(){if(BIF.context){var e=this._.spread==2?"auto":"none";BIF.context.profile.setSpreadOrientation(e)}},i._onReaderContext=function(){this._applySpreadToContext()},i._windowArea=function(){var e={width:window.innerWidth,height:window.innerHeight};return n.ask("nautilus ios")&&(e.height=document.documentElement.clientHeight),e},i._listenForVisibilityChanges=function(){if(n.ask("nautilus"))BIF.listen("msg:bifocal:view:foreground",function(){BIF.state.hidden=!1,this._afterVisibilityChange()}.bind(this)),BIF.listen("msg:bifocal:view:background",function(){BIF.state.hidden=!0,this._afterVisibilityChange()}.bind(this)),BIF.state.hidden=!1,this._afterVisibilityChange();else{var e,t;typeof document.hidden!="undefined"?(e="hidden",t="visibilitychange"):typeof document.msHidden!="undefined"?(e="msHidden",t="msvisibilitychange"):typeof document.webkitHidden!="undefined"&&(e="webkitHidden",t="webkitvisibilitychange"),this._onVisibilityChange(e),BIF.listen(window,t,this._onVisibilityChange.bind(this,e))}},i._onVisibilityChange=function(e){BIF.state.hidden=document[e],this._afterVisibilityChange()},i._afterVisibilityChange=function(){this._onResize()},r}),define("bifocal/themes/read/default/src/parts/modality",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e,t){this._.modalState=null,this._.defaultModality=e||"reading",this._changeTo(t||this._.defaultModality)},r.be=function(e){var t=this._.modalState;if(t!=e){var n={from:t,to:e};BIF.dispatch("bifocal:modality:transition",n,!0)&&(this._changeTo(e),BIF.dispatch("bifocal:"+t+":close",n),BIF.dispatch("bifocal:"+e+":open",n))}},r.open=r.be,r.close=function(){this.be(this._.defaultModality)},r.closeIf=function(e){if(this.is(e))return this.close(),!0},r.toggle=function(e){this.is(e)?this.close():this.be(e)},r.is=function(e){return this._.modalState===e},r.isNot=function(e){return!this.is(e)},r._changeTo=function(e){this._.modalState=e,t.DataClass.set(BIF.root,"modal",e)},n}),define("bifocal/themes/read/default/src/parts/menu_bar",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this.shortcuts={},this._.parts=this._layout(e),this.addShortcut("menu",this._onMenuButtonTap.bind(this))},r.adjustToLighting=function(e){this._.parts.box.classList[e?"add":"remove"]("lighting-adjustable")},r.addShortcut=function(e,n){this.shortcuts[e]&&this.removeShortcut(e);var r=this.shortcuts[e]={};return r.node=t.element({parentNode:this._.parts.right,classes:"menu-bar-shortcut menu-bar-shortcut-"+e}),BIF.objects.iconator.make(e,r.node),n&&BIF.events.onTap(r.node,n),r.node},r.removeShortcut=function(e){var t=this.shortcuts[e];t.node.parentNode.removeChild(t.node),this.shortcuts[e]=null},r._layout=function(e){var n={box:e};return n.inner=t.element({parentNode:n.box,classes:"menu-bar-inner"}),n.left=t.element({parentNode:n.inner,classes:"menu-bar-left"}),n.right=t.element({parentNode:n.inner,classes:"menu-bar-right"}),n},r._onMenuButtonTap=function(e){BIF.objects.menuList.level(BIF.objects.menuList.isHidden()?1:0)},n}),define("bifocal/themes/read/default/src/parts/read_header",["require","common","./menu_bar"],function(e){var t=e("common"),n=e("./menu_bar"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this._.parts=this._layout(e),this.menuBar=new n(this._.parts.menuBar),this.menuBar.adjustToLighting(!0)},i._layout=function(e){var n={};return n.box=e,n.menuBar=t.element({parentNode:n.box,classes:"menu-bar"}),n},r}),define("bifocal/themes/read/default/src/parts/stencil",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.SWELL_WIDTH=44,r.SWELL_HEIGHT=r.SWELL_WIDTH,r.$init=function(e){this._.box=e,this._.wards=[],this._.blocks={},this._.discards=[],BIF.listen("lens:component:visible",this._onComponentVisible.bind(this)),BIF.listen("lens:component:invisible",this._onComponentInvisible.bind(this))},r.add=function(e,t,n){this._invalidateBlocks(),this.remove(e);var r=this._createWard(e,t,n);r&&(this._calculateRegions(r),this._scheduleRevealWard(r),this._.wards.push(r))},r.remove=function(e){var n=this._wardFromLabel(e);if(n)return this._invalidateBlocks(),this._cedeMasks(n),t.excise(this._.wards,n),n},r.collide=function(e,t,n){this._generateBlocks();var r=this._.blocks[e],i=this._collidingBlock(r,t,n)||this._collidingBlock(r,t,n,!0);return i?this._blockToResult(i):null},r._createWard=function(e,n,r){var i=t.absorb(r,{});i.component=this._componentIndexForRange(n);if(typeof i.component!="number"){console.warn("[STENCIL] missing ward component:",e,n,r);return}i.label=e,i.range=n,i.priority=i.priority||0;if(i.className||i.title)i.masked=!0,i.padding=i.padding||0;return i.tap&&i.glaze&&console.error("[STENCIL] options must not have both tap & glaze",i),i},r._calculateRegions=function(e){e.regions&&this._cedeMasks(e),e.dubName=BIF.context.spool.dub.name,e.regions=[];var n=BIF.context.ruler,r=BIF.context.spine.byIndex(e.component);t.each(t.getRangeRects(e.range),function(t){var i=n.componentToSpool(r,t.left,t.top),s=n.componentToSpool(r,t.right,t.bottom),o={left:i.x,right:s.x,top:i.y,width:Math.abs(s.x-i.x),height:s.y-i.y};e.regions.push({rect:o})})},r._revealMasks=function(e){t.each(e.regions,function(t){!t.mask&&(e.className||e.title)&&(t.mask=this._createMask(),e.className&&t.mask.className!=e.className&&(t.mask.className=e.className),t.mask.title!=e.title&&(t.mask.title=e.title||""),this._alignMask(t,e.padding))},this)},r._cedeMasks=function(e){t.excise(this._.pendingReveals||[],e),t.each(e.regions,function(e){e.mask&&(this._scheduleDiscardMask(e.mask),delete e.mask)},this)},r._createMask=function(){return this._.discards.shift()||t.element({parentNode:this._.box})},r._alignMask=function(e,t){var n=["display: block","position:absolute","top:"+(e.rect.top-t)+"px","width:"+(e.rect.width+t)+"px","height:"+(e.rect.height+t)+"px"];BIF.context.profile.reverse?n.push("right:"+(e.rect.right-t)+"px"):n.push("left:"+(e.rect.left-t)+"px"),e.mask.style.cssText=n.join(";")},r._scheduleRevealWard=function(e){this._.pendingReveals=this._.pendingReveals||[],t.excise(this._.pendingReveals,e),this._.pendingReveals.push(e),this._scheduleDisplayUpdate()},r._scheduleDiscardMask=function(e){this._.pendingDiscards=this._.pendingDiscards||[],t.excise(this._.pendingDiscards,e),this._.pendingDiscards.push(e),this._scheduleDisplayUpdate()},r._scheduleDisplayUpdate=function(){clearTimeout(this._.updateDisplayTimer),this._.updateDisplayTimer=setTimeout(this._updateDisplay.bind(this),0)},r._updateDisplay=function(){t.each(this._.pendingReveals,this._revealMasks.bind(this)),this._.pendingReveals=[],t.each(this._.pendingDiscards,function(e){this._.discards.push(e),e.style.display="none"},this),this._.pendingDiscards=[]},r._onComponentVisible=function(e){this._updateAllWardsForComponent(e.m.component.index)},r._onComponentInvisible=function(e){this._removeAllWardsForComponent(e.m.component.index)},r._updateAllWardsForComponent=function(e){this._invalidateBlocks();var n=BIF.context.spool.dub.name;t.each(this._.wards,function(t){t.component==e&&t.dubName!=n&&this._calculateRegions(t),this._scheduleRevealWard(t)},this)},r._removeAllWardsForComponent=function(e){this._invalidateBlocks();var n=[];t.each(this._.wards,function(t){t.component===e?this._cedeMasks(t):n.push(t)},this),this._.wards=n},r._invalidateBlocks=function(){this._.blocks={}},r._generateBlocks=function(){if(this._.blocks.glaze&&this._.blocks.tap)return;var e=[],n=[];t.each(this._.wards,function(t){if(t.regions&&(t.glaze||t.tap)){var r=t.glaze?e:n;for(var i=0,s=t.regions.length;i<s;++i)r.push({region:t.regions[i],label:t.label,priority:t.priority})}});var r=function(e,t){return t.priority-e.priority};this._.blocks.glaze=e.sort(r),this._.blocks.tap=n.sort(r)},r._collidingBlock=function(e,t,n,r){for(var i=0,s=e.length;i<s;++i)if(this._pointInRegion(e[i].region,t,n,r))return e[i]},r._pointInRegion=function(e,n,r,i){var s=e.rect;if(i){s=t.absorb(s,{});var o;s.width<this.SWELL_WIDTH&&(o=this.SWELL_WIDTH-s.width,s.left-=o/2,s.width+=o),s.height<this.SWELL_HEIGHT&&(o=this.SWELL_HEIGHT-s.height,s.top-=o/2,s.height+=o)}var u=Math.min(s.left,s.right),a=Math.max(s.left,s.right),f=s.top,l=s.top+s.height;return n>u&&n<a&&r>f&&r<l},r._blockToResult=function(e){var n=this._wardFromLabel(e.label),r=t.absorb(n,{});return r.regions=[e.region],r},r._wardFromLabel=function(e){for(var t=0,n=this._.wards.length;t<n;++t)if(this._.wards[t].label===e)return this._.wards[t]},r._componentIndexForRange=function(e){var t=e.startContainer.ownerDocument,n=BIF.context.ruler.componentForDocument(t);return n?n.index:null},n}),define("dervish/src/manager",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.clientEnv=function(){var e={width:0,height:0},t=BIF.elements.region||BIF.elements.reader;if(t)e.width=t.offsetWidth,e.height=t.offsetHeight;else{var n=document.documentElement;e.width=window.innerWidth||n.clientWidth,e.height=window.innerHeight||Math.min(n.clientHeight,document.body.clientHeight)}var r=0-(new Date).getTimezoneOffset()*60;return{deviceId:BIF.deviceId,timezoneOffset:r,display:e}},n}),define("dervish/src/codec",["require","common"],function(e){function i(e){return atob(e)}function s(e){return atob(o(e))}function o(e){return e.replace(/(.)(.)(.)(.)/g,"$4$2$3$1")}var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(){window.__bif_cfc0=this._decode.bind(this,"cf=c0"),window.__bif_cfc1=this._decode.bind(this,"cf=c1")},r._decode=function(e,t,n){var r={"cf=c0":i,"cf=c1":s}[e],o;try{o=r(n)}catch(u){}o&&o.match(/^\s*<body/i)?this._fill(t,o):this._fail(t)},r._fill=function(e,t){e.document.body.outerHTML=t},r._fail=function(e){var t=e.document.documentElement;t.innerHTML="",t.setAttribute("data-document-status","decoding failure")},n}),define("dervish/src/expiration",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.MAX_TIMEOUT=Math.pow(2,31)-1,r.REDIRECTION_DELAY_MS=2e3,r.EXPIRED_GRACE_DELAY_MS=18e5,r.$init=function(){BIF.state.expires=BIF.map["-odread-msg-expires"],BIF.listen("bifocal:expiration:check",this._onExpirationCheck.bind(this)),this._scheduleExpiration()},r._onExpirationCheck=function(e){BIF.state.expires=this._.expiredBinding?"expired":e.m.expires,(this._.expiredBinding||this._scheduleExpiration()=="expired")&&e.preventDefault()},r._scheduleExpiration=function(){this._.expireTimer&&clearTimeout(this._.expireTimer);if(BIF.state.expires=="expired")return this._expired(),"expired";if(typeof BIF.state.expires!="number"){var e=BIF.state.expires+"";if(!e.match(/[\d\.]+/))return BIF.state.expires="n/a";BIF.state.expires=parseFloat(e)}var n=t.epochSeconds();if(BIF.state.expires<n)return this._expired(),"expired";var r=BIF.state.expires-n+2,i=Math.min(r*1e3,this.MAX_TIMEOUT);return this._.expireTimer=setTimeout(this._scheduleExpiration.bind(this),i),"scheduled"},r._expired=function(){console.log("[EXPIRATION] deferring termination"),clearTimeout(this._.expireTimer),this._.expireTimer=setTimeout(this._terminate.bind(this),this.EXPIRED_GRACE_DELAY_MS),this._.expiredBinding||(this._.expiredBinding=this._expired.bind(this),BIF.listen("bifocal:place",this._.expiredBinding))},r._terminate=function(){BIF.state.expires="expired",BIF.root.classList.add("expired"),this._modalExpirationNotice(),BIF.dispatch("bifocal:expired")},r._modalExpirationNotice=function(){var e={};e.headingText="Expired",e.promptText="This title is no longer available.",e.actions={ok:{onTap:this._onTapExpirationNoticeOK.bind(this)}},e.options={modal:!0},BIF.dispatch("bifocal:notify:dialog",e)},r._onTapExpirationNoticeOK=function(){BIF.dispatch("bifocal:expired:acknowledged",null,!0)&&this._redirectToUncachedLocation()},r._redirectToUncachedLocation=function(){var e=document.location.href;e+=e.indexOf("?")>=0?"&":"?",e+="expired",document.location.href=e},n}),define("dervish/src/synchronization",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.commence=function(e,t,n){this.state=e,this._.callbacks={success:t,failure:n},this._dispatch("commence"),BIF.state.expires=="expired"?this._onFailure("expired"):BIF.state.development?this._onFailure("development: no sync service"):this.request=BIF.network.sendRequest("/_d/possession",{method:"GET",accept:"application/json",unreliable:!0,success:this._onSuccess.bind(this),failure:this._onFailure.bind(this)})},r.cancel=function(){delete this._.callbacks,this.request&&this.request.abort(),this._dispatch("cancel")},r._onSuccess=function(e){var t=this._parseResponseJSON(e);if(!t)return this._onFailure("invalid response");try{var n={expires:t.timestamps.expires};if(!BIF.dispatch("bifocal:expiration:check",n))return this._onFailure("expired")}catch(r){console.warn("[SYNC] Expiration check error:",t,r)}this._.callbacks&&typeof this._.callbacks.success=="function"&&this._.callbacks.success(t,this.state),this._dispatch("complete")},r._onFailure=function(e){this.state.reason=e,this._.callbacks&&typeof this._.callbacks.failure=="function"&&this._.callbacks.failure(e,this.state),this._dispatch("failure")},r._parseResponseJSON=function(e){if(e)try{return JSON.parse(e)}catch(t){console.warn("[SYNC] Cannot parse response JSON:",e,t)}},r._dispatch=function(e){BIF.dispatch("bifocal:synchronization:"+e,t.absorb(this.state,{sync:this}))},n}),define("dervish/src/activity",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.BANK_KEY="activity:queues",r.$init=function(){this._.saveQueuesSoon=t.staggerInvocation(this._saveQueuesNow.bind(this),500,3e3),this._.flushQueuesSoon=t.staggerInvocation(this._flushQueuesNow.bind(this),2e3,5e3),this.queues=BIF.bank.title.get(this.BANK_KEY)||{pending:{}},this._revertSending(),BIF.listen(window,"online",this._flushQueuesNow.bind(this))},r.startTracking=function(){this._.tracking=!0,this._.flushQueuesSoon()},r.record=function(e,n,r){n=t.absorb(n,{}),n.syncstamp=t.epochMilliseconds(),this.queues.announce=this.queues.announce||{},this.queues.announce[e]=n;var i=this.queues.pending[e]||[];r&&i.length&&(n.condensing=i[1]?i[1].condensing+1:1,i=i.slice(0,1)),i.push(n),this.queues.pending[e]=i,this.queues.pending.count=(this.queues.pending.count||0)+1,this._.saveQueuesSoon(),this._.flushQueuesSoon()},r._revertSending=function(){this.queues.sending&&(t.each(this.queues.sending,function(e,t){e=="count"?this.queues.pending.count=this.queues.pending.count+t:this.queues.pending[e]?this.queues.pending[e]=t.concat(this.queues.pending[e]):this.queues.pending[e]=t},this),delete this.queues.sending,this._.saveQueuesSoon())},r._commitSending=function(){this.queues.sending&&(delete this.queues.sending,this._.saveQueuesSoon())},r._saveQueuesNow=function(){t.each(this.queues.announce,function(e,t){BIF.dispatch("dervish:activity:record",{label:e,act:t})}),delete this.queues.announce,BIF.bank.title.set(this.BANK_KEY,this.queues)},r._flushQueuesNow=function(){if(!this._.tracking)return;if(this.queues.sending)return;if(!this.queues.pending.count)return;this.queues.sending=this.queues.pending,this.queues.pending={};var e={environment:BIF.objects.dervish.clientEnv(),activities:t.absorb(this.queues.sending,{})};delete e.activities.count,this._sendActivity(e,this._commitSending.bind(this),this._revertSending.bind(this)),this._.saveQueuesSoon()},r._sendActivity=function(e,t,n){if(BIF.state.development)return t();BIF.network.sendRequest("/_d/activity",{method:"POST",body:JSON.stringify(e),contentType:"application/json",success:t,failure:n})},n}),define("dervish/src/selection",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(){BIF.listen("bifocal:component:modify",this._preventSelectionOnComponent.bind(this)),BIF.listen(document,"dragstart",BIF.events.stop)},r._preventSelectionOnComponent=function(e){e.m.component.stylizeContent("selection_prevention",["html * {","-webkit-touch-callout: none;","-webkit-user-select: none;","-moz-user-select: none;","-ms-user-select: none;","-o-user-select: none;","user-select: none;","}"]),BIF.state.development||BIF.listen(e.m.doc,"contextmenu",BIF.events.stop),BIF.listen(e.m.doc.body,"selectstart",BIF.events.stop),BIF.listen(e.m.doc.body,"dragstart",BIF.events.stop)},n}),define("dervish/dervish",["require","./src/manager","./src/codec","./src/expiration","./src/synchronization","./src/activity","./src/selection","./src/urls"],function(e){var t={Manager:e("./src/manager"),Codec:e("./src/codec"),Expiration:e("./src/expiration"),Synchronization:e("./src/synchronization"),Activity:e("./src/activity"),Selection:e("./src/selection"),URLs:e("./src/urls")};return t}),define("dervish",["dervish/dervish"],function(e){return e}),define("bifocal/themes/read/default/src/parts/possession",["require","common","dervish"],function(e){var t=e("common"),n=e("dervish"),r=t.Class.new(),i=r.prototype;return i.BANK_KEY_PREFIX="possession",i.$init=function(){this.data=this._loadPossessionData(this.BANK_KEY_PREFIX),this._restoreFirstPlace(),this._listenForActivity()},i.sync=function(e){this._.sync&&this._.sync.cancel(),this._.sync=new n.Synchronization,e&&e.onlyCheckExpiry?this._.sync.commence({},function(){},function(){}):this._.sync.commence({possession:this,preSyncPlaceHash:this.data.position},this._onPossessionSync.bind(this),this._onPossessionSyncFailure.bind(this))},i.autoSync=function(e,t){clearTimeout(this._.autoSyncTimer);if(!e)return;this._.autoSyncTimer=setInterval(function(){BIF.dispatch("bifocal:possession:autosync",{},!0)?this.sync(t):console.log("[POSSESSION] auto-sync suppressed")}.bind(this),e)},i._loadPossessionData=function(e){var n={};return n.timestamps=BIF.bank.title.get(e+":timestamps")||{created:t.epochSeconds(),updated:t.epochSeconds(),stamped:0,expires:BIF.map["-odread-msg-expires"]||0},n.statistics=BIF.bank.title.get(e+":statistics")||{accesses:1,positions:0,readingTime:0},n.position=BIF.bank.title.get(e+":position")||null,n.marks=BIF.bank.title.get(e+":marks")||{},n},i._restoreFirstPlace=function(){if(this.data.position){var e=this.data.position.spinePosition,t=this._spinePositionToIndex(e)||0,n=t+this.data.position.percentageOfComponent;BIF.map.firstPlace=n}},i._listenForActivity=function(){this._.bindingsOnFirstPlace=this._onFirstPlace.bind(this),BIF.listen("bifocal:place",this._.bindingsOnFirstPlace)},i._onFirstPlace=function(e){var t={timestamp:Math.round(e.m.place.timestamp/1e3)};BIF.objects.activity.record("access",t),BIF.deafen("bifocal:place",this._.bindingsOnFirstPlace),BIF.listen("bifocal:place",this._onPlace.bind(this))},i._onPlace=function(e){var t=e.m.place.toHash();if(!this.data.position||t.percentageOfBook!=this.data.position.percentageOfBook)this.data.position=t,this._persistPosition()},i._persistPosition=function(){BIF.objects.activity.record("position",this.data.position,!0),BIF.bank.title.set(this.BANK_KEY_PREFIX+":position",this.data.position)},i._onPossessionSync=function(e,t){this._.sync=null,t.postSyncPlaceHash=e.position||this.data.position,delete e.position,this._syncPossessionData(e,this.BANK_KEY_PREFIX),this._syncPosition(t.preSyncPlaceHash,t.postSyncPlaceHash),BIF.dispatch("bifocal:possession:synchronized",{possession:this,state:t})},i._onPossessionSyncFailure=function(e,t){this._.sync=null,console.warn("[POSSESSION] Sync failed: "+e)},i._syncPossessionData=function(e,n){if(e.timestamps.stamped<this.data.timestamps.stamped){console.warn("[POSSESSION] Sync data obsolete:",e,this.data);return}var r={};t.each(e,function(e,t){typeof this.data[e]!="undefined"?this.data[e]=r[e]=t:console.warn("[POSSESSION] Ignoring unknown data key: ",e,t)},this),this._savePossessionData(r,n)},i._savePossessionData=function(e,n){e=JSON.parse(JSON.stringify(e)),t.each(e,function(e,t){BIF.bank.title.set(n+":"+e,t)},this)},i._syncPosition=function(e,t){console.log("[POSSESSION] sync position...\n   pre: %s\n   post: %s",JSON.stringify(e),JSON.stringify(t));if(!t)return;var n=this._placeHashToPlace(t);if(this.data.position){var r=this._placeHashToPlace(this.data.position);if(this._comparePlaces(r,n))return}if(e){var i=this._placeHashToPlace(e);if(this._comparePlaces(i,n))return;if(t.timestamp>e.timestamp)return this._syncPrompt(e,t)}else this._goToSyncPlace(n),setTimeout(function(){typeof n.refresh=="function"&&n.refresh();var e="Synchronized position to "+this._describePlace(n)+" automatically.";BIF.dispatch("bifocal:notify:message",e),console.log("[POSSESSION] "+e)}.bind(this),1e3)},i._syncPrompt=function(e,t){var n=this._placeHashToPlace(this.data.position),r=this._placeHashToPlace(t),i=this._describePlace(n),s=this._describePlace(r);BIF.dispatch("bifocal:notify:dialog",{headingText:"Synchronize position?",promptText:this._describeSync(e,t),actions:{cancel:{html:'Stay at <span class="pre-sync-stay">'+i+"</span>"},ok:{html:'Go to <span class="post-sync-go">'+s+"</span>",onTap:this._goToSyncPlace.bind(this,r)}}});var o=function(e){var t=document.querySelector(".pre-sync-stay");t?(t.innerHTML=this._describePlace(e.m.place),typeof r.refresh=="function"&&r.refresh(),t=document.querySelector(".post-sync-go"),t.innerHTML=this._describePlace(r)):BIF.deafen("bifocal:place",o)}.bind(this);BIF.listen("bifocal:place",o)},i._goToSyncPlace=function(e){BIF.objects.notifier&&BIF.objects.notifier.close(),e.seek()},i._placeHashToPlace=function(e){var t;return e.spinePosition&&e.percentageOfComponent?(t=this._spinePositionToIndex(e.spinePosition),t+=e.percentageOfComponent):t={percentageOfBook:e.percentageOfBook},BIF.objects.compass.at(t)},i._comparePlaces=function(e,t){var n=this._describePlace(e),r=this._describePlace(t);return n==r},i._describePlace=function(e){var t=e.toHumanString();return t&&!t.match(/%$/)&&(t="p."+t),t},i._describeSync=function(e,t){return"There is a more recent position in this book."},i._spinePositionToIndex=function(e){for(var t=0,n=BIF.map.spine.length;t<n;++t){var r=BIF.map.spine[t]["-odread-spine-position"];typeof r=="undefined"&&(r=t);if(r==e)return t}},r}),define("lens/src/utils",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this.context=e},r.opposite=function(e){if(e=="left")return"right";if(e=="right")return"left";throw'[LENS-UTILS] Cannot give the opposite of "'+e+'"'},r.unbiased=function(e){return this.context.profile.reverse?this.opposite(e):e},n}),define("lens/src/map",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this.components=e.spine,this.chapters=(e.nav?e.nav.toc:null)||[],this.firstPlace=e.firstPlace||0,e.fetcher&&this.assignFetcher(e.fetcher)},r.assignFetcher=function(e){this._fetcher=e},r.componentSource=function(e,t){typeof this._fetcher=="function"?this._fetcher(e,t):t({url:e})},n}),define("lens/src/profile",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.MODES=["paging","snapping","scrolling"],r.DIRECTIONS={ltr:!1,rtl:!0},r.SPREAD_ORIENTATIONS=["none","auto","portrait","landscape","both"],r.$init=function(e,t){this.quirks=t||function(){return!1},this.context=e,this.mode=null,this.modeFlags={},this.reverse=null,this.spreadOrientation=null,this.computeDefaults()},r.setMode=function(e){e=e.trim().toLowerCase();var t=this._constrainMode(e);e!=t&&(console.warn('Mode must be "'+t+'" in this browser.'),e=t);if(r.MODES.indexOf(e)<0)throw"Invalid pagination mode: "+e;return this.mode!=e?(this.mode=e,this.modeFlags.scrollingReflowables=e=="scrolling",this.modeFlags.constrainFrameWidth=e!="paging",e=="paging"?this.modeFlags.primingDistance=this.PRIMING_DISTANCE:this.modeFlags.primingDistance=0,this.modeFlags.translationType=this._selectTranslationType(),e=="snapping"?this.modeFlags.animationType=null:this.modeFlags.animationType=this._selectAnimationType(),this.context.dispatch("lens:profile:mode",{mode:e}),!0):!1},r.setDirection=function(e){e=e.trim().toLowerCase();var t=r.DIRECTIONS[e];if(typeof t=="undefined")throw"Invalid page progression direction: "+e;return t!==this.reverse?(this.reverse=t,this.context.dispatch("lens:profile:direction",{direction:e,reverse:t}),!0):!1},r.setSpreadOrientation=function(e){e=e.trim().toLowerCase();if(r.SPREAD_ORIENTATIONS.indexOf(e)<0)throw"Invalid spread orientation: "+e;return this.spreadOrientation!=e?(this.spreadOrientation=e,this.context.dispatch("lens:profile:spread",{orientation:e}),!0):!1},r.computeDefaults=function(){this.DEFAULT_MODE="paging",this.DEFAULT_DIRECTION="ltr",this.DEFAULT_POSITION={ltr:"right",rtl:"left"}[this.DEFAULT_DIRECTION],this.AUTO_SPREAD_FOR_ORIENTATION="landscape",this.TRANSLATION_TYPE=this._is3dTransformAvailable()?"translate3d":"translateX",this.ANIMATION_TYPE="css",this.PRIMING_SWEEP_DELAY=200,this.PRIMING_DISTANCE=2,this.SCROLLBAR_WIDTH=this._getScrollbarWidth(),this.BASE_URL="javascript:''",this.APPROX_MODE=!1},r.autoPilot=function(){this.mode===null&&this.setMode(this.DEFAULT_MODE),this.reverse===null&&this.setDirection(this.DEFAULT_DIRECTION),this.spreadOrientation===null&&this.setSpreadOrientation("auto")},r._constrainMode=function(e){return this.quirks("expanding-iframe-widths")?"snapping":this.quirks("missing-multi-column")?"scrolling":e},r._selectTranslationType=function(){return this.quirks("translation-confuses-rects")?"left":this.quirks("3d-transform-has-artefacts")?"translateX":this.TRANSLATION_TYPE},r._selectAnimationType=function(){return this.quirks("css-transition-has-artefacts")?"js":this.ANIMATION_TYPE},r._is3dTransformAvailable=function(){var e=!1,t=["transform","-moz-transform","-webkit-transform","-ms-transform"],n,r=document.createElement("div");document.documentElement.appendChild(r);while(t.length){var i=t.shift();if(r.style[i]!==undefined){r.style[i]="translateZ(0)",n=window.getComputedStyle(r).getPropertyValue(i);if(n!==undefined&&n.length>0&&n!="none"){e=!0;break}}}return document.documentElement.removeChild(r),e},r._getScrollbarWidth=function(){var e=document.createElement("div");e.style.cssText=["width: 100px","height: 100px","overflow: scroll","position: absolute","top: -200px"].join(";"),document.body.appendChild(e);var t=e.offsetWidth-e.clientWidth;return document.body.removeChild(e),t},n}),define("lens/src/sequence",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e,t){this.context=e,this.name=t,this.resequence()},r.resequence=function(){this._.blocks=[],this._.followPos=this.context.profile.DEFAULT_POSITION,this.context.spine.each(this._sequenceComponent,this)},r.apply=function(){this.context.spine.each(this._applyToComponent,this)},r._sequenceComponent=function(e,t){var n=this._.blocks[t]={layout:e.meta["rendition-layout"]||"reflowable",pos:e.meta["rendition-position"]||this._.followPos};n.spread=!this._disallowSpread(t)&&this._spreadForOrientation(e.meta["rendition-spread"]),n.pos=="center"&&!this._spreadForOrientation("auto")&&(n.pos=this.context.utils.unbiased("left")),n.pos==this.context.utils.unbiased("right")&&n.spread?n.face="tail":n.face="head",n.layout=="pre-paginated"&&n.spread&&(n.bleed=this.context.utils.opposite(n.pos)),n.layout=="reflowable"?this._.followPos=this.context.profile.DEFAULT_POSITION:n.spread?this._.followPos=this.context.utils.opposite(n.pos):this._.followPos=this.context.utils.unbiased("left")},r._disallowSpread=function(e){var t=this._.blocks[e],n=this._.blocks[e-1],r=this.context.profile.modeFlags.scrollingReflowables&&t.layout=="reflowable";return r&&t.pos==this.context.utils.unbiased("left")?!0:r&&(!n||n.layout=="reflowable")?!0:t.pos=="center"?!0:!1},r._spreadForOrientation=function(e){var t=this.context.profile;return e=e||"auto",e=="auto"&&(e=t.spreadOrientation),e=="auto"&&(e=t.AUTO_SPREAD_FOR_ORIENTATION),e=="both"||e==this.context.scene.dimensions.orientation},r._applyToComponent=function(e,t){e.block=this._.blocks[t]},n}),define("lens/src/metrics",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e,t,n){this.context=e,this.dub=t,this.component=n,this.unmeasure(),this.unposition()},r.unmeasure=function(){this.blanks=[0,0],this.scenes=0,this.pages=0,this.widths={content:null,sheet:null,frame:null,blanks:[null,null],real:null,virtual:null}},r.unposition=function(){this.heads={real:null,virtual:null},this.tails={real:null,virtual:null}},r.isComplete=function(){return typeof this.widths.content=="number"&&typeof this.heads.real=="number"},r.computeMeasurements=function(e){this.unmeasure();if(!e)return!1;this.widths.content=e.content,this.widths.sheet=e.sheet,this.widths.frame=e.frame;var t=this._generateBlanks();return this.widths.real=t[0]+this.widths.sheet+t[1],this.widths.virtual=t[0]+this.widths.content+t[1],this.scenes=this.widths.virtual/this.context.spool.aperture,this.pages=this.scenes*(this.component.block.spread?2:1),!0},r.compareMeasurements=function(e){return e=e||{},e.content===this.widths.content&&e.sheet===this.widths.sheet&&e.frame===this.widths.frame},r.computePositionFromBase=function(e){this.unposition();if(!this.widths.virtual)return console.warn("[METRICS] cannot compute position because not yet measured",this.component.index),!1;if(this.component==e)this.heads.real=this._baseOffsetFromZero(this.component),this.tails.real=this.heads.real+this.widths.virtual,this.heads.virtual=this.heads.real,this.tails.virtual=this.heads.virtual+this.widths.virtual;else if(this.component.index>e.index){if(!this._canPositionUsing(this.component.prev))return!1;this.heads.real=this.component.prev.metrics.tails.real,this.tails.real=this.heads.real+this.widths.virtual,this.heads.virtual=this.component.prev.metrics.tails.virtual,this.tails.virtual=this.heads.virtual+this.widths.virtual}else if(this.component.index<e.index){if(!this._canPositionUsing(this.component.next))return!1;this.tails.real=this.component.next.metrics.heads.real,this.heads.real=this.tails.real-this.widths.virtual,this.tails.virtual=this.component.next.metrics.heads.virtual,this.heads.virtual=this.tails.virtual-this.widths.virtual}return!0},r.serialize=function(){var e={};return t.each(["blanks","scenes","pages","widths"],function(t){e[t]=this[t]},this),JSON.parse(JSON.stringify(e))},r.deserialize=function(e){e=JSON.parse(JSON.stringify(e)),t.each(["blanks","scenes","pages","widths"],function(t){this[t]=e[t]},this)},r._generateBlanks=function(){this.blanks=[0,0];var e=this.component;if(e.block.spread){e.block.face=="tail"&&(!e.prev||!e.prev.block.spread)&&(this.blanks[0]=1);var t=e.next?e.next.block.face:"head",n=e.block.face==t,r=e.block.layout=="reflowable"&&this.widths.content%this.context.spool.aperture==0;if(r&&!n||!r&&n)this.blanks[1]=1}var i=this.context.spool.aperture*.5;return this.widths.blanks=[this.blanks[0]*i,this.blanks[1]*i]},r._baseOffsetFromZero=function(){return this.blanks[0]||this.component.block.face=="head"?0:this.context.spool.aperture*.5},r._canPositionUsing=function(e){return e?e.metrics?e.metrics.isComplete()?typeof this.widths.virtual!="number"?!1:!0:!1:!1:!1},n}),define("lens/src/dub",["require","common","./metrics"],function(e){var t=e("common"),n=e("./metrics"),r=t.Class.new(),i=r.prototype;return i.WORK_IDLE_MS=1e3,i.MISMEASURE_ATTEMPT_MAX=6,i.MISMEASURE_ATTEMPT_INTERVAL_MS=500,i.$init=function(e,t,n){this.context=e,this.name=t,this.sequence=n,this.ambit=this._freshAmbit(),this.workQueue=[],this.workItem=null},i.apply=function(){this.context.spool.reset(),this.parcels=[];var e=this._.metricsCache||[];delete this._.metricsCache,this.context.spine.each(function(t){t.evict();var r={metrics:t.metrics=new n(this.context,this,t),claimed:!1,measured:!1,positioned:!1,primed:!1,occupied:!1};e[t.index]?(t.metrics.deserialize(e[t.index]),r.measured=!0):r.measured=t.metrics.computeMeasurements(t.measure()),this.parcels.push(r)}.bind(this))},i.focus=function(e,n,r){this._rebaseAmbit(e)&&(r=r||this._reorientSpool.bind(this)),this._calculatePrimingHorizon(e,n);var i=this._reconstructWorkQueue(e);this.workItem&&i[0]&&this.workItem.index==i[0].index&&this.workItem.order==i[0].order?(this.workQueue=i.slice(1),delete this.workItem.callback):(this.workItem&&this.halt(),this.workQueue=i);if(r){var s=[this.workItem].concat(this.workQueue);t.each(s,function(n){n&&n.index==e.index&&(n.callback=r,r=null,t.breakIteration())})}r&&r(),this.workItem||this._continueWork()},i.halt=function(){this._cancelWorkSchedule(),this.workItem&&(this.workQueue=[],this.context.spine.byIndex(this.workItem.index).halt(),this.workItem=null)},i.heal=function(){this.context.spine.each(function(e,t){var n=this.parcels[t];n.primed&&!e.healthy&&(n.primed=e.unprime(),n.occupied=e.evict())}.bind(this)),this._reorientSpool()},i.serialize=function(){var e={};return e.sequence=this.sequence.name,e.name=this.name,e.metrics=[],this.context.spine.each(function(t){if(t.healthy===!1)throw"[DUB] UNHEALTHY. Cannot serialize.";e.metrics.push(t.metrics.serialize())}),this.context.dispatch("lens:dub:save",{pkg:e}),e},i.deserialize=function(e){this.context.dispatch("lens:dub:load",{pkg:e}),this._.metricsCache=e.metrics},i.pause=function(){if(!this.context.spool.approxMode){this.context.spool.approxMode=!0;var e=[];t.each(this.workQueue,function(t){t.order!="measure"&&e.push(t)}),this.workQueue=e,this.workQueue.length&&!this.workItem&&this._continueWork()}},i.resume=function(){this.context.spool.approxMode&&(this.context.spool.approxMode=!1,this.context.spine.each(function(e,t){var n=this.parcels[t];if(n.measured)return;for(var r=0,i=this.workQueue.length;r<i;++r)if(this.workQueue[r]==t)return;this.workQueue.push({index:t,order:"measure"})}.bind(this)),this.workQueue.length&&!this.workItem&&this._continueWork())},i._reconstructWorkQueue=function(e){var t=[],n=function(e,n){var r=this.parcels[e.index];if(r[n+"d"])return;t.push({index:e.index,order:n})}.bind(this),r={prev:!0,next:!0};return this.context.spine.onionSkin(e,function(t){var i=this.parcels[t.index],s=i.claimed;i.claimed=!0;if(t==e)return n(t,"prime");var o=t.index<e.index?"prev":"next";if(r[o]){if(this._isWithinPrimingHorizon(t))return n(t,"prime");r[o]=!1}if(i.primed||!s)i.primed=t.unprime();i.occupied&&(i.occupied=t.evict());if(!this.context.spool.approxMode&&!i.measured)return n(t,"measure")}.bind(this)),t},i._calculatePrimingHorizon=function(e,t){this.horizon={focalComponent:e};var n=this.context.spool.aperture,r=n*this.context.profile.modeFlags.primingDistance,i=t;typeof i!="number"&&(e.metrics.isComplete()?i=e.metrics.heads.virtual:i=0),this.horizon.head=i-n,this.horizon.tail=i+n+r},i._isWithinPrimingHorizon=function(e){return!e||!e.metrics?!1:e.metrics.isComplete()?e.metrics.heads.virtual>=this.horizon.tail?!1:e.metrics.tails.virtual<=this.horizon.head?!1:!0:Math.abs(e.index-this.horizon.focalComponent.index)<=2},i._measuredComponent=function(e,t){typeof t.frame!="number"&&(t.frame=t.sheet);var n=this.parcels[e.index];n.measured=e.metrics.computeMeasurements(t),this._expandAmbit(),e.isLoaded()&&this._announceWalkableComponent(e),this._isWithinPrimingHorizon(e)?e.prime(this._primedComponent.bind(this,e)):this._scheduleWork(function(){n.primed=e.unprime(),n.occupied&&(n.occupied=e.evict()),this._continueWork()}.bind(this))},i._primedComponent=function(e,t){var n=this.parcels[e.index];if(n.measured&&e.healthy&&!e.metrics.compareMeasurements(t)){n.mismeasurements=(n.mismeasurements||0)+1,console.warn("[DUB] mismeasurement in %s (#%s)... %spx -> %spx",e.index,n.mismeasurements,e.metrics.widths.sheet,t.sheet),n.occupied&&(n.occupied=e.evict()),n.mismeasurements==this.MISMEASURE_ATTEMPT_MAX?(n.measured=e.metrics.computeMeasurements(t),this._repairPositionsAfterMismeasurement()):this._scheduleWork(function(){e.prime(this._primedComponent.bind(this,e))}.bind(this),this.MISMEASURE_ATTEMPT_INTERVAL_MS);return}delete n.mismeasure,n.primed=!0,!n.measured&&e.healthy&&(n.measured=e.metrics.computeMeasurements(t),n.positioned=!1),n.positioned||(this._expandAmbit(),this._announceWalkableComponent(e)),n.occupied||(n.occupied=e.occupy(e.metrics)),this.context.dispatch("lens:component:visible",{component:e});var r=this.workItem?this.workItem.callback:null;this._continueWork(),r&&r()},i._announceWalkableComponent=function(e){this.context.dispatch("lens:component:walkable",{component:e})},i._repairPositionsAfterMismeasurement=function(){this.workItem=null,this.halt(),this._rebaseAmbit(this.ambit.base,!0),this._reorientSpool()},i._reorientSpool=function(){this.context.spool.reorient()},i._freshAmbit=function(){return{base:null,count:0,pages:0,real:{min:Infinity,max:-Infinity},virtual:{min:Infinity,max:-Infinity}}},i._rebaseAmbit=function(e,n){if(this.ambit.base&&!n){var r=this.ambit.base.index,i=r>e.index?-1:1;for(;;){if(e.index===r)return!1;var s=this.parcels[r];if(!s||!s.measured||!s.positioned)break;r+=i}}return this.ambit=this._freshAmbit(),this.ambit.base=e,t.each(this.parcels,function(e){e.positioned=e.metrics.unposition()}),this._expandAmbit(),!0},i._expandAmbit=function(){var e=this.ambit.base;while(e)e=this._extendAmbitWithComponent(e)?e.next:null;e=this.ambit.base.prev;while(e)e=this._extendAmbitWithComponent(e)?e.prev:null;var n=0;t.each(this.parcels,function(e){n+=e.measured?1:0}),this.ambit.count=n,this.ambit.progress=this.ambit.count/this.context.spine.length,clearTimeout(this._.ambitTimer),this._.ambitTimer=setTimeout(this._announceAmbit.bind(this),0)},i._extendAmbitWithComponent=function(e){var t=e.metrics,n=this.parcels[e.index];if(!n.measured)return!1;if(n.positioned)return!0;n.positioned=t.computePositionFromBase(this.ambit.base);if(!n.positioned)return!1;this.ambit.virtual.min=Math.min(this.ambit.virtual.min,t.heads.virtual),this.ambit.virtual.max=Math.max(this.ambit.virtual.max,t.tails.virtual),this.ambit.real.min=Math.min(this.ambit.real.min,t.heads.real),this.ambit.real.max=Math.max(this.ambit.real.max,t.tails.real),this.ambit.pages+=t.pages;if(n.primed||n.occupied)n.occupied=e.occupy(t);return!0},i._checkAmbitCompleteness=function(){!this.ambit.complete&&this.ambit.count==this.context.spine.length&&(this.ambit.complete=!0,this.context.spool.dubComplete(this),this.context.scene.dubComplete(this))},i._announceAmbit=function(){clearTimeout(this._.ambitTimer),this._checkAmbitCompleteness(),this.context.dispatch("lens:dub:ambit",{dub:this,ambit:this.ambit})},i._continueWork=function(){if(this.workItem=this.workQueue.shift()){var e=this.context.spine.byIndex(this.workItem.index),t=this.parcels[e.index];this.workItem.order=="prime"?(t.positioned&&(t.occupied=e.occupy(e.metrics)),e.prime(this._primedComponent.bind(this,e))):this.workItem.order=="measure"&&e.measure(this._measuredComponent.bind(this,e))}else this._finishWork()},i._finishWork=function(){this._idle()},i._scheduleWork=function(e,t){this._cancelWorkSchedule(),this._.workTimer=setTimeout(e,t||0)},i._cancelWorkSchedule=function(){typeof this._.workTimer!="undefined"&&(clearTimeout(this._.workTimer),delete this._.workTimer)},i._idle=function(){this._scheduleWork(function(){if(this.context.spool.dub!=this)return;this.context.dispatch("lens:dub:idle")}.bind(this),this.WORK_IDLE_MS)},i._diagnostics=function(){var e={},n=[],r=[this.workItem].concat(this.workQueue);t.each(r,function(e){if(!e)return;n.push(e.index+":"+e.order+(e.callback?"#":""))},this),e.workQueueSummary=["  Queue: ["+n.join(", ")+"]"].join("\n");var i=[];return this.context.spine.each(function(e){var t=e.metrics,n=typeof t.heads.virtual=="number"?t.heads.virtual:"???",r=typeof t.widths.virtual=="number"?t.widths.virtual:"???",s="",o=this.parcels[e.index];s+=o.measured?"m":"â",s+=o.positioned?"p":"â",s+=o.occupied?"o":"â",s+=o.primed?"#â":"â",i.push(e.index+" "+s+" = "+n+" + "+r)}.bind(this)),e.ambitSummary=["  Base: "+(this.ambit.base?this.ambit.base.index:"--"),"  Progress: "+this.ambit.count+" of "+this.context.spine.length,"  Parcels:\n    "+i.join("\n    ")].join("\n"),e},i._diagnosticReport=function(){var e=this._diagnostics();console.log("[DUB] work:\n%s",e.workQueueSummary),console.log("[DUB] ambit:\n%s",e.ambitSummary)},r}),define("lens/src/scene",["require","common","./sequence","./dub"],function(e){var t=e("common"),n=e("./sequence"),r=e("./dub"),i=t.Class.new(),s=i.prototype;return s.DUBS_BANK_KEY="lens:dubs",s.MAX_SAVED_DUBS=10,s.REBUILD_DEBOUNCE_MS=200,s.$init=function(e,t){this.context=e,this.dimensions=null,this._.factors={dub:{},sequence:{}},this._.sequence=null,this._.sequences={},this._.dub=null,this._populateScene(t)},s.rebuild=function(){clearTimeout(this._rebuildTimer),this._.box.classList.add("rebuilding"),this._rebuildTimer=setTimeout(this._performRebuild.bind(this),this.REBUILD_DEBOUNCE_MS)},s.dubComplete=function(e){this._saveDub(e)},s._performRebuild=function(){if(!this._.box)return;this.dimensions=this._calcDimensions();if(this.dimensions.width<=0&&this.dimensions.height<=0)return;if(this._updateSequenceAndDub()){var e=this._.rebuiltAt=t.epochMilliseconds();this._.box.classList.add("rebuilding"),this.context.dispatch("lens:scene:invalidate",{scene:this}),this.context.ruler.reset(),this.context.spine.rebuild(),this._updatePresentation(),this._.sequence.apply(),this.context.spool.dub&&this.context.spool.dub.halt(),this.context.spool.dub=this._.dub,this.context.spool.dub.apply(),this.context.spool.reorient(),this.context.dispatch("lens:scene:rebuild",{scene:this});var n=t.epochMilliseconds(),r=Math.max(0,this.REBUILD_DEBOUNCE_MS-(n-e));setTimeout(function(){if(e!=this._.rebuiltAt)return;this._.box.classList.remove("rebuilding")}.bind(this),r)}else this._.box.classList.remove("rebuilding")},s._populateScene=function(e){this._.box=e,this.context.createSpool(this._.box),this.rebuild()},s._updatePresentation=function(){this._.box.style.setProperty("height",this.dimensions.height+"px"),this._.box.style.setProperty("width",this.dimensions.width+"px");var e=this._.box;t.DataClass.set(e,"dir",this.context.profile.reverse?"rtl":"ltr"),this.context.profile.quirks("translation-flicker")&&e.classList.add("translation_deflicker")},s._calcDimensions=function(){var e=this._.box.parentNode,t={};return t.height=e.offsetHeight,t.width=e.offsetWidth,t.width-=t.width%2,t.orientation=t.width<t.height?"portrait":"landscape",t},s._label=function(e){var n=[];return t.each(this._.factors[e],function(e,t){n.push([e,t].join(":"))}),n.join(";")},s._createSequence=function(e){var t=new n(this.context,e);return this._.sequences[e]=t,t},s._createDub=function(e,t){var n=new r(this.context,e,t);return n},s._updateSequenceAndDub=function(){this._collectSequenceAndDubFactors();var e=this._label("dub");if(this._.dub&&e==this._.dub.name)return!1;var t=this._label("sequence");return this._.sequence=this._.sequences[t]||this._createSequence(t),this._.dub=this._loadDub(e,this._.sequence),!0},s._collectSequenceAndDubFactors=function(){this._.factors.sequence={},this._.factors.dub={},this._assignInternalFactors();var e={scene:this,factors:{dub:{},sequence:{}}};this.context.dispatch("lens:scene:factors",e),t.absorb(e.factors.seq,this._.factors.sequence),t.absorb(e.factors.dub,this._.factors.dub)},s._assignInternalFactors=function(){t.absorb({mode:this.context.profile.mode,direction:this.context.profile.reverse,spr:this.context.profile.spreadOrientation,orientation:this.dimensions.orientation},this._.factors.sequence),t.absorb({seq:"["+this._label("sequence")+"]",h:this.dimensions.height,w:this.dimensions.width},this._.factors.dub)},s._saveDub=function(e){var n;try{n=e.serialize()}catch(r){return}var i=[n],s=this.context.bank.get(this.DUBS_BANK_KEY);s&&(t.each(s,function(e){e.name&&e.name!=n.name&&i.push(e)}),i=i.slice(0,this.MAX_SAVED_DUBS)),this.context.bank.set(this.DUBS_BANK_KEY,i)},s._loadDub=function(e,t){var n=this._createDub(e,t);if(this.context.profile.APPROX_MODE)return n;var r=this.context.bank.get(this.DUBS_BANK_KEY);if(r)for(var i=0,s=r.length;i<s;++i)if(r[i].name==e&&r[i].sequence==t.name){n.deserialize(r[i]);break}return n},i}),define("lens/src/pulley",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.ANIMATION_MS=200,r.$init=function(e,t){this.context=e,this._.box=t,this._.animX=0,this._.transFunction=this._translationValueFunctor()},r.translate=function(e,t,n){n=n||{},this._.targetX=e;var r="translateSpool";if(this.context.profile.modeFlags.animationType){var i=t?"AnimateSpool":"SnapSpool";r=this.context.profile.modeFlags.animationType+i}this["_"+r](e),n.snapElement&&this._translateElement(n.snapElement,n.snapX)},r.stopAnimation=function(){var e=this.context.profile.modeFlags.animationType;e&&this["_"+e+"StopAnimation"]()},r._jsAnimateSpool=function(e){var t=null,n=this._.animX,r=e-n,i,s;s=function(){this._jsStopAnimation(),this._.animRequest=requestAnimationFrame(i)}.bind(this),i=function(i){t||(t=i);var o=(i-t)/this.ANIMATION_MS,u=e;o<1&&(u=n+r*o,s()),this._translateSpool(u)}.bind(this),s()},r._jsSnapSpool=function(e){this._translateSpool(e)},r._jsStopAnimation=function(){this._.animRequest&&(cancelAnimationFrame(this._.animRequest),this._.animRequest=null)},r._cssAnimateSpool=function(e){if(this._.lastOp!="animate"){var n="all linear "+this.ANIMATION_MS+"ms";t.prefixProperty(this._.box.style,"transition",n),this._.lastOp="animate"}this._translateSpool(e)},r._cssSnapSpool=function(e){this._cssStopAnimation(),this._translateSpool(e)},r._cssStopAnimation=function(){this._.lastOp=="animate"&&(t.prefixProperty(this._.box.style,"transition"),this._.lastOp="snap")},r._translateSpool=function(e){this._translateElement(this._.box,this._.animX=e)},r._translateElement=function(e,t){this._.transFunction(e,this.context.profile.reverse?t:0-t)},r._translationValueFunctor=function(){var e=this.context.profile.modeFlags.translationType;if(e=="translate3d")return function(e,n){var r=typeof n=="number"?"translate3d("+n+"px,0,0)":null;t.prefixProperty(e.style,"transform",r)};if(e=="translateX")return function(e,n){var r=typeof n=="number"?"translateX("+n+"px)":null;t.prefixProperty(e.style,"transform",r)};if(e=="left")return function(e,t){typeof t=="number"?e.style.setProperty("left",t+"px"):e.style.removeProperty("left")};console.warn("Unknown translation type: ",e)},n}),define("lens/src/spool",["require","common","./pulley"],function(e){var t=e("common"),n=e("./pulley"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this.context=e,this.dub=null,this.approxMode=this.context.profile.APPROX_MODE},i.reset=function(){this.focus=null,this.cursor={virtual:0,real:0,focal:0},this.pages={here:[Infinity],total:Infinity},this.aperture=this.context.scene?this.context.scene.dimensions.width:0,this.occlusionInfo={prime:[],aperture:this.aperture,virtualX:0}},i.build=function(e){this._.box=t.element({id:"spool"}),e.appendChild(this._.box),this.context.createSpine(this._.box),this._.pulley=new n(this.context,this._.box)},i.dubComplete=function(e){this._countPages(),this._storeRegion()},i.reorient=function(){this._restoreRegion()},i.resolve=function(e){var t={};if(typeof e=="number"){var n=Math.max(0,Math.min(parseFloat(e),this._maxFloc()));t.component=this.context.spine.byIndex(Math.floor(n)),t.percent=n%1}else if(typeof e=="string"){var r=decodeURIComponent(e),i=r.match(/^\/?([^#]*)#?(.*)/),s=i[1],o=i[2],u=this.context.spine.byId(s);u&&(t.component=u,u.block&&u.block.layout=="reflowable"&&o?t.selector="#"+o:t.percent=0,t=this._normalizeLocus(t)||t)}else{if(!e||!e.component)throw"[SPOOL] resolve: ref is unknown. "+JSON.stringify(e);t=this._normalizeLocus(e)||e}return t.component?t:null},i.seek=function(e,t,n){var r;typeof n=="function"?r=function(){n(),this._storeRegion()}.bind(this):r=this._storeRegion.bind(this);var i=this.resolve(e);return i?(this._shiftToLocus(i,t,r),!0):!1},i.shiftLeft=function(){this._shiftInDirection(-1)},i.shiftRight=function(){this._shiftInDirection(1)},i.slideDelta=function(e,t){if(!this.context.profile.modeFlags.animationType)return;if(this.context.profile.modeFlags.scrollingReflowables)return;this._.pulley.translate(this.cursor.real+e,t)},i.slideBack=function(e){this._.pulley.translate(this.cursor.real,e)},i.elementToFloc=function(e,t){if(e.block&&e.block.layout!="reflowable")return e.index;if(!e.isLoaded()||!e.metrics.isComplete())return null;if(t&&t.getClientRects){var n=t.getClientRects()[0];return n?(n.height>this.context.scene.dimensions.height&&(n={top:t.offsetTop,left:t.offsetLeft}),this.rectangleToFloc(e,n)):null}},i.rectangleToFloc=function(e,t){var n=0;if(e.block&&e.block.layout!="reflowable")return e.index;if(this.context.profile.modeFlags.scrollingReflowables)n=t.top/e.sheetBox.scrollHeight;else{if(!e.metrics.isComplete())return null;var r=this.aperture*(e.block.spread?.5:1),i=t.left-t.left%r+1;this.context.profile.reverse&&(i=e.metrics.widths.virtual-i),n=i/e.metrics.widths.virtual}return e.index+n},i._storeRegion=function(e){if(!this.focus||!this.focus.metrics)return;var t=this._virtualXToLocus(this.cursor.virtual),n=this._virtualXToLocus(this.cursor.virtual+this.aperture)||t;if(!t){console.warn("[SPOOL] No locus calculable for virtualX yet:",virtualX);return}if(this.context.profile.modeFlags.scrollingReflowables){var r=t.component.sheetBox;t.percent+=r.scrollTop/r.scrollHeight;var i=n.component.sheetBox;n.percent+=(i.scrollTop+i.clientHeight)/i.scrollHeight}t=this._normalizeLocus(t),n=this._normalizeLocus(n);if(!t||!n){console.warn("[SPOOL] failed to normalize locus",t,n);return}var s=t.component.index+t.percent,o=n.component.index+n.percent,u=Math.floor(o);if(Math.floor(s)===Math.floor(o)||o%1===0)u=s+(o-s)*.5;this.focus.healthy||(u=s);var a={flocA:s,flocM:u,flocZ:o},f=this.region&&this.region.flocA===s&&this.region.flocM===u&&this.region.flocZ===o;e=e===!0?!0:!1;if(!e||!this.region)this.region=a;this.context.dispatch("lens:spool:region",{region:a,restored:e,repeated:f})},i._restoreRegion=function(){var e=this.region?this.region.flocM:this.context.map.firstPlace,t=this.resolve(e)||this.resolve(e=0);this._shiftToLocus(t,!1,this._storeRegion.bind(this,!0))},i._normalizeLocus=function(e){if(!e||!e.component)return null;var t=e.component,n=t.isLoaded();if(typeof e.percent=="number")return{component:t,percent:e.percent};if(e.selector&&t.block.layout!="reflowable")return{component:t,percent:0};if(e.selector&&n){var r=t.frameBox.contentDocument;try{var i=e.selector.replace(".","\\."),s=r.querySelector(i),o=this.elementToFloc(t,s);return this.resolve(o)}catch(u){}}else if(typeof e.finder=="function"&&n)try{return this.resolve(e.finder(t))}catch(u){}return null},i._maxFloc=function(){return Math.max(0,this.context.spine.length-1e-5)},i._locusToVirtualX=function(e){if(!e.component.metrics.isComplete())return null;var t=this._normalizeLocus(e);if(!t)return null;var n=t.component.metrics.heads.virtual;return t.component.block.layout=="reflowable"&&(n+=Math.min(t.component.metrics.widths.virtual*t.percent,t.component.metrics.widths.virtual-this.aperture)),n+=t.component.metrics.widths.blanks[0],Math.round(n)},i._virtualXToLocus=function(e){var t=this.context.spine.last();if(t.metrics.isComplete()&&t.metrics.tails.virtual<=e)return this.resolve(this._maxFloc());t=this.context.spine.first();if(t.metrics.isComplete()&&t.metrics.heads.virtual>e)return{component:t,percent:0};while(t)if(!t.metrics.isComplete()||t.metrics.tails.virtual<e)t=t.next;else{if(t.metrics.tails.virtual==e)return{component:t.next,percent:0};if(t.metrics.heads.virtual<=e){var n=e-t.metrics.heads.virtual;n=Math.max(0,n-t.metrics.widths.blanks[0]);var r=n/t.metrics.widths.virtual;if(r>=1){if(!t.next)return this._flocToLocus(this._maxFloc());t=t.next,r=0}return{component:t,percent:r}}if(e<this.aperture)return{component:this.focus,percent:0}}},i._shiftInDirection=function(e){var t=this.context.profile.reverse?-1:1,n=this.cursor.virtual+e*this.aperture*t,r=this._cursorOnBoundedGrid(n);r===n?(this._moveCursorToVirtualX(r,!0),this._storeRegion()):this.slideBack(!0)},i._shiftToLocus=function(e,t,n,r){e=this._normalizeLocus(e)||e;var i=this._locusToVirtualX(e);typeof i=="number"?(this._moveCursorToVirtualX(i,t?!0:!1),typeof n=="function"&&n()):r?console.error("[SPOOL] stalled: focus loop on %s. Metrics: %o",e.component.index,e.component.metrics):this.dub.focus(e.component,i,this._shiftToLocus.bind(this,e,t,n,!0))},i._moveCursorToVirtualX=function(e,n){var r=this._cursorOnInfiniteGrid(e),i=r,s,o,u,a=this.focus||this.context.spine.first();this.context.spine.onionSkin(a,function(e){if(!e.metrics.isComplete())return;var n=e.metrics;if(n.heads.virtual>i||n.tails.virtual<=i)return;s=n.heads.real,i-=n.heads.virtual;if(e.block.layout=="pre-paginated"||n.heads.virtual==n.heads.real&&n.tails.virtual==n.tails.real)s+=i;else{var r=this.aperture*.5;i>=n.widths.blanks[0]&&(s+=n.widths.blanks[0],i-=n.widths.blanks[0],i>=n.widths.content?(s+=n.widths.sheet,i-=n.widths.content):n.widths.content-i==r&&(s+=r,i-=r)),i>=0&&(o=i)}u=e,t.breakIteration()});if(u&&typeof s!="number"||!u&&typeof s=="number")return console.warn("[SPOOL] Unexpected mismatch: focalComponent <=> realX."),this.slideBack(!0);if(u){this.lost=!1,this.cursor.virtual=r,this.cursor.real=s;var f={};typeof o=="number"&&(f.snapElement=u.frameBox.contentDocument.documentElement,f.snapX=o),this._.pulley.translate(this.cursor.real,n,f),this._.headFocus=u;var l=u,c=u.metrics.heads.virtual;u.next&&r+this.aperture>u.metrics.tails.virtual&&(c=u.metrics.tails.virtual,l=u.next),this.cursor.focal=r-c,this._setFocus(l)}else{var h=this.context.spine.first().metrics,p=this.context.spine.last().metrics;h.isComplete()&&r<h.heads.virtual||p.isComplete()&&r>=p.tails.virtual?this.slideBack(!0):(console.warn("[SPOOL] LOST! Was moving to %s (on grid)",r),this.lost=!0,this.cursor.real=this.cursor.real+(r-this.cursor.virtual),this.cursor.virtual=r,this.cursor.focal=0,this.slideBack(!0))}},i._cursorOnInfiniteGrid=function(e){return Math.floor(e/this.aperture)*this.aperture},i._cursorOnBoundedGrid=function(e){var t=this._cursorOnInfiniteGrid(e),n=this.dub.ambit.virtual;return Math.max(n.min,Math.min(n.max,t))},i._setFocus=function(e){this.focus!=e&&this._focusChanged(this.focus,this.focus=e),this._scheduleCheckFocusHealth(),this.dub.focus(this.focus,this.cursor.virtual),this._countPages()},i._focusChanged=function(e,t){e&&e.sheetBox.onscroll&&(e.sheetBox.style.removeProperty("overflow"),e.sheetBox.style.removeProperty("-webkit-overflow-scrolling"),e.sheetBox.onscroll=null),this.context.profile.modeFlags.scrollingReflowables&&(t.sheetBox.style.setProperty("overflow","auto"),t.sheetBox.style.setProperty("-webkit-overflow-scrolling","touch"),t.sheetBox.onscroll=this._storeRegion.bind(this))},i._scheduleCheckFocusHealth=function(){clearTimeout(this._.focusHealthTimer),this._.focusHealthTimer=setTimeout(this._checkFocusHealth.bind(this),1500)},i._checkFocusHealth=function(){clearTimeout(this._.focusHealthTimer);var e=!1;if(!this.focus.isLoaded()||!this._.headFocus.isLoaded()){if(this.dub.workItem)return this._scheduleCheckFocusHealth();e=!0}this.focus&&this.focus.healthy===!1?e=!0:this._.headFocus&&this._.headFocus.healthy===!1&&(e=!0),e&&this.context.dispatch("lens:spool:unhealthy")},i._countPages=function(){this.dub.ambit.complete?this.pages.total=this.dub.ambit.pages:this.pages.total=Infinity,this.pages.here=[];var e=Infinity;if(this.focus){e=0;var t=this.context.spine.first();for(;;){if(!t||!t.metrics){e=Infinity;break}if(t===this.focus){var n=t.block.spread?2:1,r=this.cursor.focal/this.aperture*n;e+=r;break}e+=t.metrics.pages,t=t.next}}this.pages.here.push(e+1),this.focus&&this.focus.block.spread&&this.pages.here.push(e+2)},r}),define("lens/src/component",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.HTML={sourceMissing:'<html data-document-status="source missing"></html>',loadTimeout:'<html data-document-status="load timeout"></html>'},r.LOAD_CHECK_MS=500,r.LOAD_TIMEOUT_MS=15e3,r.LOAD_WAIT_FOR_HTML_MS=0,r.$init=function(e,n,r){this.context=e,this.id=n["-odread-original-path"]||n.path,this.id=this.id.replace(/^\//,""),this.meta=t.absorb(n,{}),t.excise(this.meta,"-odread-original-path"),this._layout(r),this._.workToken={},this._.memo={}},r.behaveAs=function(e){if(this._.behavior){if(this._.behavior==e)return;t.unmix(this._.behavior,this)}this._.behavior=e,t.mixin(this._.behavior,this)},r.chain=function(e,t){this.index=t,this.sheetBox.id="LENS_CMPT_"+t,this.prev=e[t-1],this.prev&&(this.prev.next=this),e[t]=this},r.fetch=function(e){if(this.isLoaded())e();else if(this._.workToken.callback){var t=this._.workToken.callback;this._.workToken.callback=function(){e(),t()}}else{var n=this._commenceWork("fetching",function(){e(),this.unprime()}.bind(this));this._loadContent(this._stepWork(this._completeWork.bind(this)))}},r.measure=function(e){if(typeof e=="undefined")return this._quickMeasure();var t=this._commenceWork("measuring",e);this._doMeasuring(this._stepWork(this._completeWork.bind(this)))},r.prime=function(e){var t=this._commenceWork("priming",e),n=function(e){if(!this._checkWork(t))return;this._doPriming(this._stepWork(this._completeWork.bind(this,e)))}.bind(this);this._doMeasuring(this._stepWork(n))},r.unprime=function(){return clearTimeout(this._.loadTaskTimer),this.boundsBox.removeAttribute("style"),t.each(this.boundsBox.querySelectorAll("iframe"),function(e){e.parentNode.removeChild(e)},this),this.frameBox&&(this.frameBox=null),this._.memo.isContentLoaded=!1},r.halt=function(){this._cancelWork()},r.stylizeContent=function(e,n){if(!this.frameBox||!this.frameBox.contentDocument){console.warn("[COMPONENT] cannot stylize unless content is loaded",this.index);return}var r=this.frameBox.contentDocument,i="_LENS_CMPT_STYLE_"+e,s=r.querySelector("style#"+i)||t.element("style",i,r.querySelector("head"));n instanceof Array&&(n=n.join("\n"));if(s.styleSheet)s.styleSheet.cssText=n;else{var o=r.createTextNode(n);s.firstChild?s.replaceChild(o,s.firstChild):s.appendChild(o)}},r.occupy=function(e){var t=["sheet",this.block.layout];this.block.spread&&t.push("spread"),this.block.layout=="pre-paginated"&&this.block.bleed&&t.push("bleed-"+this.block.bleed),e.blanks[0]&&t.push("blank-start"),e.blanks[1]&&t.push("blank-end"),this.prev||t.push(this.context.utils.unbiased("left")+"-wing"),this.next||t.push(this.context.utils.unbiased("right")+"-wing");var n={className:t.join(" "),side:this.context.utils.unbiased("left"),head:e.heads.real,width:e.widths.real};if(typeof n.head!="number")return!1;if(typeof n.width!="number")return!1;var r=this._.memo.occupation||{};return n.className!==r.className&&(this.sheetBox.className=n.className),(n.side!==r.side||n.head!==r.head)&&this.sheetBox.style.setProperty(n.side,n.head+"px"),n.width!==r.width&&this.sheetBox.style.setProperty("width",n.width+"px"),this._.memo.occupation=n,this.isLoaded()||this._revealGhost(),!0},r.evict=function(){return this.sheetBox.className!="sheet"&&this.context.dispatch("lens:component:invisible",{component:this}),this.sheetBox.className="sheet",this.sheetBox.removeAttribute("style"),delete this._.memo.occupation,!1},r.isLoaded=function(){return this._.memo.isContentLoaded},r._layout=function(e){this.sheetBox=t.element({parentNode:e,classes:"sheet"}),this.pageGhost=t.element({parentNode:this.sheetBox,classes:"page-ghost"}),this.boundsBox=t.element({parentNode:this.sheetBox,classes:"bounds"}),this._concealGhost()},r._commenceWork=function(e,n){if(this._.workToken.order)throw"[COMPONENT] cannot commence work; already working: "+this.index+" -- "+this._.workToken.order+" => "+e;return this._.workToken={id:t.generateUUID(),order:e,callback:n}},r._stepWork=function(e){if(!!this._.workToken){var n=t.absorb(this._.workToken,{});return n.callback=e,n}console.error("[COMPONENT] stepWork invoked but workToken is missing")},r._checkWork=function(e){return e.id==this._.workToken.id},r._completeWork=function(){var e=this._.workToken;this._.workToken={},e.callback.apply(this,arguments)},r._cancelWork=function(){this._.workToken={},this.unprime()},r._doMeasuring=function(e){throw"_doMeasuring must be implemented in subclasses."},r._doPriming=function(e){throw"_doPriming must be implemented in subclasses."},r._quickMeasure=function(){},r._revealGhost=function(){var e=this.context.scene.dimensions.orientation=="landscape",t=this.context.scene.dimensions.width*(e?.5:1);this.pageGhost.style.removeProperty("background-image"),this.pageGhost.style.setProperty("background-size",t+"px")},r._concealGhost=function(){this.pageGhost.style.removeProperty("background-size"),this.pageGhost.style.setProperty("background-image","none")},r._loadingStage=function(e){this._.loadingStage=e},r._scheduleLoadTask=function(e,t){clearTimeout(this._.loadTaskTimer),this._.loadTaskTimer=setTimeout(e,t||0)},r._loadContent=function(e){if(!this._checkWork(e)){this._loadingStage("dead - invalid step token in loadContent");return}if(this.isLoaded())e.callback();else{var t=this.meta.path,n={path:t},r=function(t){this._onContentSource(t,e)}.bind(this),i=this.context.dispatch("lens:component:fetch",n,!0);i?(this._loadingStage("requesting component source"),this.context.map.componentSource(t,r)):r(n.response)}},r._onContentSource=function(e,n){if(!this._checkWork(n)){this._loadingStage("dead - invalid step token on content source");return}e=e||{html:this.HTML.sourceMissing};var r=e.url,i=this._onContentLoaded.bind(this,n);e.html&&(r=this.context.profile.BASE_URL,i=function(t){if(!this._checkWork(n)){this._loadingStage("dead - invalid step token in frame populate handler");return}this._loadingStage("assigning HTML to blank frame"),this._scheduleLoadTask(this._populateContentAsHTML.bind(this,e.html,n),this.LOAD_WAIT_FOR_HTML_MS)}.bind(this));var s=function(e){if(!this._checkWork(n)){this._loadingStage("dead - invalid step token in frame load handler");return}this.frameBox=e,i(e)}.bind(this),o=t.epochMilliseconds()+this.LOAD_TIMEOUT_MS,u=function(){if(!this._checkWork(n))return;var i=function(){if(!this._checkWork(n))return;var e=this.HTML.loadTimeout;this._loadingStage("timed out - assigning timeout HTML to blank iframe"),this.frameBox=a,this._scheduleLoadTask(this._populateContentAsHTML.bind(this,e,n),0)}.bind(this),s=t.epochMilliseconds();if(s>o)return i();if(e.url){var f=new XMLHttpRequest;f.open("GET",r,!0),f.onerror=i,f.send()}this._scheduleLoadTask(u,o-s)}.bind(this);this._scheduleLoadTask(u,this.LOAD_CHECK_MS),this._loadingStage("spawning iframe -> "+r);var a=t.iframe({parentNode:this.boundsBox,src:r,width:0,height:0},s)},r._populateContentAsHTML=function(e,t){if(!this._checkWork(t)){this._loadingStage("dead - invalid step token when populating HTML");return}this.context.profile.quirks("referrer-absent-on-doc-write")?(this.frameBox.contentWindow._LENS_COMPONENT_SOURCE=e,this.frameBox.src="javascript:window['_LENS_COMPONENT_SOURCE'];"):(this.frameBox.contentDocument.open("text/html","replace"),this.frameBox.contentDocument.write(e),this.frameBox.contentDocument.close()),this._loadingStage("polling for readiness");var n=function(){var e=this.frameBox.contentDocument;e.readyState=="complete"?(delete this.frameBox.contentWindow._LENS_COMPONENT_SOURCE,this._onContentLoaded(t)):this._scheduleLoadTask(n,33)}.bind(this);this._scheduleLoadTask(n,33)},r._onContentLoaded=function(e){if(!this._checkWork(e)){this._loadingStage("dead - invalid step token on content loaded");return}this._assignContentHealth(this._isContentHealthy()),this.healthy&&this._modifyContent();var t=this._onContentReady.bind(this,e);try{this._loadingStage("waiting for fonts.ready promise to fulfill"),this.frameBox.contentDocument.fonts.ready.then(t)}catch(n){this._loadingStage("deferring a tick before calling _loaded"),this._scheduleLoadTask(t,33)}},r._modifyContent=function(){this._applyConsistentStylesToContent(),this.context.dispatch("lens:component:modify",{component:this,doc:this.frameBox.contentDocument})},r._applyConsistentStylesToContent=function(){var e=["html * {","-webkit-text-size-adjust: none;","}"];this.context.profile.quirks("font-boosting")&&e.splice(2,0,"max-height: 1000000px;"),this.stylizeContent("anti_quirks",e)},r._solicitStylesForContent=function(){this.context.dispatch("lens:component:stylize",{component:this,doc:this.frameBox.contentDocument})},r._onContentReady=function(e){if(!this._checkWork(e)){this._loadingStage("dead - invalid step token on content ready");return}clearTimeout(this._.loadTaskTimer),this._.memo.isContentLoaded=!0,this._loadingStage("done"),e.callback()},r._onContentStyled=function(){this._concealGhost(),this.boundsBox.style.setProperty("opacity",1)},r._isContentHealthy=function(e){e=e||this.frameBox.contentDocument;try{docStatus=e.documentElement.getAttribute("data-document-status");if(!docStatus){var n=e.querySelectorAll('head meta[name="generator"]');t.each(n,function(n){n.getAttribute("content")=="odnorm-normalized"&&(docStatus="ok",e.documentElement.setAttribute("data-document-status",docStatus),t.breakIteration())})}}catch(r){console.warn("[COMPONENT] %s - error checking health",this.id,r)}return docStatus=="ok"},r._assignContentHealth=function(e){if(this.healthy===e)return;this.healthy=e,this.healthy===!1&&(this.isLoaded()&&(this.frameBox.contentDocument.documentElement.innerHTML=""),console.warn("[COMPONENT] %s unhealthy: %s",this.index,this.meta.path))},n}),define("lens/src/component_scaled",["require","common"],function(e){var t=e("common"),n={};return n._doMeasuring=function(e){if(!this._checkWork(e))return;e.callback(this._quickMeasure())},n._doPriming=function(e){this._loadContent(this._stepWork(function(){if(!this._checkWork(e))return;this._applyPaginationStylesToContent(),e.callback(this._quickMeasure())}.bind(this)))},n._quickMeasure=function(){var e=this._takeMeasurements();return{content:e.sheetWidth,sheet:e.sheetWidth,frame:e.frameWidth}},n._takeMeasurements=function(){var e={sceneWidth:this.context.spool.aperture,sheetWidth:null,frameWidth:null};return this.block.spread?e.sheetWidth=e.frameWidth=e.sceneWidth*.5:(e.sheetWidth=e.sceneWidth,this.block.pos=="center"?e.frameWidth=e.sceneWidth*.5:e.frameWidth=e.sceneWidth),e},n._determineViewport=function(){var e=768,t=1024,n=this.meta["rendition-viewport"];return n?(e=n.width,t=n.height):console.warn("No viewport in pre-paginated HTML: %s.",this.meta.path),{w:e,h:t}},n._applyPaginationStylesToContent=function(){var e=this.frameBox.contentDocument,n=this._determineViewport(),r=this._takeMeasurements().frameWidth,i=this.context.scene.dimensions.height,s=n.w,o=n.h,u=Math.min(r/s,i/o),a=s*u,f=o*u;this.boundsBox.style.setProperty("width",a+"px"),this.boundsBox.style.setProperty("height",f+"px"),this.boundsBox.style.setProperty("padding-top",(i-f)*.5+"px");var l=this.frameBox.style;this.context.profile.modeFlags.constrainFrameWidth&&(l=e.documentElement.style,this.frameBox.style.setProperty("width",a+"px"),this.frameBox.style.setProperty("height",f+"px"),t.prefixProperty(l,"transform-origin","0 0")),l.setProperty("width",s+"px"),l.setProperty("height",o+"px"),t.prefixProperty(l,"transform","scale("+u+")"),this.context.profile.quirks("scaling-causes-missing-elements")?this.sheetBox.style.setProperty("-webkit-transform","translateZ(0)"):this.sheetBox.style.removeProperty("-webkit-transform"),this._solicitStylesForContent(),this._onContentStyled()},n}),define("lens/src/component_scrollable",["require","common","./component_scaled"],function(e){var t=e("common"),n=t.absorb(e("./component_scaled"),{});return n._quickMeasure=function(){var e=this._takeMeasurements();return{content:e.sheetWidth,sheet:e.sheetWidth,frame:e.sheetWidth}},n._takeMeasurements=function(){var e={};return e.sceneWidth=this.context.spool.aperture,e.sheetWidth=e.sceneWidth*(this.block.spread?.5:1),e},n._applyPaginationStylesToContent=function(){var e=this.frameBox.contentDocument,t=this._takeMeasurements(),n=this.context.scene.dimensions.height,r=t.sheetWidth-this.context.profile.SCROLLBAR_WIDTH;this.frameBox.style.setProperty("width",r+"px");var i=this._reflowableMargins(n,r);this.stylize("pagination",["html {","height:"+n+"px !important;","margin:"+i.t+"px "+i.x+"px "+i.b+"px !important;","padding:0 !important;","word-wrap:break-word;","}"]);var s=e.documentElement.scrollHeight;e.body.offsetHeight+i.t+i.b<n?s=n:this.context.profile.quirks("top-margin-in-scrollheight")?s+=i.t:s+=i.t+i.b,this.frameBox.style.setProperty("height",s+"px"),this._solicitStylesForContent(),this._onContentStyled()},n}),define("lens/src/component_columned",["require","common"],function(e){var t={};return t._doMeasuring=function(e){this._loadContent(this._stepWork(function(){if(!this._checkWork(e))return;var t=this._applyPaginationStylesToContent();this._takeMeasurements(t,e)}.bind(this)))},t._doPriming=function(e){e.callback()},t._applyPaginationStylesToContent=function(){var e={};e.contentWidth=0,e.sheetWidth=0,e.sheetHeight=this.sheetBox.offsetHeight,e.pageWidth=this._computePageWidth(),e.margin=this._reflowableMargins(e.sheetHeight,e.pageWidth),this.block.pos=="center"&&(e.margin.x+=Math.floor(e.pageWidth*.25)),e.columnHeight=e.sheetHeight-(e.margin.t+e.margin.b),e.columnWidth=e.pageWidth-e.margin.x*2;var t=["html {","height:"+e.columnHeight+"px !important;","width:"+e.columnWidth+"px !important;","margin:"+e.margin.t+"px "+e.margin.x+"px "+e.margin.b+"px !important;","-webkit-column-width:"+e.columnWidth+"px !important;","-moz-column-width:"+e.columnWidth+"px !important;","-ms-column-width:"+e.columnWidth+"px !important;","column-width:"+e.columnWidth+"px !important;","-webkit-column-gap:"+e.margin.x*2+"px !important;","-moz-column-gap:"+e.margin.x*2+"px !important;","-ms-column-gap:"+e.margin.x*2+"px !important;","column-gap:"+e.margin.x*2+"px !important;","-webkit-column-fill:auto !important;","-moz-column-fill:auto !important;","-ms-column-fill:auto !important;","column-fill:auto !important;","padding: 0 !important;","word-wrap: break-word;","}","body {","margin: 0;","}","html * {","max-width:"+e.columnWidth+"px !important;","}","img, video, audio, object, svg {","max-height:"+e.columnHeight+"px !important;","box-sizing: border-box;","object-fit: contain;","-webkit-column-break-inside: avoid;","page-break-inside: avoid;","break-inside: avoid;","}"].join("");return this.stylizeContent("pagination",t),this._solicitStylesForContent(),e},t._takeMeasurements=function(e,t){this.metrics.widths.frame&&!this.context.profile.quirks("iframe-scrollwidth-expands-to-width")?e.appliedFrameWidth=this.metrics.widths.frame:e.appliedFrameWidth=0,this.frameBox.style.setProperty("width",e.appliedFrameWidth+"px"),this.frameBox.style.setProperty("height",e.sheetHeight+"px"),this._confirmMeasurements(e,t)},t._confirmMeasurements=function(e,t){if(!this._checkWork(t))return;e.attempts>1&&console.warn("[COMPONENT] (%s) re-measuring for:",e.attempts,this.index),this.DEBUG_COMPARE_RECTANGLES&&this._debugCompareRectangles(),e.attempts=(e.attempts||0)+1,e.contentWidth=this._computeContentWidth(),this.context.profile.modeFlags.constrainFrameWidth?e.sheetWidth=Math.min(this.context.scene.dimensions.width,e.contentWidth):e.sheetWidth=e.contentWidth;var n=e.appliedFrameWidth!=e.sheetWidth;e.attempts>3&&(n=e.appliedFrameWidth<e.sheetWidth),n?(this.frameBox.style.setProperty("width",e.sheetWidth+"px"),e.appliedFrameWidth=e.sheetWidth,setTimeout(this._confirmMeasurements.bind(this,e,t),0)):(this._onContentStyled(),t.callback({content:e.contentWidth,sheet:e.sheetWidth,frame:e.sheetWidth}))},t._computePageWidth=function(){return this.context.scene.dimensions.width*(this.block.spread?.5:1)},t._computeContentWidth=function(){var e=this.frameBox.contentDocument,t=this._computePageWidth();return Math.ceil(e.documentElement.scrollWidth/t)*t},t._reflowableMargins=function(e,t){var n=18,r=this.context.scene.textScaleData;if(r){var i=r[1]||16,s=r[0]||1;n=Math.round(i*s)}var o=1.4,u=n*.435,a=n*o,f=e/a,l=e*.82;if(f<=30){var c=Math.min(15,15-(f-15));l=e*(.88+.04*(c/15))}else f<=37?l=e*.875:f<=44&&(l=e*.85);var h=t*.82,p=h/u;if(f+5<a)h=t*.875;else if(h/l<.5)h=t*.85;else if(p<40){var d=Math.min(20,20-(p-20));h*=1+.15*(d/20)}else p>55?h=t*.805:p>=75&&(h=u*75);return l=Math.max(l,e-(t-h)*1.1),{t:Math.floor((e-l)*.4),b:Math.floor((e-l)*.6),x:Math.floor((t-h)*.5)}},t._debugCompareRectangles=function(){var t=this._.debugRects,n=this._.debugRects=[],r=this.frameBox.contentDocument,i=e("common");i.walk(r.documentElement,function(e){e.getBoundingClientRect&&n.push([e,e.getBoundingClientRect(),e.getAttribute("data-loc")])}),t&&t.length&&i.each(n,function(e,n){var r=e[1],i=t[n],s=i[1];s.height!=r.height&&console.warn("[DEBUG] expanded! (%s): h[%s => %s] w[%s => %s] ",e[2],s.height,r.height,s.width,r.width,e[0])})},t}),define("lens/src/spine",["require","common","./component","./component_scaled","./component_scrollable","./component_columned"],function(e){var t=e("common"),n=e("./component"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this.context=e,this._.components=[],this.length=0},i.build=function(e){this._.container=e,typeof this.context.map=="undefined"?console.warn("Context has no book map assigned. Cannot proceed."):t.each(this.context.map.components,this._buildComponent,this)},i.rebuild=function(){this.each(this._adjustComponent,this)},i.each=function(e,n){t.each(this._.components,e,n)},i.onionSkin=function(e,n,r){try{r&&(n=n.bind(r));var i=!0,s=!0,o=0,u=e.index,a=e,f=this._.components;n(a,o);for(;;){o+=1,(s=s&&(a=f[u-o]))&&n(a,o),(i=i&&(a=f[u+o]))&&n(a,o);if(!s&&!i)break}}catch(l){if(l!==t.BreakException)throw l}},i.first=function(){return this.byIndex(0)},i.last=function(){return this.byIndex(this.length-1)},i.byIndex=function(e){return this._.components[e]},i.byPosition=function(e){var t=this.first();while(t){if(t.spinePosition==e)return t;t=t.next}},i.byPath=function(e){var t=this.first();while(t){if(t.meta.path==e)return t;t=t.next}},i.byId=function(e){var t=this.first();while(t){if(t.id==e)return t;t=t.next}},i._buildComponent=function(e,t){var r=new n(this.context,e,this._.container);return r.chain(this._.components,t),r.spinePosition=e["-odread-spine-position"]||t,this._adjustComponent(r),this.length=this._.components.length,r},i._adjustComponent=function(e){var t=this._componentBehavior(e.meta["rendition-layout"]);e.behaveAs(t)},i._componentBehavior=function(t){return t=="pre-paginated"?e("./component_scaled"):this.context.profile.modeFlags.scrollingReflowables?e("./component_scrollable"):e("./component_columned")},r}),define("lens/src/ruler",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this.context=e,this.reset()},r.reset=function(){this._.frameOffsets={},this._.scaleFactors={}},r.spoolToComponent=function(e,t,n){var r=this._componentAt(e);if(!r){n||console.warn("[RULER] component not found at",e);return}if(!r.isLoaded()){n||console.warn("[RULER] component not loaded",r);return}var i={component:r},s=this.componentOffset(i.component),o=this.componentScale(i.component);return this.context.profile.reverse?i.x=Math.round((s.x+r.metrics.widths.real-e)/o.x):i.x=Math.round((e-s.x)/o.x),i.y=Math.round((t-s.y)/o.y),i.scaleX=o.x,i.scaleY=o.y,i.offsetX=s.x,i.offsetY=s.y,i},r.componentToSpool=function(e,t,n,r){if(!e.isLoaded()){r||console.warn("[RULER] component not loaded",e);return}var i={},s=this.componentOffset(e),o=this.componentScale(e);return this.context.profile.reverse?i.x=Math.round(e.metrics.widths.real+s.x-t*o.x):i.x=Math.round(s.x+t*o.x),i.y=Math.round(s.y+n*o.y),i.scaleX=o.x,i.scaleY=o.y,i.offsetX=s.x,i.offsetY=s.y,i},r.elementToSpool=function(e,t,n,r){var i=this.componentForDocument(e.ownerDocument);return this.componentToSpool(i,t,n,r)},r.rangeToSpool=function(e,t,n,r){var i=this.componentForDocument(e.startContainer.ownerDocument);return this.componentToSpool(i,t,n,r)},r.spoolToScene=function(e,t){var n={y:t};return this.context.profile.reverse?n.x=this.context.spool.aperture+(this.context.spool.cursor.real-e):n.x=e-this.context.spool.cursor.real,n},r.sceneToSpool=function(e,t){var n={y:t};return this.context.profile.reverse?n.x=this.context.spool.aperture-e+this.context.spool.cursor.real:n.x=e+this.context.spool.cursor.real,n},r.componentForDocument=function(e){var t=this.context.spine.first();while(t){if(t.frameBox&&t.frameBox.contentDocument===e)return t;t=t.next}},r.componentOffset=function(e){var t=this._.frameOffsets[e.index];t||(t=this._.frameOffsets[e.index]={x:e.frameBox.offsetLeft,y:e.frameBox.offsetTop+e.sheetBox.offsetTop});var n={y:t.y};return this.context.profile.reverse?n.x=e.metrics.heads.real-t.x:n.x=e.metrics.heads.real+t.x,n},r.componentScale=function(e){if(!this._.scaleFactors[e.index])if(e.block.layout=="reflowable")this._.scaleFactors[e.index]={x:1,y:1};else{var t=e.frameBox,n=this._scaleFactor(t),r=this._scaleFactor(t.contentDocument.documentElement);this._.scaleFactors[e.index]={x:n.x*r.x,y:n.y*r.y}}return this._.scaleFactors[e.index]},r._componentAt=function(e){var t=this.context.spine.first();while(t){if(t.metrics&&t.metrics.heads.real<=e&&t.metrics.tails.real>e)return t;t=t.next}},r._scaleFactor=function(e){var t={x:1,y:1},n=e.ownerDocument.defaultView,r=n.getComputedStyle(e),i=r.getPropertyValue("-webkit-transform")||r.getPropertyValue("-moz-transform")||r.getPropertyValue("-ms-transform")||r.getPropertyValue("-o-transform")||r.getPropertyValue("transform");if(i&&i.match(/^matrix/)){var s=i.split("(")[1];s=s.split(")")[0],s=s.split(",");var o=s[0],u=s[1],a=s[2],f=s[3];t.x=Math.sqrt(o*o+u*u),t.y=Math.sqrt(a*a+f*f)}return t},n}),define("lens/src/context",["require","common","./utils","./map","./profile","./scene","./spool","./spine","./ruler"],function(e){var t=e("common"),n=e("./utils"),r=e("./map"),i=e("./profile"),s=e("./scene"),o=e("./spool"),u=e("./spine"),a=e("./ruler"),f=t.Class.new(),l=f.prototype;return l.$init=function(e){e=e||{},this.utils=new n(this),this.profile=null,this.scene=null,e.map instanceof r?this.assignMap(e.map):typeof e.map=="object"&&this.assignMap(new r(e.map)),typeof e.dispatcher=="function"&&this.assignDispatcher(e.dispatcher),this.assignBank(e.bank),this.createProfile(e.quirks||null),typeof e.scene=="object"&&this.createScene(e.scene),this.ruler=new a(this)},l.assignMap=function(e){this.map=e},l.assignDispatcher=function(e){this._.dispatcher=e},l.assignBank=function(e){if(e)this.bank=e;else if(typeof window.localStorage!="undefined")this.bank={get:function(e){var t=localStorage.getItem(e);return t?JSON.parse(t):null},set:function(e,t){localStorage.setItem(e,JSON.stringify(t))}};else{var t={};this.bank={get:function(e){return t[e]},set:function(e,n){t[e]=n}}}},l.dispatch=function(e,t,n){if(typeof this._.dispatcher=="function"){t=t||{},t.context=this;var r=this._.dispatcher(e,t,n);return n&&r===!1?!1:!0}},l.createProfile=function(e){if(this.scene)throw"Cannot reinstantiate profile after scene has been created.";return this.profile=new i(this,e)},l.createScene=function(e){if(this.scene)throw"Cannot reinstantiate scene with new parent node: "+e;if(typeof e!="object")throw"Creation of the scene requires scene element as argument.";return this.profile||this.createProfile(),this.profile.autoPilot(),this.scene=new s(this,e),this.dispatch("lens:context:scene",{scene:this.scene}),this.scene},l.createSpool=function(e){this.spool=new o(this),this.spool.build(e),this.dispatch("lens:context:spool",{spool:this.spool})},l.createSpine=function(e){this.spine=new u(this),this.spine.build(e),this.dispatch("lens:context:spine",{spine:this.spine})},f}),define("lens/lens",["require","./src/context","./src/utils","./src/map","./src/profile","./src/scene","./src/spool","./src/spine","./src/sequence","./src/dub","./src/metrics","./src/component","./src/component_scaled","./src/component_columned","./src/component_scrollable"],function(e){var t={};return t.Context=e("./src/context"),t.Utils=e("./src/utils"),t.Map=e("./src/map"),t.Profile=e("./src/profile"),t.Scene=e("./src/scene"),t.Spool=e("./src/spool"),t.Spine=e("./src/spine"),t.Sequence=e("./src/sequence"),t.Dub=e("./src/dub"),t.Metrics=e("./src/metrics"),t.Component=e("./src/component"),t.ComponentScaled=e("./src/component_scaled"),t.ComponentColumned=e("./src/component_columned"),t.ComponentScrollable=e("./src/component_scrollable"),t}),define("lens",["lens/lens"],function(e){return e}),define("glaze/src/surface",["require","common","gala"],function(e){var t=e("common"),n=e("gala"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this._.owner=e,this._.surfaces=[]},i.setOrigin=function(e){this._.origin=e,typeof e.contentDocument!="undefined"?(this._.root=e.contentDocument.documentElement,this._.subtree=this._.root):(this._.root=e.ownerDocument.documentElement,this._.subtree=e),this._.handler&&this._.handler.deafen();var t=this._prepareContact.bind(this);this._.handler=new n.ContactHandler(this._.subtree,{start:t,move:t,end:t,cancel:t},{multitouch:!0})},i.findSurfaces=function(){try{var e=this._.subtree.querySelectorAll("iframe");t.each(e,this._buildSurface,this),this._enableSurface()}catch(n){console.warn("Non-fatal failure finding sub-surfaces",n),this._disableSurface()}return this._.surfaces},i.cascade=function(e){if(typeof e=="string"){var n=e;e=function(e){e[n]()}}e(this),t.each(this._.surfaces,e)},i.listenForStart=function(){!this._.listening&&!this.disabled&&(this._.handler.listen(),this._.listening=!0)},i.handleContact=function(e){this._.owner&&typeof this._.owner.handleContact=="function"?this._.owner.handleContact(e):this.warn("[GLAZE] Owner cannot handleContact: %o",this._.owner)},i._buildSurface=function(e){var t=e.contentDocument.documentElement;if(!t)return;var n;for(var i=0,s=this._.surfaces.length;i<s;++i){n=this._.surfaces[i];if(!n.disabled&&n._.root===t)return n}return n=new r(this),n.setOrigin(e),this._.surfaces.push(n),n},i._prepareContact=function(e){var t={event:e,contactType:e.contactType,contactIndex:e.contactIndex,surface:this};t.point={x:t.event.clientX,y:t.event.clientY,document:e.target.ownerDocument},t.canceled=e.defaultPrevented||this._hasActiveSelection(),this.handleContact(t)},i._hasActiveSelection=function(){var e=this._.subtree.ownerDocument.defaultView;return!e.getSelection().isCollapsed},i._disableSurface=function(){this.disabled||(this.disabled=!0)},i._enableSurface=function(){this.disabled&&(this.disabled=!1)},r}),define("glaze/src/glazier",["require","common","gala","./surface"],function(e){var t=e("common"),n=e("gala"),r=e("./surface"),i=r.new(),s=i.prototype;return s.$init=function(e,t){r.prototype.$init.call(this,e),this._.clients=[],this._.action={},this._.offsetParent=t,this.setOrigin(e),this.updateSurfaces()},s.addClient=function(e){e.options=e.options||{},e.options.priority?this._.clients.unshift(e):this._.clients.push(e)},s.removeClient=function(e){t.excise(this._.clients,e)},s.handleContact=function(e){e.contactType=="start"?this._handleStart(e):e.contactType=="move"?this._handleMove(e):e.contactType=="end"?this._handleEnd(e):e.contactType=="cancel"&&this._handleCancel(e)},s.updateSurfaces=function(){this.cascade("findSurfaces"),this.cascade("listenForStart")},s._handleStart=function(e){this._.action.start&&this._notifyCancel();if(e.canceled)return this._resetAction();this._updateAction(e),this._dispatchAction()?this._notifyContact("start"):this._resetAction()},s._handleMove=function(e){this._updateAction(e),!e.canceled&&this._dispatchAction()?this._notifyContact(e.contactType,e.contactIndex):this._notifyCancel()},s._handleEnd=function(e){this._handleMove(e),this._resetAction()},s._handleCancel=function(e){this._updateAction(e),this._.action.creationTime?this._notifyCancel():this._resetAction()},s._updateAction=function(e){var t=this._.action;if(this._.offsetParent){var n=this._.offsetParent.getBoundingClientRect();e.point.x-=n.left,e.point.y-=n.top}typeof t.creationTime!="number"&&(t.creationTime=(new Date).getTime(),t.start=e.point),t.point=e.point,t.currentType=e.contactType,t.originalEvent=e.event,t.elapsedTime=(new Date).getTime()-t.creationTime},s._dispatchAction=function(){var e="glaze:contact:"+this._.action.currentType;return n.dispatch(this._.origin,e,this._.action)},s._resetAction=function(){this._.action={}},s._notifyContact=function(e,n){var r="onContact"+e[0].toUpperCase()+e.slice(1);t.each(this._.clients,function(e){if(n&&!e.options.multitouch)return;this._.action.client?this._.action.client===e?this._clientInvoke(e,r):this._clientInvoke(e,"onContactHandled"):this._clientInvoke(e,r)&&(this._setClient(e),this._.action.originalEvent.retainDefault||this._.action.originalEvent.preventDefault())},this)},s._setClient=function(e){this._.action.client=e,t.each(this._.clients,function(e){this._.action.client!==e&&this._clientInvoke(e,"onContactCancel")},this)},s._notifyCancel=function(e){t.each(this._.clients,function(e){var t;!this._.action.client||this._.action.client===e?t="onContactCancel":t="onContactHandled",this._clientInvoke(e,t)},this),this._resetAction()},s._clientInvoke=function(e,t){if(typeof e[t]=="function")return e[t](this._.action)},i}),define("glaze/glaze",["require","./src/glazier"],function(e){return e("./src/glazier")}),define("glaze",["glaze/glaze"],function(e){return e}),define("bifocal/themes/read/default/src/parts/place",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this._fresh(),this._prime(e)},r.isFinite=function(){return this._.finite},r.isSeekable=function(){return typeof this.floc=="number"},r.match=function(e){for(var t in e)if(e.hasOwnProperty(t)&&this._[t]!==e[t])return!1;return!0},r.overlaps=function(e){return typeof this.flocA=="undefined"?!1:typeof e.flocA=="undefined"?!1:this.flocA==e.flocA?!0:!(this.flocA>=e.flocZ||this.flocZ<=e.flocA)},r.component=function(){return this._.component?this._.component:BIF.context.spine?typeof this.floc!="number"?null:this._.component=BIF.context.spine.byIndex(Math.floor(this.floc)):null},r.seek=function(){BIF.objects.compass.seek(this.path||this.floc)},r.toHash=function(){return{uuid:this.uuid,timestamp:Math.round(this.timestamp/1e3),percentageOfBook:this.percentageOfBook,spinePosition:this.spinePosition,percentageOfComponent:this.percentageOfComponent,pageSizePercentage:this.pageSizePercentage}},r.toHumanString=function(){if(this.pages.head&&this._.finite)return this.pages.join("&ndash;");if(isFinite(this.percentageOfBook))return Math.round(this.percentageOfBook*100)+"%"},r.refresh=function(){this._setFiniteness(),this._setPages(this.pages||[]),this._recompute({region:!0})},r._fresh=function(){this._={},this.timestamp=t.epochMilliseconds(),this.uuid=t.generateUUID(),this._setFiniteness(),this._setPages([])},r._prime=function(e){if(typeof e=="undefined"||e==null)return;typeof e=="string"&&(e=parseFloat(e)),typeof e=="number"&&isFinite(e)&&(e={region:e}),typeof e.path=="string"&&(this.path=e.path);var t={region:!1,pages:!1,pcob:!1};typeof e.region!="undefined"&&e.region!=null&&(t.region=this._setRegion(e.region)),typeof e.pages!="undefined"&&e.pages!=null&&(t.pages=this._setPages(e.pages)),typeof e.percentageOfBook!="undefined"&&e.percentageOfBook!=null&&(t.pcob=this._setPercentageOfBook(e.percentageOfBook)),this._recompute(t)},r._recompute=function(e,n){n&&t.absorb(n,e);if(!e.region&&this.path){var r=this._pathToFloc(this.path);if(typeof r=="number")return this._setRegion(r),this._recompute(e,{region:!0})}if(e.region&&!e.pcob)return this.percentageOfBook=this._flocToPercentageOfBook(this.floc),this._recompute(e,{pcob:!0});if(e.pcob&&!e.region)return this._setRegion(this._percentageOfBookToFloc(this.percentageOfBook)),this._recompute(e,{region:!0});if(e.pcob&&!e.pages&&this._.finite)return this._setPages(1+this.percentageOfBook*this.pages.total),this._recompute(e,{pages:!0});if(e.pages&&!e.pcob&&this._.finite)return this.percentageOfBook=(this.pages.head-1)/this.pages.total,this._recompute(e,{pcob:!0});var i=this.component();i&&(this.spinePosition=i.spinePosition,this.percentageOfComponent=this.floc%1,this.pageSizePercentage=this._pageSizePercentage(this),this.chapter=this._chapterAtRegion(this))},r._setFiniteness=function(){this._.finite=BIF.context.spool&&BIF.context.spool.dub&&BIF.context.spool.dub.ambit.complete},r._setRegion=function(e){return typeof e=="number"&&(e={flocA:e,flocM:e,flocZ:e}),this.flocA=t.smoothFloat(parseFloat(e.flocA)),this.flocM=t.smoothFloat(parseFloat(e.flocM)),this.flocZ=t.smoothFloat(parseFloat(e.flocZ)),this.floc=this.flocM,!0},r._setPages=function(e){typeof e=="string"&&(e=parseInt(e,10)),typeof e=="number"&&(e=[e]),isFinite(e[0])||(e=[]),this.pages=[];for(var n=0,r=e.length;n<r;++n)this.pages.push(Math.max(1,Math.floor(t.smoothFloat(e[n]))));this.pages.head=this.pages[0],this.pages.tail=this.pages[this.pages.length-1];var i=this.component();return i&&i.block?this.pages.spread=i.block.spread:this.pages.spread=this.pages.head!==this.pages.tail,BIF.context.spool&&BIF.context.spool.pages?this.pages.total=BIF.context.spool.pages.total:this.pages.total=Infinity,this.pages.head=Math.min(this.pages.head,this.pages.total),this.pages.tail=Math.min(this.pages.tail,this.pages.total),!0},r._setPercentageOfBook=function(e){return e=parseFloat(e),e>=0&&e<=1?(this.percentageOfBook=Math.min(e,.999999999),!0):(console.warn("percentageOfBook: must be between 0 and 1 -- ",e),!1)},r._pageSizePercentage=function(){return this.flocZ-(this.pages.spread?this.flocM:this.flocA)},r._pathToFloc=function(e){var t=BIF.context.spool.resolve(e);if(t&&typeof t.percent=="number")return t.component.index+t.percent},r._flocToPercentageOfBook=function(e){var t=this._componentProportions(),n=0;for(var r=0;r<Math.floor(e);++r)n+=t[r];return n+=t[r]*(e%1),n/t.total},r._percentageOfBookToFloc=function(e){var t=this._componentProportions(),n=0;for(var r=0,i=t.length;r<i;++r){var s=t[r]/t.total;if(n+s>=e)return r+(e-n)/s;n+=s}},r._componentProportions=function(){var e=[];return e.add=function(e){this.push(e),this.total=(this.total||0)+e},this._.finite?BIF.context.spine.each(function(t){e.add(t.metrics.widths.virtual)}):t.each(BIF.map.spine,function(t){e.add(t["-odread-file-bytes"]||1)}),e},r._chapterAtRegion=function(){var e=BIF.objects.compass.chapters[0],t;while(e){e.place.flocA<this.flocZ&&(t=e);if(e.place.flocZ>=this.flocZ)break;e=e.next}return t},n}),define("bifocal/themes/read/default/src/parts/chapter_manager",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(){this._.archive=[],this._listen()},r._listen=function(){BIF.listen("lens:context:spine",this._assembleChapters.bind(this)),BIF.listen("lens:scene:rebuild",this._restorePlacesFromArchive.bind(this)),BIF.listen("lens:dub:save",this._onLensDubSave.bind(this)),BIF.listen("lens:dub:load",this._onLensDubLoad.bind(this)),BIF.listen("lens:component:walkable",this._resolveWithinComponent.bind(this))},r._announceChapters=function(){BIF.dispatch("bifocal:chapters",{chapters:this.chapters})},r._assembleChapters=function(e){this.chapters=[],this._.unresolvedChapters=[],t.each(BIF.context.map.chapters,function(e){var t=this._transformChapter(e,0);this.chapters.push(t),t.place.path.indexOf("#")>=0&&this._.unresolvedChapters.push(t)},this),delete this._.lastAssembledChapter},r._transformChapter=function(e,n){var r={title:e.title,level:n};return this._placeForChapter(r,{path:e.path}),(r.prev=this._.lastAssembledChapter)?(r.prev.next=r,r.index=r.prev.index+1):r.index=0,r.path=r.place.isSeekable()?r.place.path:null,this._.lastAssembledChapter=r,e.contents&&(r.contents=[],t.each(e.contents,function(e){r.contents.push(this._transformChapter(e,n+1))},this)),r},r._restorePlacesFromArchive=function(){var e=[],t=this._unarchiveChapterFlocs(this._dubName())||[];this._eachChapter(function(n,r){typeof t[r]=="number"&&t[r]!=n.place.floc?this._placeForChapter(n,{path:n.path,region:t[r]}):n.place.path.indexOf("#")>=0&&e.push(n)}.bind(this)),this._.unresolvedChapters=e,this._announceChapters()},r._resolveWithinComponent=function(e){var n=[],r=e.m.component;t.each(this._.unresolvedChapters,function(e){if(Math.floor(e.place.floc)!=r.index)return n.push(e);var t=e.place.floc;this._placeForChapter(e,{path:e.path}),e.place.floc!=t&&(e.path=e.place.isSeekable()?e.place.path:null)},this),this._.unresolvedChapters=n},r._archiveChapters=function(){var e=[];return this._eachChapter(function(t,n){e[n]=t.place.floc}),this._archiveChapterFlocs(e,this._dubName()),e},r._archiveChapterFlocs=function(e,t){for(var n=0,r=this._.archive.length;n<r;++n)if(this._.archive[n][0]==t){this._.archive[n][1]=e;return}e.length&&(this._.archive.unshift([t,e]),this._.archive.splice(8))},r._unarchiveChapterFlocs=function(e){for(var t=0,n=this._.archive.length;t<n;++t)if(this._.archive[t][0]==e)return this._.archive[t][1]},r._onLensDubSave=function(e){this._eachChapter(function(e){e.place.refresh()}),e.m.pkg.chapterPlaces=this._archiveChapters(),this._announceChapters()},r._onLensDubLoad=function(e){var n=[];t.each(e.m.pkg.chapterPlaces,function(e){e instanceof Array?n.push(e[0]):n.push(e)}),n.length&&this._archiveChapterFlocs(n,e.m.pkg.name)},r._dubName=function(){return BIF.context.spool&&BIF.context.spool.dub?BIF.context.spool.dub.name:t.generateUUID()},r._eachChapter=function(e){var t=this.chapters[0],n=0;while(t)e(t,n),t=t.next,n+=1},r._placeForChapter=function(e,t){return e.place=BIF.objects.compass.at(t),e.place.chapter=e,e.place},n}),define("bifocal/themes/read/default/src/parts/compass",["require","common","./place","./chapter_manager"],function(e){var t=e("common"),n=e("./place"),r=e("./chapter_manager"),i=t.Class.new(),s=i.prototype;return s.$init=function(){this.place=new n,this.chapters=[],this._.landmarks={},this._.chapterManager=new r,BIF.listen("lens:spool:region",this._onLensRegion.bind(this)),BIF.listen("bifocal:chapters",this._onChapters.bind(this))},s.at=function(e){return new n(e)},s.seek=function(e,t){var n=BIF.context.spool.resolve(e);return n?(this._jumping(),BIF.context.spool.seek(n,t),!0):!1},s.landmarks=function(e,t){var n=this._.landmarks[e]=this._.landmarks[e]||[];t(function(t,r,i){var s={type:e,id:t,place:r,meta:i||{}};for(var o=0,u=n.length;o<u;++o)if(n[o]["type"]==e&&n[o]["id"]==t)return n[o]=s;n.push(s)}),this._.landmarkTimer||(this._.landmarkTimer=setTimeout(this._announceLandmarks.bind(this),0))},s._announceLandmarks=function(){t.each(this._.landmarks,function(e,t){BIF.dispatch("bifocal:landmarks:group",{name:e,items:t})}),this._.landmarks={},this._.landmarkTimer=null},s._onChapters=function(e){this.chapters=e.m.chapters,this.landmarks("chapter",function(e){var n=function(r){e(r.index,r.place,{title:r.title,level:r.level}),r.contents&&t.each(r.contents,n)};t.each(this.chapters,n)}.bind(this))},s._onLensRegion=function(e){var t=this.place?this.place.spinePosition:null;this.place=this.at({region:e.m.region,pages:BIF.context.spool.pages.here}),BIF.dispatch("bifocal:place",{place:this.place,restored:e.m.restored,repeated:e.m.repeated}),this.place.match({spinePosition:t})||BIF.dispatch("bifocal:component:active",{component:this.place.component()})},s._jumping=function(){this._.jumper=BIF.events.on("lens:spool:region",this._jumped.bind(this)),BIF.root.classList.add("jumping"),BIF.dispatch("bifocal:jumping",{place:this.place})},s._jumped=function(){this._.jumper.deafen(),BIF.root.classList.remove("jumping"),BIF.dispatch("bifocal:jumped",{place:this.place})},i}),define("bifocal/themes/read/default/src/parts/seeker",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.INTERVAL=90,r.$init=function(){this._listen()},r._listen=function(){BIF.listen("bifocal:place",this._onPlace.bind(this)),BIF.listen("bifocal:seeking",this._onSeeking.bind(this)),BIF.listen("bifocal:seeked",this._onSeeked.bind(this))},r._onPlace=function(e){this.seeking||this._deferEvent(e,"place")},r._onSeeking=function(e){this.seeking=!0,this._deferEvent(e,"seek")},r._onSeeked=function(e){this.seeking=!1,this._deferEvent(e,"seek")},r._queueEvent=function(e,n){this._.pendingEvtData=t.absorb(e.m,{mode:n,source:"unknown"})},r._deferEvent=function(e,t){this._queueEvent(e,t),this._.timer=this._.timer||setTimeout(this._announceEvent.bind(this),this.INTERVAL)},r._announceEvent=function(){this._.pendingEvtData&&(BIF.dispatch("bifocal:seeker:place",this._.pendingEvtData),this._.pendingEvtData=null),clearTimeout(this._.timer),this._.timer=null},n}),define("bifocal/themes/read/default/src/parts/reader",["require","common","./quirks","lens","dervish","glaze","./compass","./seeker"],function(e){var t=e("common"),n=e("./quirks"),r=e("lens"),i=e("dervish"),s=e("glaze"),o=e("./compass"),u=e("./seeker"),a=t.Class.new(),f=a.prototype;return f.$init=function(e){this._.sceneContainer=e},f.open=function(){BIF.reader=this,BIF.dispatch("bifocal:reader:opening",{reader:this}),BIF.listen("lens:context:scene",this._onSceneInitialized.bind(this)),BIF.listen("lens:scene:factors",this._onSceneFactors.bind(this)),BIF.listen("lens:context:spool",this._onSpoolInitialized.bind(this)),BIF.listen("lens:profile:direction",this._onDirection.bind(this)),BIF.listen("lens:component:modify",this._modifyComponent.bind(this)),BIF.listen("lens:spool:unhealthy",this._onSpoolUnhealthy.bind(this)),this._.bookMap=new r.Map(BIF.map),this._.codec=new i.Codec,this._.bookMap.assignFetcher(this._chooseComponentFetcher()),BIF.dispatch("bifocal:reader:map",{reader:this,map:this._.bookMap}),BIF.context=this._.context=new r.Context({map:this._.bookMap,dispatcher:BIF.dispatch,bank:BIF.bank.title,quirks:n}),BIF.map["i18n-page-progression-direction"]=="rtl"&&BIF.context.profile.setDirection("rtl"),BIF.dispatch("bifocal:reader:context",{reader:this,context:BIF.context}),BIF.objects.compass=new o,BIF.objects.seeker=new u,this._.context.createScene(this._.sceneContainer)},f._onSceneInitialized=function(e){var t=e.m.scene;BIF.listen("bifocal:mode:resize",function(){t.rebuild()}),BIF.dispatch("bifocal:reader:ready",{reader:this,scene:t});var n=function(){BIF.deafen("lens:scene:rebuild",n),BIF.dispatch("bifocal:reader:built",{reader:this,scene:t})};BIF.listen("lens:scene:rebuild",n)},f._onSceneFactors=function(e){e.m.factors.dub.access=BIF.map["-odread-msg-access"]||"f",e.m.factors.dub.theme=BIF.tData.theme,e.m.factors.dub.version=20},f._onSpoolInitialized=function(e){BIF.tData["approx-mode"]&&!BIF.objects.codex.fullyPrepaginated()&&(e.m.spool.approxMode=!0)},f._onDirection=function(e){var n=e.m.direction;n=="rtl"&&(BIF.context.profile.DEFAULT_POSITION="left"),t.DataClass.set(BIF.root,"dir",n)},f._modifyComponent=function(e){typeof window._SHIM_addClassListToView=="function"&&window._SHIM_addClassListToView(e.m.doc.defaultView),e.m.doc.documentElement.classList.add("RS-BIFOCAL"),BIF.dispatch("bifocal:component:modify",e.m)},f._onSpoolUnhealthy=function(){BIF.dispatch("bifocal:notify:dialog",{headingText:"Reload pages?",promptText:["These pages did not load successfully, ","perhaps due to network problems."].join(""),actions:{ok:{html:"Try again",onTap:function(){BIF.context.spool.dub.heal(),BIF.dispatch("bifocal:notify:close")}}}})},f._chooseComponentFetcher=function(){if(BIF.state.development){var e=0;return function(t,n){setTimeout(function(){n({url:t})},e)}}return n("load-components-via-xhr")?this._fetchHTML.bind(this):this._fetchURL.bind(this)},f._fetchURL=function(e,t){var r=e;n("supply-message-in-referrer")&&(r+="&m="+BIF.map["-odread-msg-m"]),t({url:r})},f._fetchHTML=function(e,t){var r=e;n("supply-message-in-referrer")&&(this._.context.profile.BASE_URL="/_d/base/"+BIF.map["-odread-msg-m"]),BIF.network.sendRequest(r,{success:function(e){t({html:e})}})},a}),define("bifocal/themes/read/default/src/parts/chapticker",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this._.parts=this._layout(e),this._listen()},r._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"chapticker"}),n.chapter=t.element({parentNode:n.box,classes:"chapticker-chapter"}),n.chapterTitle=t.element({tag:"span",parentNode:n.chapter,classes:"chapticker-chapter-title",html:"â â"}),n},r._listen=function(){BIF.listen("bifocal:seeker:place",this._onPlace.bind(this))},r._onPlace=function(e){this._updateToPlace(e.m.place)},r._updateToPlace=function(e){if(!this._.chapter||this._.chapter!=e.chapter){this._.chapter=e.chapter;var t=this._.chapter?this._.chapter.title:BIF.objects.codex.title();this._.parts.chapterTitle.innerHTML=t}},n}),define("bifocal/themes/read/default/src/parts/page_numbers",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.BANK_KEY_SCOPE="pagenumbers:scope",r.SCOPES=["book","chapter","percent"],r.$init=function(e){this._.parts=this._layout(e),this._listen(),BIF.state.pageNumberScope=BIF.bank.global.get(this.BANK_KEY_SCOPE)||this.SCOPES[0],this._update(BIF.state.pageNumberScope,BIF.objects.compass.place)},r.toggle=function(){var e=this.SCOPES.indexOf(BIF.state.pageNumberScope),t=(e+1)%this.SCOPES.length;BIF.state.pageNumberScope=this.SCOPES[t],BIF.bank.global.set(this.BANK_KEY_SCOPE,BIF.state.pageNumberScope),BIF.objects.activity.record("page-numbers-switch",{display:BIF.state.pageNumberScope}),this._update(BIF.state.pageNumberScope,BIF.objects.compass.place)},r._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"pgnum-box"}),n.unknown=t.element({parentNode:n.box,classes:"pgnum-unknown"}),n.percent=t.element({parentNode:n.box,classes:"pgnum-percent"}),t.element({tag:"span",parentNode:n.percent,classes:"pgnum-context",html:"At&nbsp;"}),n.percentValue=t.element({tag:"span",parentNode:n.percent}),n.book=t.element({parentNode:n.box,classes:"pgnum-book"}),n.bookPage=t.element({tag:"span",parentNode:n.book}),t.element({tag:"span",parentNode:n.book,classes:"pgnum-context",html:"&nbsp;of&nbsp;"}),n.bookTotal=t.element({tag:"span",parentNode:n.book}),n.chapter=t.element({parentNode:n.box,classes:"pgnum-chapter"}),n.chapterPage=t.element({tag:"span",parentNode:n.chapter}),t.element({tag:"span",parentNode:n.chapter,classes:"pgnum-context",html:"<span>&nbsp;left</span>&nbsp;in&nbsp;chapter"}),n},r._listen=function(){BIF.listen("bifocal:seeker:place",this._onPlace.bind(this)),BIF.events.onTap(this._.parts.box,this.toggle.bind(this))},r._update=function(e,n){n.isFinite()||(e=isFinite(n.percentageOfBook)?"percent":"unknown"),this._.appliedScope!=e&&(this._.appliedScope=e,t.DataClass.set(BIF.root,"pgnum-scope",e));if(e=="unknown")this._.parts.unknown.innerHTML="--";else if(e=="percent"){var r=Math.round(n.percentageOfBook*100);this._.parts.percentValue.innerHTML=r+"%"}else e=="book"?(this._.parts.bookPage.innerHTML=n.toHumanString(),this._.parts.bookTotal.innerHTML=n.pages.total):e=="chapter"&&(this._.parts.chapterPage.innerHTML=this._pagesLeftInChapter(n))},r._pagesLeftInChapter=function(e){if(!isFinite(e.floc))return"--";var t=e.chapter?e.chapter.next:BIF.objects.compass.chapters[0];if(t&&t.place&&t.place.pages.head&&e.pages.head)pp=t.place.pages.head-e.pages.head;else{var n=BIF.context.spine.byIndex(Math.floor(e.floc));if(!n.metrics||!n.metrics.pages)return"--";var r=1;t&&Math.floor(t.place.floc)==n.index&&(r=t.place.floc%1);var i=e.floc%1;pp=Math.ceil(n.metrics.pages*(r-i));if(t&&r!=1)while(n=n.next){var s=Math.min(t.place.floc-n.index,1);if(!n.metrics||!n.metrics.pages||s<=0)break;pp+=n.metrics.pages*s}}return Math.max(0,pp-(e.pages.spread?2:1))},r._onPlace=function(e){var t=e.m.mode=="seek"?"book":BIF.state.pageNumberScope;t=BIF.state.pageNumberScope,this._update(t,e.m.place)},n}),define("bifocal/themes/read/default/src/parts/timeline",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.MOVE_THRESHOLD_PX=8,r.CRUMB_COUNT=1,r.CRUMB_CONTACT_WIDTH=32,r.$init=function(e){this._.needlePercent=0,this._.box=e,this._.parts=this._layout(e),this._.crumbs={},this._.tapTracker=[],this._listen(),this._updateNeedle(),setTimeout(this._animate.bind(this),0)},r._layout=function(e){var n={};return n.track=t.element({parentNode:e,classes:"timeline-track"}),n.progress=t.element({parentNode:n.track,classes:"timeline-progress"}),n.needle=t.element({parentNode:n.track,classes:"timeline-needle"}),n},r._listen=function(){BIF.listen("bifocal:seeker:place",this._updateNeedle.bind(this)),BIF.listen("bifocal:mode:resize",this._onModeResize.bind(this)),BIF.listen("bifocal:history",this._updateCrumbs.bind(this)),this._.handler=BIF.events.onContact(this._.box,{start:this._onContactStart.bind(this),move:this._onContactMove.bind(this),end:this._onContactEnd.bind(this),cancel:this._onContactCancel.bind(this)},{cancelOnLeave:this._.box.parentNode.parentNode})},r._animate=function(){this._.parts.track.classList.add("timeline-animating")},r._onModeResize=function(e){this._.initialized&&(this._updateDimensions(),this._updateNeedle())},r._updateDimensions=function(){var e=this._.parts.track.getBoundingClientRect();return this._.dims={left:e.left,width:e.width},this._updateCrumbs(),this._.dims},r._updateNeedle=function(e){this._.initialized||(this._.initialized=!0,this._updateDimensions());var t=0;try{e&&typeof e.m.place.percentageOfBook=="number"?t=e.m.place.percentageOfBook:t=BIF.objects.possession.data.position.percentageOfBook||0}catch(n){}(!e||e.m.source!="timeline"&&!this._.contact)&&this._moveNeedle(t)},r._updateCrumbs=function(){if(!BIF.objects.historyManager)return;var e=t.epochMilliseconds(),n=this.CRUMB_COUNT,r=BIF.objects.historyManager.history.slice(0,n);t.each(r,function(t,n){var r=this._.crumbs[t.uuid]||this._createCrumb(t);this._.crumbs[t.uuid]=r,r.stamp=e,this._updateCrumb(r)},this),t.each(this._.crumbs,function(t,n){n.discarded&&(n.box.parentNode.removeChild(n.box),delete this._.crumbs[t]),n.stamp!=e&&(n.box.classList.remove("show"),n.discarded=!0)},this)},r._createCrumb=function(e){var n;return t.each(this._.crumbs,function(e,t){t.discarded&&(n=t,delete this._.crumbs[e])},this),n||(n={},n.box=t.element({parentNode:this._.parts.track,classes:"timeline-crumb"})),n.place=e,n.discarded=!1,n},r._updateCrumb=function(e){var t=(this._.dims.width-1)*e.place.percentageOfBook;e.box.style.setProperty("left",t+"px"),e.box.classList.contains("show")||setTimeout(function(){e.box.classList.add("show")},0)},r._seekToPercent=function(e){BIF.objects.compass.at({percentageOfBook:e}).seek()},r._moveNeedle=function(e){if(this._.dims){this._.needlePercent=e;var n=this._.parts.needle.offsetWidth*.5,r=this._.dims.width*e-n,i="translate3d("+r+"px,0,0)";t.prefixProperty(this._.parts.needle.style,"transform",i);var s="scaleX("+e+")";t.prefixProperty(this._.parts.progress.style,"transform",s)}},r._onContactStart=function(e){this._updateDimensions(),this._.contact={originPercent:this._.needlePercent,originX:this._.needlePercent*this._.dims.width,startX:this._relativeX(e.pageX)},BIF.events.stop(e)},r._onContactMove=function(e){var n=this._.contact;if(!n)return;var r=this._relativeX(e.pageX);if(n.moved||Math.abs(n.startX-r)>=this.MOVE_THRESHOLD_PX){var i=Math.abs(n.originX-r)<this.MOVE_THRESHOLD_PX,s=(i?n.originX:r)/this._.dims.width;n.lastPercent=Math.max(0,Math.min(s,1)),this._moveNeedle(n.lastPercent),BIF.dispatch("bifocal:seeking",this._seekEventData()),BIF.root.classList.add("grabbing"),t.prefixProperty(this._.parts.needle.style,"transition","none"),n.moved=!0}},r._onContactEnd=function(e){if(this._.contact&&this._.contact.moved)this._.needlePercent!=this._.contact.originPercent&&(this._moveNeedle(this._.contact.lastPercent),this._seekToPercent(this._.contact.lastPercent)),BIF.dispatch("bifocal:seeked",this._seekEventData());else if(this._.contact){var n=this._.contact.startX,r=null,i=Infinity;t.each(this._.crumbs,function(e,t){if(t.discarded)return;var s=this._distFromCrumb(t,n);s<i&&(r=t,i=s)},this),r?BIF.objects.historyManager.seekToHistory(r.place):this._tappedNothing()}this._resetContact()},r._onContactCancel=function(e){this._.contact&&(this._.contact.lastPercent=this._.contact.originPercent,this._onContactEnd(e))},r._seekEventData=function(){return{source:"timeline",place:BIF.objects.compass.at({percentageOfBook:this._.needlePercent})}},r._resetContact=function(e){BIF.root.classList.remove("grabbing"),t.prefixProperty(this._.parts.needle.style,"transition"),this._.contact=null},r._distFromCrumb=function(e,t){if(!e)return Infinity;var n=e.box.getBoundingClientRect(),r=this._relativeX(n.left+n.width*.5),i=Math.abs(r-t);return i<this.CRUMB_CONTACT_WIDTH*.5?i:Infinity},r._relativeX=function(e){return BIF.context&&BIF.context.profile&&BIF.context.profile.reverse?this._.dims.left+this._.dims.width-e:e-this._.dims.left},r._tappedNothing=function(){var e=t.epochMilliseconds();this._.tapTracker.push(e);while(this._.tapTracker[0]<e-500)this._.tapTracker.shift();this._.tapTracker.length>=3&&(this._.tapTracker.splice(0),BIF.objects.historyManager.reset()&&this._showHistoryResetMessage())},r._showHistoryResetMessage=function(){var e=this._.parts.track;e.classList.add("timeline-reset"),clearTimeout(this._.resetTimer),this._.resetTimer=setTimeout(function(){e.classList.remove("timeline-reset")},1e3)},n}),define("bifocal/themes/read/default/src/parts/seekometer_affordance",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.SCROLLING_THRESHOLD=8,r.$init=function(e){this.tape=e,this.contactTarget=this.tape.parentNode,this.handler=BIF.events.onContact(this.contactTarget,{start:this._onContactStart.bind(this),move:this._onContactMove.bind(this),end:this._onContactEnd.bind(this),cancel:this._onContactCancel.bind(this)},{cancelOnLeave:this.contactTarget.parentNode}),this.listen()},r.reset=function(){this._.width=null},r.jump=function(e,t){var n=this._tapeWidth();if(typeof this._.percent=="number"&&typeof t!="number"){var r=Math.abs(e*n-this._.percent*n);t=Math.min(300,r*3)}clearTimeout(this._.setPercentTimer),this._setPercent(e,t,"ease-out")},r.interpolate=function(e,n,r){this._setPercent(e);if(e!=n){var i=r-t.epochMilliseconds();this._.setPercentTimer=setTimeout(function(){this._setPercent(n,i,"linear")}.bind(this),0)}},r.on=function(e){this._.callbacks=e},r.listen=function(){this.handler.listen()},r.deafen=function(){this.handler.deafen()},r._setPercent=function(e,n,r){r=r||"linear";var i=t.epochMilliseconds()+(n||0);if(this._.easing==r&&Math.abs(this._.percent-e)<1e-6&&this._.eta&&i&&Math.abs(this._.eta-i)<1e3)return;this._.percent=e,this._.easing=r,this._.eta=i;var s=this.tape.style;if(n){var o="transform "+this._.easing+" "+n+"ms";t.each(["-webkit-","-moz-","-ms",""],function(e){s.setProperty(e+"transition",e+o)})}else this._.easing=null,t.prefixProperty(s,"transition");var u=this._tapeWidth()*e;t.prefixProperty(s,"transform","translate3d("+(0-u)+"px,0,0)")},r._onContactStart=function(e){this._.contact={},this._.contact.start=e.clientX;var t=this.tape.offsetLeft;t+=this.tape.parentNode.getBoundingClientRect().left;var n=t-this.tape.getBoundingClientRect().left;this._.contact.startPercent=n/this._tapeWidth()},r._onContactMove=function(e){if(!this._.contact)return;this._.contact.here=e.clientX;var t=this._.contact.start-this._.contact.here,n=t/this._tapeWidth(),r=this._.contact.startPercent+n;this._.contact.herePercent=Math.max(0,Math.min(.9999,r)),Math.abs(t)>this.SCROLLING_THRESHOLD&&(this._.contact.scrolling=!0),this._.contact.scrolling&&(this._setPercent(this._.contact.herePercent),this._.callbacks.scrolling&&this._.callbacks.scrolling(this._.contact.herePercent))},r._onContactEnd=function(e){if(!this._.contact)return;this._.contact.scrolling?this._.callbacks.scrolled&&this._.callbacks.scrolled(this._.contact.herePercent):this._onTap(e)},r._onContactCancel=function(e){if(!this._.contact)return;if(!this._.contact.scrolling)return;this._.callbacks.scrolled&&this._.callbacks.scrolled(this._.contact.startPercent)},r._onTap=function(e){if(!this._.callbacks.tap)return;var t=this.tape.firstChild.getBoundingClientRect(),n=e.clientX-t.left,r=this._magnetizeTapeTap(n);if(typeof r!="undefined"){var i=Math.max(0,Math.min(1,r/this._tapeWidth()));this._.callbacks.tap(i)}},r._magnetizeTapeTap=function(e){var t=this.tape.querySelector(".seekometer-landmarks"),n=t.firstChild,r,i=8;while(n){var s=n.firstChild;while(s){if(typeof s.lmLeft!="undefined"){var o=s.lmLeft,u=s.lmLeft+s.lmWidth;if(o<=e&&u>=e)return o;o<=e+i&&u>=e-i&&(r=o,i=Math.min(Math.abs(o-e),Math.abs(u-e)))}s=s.nextSibling}n=n.nextSibling}return r},r._tapeWidth=function(){return this._.width||(this._.width=this.tape.offsetWidth)},n}),define("bifocal/themes/read/default/src/parts/seekometer",["require","common","./seekometer_affordance"],function(e){var t=e("common"),n=e("./seekometer_affordance"),r=t.Class.new(),i=r.prototype;return i.UNIT=7,i.GROUP=10,i.$init=function(e){this._.box=e,this._.parts=this._layout(e),this._.enabled=null,this._listen()},i._layout=function(e){var n={};return n.tape=t.element({parentNode:e,classes:"seekometer-tape"}),n.notches=t.element({parentNode:n.tape,classes:"seekometer-notches"}),n.numbers=t.element({parentNode:n.tape,classes:"seekometer-numbers"}),n.landmarks=t.element({parentNode:n.tape,classes:"seekometer-landmarks"}),n.gauge=t.element({parentNode:e,classes:"seekometer-gauge"}),n.ribbon=t.element({parentNode:n.gauge,classes:"seekometer-ribbon"}),n.needle=t.element({parentNode:n.gauge,classes:"seekometer-needle"}),n},i._listen=function(){this._.affordance=new n(this._.parts.tape),this._.affordance.on({tap:this._onTap.bind(this),scrolling:this._onScrolling.bind(this),scrolled:this._onScrolled.bind(this)}),BIF.listen("lens:dub:ambit",this._onAmbit.bind(this)),BIF.listen("bifocal:landmarks:group",this._onLandmarksGroup.bind(this)),BIF.listen("bifocal:seeker:place",this._onSeekerPlace.bind(this)),this._disable()},i._onAmbit=function(e){e.m.ambit.complete||this._disable()},i._updatePosition=function(e){if(!e.isFinite())return;this._.enabled||this._enable();var t=e.pages.total*this.UNIT-1;t!==this._.tapeWidth&&(this._.tapeWidth=t,this._.parts.tape.style.width=this._.tapeWidth+"px",this._populateNumbers(Math.floor(e.pages.total/this.GROUP)),this._.affordance.reset());var n=this._directionalPercent(e.percentageOfBook),r=this._griddedPercentage(n),i=BIF.objects.modality.is("orienting")?200:null;this._.affordance.jump(r,i)},i._griddedPercentage=function(e){try{var t=BIF.objects.compass.place.pages.total,n=1/t,r=Math.floor(e/n)*n;if(isFinite(r))return r}catch(i){}return e},i._onSeekerPlace=function(e){e.m.source!="seekometer"&&this._updatePosition(e.m.place)},i._onTap=function(e){var t=this._griddedPercentage(e);this._.affordance.jump(t),this._onScrolling(e),this._onScrolled(e)},i._onScrolling=function(e){this._.needlePercent=this._directionalPercent(e),BIF.dispatch("bifocal:seeking",this._seekEventData())},i._onScrolled=function(e){this._.needlePercent=this._directionalPercent(e);var t=this._seekEventData();BIF.dispatch("bifocal:seeked",t),t.place.seek(),this._updatePosition(t.place)},i._directionalPercent=function(e){var t=BIF.context.profile.reverse?!0:!1;return t?1-e:e},i._seekEventData=function(){return{source:"seekometer",place:BIF.objects.compass.at({percentageOfBook:this._.needlePercent})}},i._populateNumbers=function(e){var n=this._.parts.numbers;while(n.children.length>e)n.removeChild(n.firstChild);var r=n.children.length;while(r<e){var i=t.element({parentNode:n,classes:"seekometer-number"});r+=1}},i._onLandmarksGroup=function(e){var n=this._landmarkLayer(e.m.name),r="seekometer-landmark-"+e.m.name,i=this._.parts.landmarks.querySelectorAll("."+r);i=Array.prototype.slice.apply(i);var s=e.m.items.slice(0).sort(function(e,t){var n=(e.place?e.place.floc:0)||0,r=(t.place?t.place.floc:0)||0;return n-r}),o=BIF.context.profile.reverse?"right":"left";t.each(s,function(s){if(!s.place||!s.place.isFinite())return;var u=["seeko",s.type,s.id].join("-"),a;for(var f=0,l=i.length;f<l;++f)if(i[f].id==u){a=i[f],t.excise(i,a);break}a||(a=t.element({parentNode:n,id:u}));var c=[r];s.meta.colorGroup&&c.push("seekometer-landmark-color_"+s.meta.colorGroup),a.className!=c.join(" ")&&(a.className=c.join(" ")),s.meta.title?a.setAttribute("title",s.meta.title):a.removeAttribute("title"),a.lmType=e.m.name,a.lmLeft=(s.place.pages.head-1)*this.UNIT,a.style.removeProperty("left"),a.style.removeProperty("right"),a.style.setProperty(o,a.lmLeft+"px"),n.appendChild(a),a.lmWidth=a.getBoundingClientRect().width},this);while(i.length){var u=i.shift();u.parentNode.removeChild(u)}e.m.name!="chapter"&&this._stackLandmarks()},i._stackLandmarks=function(){var e=["seekometer-landmark-bookmark","seekometer-landmark-color_Y","seekometer-landmark-color_R","seekometer-landmark-color_G"],n={};t.each(e,function(e){var r={},i=this._.parts.landmarks.querySelectorAll("."+e);t.each(i,function(e){var t=e.lmLeft;r[t]?e.style.setProperty("display","none"):(n[t]=n[t]||[],n[t].push(e),r[t]=!0,e.style.removeProperty("display"))})},this);var r=BIF.context.profile.reverse?"right":"left",i=this._landmarkLayer("stack"),s,o;while(s=i.firstChild){while(o=s.firstChild)this._landmarkLayer(o.lmType).appendChild(o),o.style.setProperty(r,o.lmLeft+"px");i.removeChild(s)}t.each(n,function(e,n){if(n.length>1){var s=t.element({classes:"seekometer-landmark-stack count-"+n.length});s.lmLeft=parseFloat(e),s.style.setProperty(r,s.lmLeft+"px"),i.appendChild(s),t.each(n,function(e){e.style.removeProperty("left"),s.appendChild(e),s.lmWidth=Math.max(s.lmWidth||0,e.lmWidth)})}})},i._landmarkLayer=function(e){var n="seekometer-landmarks-layer-"+e;return this._.parts.landmarks.querySelector("."+n)||t.element({parentNode:this._.parts.landmarks,classes:n})},i._enable=function(){this._.enabled!==!0&&(this._.affordance.listen(),this._.enabled=!0,this._.box.classList.remove("disabled"))},i._disable=function(){this._.enabled!==!1&&(this._.affordance.deafen(),this._.enabled=!1,this._.box.classList.add("disabled"))},r}),define("bifocal/themes/read/default/src/parts/string_interpolator",["require","common","./quirks"],function(e){var t=e("common"),n=e("./quirks"),r=t.Class.new(),i=r.prototype;return i.make=function(e){var n=typeof e=="string"?e:e.join(" "),r=t.absorb(this.substitutions||{},this._defaultSubstitutions());return t.each(r,function(e,r){n=n.replace(new RegExp("{(_?)"+e+"}","g"),function(e,n){return n=="_"?t.capitalize(r):r})}),n},i.substitute=function(e){this.substitutions=e},i._defaultSubstitutions=function(){var e=n("has-touch-pointers");return{TAP:e?"tap":"click",TAPPING:e?"tapping":"clicking",SWIPE:e?"swipe":"drag",SWIPING:e?"swiping":"dragging",BRANDNAME:BIF.objects.brand?BIF.objects.brand.name:"OverDrive Read"}},r}),define("bifocal/themes/read/default/src/parts/pagination_progress",["require","common","./string_interpolator"],function(e){var t=e("common"),n=e("./string_interpolator"),r=t.Class.new(),i=r.prototype;return i.PROMPTS={MANUAL_PAUSE:"Counting pages. {_TAP} to pause.",MANUAL_RESUME:"{_TAP} to resume counting pages.",AUTO_RESUME:"Counting pages is slow. Paused â {TAP} to resume."},i.SLOW_MS=15e3,i.$init=function(e){this._.container=e,this._.parts=this._layout(e),this._onReset(),this._listen()},i._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"pagination-progress"}),n.rim=t.element({parentNode:n.box,classes:"pagination-progress-rim"}),n.status=t.element({parentNode:n.box,classes:"pagination-progress-status"}),n},i._listen=function(){BIF.listen("lens:scene:invalidate",this._onReset.bind(this)),BIF.listen("lens:dub:ambit",this._onProgress.bind(this)),BIF.events.onTap(this._.parts.box,this._onTap.bind(this))},i._onReset=function(){this._.parts.bar&&this._.parts.rim.removeChild(this._.parts.bar),this._.parts.bar=t.element({parentNode:this._.parts.rim,classes:"pagination-progress-bar"}),this._paginationProgress(0),this._updateForSpoolMode(),clearTimeout(this._.slowTimer),this._.slowTimer=setTimeout(this._onSlow.bind(this),this.SLOW_MS)},i._onProgress=function(e){this._paginationProgress(e.m.ambit.progress),this._updateForSpoolMode()},i._paginationProgress=function(e){this._.progressPercent!==e&&(this._.progressPercent=e,t.prefixProperty(this._.parts.bar.style,"transform","scaleX("+e+")"))},i._onSlow=function(){var e=BIF.context.spool;e.approxMode||(e.dub.pause(),this._updateForSpoolMode())},i._onTap=function(){var e=BIF.context.spool;e.approxMode?(this._.manualPause=!1,e.dub.resume()):(this._.manualPause=!0,e.dub.pause()),clearTimeout(this._.slowTimer),this._updateForSpoolMode()},i._updateForSpoolMode=function(){var e,n,r=BIF.context.spool;r&&r.dub&&r.dub.ambit.complete?(e="done",n="",clearTimeout(this._.slowTimer)):r&&r.approxMode?(e="paused",n=this._prompt(this._.manualPause?"MANUAL_RESUME":"AUTO_RESUME")):(e="resumed",n=this._prompt("MANUAL_PAUSE")),e!=this._.state&&(this._.state=e,clearTimeout(this._.modeTimer),this._.modeTimer=setTimeout(function(){t.DataClass.set(this._.parts.box,"pagination-progress",e),this._.parts.status.innerHTML=n}.bind(this),0))},i._prompt=function(e){var t=new n;return t.make(this.PROMPTS[e])},r}),define("bifocal/themes/read/default/src/parts/orient_film",["require","common","./chapticker","./page_numbers","./timeline","./seekometer","./pagination_progress"],function(e){var t=e("common"),n=e("./chapticker"),r=e("./page_numbers"),i=e("./timeline"),s=e("./seekometer"),o=e("./pagination_progress"),u=t.Class.new(),a=u.prototype;return a.$init=function(e){this._.parts=this._layout(e);var t=BIF.objects.brand["logo-cover"]||"";this._.parts.orb.innerHTML=t,this._.parts.orb.classList[t?"remove":"add"]("cover-2d-img"),this._.chapticker=new n(this._.parts.chapticker),this._.pageNumbers=new r(this._.parts.pageNumbers),this._.timeline=new i(this._.parts.timeline),this._.paginationProgress=new o(this._.parts.seekBox),this._.seekometer=new s(this._.parts.seekBox),BIF.events.onTap(this._.parts.shield,this._close.bind(this)),BIF.events.onTap(this._.parts.pommel,this._onPommelTap.bind(this)),BIF.events.onTap(this._.parts.chapticker,this._onChapterTap.bind(this))},a._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"orient-film"}),n.shield=t.element({parentNode:n.box,classes:"orient-shield"}),n.bounds=t.element({parentNode:n.box,classes:"orient-bounds"}),n.board=t.element({parentNode:n.bounds,classes:"orient-board hug-b"}),n.pommel=t.element({parentNode:n.board,classes:"orient-orb-pommel"}),n.shadow=t.element({parentNode:n.pommel,classes:"orient-orb-shadow"}),n.orb=t.element({parentNode:n.pommel,classes:"orient-orb"}),n.surface=t.element({parentNode:n.bounds,classes:"orient-surface hug-b"}),n.chapticker=t.element({parentNode:n.surface,classes:"orient-chapticker"}),n.midpoint=t.element({parentNode:n.surface,classes:"orient-midpoint"}),n.pageNumbers=t.element({parentNode:n.surface,classes:"orient-page-numbers"}),n.seekBox=t.element({parentNode:n.surface,classes:"orient-seek-box"}),n.timeline=t.element({parentNode:n.seekBox,classes:"orient-timeline"}),n},a._onPommelTap=function(){BIF.objects.panelOvw&&BIF.objects.panelOvw.open()},a._onChapterTap=function(e){BIF.objects.panelToc.open()},a._close=function(){BIF.objects.modality.closeIf("orienting")},u}),define("bifocal/themes/read/default/src/parts/connect_link",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return n.contextualizeURL=function(e){var n=t.absorb(BIF.map["-odread-msg-original"]||{},{book:BIF.state.buid,progress:BIF.objects.compass.place.percentageOfBook||0}),r=[];for(var i in n)n.hasOwnProperty(i)&&r.push(encodeURIComponent(i)+"="+encodeURIComponent(n[i]));return e+(e.match(/\?/)?"&":"?")+r.join("&")},r.$init=function(e){this._.parts=this._layout(e)},r._layout=function(e){var t={},n=BIF.objects.brand["connect-link"];return n?typeof n=="function"?n(e,t):this._buildConnectLink(e,t,n):console.warn("No connect-link in brand:",BIF.objects.brand),t},r._buildConnectLink=function(e,r,i){var s={parentNode:e,classes:"connect-link tappable"};i.url&&(s.tag="a",s.attributes={href:i.url,target:"_blank"}),r.box=t.element(s),i.url&&!i.url.match(/^javascript:/)?BIF.listen(r.box,"click",function(){r.box.href=n.contextualizeURL(i.url)}):BIF.events.onTap(r.box,this._openAppPanel.bind(this)),i.icon&&(r.icon=t.element({parentNode:r.box,classes:"connect-link-icon",html:i.icon})),i.text&&(r.text=t.element({tag:"h2",parentNode:r.box,classes:"connect-link-text",html:i.text}),s.tag=="a"&&r.box.setAttribute("title",r.text.innerText))},r._openAppPanel=function(){BIF.objects.panelApp&&BIF.objects.panelApp.open()},n}),define("bifocal/themes/read/default/src/parts/menu_list",["require","common","./connect_link"],function(e){var t=e("common"),n=e("./connect_link"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this.panels={},this._.arrangement=[],this._.parts=this._layout(e),this.connectLink=new n(this._.parts.connectBox),this._listen(),this.hide()},i.header=function(e,t){this._.parts.header.innerHTML=e,this.panels.header=t,this._.parts.header.classList[t?"add":"remove"]("tappable")},i.arrangement=function(e){this._.arrangement=e,this._rearrangeButtons()},i.addPanel=function(e,n){this.panels[e.ID]=e;var r=t.element({tag:"li",parentNode:this._.parts.list,classes:"main-menu-button",html:e.title,attributes:{"data-panel-id":e.ID}}),i=BIF.objects.iconator.make(e.ID);return r.insertBefore(i,r.firstChild),this._rearrangeButtons(),this._tapForPanel(r,e),r},i.hide=function(e){e&&BIF.events.stop(e),this.level(0)},i.showPanel=function(){this.level(2)},i.level=function(e){var n=parseFloat(t.DataClass.get(BIF.root,"menu"));n<e-1&&(BIF.elements.menuTrain.classList.remove("animated"),t.DataClass.set(BIF.root,"menu",e-1)),setTimeout(function(){BIF.elements.menuTrain.classList.add("animated"),t.DataClass.set(BIF.root,"menu",e),n==0&&e==1?BIF.dispatch("bifocal:menuing:open"):n>0&&e==0&&BIF.dispatch("bifocal:menuing:close"),n!=e&&BIF.dispatch("bifocal:menuing:level",{level:e,was:n})}.bind(this),0)},i.isHidden=function(){return t.DataClass.get(BIF.root,"menu")!="1"},i._layout=function(e){var n={};return n.shield=t.element({parentNode:BIF.elements.bookLayer,classes:"menu-shield"}),n.box=t.element({parentNode:e,classes:"menu-list-box"}),n.scroller=t.element({parentNode:n.box,classes:"menu-list-scroller"}),n.contents=t.element({parentNode:n.scroller,classes:"menu-list-contents"}),n.header=t.element({parentNode:n.contents,classes:"menu-list-header",html:BIF.objects.brand.name||"OverDrive Read"}),n.list=t.element({tag:"ul",parentNode:n.contents,classes:"main-menu"}),n.connectBox=t.element({parentNode:n.contents,classes:"menu-connect-box"}),BIF.events.scrollable(n.scroller),n},i._tapForPanel=function(e,t){e.classList.add("tappable"),BIF.events.onTap(e,t.open.bind(t))},i._listen=function(){BIF.events.onTap(this._.parts.shield,this.hide.bind(this)),BIF.events.onTap(this._.parts.header,this._onHeaderTap.bind(this))},i._rearrangeButtons=function(){var e=Array.prototype.slice.call(this._.parts.list.children,0),n=e.slice(0).sort(function(e,t){var n=e.getAttribute("data-panel-id"),r=t.getAttribute("data-panel-id"),i=this._.arrangement.indexOf(n),s=this._.arrangement.indexOf(r);return i<0&&s<0?n>=r?1:-1:i<0?1:s<0?-1:i-s}.bind(this)),r=!1;for(var i=0,s=e.length;i<s;++i)if(e[i]!==n[i]){r=!0;break}if(!r)return;t.each(n,function(e){e.parentNode.appendChild(e)})},i._onBoxTap=function(){this.isHidden()&&this.level(1)},i._onHeaderTap=function(){this.panels.header&&this.panels.header.open()},r}),define("bifocal/themes/read/default/src/parts/menu_panel",["require","common","./quirks"],function(e){var t=e("common"),n=e("./quirks"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this._.parts=this._layout(e),this.disappear(),this._listen()},i.appear=function(e){this._adopt(e),BIF.objects.menuList.level(2)},i.disappear=function(){BIF.objects.menuList.hide()},i._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"menu-panel"}),n.content=t.element({parentNode:n.box,classes:"menu-panel-content"}),n.backButton=t.element({parentNode:n.box,classes:"menu-back-button"}),n.backButtonIcon=BIF.objects.iconator.make("menu",n.backButton),n},i._listen=function(){BIF.events.onTap(this._.parts.backButton,function(){BIF.objects.menuList.level(1)});if(n("scrolling-transition-bug-417345")){var e=function(){this._.parts.box.style.setProperty("display","none"),this._.parts.box.offsetHeight,this._.parts.box.style.removeProperty("display")}.bind(this);BIF.listen(this._.parts.box,"transitionend",e),BIF.listen(this._.parts.box,"webkitTransitionEnd",e)}},i._adopt=function(e){var n=this._.parts.content;e.parentNode!=n&&n.appendChild(e),t.each(n.children,function(t){t.style.setProperty("display",t==e?"block":"none")}),this.activeChild=e},r}),define("bifocal/themes/read/default/src/parts/panel_abstract",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.TITLE="[Untitled]",r.ID="pnl",r.CLOSE_POLITELY_MS=100,r.$init=function(){this.title=this._title(),this._.parts=this._layout(),this._innerLayout(this._.parts.body),this._listen(),this._initialized()},r.open=function(){this.isOpen()||BIF.objects.menuPanel.appear(this._.parts.dialog)},r.isOpen=function(){return t.DataClass.get(BIF.root,"menu")=="2"&&BIF.objects.menuPanel.activeChild==this._.parts.dialog},r._layout=function(){var e={};return e.dialog=t.element({classes:"menu-panel-dialog menu-panel-dialog-"+this.ID}),e.panelTitleBar=t.element({parentNode:e.dialog,classes:"menu-panel-title-bar"}),e.panelTitle=t.element({parentNode:e.panelTitleBar,classes:"menu-panel-title",html:this.title}),e.panelDone=t.element({parentNode:e.panelTitleBar,classes:"menu-panel-done-button",html:"Done"}),e.body=t.element({parentNode:e.dialog,classes:"menu-panel-body"}),BIF.events.scrollable(e.body),e},r._listen=function(){BIF.listen("bifocal:menuing:level",this._onMenuLevelChange.bind(this)),BIF.events.onTap(this._.parts.panelDone,this._onTapDone.bind(this))},r._onMenuLevelChange=function(){this.isOpen()?(this._onOpen(),this._.opened=!0):this._.opened&&(this._onClose(),this._.opened=!1)},r._onTapDone=function(){BIF.objects.menuPanel.disappear()},r._closePolitely=function(e){BIF.objects.modality.close(),setTimeout(function(){BIF.objects.menuPanel.disappear()},e||this.CLOSE_POLITELY_MS)},r._title=function(){return this.title||this.TITLE.replace(/ \& /g,' <span class="amp">&amp;</span> ')},r._innerLayout=function(e){},r._initialized=function(){},r._onOpen=function(){},r._onClose=function(){},n}),define("bifocal/themes/read/default/src/parts/panel_app",["require","./panel_abstract","common"],function(e){var t=e("./panel_abstract"),n=e("common"),r=t.new(),i=r.prototype;return i._title=function(){return this.title||BIF.objects.brand.get("panel-title")},i._innerLayout=function(e){this._.parts.info=n.element({parentNode:e,classes:"app-info"}),this._updateHTML()},i._onOpen=function(e){this._updateHTML()},i._updateHTML=function(){try{var e=BIF.objects.brand.get("panel-html");this.currentHTML!==e&&(this._.parts.info.innerHTML=e,this.currentHTML=e)}catch(t){console.warn("[PANEL-APP] failed to load HTML from brand",t)}},r}),define("text!bifocal/themes/read/default/resources/icons/pnl-overview.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='#000000' stroke-width='3' fill='none' fill-rule='evenodd' class='icon-hollow'>\n    <path d='M41,13 L41,52.538077 L19.9790067,50.1127462 C18.3337467,49.9229217 17,48.4257261 17,46.7666801 L17,18.7713969 C17,17.1132401 18.3245302,15.6162187 19.9790067,15.4253308 L41,13 Z' />\n    <path d='M41,13 L45.2735733,14.9481785 C46.7793372,15.6346057 48,17.5318823 48,19.1919117 L48,46.3461653 C48,48.0034872 46.7806931,49.9028532 45.2735733,50.5898984 L41,52.538077' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/pnl-chapters.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M31.5,24 L49.5,24' stroke='#000000' stroke-width='4' stroke-linecap='square' class='icon-hollow' />\n    <path d='M15.3266782,46.1094366 C15.7385244,45.1436365 16.7107369,44.1212359 18.2433449,43.042204 C19.5734056,42.1030467 20.4342187,41.4303271 20.8258102,41.024025 C21.4267005,40.3912594 21.7271412,39.698558 21.7271412,38.9459 C21.7271412,38.3331165 21.5549786,37.8235813 21.2106481,37.4172792 C20.8663177,37.0109771 20.37346,36.807829 19.7320602,36.807829 C18.8543552,36.807829 18.2568496,37.1308677 17.9395255,37.7769547 C17.7572329,38.1499533 17.6492093,38.7427459 17.6154514,39.5553501 L14.8101852,39.5553501 C14.8574462,38.3231224 15.0836207,37.3273641 15.4887153,36.5680454 C16.2583951,35.1226756 17.6255689,34.4000015 19.5902778,34.4000015 C21.1431405,34.4000015 22.3786605,34.8246142 23.296875,35.6738522 C24.2150895,36.5230902 24.6741898,37.6470648 24.6741898,39.0458098 C24.6741898,40.118181 24.350119,41.0706454 23.7019676,41.9032317 C23.2766182,42.456069 22.5778405,43.0721736 21.6056134,43.751564 L20.4510995,44.5608339 C19.7286808,45.0670463 19.2341352,45.4333788 18.9674479,45.6598423 C18.7007606,45.8863057 18.4762741,46.1493991 18.2939815,46.4491301 L24.7045718,46.4491301 L24.7045718,48.9568675 L14.6481481,48.9568675 C14.6751545,47.9177998 14.9013289,46.9686657 15.3266782,46.1094366 L15.3266782,46.1094366 Z' fill='#000000' class='icon-solid' />\n    <path d='M31.5,47 L49.5,47' stroke='#000000' stroke-width='4' stroke-linecap='square' class='icon-hollow' />\n    <path d='M15.4380787,15.9959435 L15.4380787,14.0576923 C16.3495416,14.0177282 16.987556,13.9577829 17.3521412,13.8778546 C17.9327768,13.7513015 18.4053801,13.498199 18.7699653,13.1185397 C19.0197736,12.8587727 19.2088149,12.512422 19.3370949,12.0794772 C19.4113623,11.8197102 19.4484954,11.6265531 19.4484954,11.5 L21.848669,11.5 L21.848669,25.9869291 L18.8914931,25.9869291 L18.8914931,15.9959435 L15.4380787,15.9959435 Z' fill='#000000' class='icon-solid' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/pnl-marks.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='#000000' stroke-width='3' fill='none' fill-rule='evenodd' class='icon-hollow'>\n    <path d='M21,16 L21,14 C21,12.8954305 21.8896739,12 22.991155,12 L41.008845,12 C42.1085295,12 43,12.8877296 43,14 L43,16' />\n    <path d='M15,30.9939817 C15,29.3404512 16.3433124,28 18.0023584,28 L45.9976416,28 C47.6557983,28 49,29.3387041 49,30.9939817 L49,49.8434578 C49,50.8354833 48.2871507,51.2701842 47.3969141,50.8112856 L33.9959649,44.3076284 C33.059198,44.0050633 31.5203865,43.9506664 30.5932357,44.2952078 L16.5918433,50.8480459 C15.7126925,51.2852527 15,50.8259475 15,49.8434578 L15,30.9939817 Z' />\n    <path d='M18,25 L18,22 C18,20.3431458 19.3504982,19 20.9964905,19 L43.0035095,19 C44.6584255,19 46,20.3465171 46,22 L46,25' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/pnl-history.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M21.8528523,17.1306486 C17.1115736,20.3724398 14,25.8228464 14,32 C14,41.9411255 22.0588745,50 32,50 L32,50 C41.9411255,50 50,41.9411255 50,32 C50,22.0588745 41.9411255,14 32,14' stroke='#000000' stroke-width='3' class='icon-hollow' />\n    <path d='M16.5,32 L19,32' stroke='#000000' stroke-width='2' stroke-linecap='square' class='icon-hollow' />\n    <path d='M35,9 L35,23 L26,16 L35,9 Z' fill='#000000' class='icon-solid' />\n    <path d='M45,32 L47.5,32' stroke='#000000' stroke-width='2' stroke-linecap='square' class='icon-hollow' />\n    <path d='M31.6829188,47.5841994 L31.6829188,44.9806198' stroke='#000000' stroke-width='2' stroke-linecap='square' class='icon-hollow' />\n    <path d='M26.107233,30.440864 L32.892767,30.1553301' stroke='#000000' stroke-width='2' stroke-linecap='square' transform='translate(29.500000, 30.298097) rotate(-315.000000) translate(-29.500000, -30.298097) ' class='icon-hollow' />\n    <path d='M32,29 L35.5355339,32.5355339' stroke='#000000' stroke-width='2' stroke-linecap='square' transform='translate(33.767767, 30.767767) scale(-1, 1) translate(-33.767767, -30.767767) ' class='icon-hollow' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/pnl-narration.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M32.5,45.6875 L32.5,51.3125' stroke='#000000' stroke-width='3' stroke-linecap='square' class='icon-hollow' />\n    <path d='M44,34.9772727 C44,41.0649569 38.1158336,47 32.0909091,47 C26.0659845,47 20.1818182,41.0649569 20.1818182,34.9772727 C20.1818182,34.6052563 20.2000576,34.2375444 20.2356821,33.875 L23.4311568,33.875 C23.3865927,34.2360982 23.3636364,34.6039767 23.3636364,34.9772727 C23.3636364,39.8474201 27.2709695,43.7954545 32.0909091,43.7954545 C36.9108487,43.7954545 40.8181818,39.8474201 40.8181818,34.9772727 C40.8181818,34.6039767 40.7952255,34.2360982 40.7506614,33.875 L43.9461361,33.875 C43.9461361,33.875 44,34.6052563 44,34.9772727 Z' fill='#000000' class='icon-solid' />\n    <path d='M38.6363636,26 L38.6363636,23.5513505 C38.6363636,19.9331395 35.6985081,17 32.0909091,17 C28.4759544,17 25.5454545,19.9363416 25.5454545,23.5513505 L25.5454545,26 L29.9090909,26 L29.9090909,28.25 L25.5454545,28.25 L25.5454545,30.5 L29.9090909,30.5 L29.9090909,32.75 L25.5454545,32.75 L25.5454545,35.1986495 C25.5454545,38.8168605 28.4833101,41.75 32.0909091,41.75 C35.7058638,41.75 38.6363636,38.8136584 38.6363636,35.1986495 L38.6363636,32.75 L34.2727273,32.75 L34.2727273,30.5 L38.6363636,30.5 L38.6363636,28.25 L34.2727273,28.25 L34.2727273,26 L38.6363636,26 L38.6363636,26 Z' fill='#000000' class='icon-solid' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/pnl-readability.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='#000000' stroke-width='1' fill='none' fill-rule='evenodd' class='icon-hollow'>\n    <path d='M28.036347,17.8587708 C28.4565633,16.8322001 29.6947074,16 30.7915496,16 L33.1610965,16 C34.2625365,16 35.4936174,16.823173 35.919076,17.8587708 L47.5384671,46.1412292 C47.9602172,47.1677999 47.4087741,48 46.2979374,48 L41.8949018,48 C41.3432749,48 40.7459013,47.5779827 40.5593687,47.0538528 L37.6930829,39 L26.0683386,39 L23.2020529,47.0538528 C23.0160852,47.5763955 22.4170013,48 21.8687894,48 L17.6947452,48 C16.5921605,48 16.0352966,47.176827 16.4592081,46.1412292 L28.036347,17.8587708 Z' stroke-width='2.5' />\n    <path d='M32.2805273,25.0964817 C32.09588,24.6289828 31.7981152,24.6367187 31.6157583,25.1129578 L28.5,33.25 L35.5,33.2476992 L32.2805273,25.0964817 Z' stroke-width='2.25' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/pnl-offline-cache.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='#000000' stroke-width='3' fill='none' fill-rule='evenodd' class='icon-hollow'>\n    <path d='M18.6163349,45 C15.8743125,43.5613202 14,40.6566648 14,37.3076923 C14,32.8011598 17.3939378,29.0991805 21.7290769,28.6911772 C22.5256543,23.7494124 26.3969535,20 31.0526316,20 C34.9510683,20 38.2995324,22.6289256 39.7533312,26.3854904 C40.3942912,25.9942423 41.1449399,25.7692308 41.9473684,25.7692308 C44.3018455,25.7692308 46.2105263,27.7064602 46.2105263,30.0961538 C46.2105263,30.7887708 46.0501888,31.4433787 45.7651313,32.0238275 C48.2431013,33.0687096 50,35.6862387 50,38.75 C50,41.4215989 48.6640832,43.7538903 46.6790594,45 L18.6163349,45 Z' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/pnl-tips.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <ellipse stroke='#000000' stroke-width='3' cx='32' cy='27' rx='12' ry='11' class='icon-hollow' />\n    <rect fill='#000000' x='25' y='42' width='13' height='3' rx='2' class='icon-solid' />\n    <rect fill='#000000' x='25' y='48' width='13' height='3' rx='2' class='icon-solid' />\n  </g>\n</svg>\n"}),define("bifocal/themes/read/default/src/parts/key_manager",["require","common","core/src/keys"],function(e){var t=e("common"),n=e("core/src/keys"),r=t.Class.new(),i=r.prototype;return i.COMMANDS={turnForward:function(e){BIF.objects.menuList.isHidden()&&BIF.objects.modality.is("reading")&&(BIF.events.stop(e),BIF.context.spool.shiftRight())},turnBackward:function(e){BIF.objects.menuList.isHidden()&&BIF.objects.modality.is("reading")&&(BIF.events.stop(e),BIF.context.spool.shiftLeft())},menu:function(e){BIF.events.stop(e),BIF.objects.modality.isNot("reading")?BIF.objects.modality.close():BIF.objects.menuList.level(BIF.objects.menuList.isHidden()?1:0)},orient:function(e){BIF.events.stop(e),BIF.objects.menuList.isHidden()?BIF.objects.modality.isNot("reading")?BIF.objects.modality.close():BIF.objects.modality.open("orienting"):BIF.objects.menuList.hide()},dismiss:function(e){BIF.events.stop(e);var n=t.DataClass.get(BIF.root,"menu");parseFloat(n)>0&&BIF.objects.menuList.hide(),BIF.objects.modality.close()}},i.BINDINGS={"PAGEUP down":"turnBackward","LEFT down":"turnBackward","PAGEDOWN down":"turnForward","RIGHT down":"turnForward","SPACE down":"turnForward","shift-SPACE down":"turnBackward","DOWN down":"menu","UP down":"orient",ESC:"dismiss"},i.$init=function(e){this._.doc=e||document,this._.bindings=null,this._bindKeys(),this.listenForFocus()},i.listenForFocus=function(){var e=this._.doc.querySelectorAll("input, textarea, select");t.each(e,function(e){if(typeof e._keyHandlers=="undefined"){var t=e._keyHandlers=[];t.push(BIF.events.on(e,"focus",this.disableKeyCmds.bind(this))),t.push(BIF.events.on(e,"blur",this._deferEnableKeyCmds.bind(this)))}},this)},i.disableKeyCmds=function(e){clearTimeout(this._.enableTimer),t.each(this._.bindings,function(e){e.off()})},i.enableKeyCmds=function(){if(this._.doc.activeElement){var e=this._.doc.activeElement.tagName.toLowerCase();if(e=="input"||e=="textarea"||e=="select")return}t.each(this._.bindings,function(e){e.on()})},i.addBinding=function(e,t){this._.bindings.push(new n(e,t,this._.doc))},i._bindKeys=function(){this._.bindings=[],t.each(i.BINDINGS,function(e,t){this.addBinding(e,i.COMMANDS[t])},this)},i._deferEnableKeyCmds=function(){this._.enableTimer=setTimeout(this.enableKeyCmds.bind(this),500)},r}),define("bifocal/themes/read/default/src/parts/reader_affordance",["require","common","glaze","./quirks"],function(e){var t=e("common"),n=e("glaze"),r=e("./quirks"),i=t.Class.new(),s=i.prototype;return s.$init=function(e){this._.clients={},this._.scene=e,this._.spool=e.context.spool,this._.ruler=e.context.ruler,this._createFilm(),this.glaze=new n(this._.film,BIF.elements.scene),this._generateClients(),this._updateGlaze(),BIF.listen("bifocal:component:modify",this._updateGlaze.bind(this))},s.PAGE_ANIM_MS=200,s.MOTION_THRESHOLD=8,s.LONG_PRESS_MS=400,s._createFilm=function(){var e=BIF.objects.stencil._.box;this._.film=t.element({parentNode:e.parentNode,classes:"affordance-film"}),this._.film.appendChild(e),BIF.listen("lens:dub:ambit",this._onDubAmbit.bind(this))},s._onDubAmbit=function(e){this._resizeFilm(e.m.ambit.real.min,e.m.ambit.real.max)},s._resizeFilm=function(e,n){var r=e,i=n-e;BIF.context.profile.reverse&&(r=this._.spool.aperture-n);if(r==this._.filmLeft&&i==this._.filmWidth)return;this._.filmLeft=r,this._.filmWidth=i,isFinite(r)&&isFinite(i)?(this._.film.style.left=r+"px",this._.film.style.width=i+"px"):(this._.film.style.removeProperty("left"),this._.film.style.removeProperty("width")),t.each(this._.film.children,function(e){var t=0;BIF.context.profile.reverse&&e==BIF.objects.stencil._.box&&(t=BIF.context.spool.aperture),e.style.left=t-r+"px"})},s._generateClients=function(){this.glaze.addClient(this._makeClient("stencilGlaze")),this.glaze.addClient(this._makeClient("stencilTap")),this.glaze.addClient(this._makeClient("pincer")),this.glaze.addClient(this._makeClient("orient")),this.glaze.addClient(this._makeClient("hotspot")),this.glaze.addClient(this._makeClient("menuSwipe")),this.glaze.addClient(this._makeClient("lens"))},s._makeClient=function(e){var t={},n=["Start","Move","End","Cancel"];while(n.length){var r=n.shift(),i=this["_"+e+r];typeof i!="undefined"&&(console.assert(typeof i=="function","Not a function",e,r),t["onContact"+r]=i.bind(this))}return this._.clients[e]=t},s._updateGlaze=function(){this.glaze.updateSurfaces()},s._intentionalMotion=function(e){var t=[],n=Math.abs(e.point.x-e.start.x),r=Math.abs(e.point.y-e.start.y);return n>this.MOTION_THRESHOLD&&t.push("x"),r>this.MOTION_THRESHOLD&&t.push("y"),t.length&&(r>n?t.reverse():r==n&&(t=[t.join()])),t},s._stencilGlazeStart=function(e){return this._stencilGlazeSend("start",e,!0)},s._stencilGlazeMove=function(e){return this._.stenGlaze&&(e.intentionalMotion=this._intentionalMotion(e)),this._stencilGlazeSend("move",e,!0)},s._stencilGlazeEnd=function(e){return this._stencilGlazeSend("end",e)},s._stencilGlazeCancel=function(e){return this._stencilGlazeSend("cancel",e)},s._stencilGlazeSend=function(e,t,n){if(!this._.stenGlaze){var r=this._.ruler.sceneToSpool(t.point.x,t.point.y);this._.stenGlaze=BIF.objects.stencil.collide("glaze",r.x,r.y)}var i=this._.stenGlaze;if(i){n||(this._.stenGlaze=null);if(typeof i.glaze[e]=="function")return i.glaze[e](t,i)}},s._stencilTapStart=function(e){this._.stenTap=!0},s._stencilTapMove=function(e){this._intentionalMotion(e).length&&this._stencilTapCancel()},s._stencilTapEnd=function(e){if(this._.stenTap){this._.stenTap=!1;var t=this._.ruler.sceneToSpool(e.point.x,e.point.y),n=BIF.objects.stencil.collide("tap",t.x,t.y);if(n)return n.tap(e,n),!0}},s._stencilTapCancel=function(e){this._.stenTap=!1},s._pincerStart=function(e){if(this._.pin)return!0;var t=!BIF.dispatch("bifocal:pincer:reset",null,!0),n=this._.ruler.sceneToSpool(e.point.x,e.point.y),r=this._.ruler.spoolToComponent(n.x,n.y,!0);return r&&(this._.pin={point:r},this._.pin.pressTimer=setTimeout(this._pincerPress.bind(this),this.LONG_PRESS_MS)),t},s._pincerPress=function(){this._.pin.pressTimer=null,BIF.objects.pincer.pince(this._.pin.point)},s._pincerMove=function(e){if(!this._.pin)return;if(!this._.pin.pressTimer){var t=this._.ruler.sceneToSpool(e.point.x,e.point.y);return this._.pin.point=this._.ruler.spoolToComponent(t.x,t.y,!0),BIF.objects.pincer.pincing(this._.pin.point),!0}this._intentionalMotion(e).length&&this._pincerCancel()},s._pincerEnd=function(e){if(!this._.pin)return;if(!this._.pin.pressTimer)return BIF.objects.pincer.pinced(),this._.pin=null,!0;this._pincerCancel()},s._pincerCancel=function(e){this._.pin&&(clearTimeout(this._.pin.pressTimer),this._.pin=null)},s._orientStart=function(e){this._.mid={lowpoint:e.start.y}},s._orientMove=function(e){if(!this._.mid)return!1;var t=this.MOTION_THRESHOLD*.5;if(this._inMiddle(e.point.x))if(this._.mid.orientUp)e.point.y>this._.mid.highpoint+t?(this._orientDown(),this._.mid.highpoint=null,this._.mid.lowpoint=e.point.y):this._.mid.highpoint=Math.min(this._.mid.highpoint,e.point.y);else if(this._intentionalMotion(e)[0]=="y"){if(e.point.y<this._.mid.lowpoint)return this._orientUp(),this._.mid.highpoint=e.point.y,!0;this._.mid.orientUp===!1?this._.mid.lowpoint=e.point.y-t:this._.mid=null}},s._orientEnd=function(e){if(!this._.mid)return!1;if(this._.mid){var t=this._.mid.orientUp||this._.mid.orientUp!==!1&&this._inMiddle(e.point.x);return t&&setTimeout(function(){BIF.objects.modality.open("orienting")},10),this._orientFinalize(),this._.mid=null,t}},s._orientCancel=function(e){return this._orientFinalize(),this._.mid=null,!1},s._orientUp=function(){this._.mid.orientUp=!0,BIF.elements.fastPagerBox?BIF.elements.fastPagerBox.classList.remove("disabled"):(BIF.root.classList.add("orient-pending"),BIF.objects.modality.open("orienting"))},s._orientDown=function(){this._.mid.orientUp=!1,BIF.elements.fastPagerBox?BIF.elements.fastPagerBox.classList.add("disabled"):BIF.objects.modality.closeIf("orienting")},s._orientFinalize=function(){BIF.elements.fastPagerBox?this._.mid&&this._.mid.orientUp&&BIF.elements.fastPagerBox.classList.add("disabled"):BIF.root.classList.remove("orient-pending")},s._inMiddle=function(e){var t=this._.spool.aperture;return e>t*.33&&e<t*.67},s._hotspotEnd=function(e){if(BIF.state.mode=="mea")return;if(!this._intentionalMotion(e).length){var t=BIF.context.scene.dimensions,n=Math.max(90,t.width*.2),r=Math.max(90,t.height*.15);if(e.point.y<=r&&e.point.x>=t.width-n&&BIF.objects.bookmarkButton)return BIF.objects.bookmarkButton.toggle(),!0}},s._menuSwipeStart=function(e){this._inMiddle(e.point.x)&&(this._.menuSwipe={invoked:!1})},s._menuSwipeMove=function(e){if(!this._.menuSwipe)return;if(this._.menuSwipe.invoked)return!0;if(this._intentionalMotion(e).join().match(/x/))return this._menuSwipeCancel();if(e.point.y-e.start.y>25)return BIF.objects.menuList.level(1),this._.menuSwipe.invoked=!0},s._menuSwipeEnd=function(e){this._.menuSwipe=null},s._menuSwipeCancel=s._menuSwipeEnd,s._lensStart=function(e){BIF.events.stop(e.originalEvent),this._.lens={}},s._lensMove=function(e){if(!this._.lens)return;!this._.lens.dir&&this._intentionalMotion(e).join().match(/x/)&&(this._.lens.dir=this._lensMotion(e.point.x,e.start.x),this._.lens.motion=this._.lens.dir,this._.lens.waypoint=e.point.x);if(this._.lens.dir){var t=this._lensMotion(e.point.x,this._.lens.waypoint);t&&(this._.lens.motion=t),this._.lens.waypoint=e.point.x;var n=this._lensDelta(e);return BIF.context.profile.reverse&&(n*=-1),this._.spool.slideDelta(n,!1),!0}},s._lensEnd=function(e){if(!this._.lens)return;if(this._.lens.dir=="<"&&this._.lens.motion=="<")this._.spool.shiftLeft();else if(this._.lens.dir==">"&&this._.lens.motion==">")this._.spool.shiftRight();else if(!this._.lens.dir){var t=this._.spool.aperture*.5;e.start.x<t?this._.spool.shiftLeft():this._.spool.shiftRight()}else this._.spool.slideBack(!0);return!0},s._lensCancel=function(e){this._.lens&&this._.lens.dir&&this._.spool.slideBack(!0)},s._lensMotion=function(e,t){if(e<t)return">";if(e>t)return"<"},s._lensDelta=function(e){return e.start.x-e.point.x},i}),define("text!bifocal/themes/read/default/resources/icons/icon-sync.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='#000000' fill-rule='evenodd' class='icon-solid'>\n    <path d='M43.2570862,21.9108303 C42.4626052,22.5315468 42.5943897,23.2799512 43.5480593,23.5813712 L54.8277442,27.1464668 C55.3071748,27.2979972 55.6708587,27.0171633 55.6396189,26.5121607 L54.9092247,14.705056 C54.8473738,13.7052123 54.1536189,13.3975259 53.3586987,14.0185856 L43.2570862,21.9108303 L43.2570862,21.9108303 Z' />\n    <path d='M18.2939109,16.033836 C27.1121879,9.14424293 40.0410225,10.7455021 47.3223551,19.0976351 L50.1044273,17.8301192 C41.9439367,7.38516749 26.8749603,5.5225308 16.4469265,13.6698037 C10.8151466,18.0698324 7.68873103,24.4895647 7.28960214,31.1093976 L10.3837511,30.1497285 C11.0171269,24.6211051 13.803979,19.5417552 18.2939109,16.033836 Z' />\n    <path d='M20.3585753,44.8771805 C21.1530563,44.2564639 21.0212718,43.5080596 20.0676022,43.2066395 L8.78791729,39.641544 C8.30848666,39.4900135 7.94480282,39.7708474 7.97604256,40.2758501 L8.70643676,52.0829548 C8.76828766,53.0827985 9.46204261,53.3904849 10.2569628,52.7694252 L20.3585753,44.8771805 L20.3585753,44.8771805 L20.3585753,44.8771805 Z' />\n    <path d='M53.2195593,36.5020568 C52.328632,41.5486511 49.6320925,46.1175484 45.4940999,49.3505025 C36.702683,56.2191102 24.1377262,54.9539171 16.8462638,46.6701016 L13.6835834,47.5542193 C21.8440741,57.999171 36.9130505,59.8618077 47.3410843,51.7145348 C52.590863,47.6129582 55.6636261,41.7563768 56.3796161,35.6186725 L53.2195593,36.5020568 L53.2195593,36.5020568 Z' />\n  </g>\n</svg>\n"}),define("bifocal/themes/read/default/src/parts/sync_button",["require","common","text!../../resources/icons/icon-sync.text.svg"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this._registerIcons(),this._.parts=this._layout(e),this._listen(this._.parts)},r._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"sync-button"}),n.label=t.element({tag:"span",parentNode:n.box,html:"Sync"}),n.icon=BIF.objects.iconator.make("sync",n.box),n},r._listen=function(e){BIF.events.onTap(e.box,this._onTap.bind(this)),BIF.events.on("bifocal:synchronization:commence",this._onSyncCommenced.bind(this)),BIF.events.on("bifocal:synchronization:complete",this._onSyncConcluded.bind(this)),BIF.events.on("bifocal:synchronization:cancel",this._onSyncConcluded.bind(this)),BIF.events.on("bifocal:synchronization:failure",this._onSyncConcluded.bind(this))},r._onTap=function(){BIF.objects.possession.sync(),BIF.objects.activity.record("sync-manual")},r._onSyncCommenced=function(){this._.parts.box.classList.add("syncing")},r._onSyncConcluded=function(){setTimeout(function(){this._.parts.box.classList.remove("syncing")}.bind(this),200)},r._registerIcons=function(){BIF.objects.iconator.register("sync",e("text!../../resources/icons/icon-sync.text.svg"))},n}),define("bifocal/themes/read/default/src/features/world",["require","common","../parts/quirks","../parts/iconator","core/src/bank/bank-scope-cookie","core/src/bank/bank-scope-domain","../parts/bank_migrator","../parts/codex","../parts/brand_overdrive_read","../parts/mode","../parts/modality","../parts/read_header","../parts/stencil","dervish","../parts/possession","../parts/reader","../parts/orient_film","../parts/menu_list","../parts/menu_panel","../../../../read/default/src/parts/panel_app","text!../../resources/icons/pnl-overview.text.svg","text!../../resources/icons/pnl-search.text.svg","text!../../resources/icons/pnl-chapters.text.svg","text!../../resources/icons/pnl-marks.text.svg","text!../../resources/icons/pnl-history.text.svg","text!../../resources/icons/pnl-narration.text.svg","text!../../resources/icons/pnl-readability.text.svg","text!../../resources/icons/pnl-offline-cache.text.svg","text!../../resources/icons/pnl-tips.text.svg","../parts/key_manager","../parts/reader_affordance","../parts/sync_button"],function(e){var t=e("common"),n=e("../parts/quirks");return function(r){return r.runSheet.append(["bifocal:reveal","baseline"],["bifocal:reveal","layout"],["bifocal:reveal","listen"],["bifocal:reveal","envCaps"],["bifocal:reveal","loadBank"],["bifocal:reveal","loadCodex"],["bifocal:reveal","loadBrand"],["bifocal:reveal","loadMode"],["bifocal:sized","loadModality"],["bifocal:sized","loadReadHeader"],["bifocal:sized","loadDervish"],["bifocal:sized","loadPossession"],["bifocal:sized","openReader"],["lens:context:scene","loadStencil"],["bifocal:reader:ready","loadControlFilm"],["bifocal:reader:ready","loadOrientFilm"],["bifocal:reader:ready","loadMenus"],["bifocal:reader:ready","arrangeMenus"],["bifocal:reader:ready","loadKeyManager"],["bifocal:reader:ready","loadReaderAffordance"],["bifocal:reader:built","announceReady"],["bifocal:reader:built","enableSync"],["bifocal:reader:built","enableTracking"],["bifocal:expired","onExpired"]),r.baseline=function(){BIF.state.outlet="Read"},r.layout=function(){if(BIF.root.classList.contains("expired"))return;BIF.objects.iconator=new(e("../parts/iconator")),BIF.elements.bookSurface=t.element({parentNode:document.body,classes:"book-surface"}),BIF.elements.bookPillar=t.element({parentNode:BIF.elements.bookSurface,classes:"book-pillar"}),BIF.elements.menuLayer=t.element({parentNode:BIF.elements.bookPillar,classes:"menu-layer hug-t hug-b hug-r"}),BIF.elements.menuTrain=t.element({parentNode:BIF.elements.menuLayer,classes:"menu-train"}),BIF.elements.bookLayer=t.element({parentNode:BIF.elements.bookPillar,classes:"book-layer"}),BIF.elements.header=t.element({parentNode:BIF.elements.bookLayer,classes:"read-header hug-t"}),BIF.elements.bookBounds=t.element({parentNode:BIF.elements.bookLayer,classes:"book-bounds"}),BIF.elements.bookPortal=t.element({parentNode:BIF.elements.bookBounds,classes:"book-portal"}),BIF.elements.pageGhost=t.element({parentNode:BIF.elements.bookPortal,classes:"page-ghost"}),BIF.elements.scene=t.element({parentNode:BIF.elements.bookPortal,classes:"scene"}),BIF.elements.bookWidgets=t.element({parentNode:BIF.elements.bookBounds,classes:"book-widgets"}),BIF.elements.fullscreenModal=t.element({parentNode:BIF.elements.bookSurface,classes:"full-screen-modal"})},r.listen=function(){BIF.events.on(window,"dragstart",BIF.events.stop),n("cannot-disable-viewport-scaling")&&BIF.events.on(document,"gesturestart",BIF.events.stop)},r.envCaps=function(){var e=document.documentElement.classList;n.ask("ios-standalone ios<9")&&e.add("env-standalone"),n.ask("windows")&&e.add("env-windows")},r.loadBank=function(){var n=e("core/src/bank/bank-scope-cookie"),r=e("core/src/bank/bank-scope-domain");BIF.bank={global:new n("bifocal"),title:new r(BIF.map["-odread-bank-scope"])};var i=e("../parts/bank_migrator");(new i).migrate(),BIF.deviceId=BIF.bank.global.get("device-id"),BIF.deviceId||BIF.bank.global.set("device-id",BIF.deviceId=t.generateUUID())},r.loadCodex=function(){var t=e("../parts/codex");BIF.objects.codex=new t},r.loadBrand=function(){var t=e("../parts/brand_overdrive_read");BIF.objects.brand=new t},r.loadMode=function(){var t=e("../parts/mode");BIF.objects.mode=new t,BIF.objects.mode.engage()},r.loadModality=function(){var t=e("../parts/modality");BIF.objects.modality=new t(r.DEFAULT_MODALITY,r.INITIAL_MODALITY)},r.loadReadHeader=function(){var t=e("../parts/read_header");BIF.objects.readHeader=new t(BIF.elements.header)},r.loadStencil=function(n){var r=e("../parts/stencil"),i=t.element({parentNode:n.m.scene.context.spool._.box,classes:"stencil"});BIF.objects.stencil=new r(i),BIF.dispatch("bifocal:stencil",{stencil:BIF.objects.stencil})},r.loadDervish=function(){var t=e("dervish");BIF.objects.dervish=new t.Manager,BIF.objects.expiration=new t.Expiration,BIF.objects.selection=new t.Selection,BIF.objects.activity=new t.Activity},r.loadPossession=function(){var t=e("../parts/possession");BIF.objects.possession=new t},r.openReader=function(){if(BIF.objects.reader)return;var t=e("../parts/reader");BIF.objects.reader=new t(BIF.elements.scene),BIF.objects.reader.open()},r.loadControlFilm=function(){BIF.elements.controlFilm=t.element({parentNode:BIF.elements.bookLayer,classes:"control-film"})},r.loadOrientFilm=function(){var t=e("../parts/orient_film");BIF.objects.orientFilm=new t(BIF.elements.bookLayer)},r.loadMenus=function(){var t=e("../parts/menu_list");BIF.objects.menuList=new t(BIF.elements.menuTrain);var n=e("../parts/menu_panel");BIF.objects.menuPanel=new n(BIF.elements.menuTrain);if(BIF.objects.brand["panel-html"]){var r=e("../../../../read/default/src/parts/panel_app");BIF.objects.panelApp=new r}},r.arrangeMenus=function(){var n={ovw:e("text!../../resources/icons/pnl-overview.text.svg"),sch:e("text!../../resources/icons/pnl-search.text.svg"),toc:e("text!../../resources/icons/pnl-chapters.text.svg"),mrk:e("text!../../resources/icons/pnl-marks.text.svg"),hst:e("text!../../resources/icons/pnl-history.text.svg"),nar:e("text!../../resources/icons/pnl-narration.text.svg"),rdy:e("text!../../resources/icons/pnl-readability.text.svg"),olc:e("text!../../resources/icons/pnl-offline-cache.text.svg"),tip:e("text!../../resources/icons/pnl-tips.text.svg")},r=[];t.each(n,function(e,t){r.push(e),BIF.objects.iconator.register(e,t)}),BIF.objects.menuList.arrangement(r)},r.loadKeyManager=function(){var t=e("../parts/key_manager");BIF.objects.keyManager=new t,setInterval(BIF.objects.keyManager.listenForFocus.bind(BIF.objects.keyManager),1e3)},r.loadReaderAffordance=function(t){var n=e("../parts/reader_affordance");BIF.objects.readerAffordance=new n(t.m.scene)},r.announceReady=function(){setTimeout(function(){BIF.state.ready=t.epochMilliseconds(),BIF.root.classList.add("ready"),BIF.dispatch("bifocal:ready")},0)},r.enableSync=function(){if(BIF.map["-odread-msg-sync"]){var t=document.querySelector(".orient-page-numbers");if(t){var n=e("../parts/sync_button");BIF.elements.orientSyncButton=new n(t)}}BIF.objects.possession.sync(),BIF.objects.possession.autoSync(9e5,{onlyCheckExpiry:!0})},r.enableTracking=function(){BIF.objects.activity.startTracking()},r.onExpired=function(){t.each(document.querySelectorAll("#spool .sheet"),function(e){parseFloat(e.style.opacity)<1&&(e.innerHTML="",e.style.visibility="hidden")})},!0}}),define("bifocal/themes/read/default/src/parts/stencil_links",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this._.stencil=e,this._.count=0,BIF.listen("lens:component:visible",this._onComponentVisible.bind(this))},r._onComponentVisible=function(e){var n=e.m.component.frameBox.contentDocument;t.each(n.querySelectorAll("a[href]"),this._processLink,this)},r._processLink=function(e){BIF.listen(e,"click",BIF.events.stop);var t=this._constructHrefObject(e),n="link-"+(this._.count+=1),r=this._rangeFor(e),i={className:"mask-link",title:t.internal?"Skip to chapter":e.title,priority:1,padding:2,tap:this._tapHandlerFor(t)};this._.stencil.add(n,r,i)},r._rangeFor=function(e){var t=e.ownerDocument.createRange();return t.selectNodeContents(e),t},r._constructHrefObject=function(e){var t=document.location,n=t.protocol+"//"+t.host,r=e.href,i=r.substring(n.length),s=r.match(/^dispatch:(.*)$/);if(s)return{dispatch:s[1]};if(e.getAttribute("target"))return{external:r};if(r.indexOf(n)!==0)return{external:r};var o=t.pathname.replace(/[^\/]*\.[^\/]+$/,"");return o[o.length-1]!="/"&&(o+="/"),i.indexOf(o)===0?{internal:i.substring(o.length)}:{external:r}},r._tapHandlerFor=function(e){if(e.dispatch)return function(){BIF.events.dispatch(e.dispatch)};if(e.external)return function(){this._openURL(e.external)}.bind(this);if(e.internal)return function(){this._jumpToURL(e.internal)}.bind(this)},r._openURL=function(e){BIF.dispatch("bifocal:link:external",{url:e})},r._jumpToURL=function(e){BIF.objects.compass.seek(e)||BIF.dispatch("bifocal:notify:message","Chapter is not accessible.")},n}),function(e){var t=Date.now||function(){return+(new Date)},n=60,r=1e3,i={},s={},o=1;e.core?core.effect||(core.effect={}):e.core={effect:{}},core.effect.Animate={requestAnimationFrame:function(){var t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame,n=!!t;t&&!/requestAnimationFrame\(\)\s*\{\s*\[native code\]\s*\}/i.test(t.toString())&&(n=!1);if(n)return function(e,n){t(e,n)};var r=60,i={},s=0,o=1,u=null,a=+(new Date);return function(e,t){var n=o++;return i[n]=e,s++,u===null&&(u=setInterval(function(){var e=+(new Date),t=i;i={},s=0;for(var n in t)t.hasOwnProperty(n)&&(t[n](e),a=e);e-a>2500&&(clearInterval(u),u=null)},1e3/r)),n}}(),stop:function(e){var t=i[e]!=null;return t&&(i[e]=null),t},cancel:function(e){s[e]={},core.effect.Animate.stop(e)},isRunning:function(e){return i[e]!=null},start:function(e,u,a,f,l,c){var h=t(),p=h,d=0,v=0,m=o++;c||(c=document.body);if(m%20===0){var g={},y={};for(var b in i)g[b]=!0,y[b]=s[b];i=g,s=y}s[m]={step:e,verify:u,complete:a};var w=function(e){var o=e!==!0,u=t();if(!i[m]||s[m].verify&&!s[m].verify(m)){i[m]=null,s[m].complete&&s[m].complete(n-v/((u-h)/r),m,!1);return}if(o){var a=Math.round((u-p)/(r/n))-1;for(var g=0;g<Math.min(a,4);g++)w(!0),v++}f&&(d=(u-h)/f,d>1&&(d=1));var y=l?l(d):d;s[m].step(y,u,o)!==!1&&d!==1||!o?o&&(p=u,core.effect.Animate.requestAnimationFrame(w,c)):(i[m]=null,s[m].complete&&s[m].complete(n-v/((u-h)/r),m,d===1||f==null))};return i[m]=!0,core.effect.Animate.requestAnimationFrame(w,c),m}}}(this),define("scroller/src/zynga_animate",function(){});var Scroller;(function(){var e=function(){};Scroller=function(t,n){this.__callback=t,this.options={scrollingX:!0,scrollingY:!0,animating:!0,animationDuration:250,bouncing:!0,locking:!0,paging:!1,snapping:!1,zooming:!1,minZoom:.5,maxZoom:3,speedMultiplier:1,minTouchDelta:80,scrollingComplete:e,penetrationDeceleration:.03,penetrationAcceleration:.08};for(var r in n)this.options[r]=n[r]};var t=function(e){return Math.pow(e-1,3)+1},n=function(e){return(e/=.5)<1?.5*Math.pow(e,3):.5*(Math.pow(e-2,3)+2)},r={__isSingleTouch:!1,__isTracking:!1,__didDecelerationComplete:!1,__isGesturing:!1,__isDragging:!1,__isDecelerating:!1,__isAnimating:!1,__clientLeft:0,__clientTop:0,__clientWidth:0,__clientHeight:0,__contentWidth:0,__contentHeight:0,__snapWidth:100,__snapHeight:100,__refreshHeight:null,__refreshActive:!1,__refreshActivate:null,__refreshDeactivate:null,__refreshStart:null,__zoomLevel:1,__scrollLeft:0,__scrollTop:0,__maxScrollLeft:0,__maxScrollTop:0,__scheduledLeft:0,__scheduledTop:0,__scheduledZoom:0,__lastTouchLeft:null,__lastTouchTop:null,__lastTouchMove:null,__positions:null,__minDecelerationScrollLeft:null,__minDecelerationScrollTop:null,__maxDecelerationScrollLeft:null,__maxDecelerationScrollTop:null,__decelerationVelocityX:null,__decelerationVelocityY:null,setDimensions:function(e,t,n,r){var i=this;e===+e&&(i.__clientWidth=e),t===+t&&(i.__clientHeight=t),n===+n&&(i.__contentWidth=n),r===+r&&(i.__contentHeight=r),i.__computeScrollMax(),i.scrollTo(i.__scrollLeft,i.__scrollTop,!0)},setPosition:function(e,t){var n=this;n.__clientLeft=e||0,n.__clientTop=t||0},setSnapSize:function(e,t){var n=this;n.__snapWidth=e,n.__snapHeight=t},activatePullToRefresh:function(e,t,n,r){var i=this;i.__refreshHeight=e,i.__refreshActivate=t,i.__refreshDeactivate=n,i.__refreshStart=r},triggerPullToRefresh:function(){this.__publish(this.__scrollLeft,-this.__refreshHeight,this.__zoomLevel,!0),this.__refreshStart&&this.__refreshStart()},finishPullToRefresh:function(){var e=this;e.__refreshActive=!1,e.__refreshDeactivate&&e.__refreshDeactivate(),e.scrollTo(e.__scrollLeft,e.__scrollTop,!0)},getValues:function(){var e=this;return{left:e.__scrollLeft,top:e.__scrollTop,zoom:e.__zoomLevel}},getScrollMax:function(){var e=this;return{left:e.__maxScrollLeft,top:e.__maxScrollTop}},zoomTo:function(e,t,n,r,i){var s=this;if(!s.options.zooming)throw new Error("Zooming is not enabled!");i&&(s.__zoomComplete=i),s.__isDecelerating&&(core.effect.Animate.stop(s.__isDecelerating),s.__isDecelerating=!1);var o=s.__zoomLevel;n==null&&(n=s.__clientWidth/2),r==null&&(r=s.__clientHeight/2),e=Math.max(Math.min(e,s.options.maxZoom),s.options.minZoom),s.__computeScrollMax(e);var u=(n+s.__scrollLeft)*e/o-n,a=(r+s.__scrollTop)*e/o-r;u>s.__maxScrollLeft?u=s.__maxScrollLeft:u<0&&(u=0),a>s.__maxScrollTop?a=s.__maxScrollTop:a<0&&(a=0),s.__publish(u,a,e,t)},zoomBy:function(e,t,n,r,i){var s=this;s.zoomTo(s.__zoomLevel*e,t,n,r,i)},scrollTo:function(e,t,n,r){var i=this;i.__isDecelerating&&(core.effect.Animate.stop(i.__isDecelerating),i.__isDecelerating=!1);if(r!=null&&r!==i.__zoomLevel){if(!i.options.zooming)throw new Error("Zooming is not enabled!");e*=r,t*=r,i.__computeScrollMax(r)}else r=i.__zoomLevel;i.options.scrollingX?i.options.paging?e=Math.round(e/i.__clientWidth)*i.__clientWidth:i.options.snapping&&(e=Math.round(e/i.__snapWidth)*i.__snapWidth):e=i.__scrollLeft,i.options.scrollingY?i.options.paging?t=Math.round(t/i.__clientHeight)*i.__clientHeight:i.options.snapping&&(t=Math.round(t/i.__snapHeight)*i.__snapHeight):t=i.__scrollTop,e=Math.max(Math.min(i.__maxScrollLeft,e),0),t=Math.max(Math.min(i.__maxScrollTop,t),0),e===i.__scrollLeft&&t===i.__scrollTop&&(n=!1),i.__publish(e,t,r,n)},scrollBy:function(e,t,n){var r=this,i=r.__isAnimating?r.__scheduledLeft:r.__scrollLeft,s=r.__isAnimating?r.__scheduledTop:r.__scrollTop;r.scrollTo(i+(e||0),s+(t||0),n)},doMouseZoom:function(e,t,n,r){var i=this,s=e>0?.97:1.03;return i.zoomTo(i.__zoomLevel*s,!1,n-i.__clientLeft,r-i.__clientTop)},doTouchStart:function(e,t){if(e.length==null)throw new Error("Invalid touch list: "+e);t instanceof Date&&(t=t.valueOf());if(typeof t!="number")throw new Error("Invalid timestamp value: "+t);var n=this;n.__interruptedAnimation=!0,n.__isDecelerating&&(core.effect.Animate.stop(n.__isDecelerating),n.__isDecelerating=!1,n.__interruptedAnimation=!0),n.__isAnimating&&(core.effect.Animate.stop(n.__isAnimating),n.__isAnimating=!1,n.__interruptedAnimation=!0);var r,i,s=e.length===1;s?(r=e[0].pageX,i=e[0].pageY):(r=Math.abs(e[0].pageX+e[1].pageX)/2,i=Math.abs(e[0].pageY+e[1].pageY)/2),n.__initialTouchLeft=r,n.__initialTouchTop=i,n.__zoomLevelStart=n.__zoomLevel,n.__lastTouchLeft=r,n.__lastTouchTop=i,n.__lastTouchMove=t,n.__lastScale=1,n.__enableScrollX=!s&&n.options.scrollingX,n.__enableScrollY=!s&&n.options.scrollingY,n.__isTracking=!0,n.__didDecelerationComplete=!1,n.__isDragging=!s,n.__isSingleTouch=s,n.__positions=[]},doTouchMove:function(e,t,n){if(e.length==null)throw new Error("Invalid touch list: "+e);t instanceof Date&&(t=t.valueOf());if(typeof t!="number")throw new Error("Invalid timestamp value: "+t);var r=this;if(!r.__isTracking)return;var i,s;e.length===2?(i=Math.abs(e[0].pageX+e[1].pageX)/2,s=Math.abs(e[0].pageY+e[1].pageY)/2):(i=e[0].pageX,s=e[0].pageY);var o=r.__positions;if(r.__isDragging){var u=i-r.__lastTouchLeft,a=s-r.__lastTouchTop,f=r.__scrollLeft,l=r.__scrollTop,c=r.__zoomLevel;if(n!=null&&r.options.zooming){var h=c;c=c/r.__lastScale*n,c=Math.max(Math.min(c,r.options.maxZoom),r.options.minZoom);if(h!==c){var p=i-r.__clientLeft,d=s-r.__clientTop;f=(p+f)*c/h-p,l=(d+l)*c/h-d,r.__computeScrollMax(c)}}if(r.__enableScrollX){f-=u*this.options.speedMultiplier;var v=r.__maxScrollLeft;if(f>v||f<0)r.options.bouncing?f+=u/2*this.options.speedMultiplier:f>v?f=v:f=0}if(r.__enableScrollY){l-=a*this.options.speedMultiplier;var m=r.__maxScrollTop;if(l>m||l<0)r.options.bouncing?(l+=a/2*this.options.speedMultiplier,!r.__enableScrollX&&r.__refreshHeight!=null&&(!r.__refreshActive&&l<=-r.__refreshHeight?(r.__refreshActive=!0,r.__refreshActivate&&r.__refreshActivate()):r.__refreshActive&&l>-r.__refreshHeight&&(r.__refreshActive=!1,r.__refreshDeactivate&&r.__refreshDeactivate()))):l>m?l=m:l=0}o.length>60&&o.splice(0,30),o.push(f,l,t),r.__publish(f,l,c)}else{var g=r.options.locking?8:0,y=5,b=Math.abs(i-r.__initialTouchLeft),w=Math.abs(s-r.__initialTouchTop);r.__enableScrollX=r.options.scrollingX&&b>=g,r.__enableScrollY=r.options.scrollingY&&w>=g,o.push(r.__scrollLeft,r.__scrollTop,t),r.__isDragging=(r.__enableScrollX||r.__enableScrollY)&&(b>=y||w>=y),r.__isDragging&&(r.__interruptedAnimation=!1)}r.__lastTouchLeft=i,r.__lastTouchTop=s,r.__lastTouchMove=t,r.__lastScale=n},doTouchEnd:function(e){e instanceof Date&&(e=e.valueOf());if(typeof e!="number")throw new Error("Invalid timestamp value: "+e);var t=this;if(!t.__isTracking)return;t.__isTracking=!1;if(t.__isDragging){t.__isDragging=!1;if(t.__isSingleTouch&&t.options.animating&&e-t.__lastTouchMove<=100){var n=t.__positions,r=n.length-1,i=r;for(var s=r;s>0&&n[s]>t.__lastTouchMove-100;s-=3)i=s;if(i!==r){var o=n[r]-n[i],u=t.__scrollLeft-n[i-2],a=t.__scrollTop-n[i-1];t.options.minTouchDelta&&(o=Math.max(o,t.options.minTouchDelta)),t.__decelerationVelocityX=u/o*(1e3/60),t.__decelerationVelocityY=a/o*(1e3/60);var f=t.options.paging||t.options.snapping?4:1;if(Math.abs(t.__decelerationVelocityX)>f||Math.abs(t.__decelerationVelocityY)>f)t.__decelerationVelocityX*=t.options.nitroX||1,t.__decelerationVelocityY*=t.options.nitroY||1,t.__refreshActive||t.__startDeceleration(e)}else t.options.scrollingComplete()}else e-t.__lastTouchMove>100&&t.options.scrollingComplete()}t.__isDecelerating||(t.__refreshActive&&t.__refreshStart?(t.__publish(t.__scrollLeft,-t.__refreshHeight,t.__zoomLevel,!0),t.__refreshStart&&t.__refreshStart()):((t.__interruptedAnimation||t.__isDragging)&&t.options.scrollingComplete(),t.scrollTo(t.__scrollLeft,t.__scrollTop,!0,t.__zoomLevel),t.__refreshActive&&(t.__refreshActive=!1,t.__refreshDeactivate&&t.__refreshDeactivate()))),t.__positions.length=0},__publish:function(e,r,i,s){var o=this,u=o.__isAnimating;u&&(core.effect.Animate.stop(u),o.__isAnimating=!1);if(s&&o.options.animating){o.__scheduledLeft=e,o.__scheduledTop=r,o.__scheduledZoom=i;var a=o.__scrollLeft,f=o.__scrollTop,l=o.__zoomLevel,c=e-a,h=r-f,p=i-l,d=function(e,t,n){n&&(o.__scrollLeft=a+c*e,o.__scrollTop=f+h*e,o.__zoomLevel=l+p*e,o.__callback&&o.__callback(o.__scrollLeft,o.__scrollTop,o.__zoomLevel))},v=function(e){return o.__isAnimating===e},m=function(e,t,n){t===o.__isAnimating&&(o.__isAnimating=!1),(o.__didDecelerationComplete||n)&&o.options.scrollingComplete(),o.options.zooming&&(o.__computeScrollMax(),o.__zoomComplete&&(o.__zoomComplete(),o.__zoomComplete=null))};o.__isAnimating=core.effect.Animate.start(d,v,m,o.options.animationDuration,u?t:n)}else o.__scheduledLeft=o.__scrollLeft=e,o.__scheduledTop=o.__scrollTop=r,o.__scheduledZoom=o.__zoomLevel=i,o.__callback&&o.__callback(e,r,i),o.options.zooming&&(o.__computeScrollMax(),o.__zoomComplete&&(o.__zoomComplete(),o.__zoomComplete=null))},__computeScrollMax:function(e){var t=this;e==null&&(e=t.__zoomLevel),t.__maxScrollLeft=Math.max(t.__contentWidth*e-t.__clientWidth,0),t.__maxScrollTop=Math.max(t.__contentHeight*e-t.__clientHeight,0)},__startDeceleration:function(e){var t=this;if(t.options.paging){var n=Math.max(Math.min(t.__scrollLeft,t.__maxScrollLeft),0),r=Math.max(Math.min(t.__scrollTop,t.__maxScrollTop),0),i=t.__clientWidth,s=t.__clientHeight;t.__minDecelerationScrollLeft=Math.floor(n/i)*i,t.__minDecelerationScrollTop=Math.floor(r/s)*s,t.__maxDecelerationScrollLeft=Math.ceil(n/i)*i,t.__maxDecelerationScrollTop=Math.ceil(r/s)*s}else t.__minDecelerationScrollLeft=0,t.__minDecelerationScrollTop=0,t.__maxDecelerationScrollLeft=t.__maxScrollLeft,t.__maxDecelerationScrollTop=t.__maxScrollTop;var o=function(e,n,r){t.__stepThroughDeceleration(r)},u=t.options.snapping?4:.1,a=function(){var e=Math.abs(t.__decelerationVelocityX)>=u||Math.abs(t.__decelerationVelocityY)>=u;return e||(t.__didDecelerationComplete=!0),e},f=function(e,n,r){t.__isDecelerating=!1,t.__didDecelerationComplete&&t.options.scrollingComplete(),t.scrollTo(t.__scrollLeft,t.__scrollTop,t.options.snapping)};t.__isDecelerating=core.effect.Animate.start(o,a,f)},__stepThroughDeceleration:function(e){var t=this,n=t.__scrollLeft+t.__decelerationVelocityX,r=t.__scrollTop+t.__decelerationVelocityY;if(!t.options.bouncing){var i=Math.max(Math.min(t.__maxDecelerationScrollLeft,n),t.__minDecelerationScrollLeft);i!==n&&(n=i,t.__decelerationVelocityX=0);var s=Math.max(Math.min(t.__maxDecelerationScrollTop,r),t.__minDecelerationScrollTop);s!==r&&(r=s,t.__decelerationVelocityY=0)}e?t.__publish(n,r,t.__zoomLevel):(t.__scrollLeft=n,t.__scrollTop=r);if(!t.options.paging){var o=.95;t.__decelerationVelocityX*=o,t.__decelerationVelocityY*=o}if(t.options.bouncing){var u=0,a=0,f=t.options.penetrationDeceleration,l=t.options.penetrationAcceleration;n<t.__minDecelerationScrollLeft?u=t.__minDecelerationScrollLeft-n:n>t.__maxDecelerationScrollLeft&&(u=t.__maxDecelerationScrollLeft-n),r<t.__minDecelerationScrollTop?a=t.__minDecelerationScrollTop-r:r>t.__maxDecelerationScrollTop&&(a=t.__maxDecelerationScrollTop-r),u!==0&&(u*t.__decelerationVelocityX<=0?t.__decelerationVelocityX+=u*f:t.__decelerationVelocityX=u*l),a!==0&&(a*t.__decelerationVelocityY<=0?t.__decelerationVelocityY+=a*f:t.__decelerationVelocityY=a*l)}}};for(var i in r)Scroller.prototype[i]=r[i]})(),define("scroller/src/zynga_scroller",function(){}),define("scroller/scroller",["require","./src/zynga_animate","./src/zynga_scroller"],function(e){return e("./src/zynga_animate"),e("./src/zynga_scroller"),Scroller}),define("scroller",["scroller/scroller"],function(e){return e}),define("bifocal/themes/read/default/src/parts/stencil_images",["require","common","scroller"],function(e){var t=e("common"),n=e("scroller"),r=t.Class.new(),i=r.prototype;return i.LONG_PRESS_MS=200,i.PAN_DISMISS_PX=120,i.PAN_DISMISS_OPACITY=.75,i.BALLOON_ANIM_MS=600,i.SCROLLER_ANIM_MS=250,i.$init=function(e){this._.stencil=e,this._.count=0,BIF.listen("lens:component:visible",this._onComponentVisible.bind(this))},i._onComponentVisible=function(e){var n=e.m.component;if(n.block.layout=="reflowable"){var r=n.frameBox.contentDocument;t.each(r.querySelectorAll("img[src]"),this._processImage,this)}},i._processImage=function(e){BIF.listen(e,"click",BIF.events.stop);var t="image-"+(this._.count+=1),n=this._rangeFor(e),r={className:"mask-image",title:"Zoom image",priority:1,padding:2,glaze:this._glazeHandlerFor(e)};this._.stencil.add(t,n,r)},i._rangeFor=function(e){var t=e.ownerDocument.createRange();return t.selectNodeContents(e),t},i._glazeHandlerFor=function(e){var n={state:{}},r=this.LONG_PRESS_MS;return n.start=function(e,i){n.end(),n.state.regions=i.regions,t.each(n.state.regions,function(e){if(!e.mask)return;e.mask.classList.add("stencil-image-pressing")}),n.state.timer=setTimeout(n.trigger,r)},n.trigger=function(){var t=BIF.context.ruler.componentForDocument(e.ownerDocument);t&&t.isLoaded()&&(this._billboardImage(e),n.state.triggered=!0)}.bind(this),n.move=function(e){return n.state.timer&&e.intentionalMotion.length?n.end():n.state.triggered},n.end=function(){var e=n.state.triggered;return clearTimeout(n.state.timer),t.each(n.state.regions,function(e){if(!e.mask)return;e.mask.classList.remove("stencil-image-pressing")}),n.state={},e},n.cancel=n.end,n},i._billboardImage=function(e){var n={};n.source=e,n.board=t.element({parentNode:BIF.elements.fullscreenModal,classes:"stencil-image-billboard"}),n.veil=t.element({parentNode:n.board,classes:"stencil-image-veil"}),n.panhandler=t.element({parentNode:n.board,classes:"stencil-image-panhandler"}),n.pannable=t.element({parentNode:n.panhandler,classes:"stencil-image-pannable"}),n.fixture=t.element({parentNode:n.pannable,classes:"stencil-image-fixture"}),n.balloon=t.element({parentNode:n.fixture,classes:"stencil-image-balloon"}),n.clone=t.element({parentNode:n.balloon,tag:"img",classes:"stencil-image-clone"});var r=n.source.title||n.source.alt;if(!r||r.replace(/[^\w]+/g,"").toLowerCase()=="image")r=null;r&&(n.caption=t.element({parentNode:n.board,classes:"stencil-image-caption",html:r})),n.dismissButton=t.element({parentNode:n.board,classes:"stencil-image-dismiss-button",html:"&times;"}),n.clone.onload=this._onBillboardLoaded.bind(this,n),n.clone.setAttribute("src",n.source.src)},i._onBillboardLoaded=function(e){e.clientWidth=e.board.offsetWidth,e.clientHeight=e.board.offsetHeight,e.wRatio=e.clientWidth/e.source.naturalWidth,e.hRatio=e.clientHeight/e.source.naturalHeight,e.ratio=Math.max(e.wRatio,e.hRatio),e.contentWidth=Math.round(e.source.naturalWidth*e.ratio),e.contentHeight=Math.round(e.source.naturalHeight*e.ratio),e.fitZoom=Math.min(e.clientWidth/e.contentWidth,e.clientHeight/e.contentHeight),e.natZoom=Math.min(e.source.naturalWidth/e.clientWidth,e.source.naturalHeight/e.clientHeight),e.initialZoom=Math.min(e.fitZoom,e.natZoom),e.initialWidth=e.contentWidth*e.initialZoom,e.initialHeight=e.contentHeight*e.initialZoom,e.xOffset=e.clientWidth*.5-e.initialWidth*.5,e.yOffset=e.clientHeight*.5-e.initialHeight*.5,e.maxZoom=e.initialZoom==e.natZoom?3:4,e.fixture.style.width=e.initialWidth+"px",e.fixture.style.height=e.initialHeight+"px",this._positionBalloonToSource(e);var t={locking:!1,bouncing:!0,zooming:!0,minZoom:.9,maxZoom:e.maxZoom,animationDuration:this.SCROLLER_ANIM_MS};e.scroller=new n(this._scrollerRender.bind(this,e),t),e.scroller.setDimensions(e.clientWidth,e.clientHeight,e.clientWidth,e.clientHeight),e.pointerHandler=BIF.events.onContact(e.panhandler,{start:this._onScrollerStart.bind(this,e),move:this._onScrollerMove.bind(this,e),end:this._onScrollerEnd.bind(this,e),cancel:this._onScrollerCancel.bind(this,e)},{multitouch:!0}),BIF.events.on(e.panhandler,"onwheel"in document.body?"wheel":"mousewheel",this._onScrollerWheel.bind(this,e)),BIF.events.onTap(e.panhandler,this._onTap.bind(this,e)),BIF.events.onTap(e.dismissButton,this._billboardDismiss.bind(this,e));var r=BIF.events.on("bifocal:mode:resize",function(){r.deafen(),this._cleanup(e)}.bind(this));e.board.classList.add("active"),setTimeout(function(){e.balloon.style.display="block",e.source.style.visibility="hidden",setTimeout(this._positionBalloonToCenter.bind(this,e),0),setTimeout(function(){e.board.classList.add("clutter"),e.board.classList.add("interactive")},this.BALLOON_ANIM_MS)}.bind(this),0)},i._onTap=function(e){if(e.dismissed)return;this._billboardMode(e);var n=t.epochMilliseconds();n-this._.lastTap<300&&(e.renderZ!==1?e.scroller.zoomTo(1,!0):this._billboardDismiss(e)),this._.lastTap=n},i._billboardMode=function(e){e.board.classList.toggle("clutter")},i._billboardDismiss=function(e){if(e.dismissed)return;e.dismissed=!0,e.pointerHandler.deafen(),e.board.classList.remove("active"),e.board.classList.remove("interactive"),e.veil.style.removeProperty("transition"),e.veil.style.opacity=0,core.effect.Animate.cancel(e.scroller.__isDecelerating),core.effect.Animate.cancel(e.scroller.__isAnimating),e.scroller.zoomTo(1,!0),this._positionBalloonToSource(e),setTimeout(this._cleanup.bind(this,e),this.BALLOON_ANIM_MS)},i._cleanup=function(e){e.dismissed=!0,e.source.style.visibility="visible",e.board.parentNode.removeChild(e.board)},i._scrollerRender=function(e,n,r,i){var s=Math.round(0-n),o=Math.round(0-r);if(e.renderX===s&&e.renderY===o&&e.renderZ===i)return;var u="translate3d("+s+"px,"+o+"px,0)",a="scale("+i+")";t.prefixProperty(e.pannable.style,"transform",u+" "+a),e.renderX=s,e.renderY=o,e.renderZ=i;if(!e.dismissed){var f=1;if(i<1)f=i*i*i*i*i;else{var l=e.clientHeight*.5*i-e.clientHeight*.5,c=Math.abs(r-l),h=c-Math.abs(l),p=e.initialHeight/e.clientHeight;if(p<.8&&i>2){var d=(e.clientHeight-e.initialHeight)*i;h+=d*.25}h=Math.max(0,Math.round(h));if(h){var v=this.PAN_DISMISS_PX/(1-this.PAN_DISMISS_OPACITY);f=(v-h)/v}}f!==e.renderOpacity&&(e.veil.style.opacity=f,e.renderOpacity=f),f<this.PAN_DISMISS_OPACITY&&setTimeout(this._billboardDismiss.bind(this,e),33)}},i._scrollerDo=function(e,n,r){return e["do"+n](r.contactPointers,t.epochMilliseconds(),r.contactScale)},i._onScrollerStart=function(e,t){this._scrollerDo(e.scroller,"TouchStart",t)},i._onScrollerMove=function(e,t){this._scrollerDo(e.scroller,"TouchMove",t)},i._onScrollerEnd=function(e,n){var r=parseFloat(e.veil.style.opacity);e.scroller.doTouchEnd(t.epochMilliseconds())},i._onScrollerCancel=i._onScrollerEnd,i._onScrollerWheel=function(e,t){if(e.dismissed)return;var n=0;typeof t.deltaY=="number"?n=t.deltaY:typeof t.wheelDelta=="number"&&(n=0-t.wheelDelta),n=n>0?1:n<0?-1:0,e.scroller.doMouseZoom(n,t.timeStamp,t.pageX,t.pageY)},i._positionBalloonToSource=function(e){if(!e.balloonTransform){var n=e.source.getBoundingClientRect(),r=e.source.naturalWidth/e.source.naturalHeight,i=n.left,s=n.width,o=n.width/r,u=n.top+(n.height*.5-o*.5),a=BIF.elements.scene.getBoundingClientRect(),f=BIF.context.ruler.elementToSpool(e.source,i,u);f=BIF.context.ruler.spoolToScene(f.x,f.y),f.x=f.x+a.left,f.y=f.y+a.top;var l=Math.round(f.x-e.xOffset),c=Math.round(f.y-e.yOffset),h="translate3d("+l+"px,"+c+"px,0)",r=e.source.naturalWidth/e.source.naturalHeight,p=s/e.initialWidth,d=o/e.initialHeight,v="scale3d("+p+","+d+",1)";e.balloonTransform=h+" "+v}t.prefixProperty(e.balloon.style,"transform",e.balloonTransform)},i._positionBalloonToCenter=function(e){t.prefixProperty(e.balloon.style,"transform")},r}),define("bifocal/themes/read/default/src/features/links",["require","../parts/stencil_links","../parts/stencil_images"],function(e){var t=e("../parts/stencil_links"),n=e("../parts/stencil_images");return function(e){e.runSheet.append(["bifocal:stencil","hijackLinks"]),e.runSheet.append(["bifocal:stencil","hijackImages"]),e.runSheet.append(["bifocal:link:external","onExternalLinkClick"]),e.hijackLinks=function(e){BIF.objects.stencilLinks=new t(e.m.stencil)},e.hijackImages=function(e){BIF.objects.stencilImages=new n(e.m.stencil)},e.onExternalLinkClick=function(e){window.open(e.m.url,"_blank")}}}),define("bifocal/themes/read/default/src/parts/pincer",["require","common","core/src/locator","./quirks"],function(e){var t=e("common"),n=e("core/src/locator"),r=e("./quirks"),i=function(){function u(){o.locator=new n,BIF.listen("bifocal:pincer:reset",p),BIF.listen("bifocal:place",h),BIF.listen("lens:scene:rebuild",h)}function a(t){return o.pincing=!0,o.component=t.component,o.doc=o.component.frameBox.contentDocument,k(t),g()?(BIF.dispatch("bifocal:pince",{pincer:e}),!0):!1}function f(t){k(t),g()&&BIF.dispatch("bifocal:pincing",{pincer:e})}function l(){o.pincing=!1,o.range&&(m(o.range),d()),BIF.dispatch("bifocal:pinced",{pincer:e})}function c(e,t){o.component=e,o.doc=o.component.frameBox.contentDocument,o.range=t,m(o.range),d()}function h(){o.pincing&&(o.pincing=!1,BIF.dispatch("bifocal:pinced",{pincer:e}));if(o.range)return o.range=null,BIF.objects.stencil.remove("pincer-chunk"),BIF.dispatch("bifocal:deselection",{pincer:e}),!0}function p(e){h()&&e.preventDefault()}function d(){if(o.range){if(o.range.collapsed)return h();var t={className:"mask-pincer-chunk",glaze:{start:L,move:A,end:O}};BIF.objects.stencil.add("pincer-chunk",o.range,t);var n={pincer:e,text:v(o.range),locatorA:o.locatorA,locatorZ:o.locatorZ};BIF.dispatch("bifocal:selection",n)}}function v(e){var n="",r=function(e){var t=e.currentStyle||window.getComputedStyle(e,"");return t.display!=="inline"},i=t._nextInWalk(e.endContainer);return t.walk(e.startContainer,function(t){if(t===i)throw"halt";var s=t===e.startContainer,o=t===e.endContainer;if(t.nodeType==1){var u=t.tagName;u=="BR"||u=="HR"?n+="\n":r(t)&&(n+="\n\n")}else if(t.nodeType==3&&t.nodeValue.length){var a=t.nodeValue;s&&o?a=a.substring(e.startOffset,e.endOffset):s?a=a.substring(e.startOffset):o&&(a=a.substring(0,e.endOffset)),n+=a.replace(/\s+/g," ")}}),n}function m(e){var t=e.cloneRange();t.collapse(!0);var n=t.endContainer.nodeValue.length;while(t.endOffset<n){t.setEnd(t.endContainer,t.endOffset+1);var r=t.toString();if(r.length>s.LOCATOR_MIN_CHARS&&r.substr(-1).match(/\s/)){t.setEnd(t.endContainer,t.endOffset-1);break}}var i=e.cloneRange();i.collapse(!1),w(i);while(i.startOffset){i.setStart(i.startContainer,i.startOffset-1);var r=i.toString();if(r.length>s.LOCATOR_MIN_CHARS&&r[0].match(/\s/)){i.setStart(i.startContainer,i.startOffset+1);break}}o.locatorA=o.locator.rangeToLocator(t,o.component.spinePosition),o.locatorZ=o.locator.rangeToLocator(i,o.component.spinePosition)}function g(){var e=E();if(!e)return;var t=o.state.cur.x,n=o.state.cur.y,r=S(e,t,n),i=null;if(r){i=x(r,t,n);if(!i)return;var s=i.toString();if(s.match(/[\s]/))return}else{var u=e;while(u){if(u.nodeType===e.TEXT_NODE){r=u;break}u=u.lastChild||u.previousSibling||(u.parentNode!=e?u.parentNode.previousSibling:null)}if(!r)return;i=T(r);var a=i.getClientRects();if(!a.length)return;var f=a[a.length-1];if(f.top>n||f.bottom<n||f.right>t)return;i.setStart(i.endContainer,i.endOffset-1),w(i);if(!i.toString().trim())return}if(i){var l=b(i);return y(l),!0}}function y(e){if(!o.range)o.range=e;else{var t;e.compareBoundaryPoints(Range.START_TO_START,o.range)<0?t="left":e.compareBoundaryPoints(Range.END_TO_END,o.range)>=0?t="right":t=o.state.dir,o.state.dir&&t!==o.state.dir&&o.range.collapse(t=="left"),o.state.dir=t,o.state.dir=="left"?o.range.setStart(e.startContainer,e.startOffset):o.state.dir=="right"&&o.range.setEnd(e.endContainer,e.endOffset)}var n={className:"mask-pincer-chunk"};BIF.objects.stencil.add("pincer-chunk",o.range,n)}function b(e){var t=e.startContainer,n;e.toString().match(s.REGEX_PUNCT)?n=new RegExp("[^"+s.PUNCT+"]"):n=new RegExp("[\\s"+s.PUNCT+"]");while(e.startOffset>0){e.setStart(t,e.startOffset-1);if(e.toString().match(n)){e.setStart(t,e.startOffset+1);break}}for(;;)try{e.setEnd(t,e.endOffset+1);if(e.toString().match(n)){e.setEnd(t,e.endOffset-1);break}if(e.endOffset===t.length)break}catch(r){break}return e}function w(e){if(e.startOffset){e.setStart(e.startContainer,e.startOffset-1);var t=e.toString().trim();while(!t&&e.startOffset)e.setStart(e.startContainer,e.startOffset-1),t=e.toString().trim()}}function E(){var e;r("element-from-point-fails-when-obscured")&&(e=BIF.objects.readerAffordance._.film,e.style.setProperty("display","none"));var t=o.doc.elementFromPoint(o.state.cur.x,o.state.cur.y);return e&&e.style.removeProperty("display"),t}function S(e,t,n){if(e.nodeType===e.TEXT_NODE)return e;for(var r=0,i=e.childNodes.length;r<i;++r){var s=e.childNodes[r];if(N(s,t,n))return S(s,t,n)}}function x(e,t,n){var r=T(e),i=r.endOffset-1;r.collapse(!0);while(r.endOffset<=i){r.setStart(e,r.endOffset),r.setEnd(e,r.startOffset+1);if(N(r,t,n))return r}}function T(e){var t=o.doc.createRange();return t.selectNodeContents(e),t}function N(e,t,n){var r=e.getClientRects?e:T(e),i=r.getClientRects();for(var s=0,o=i.length;s<o;++s){var u=i[s];if(u.left<=t&&u.right>=t&&u.top<=n&&u.bottom>=n)return!0}return!1}function k(e){o.state.cur={x:Math.min(e.x,o.doc.documentElement.scrollWidth-1),y:e.y}}function L(e,t){if(o.pincing||!o.range)return;var n=BIF.context.ruler,r=n.sceneToSpool(e.point.x,e.point.y),i=n.spoolToComponent(r.x,r.y);if(i)return o.state.dir=M(i),a(i),!0}function A(e,t){if(o.pincing){var n=BIF.context.ruler,r=n.sceneToSpool(e.point.x,e.point.y),i=n.spoolToComponent(r.x,r.y);return f(i),!0}}function O(e,t){if(o.pincing)return l(),!0}function M(e){var n=t.getRangeRects(o.range),r=n[0],i=n[n.length-1],s,u;return r.top==i.top?(s=Math.abs(r.left-e.x),u=Math.abs(i.right-e.x)):(s=Math.abs(r.top-e.y),u=Math.abs(i.bottom-e.y)),s<u?"left":"right"}var e={constructor:i},s=e.constants=e.constructor,o=e.properties={state:{},range:null};return e.pince=a,e.pincing=f,e.pinced=l,e.select=c,e.reset=h,e.toFormattedText=v,u(),e};return i.DEFAULT_BACKGROUND_COLOR="#38F",i.DEFAULT_FOREGROUND_COLOR="#FFF",i.LOCATOR_MIN_CHARS=3,i.PUNCT=t.regExpPunctuation(),i.REGEX_PUNCT=new RegExp("["+i.PUNCT+"]"),i}),define("bifocal/themes/read/default/src/parts/context_bar",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.KLS={EXPOSE:"context-allow-selection",MORE:"context-more",MAX:"context-max",OFF:"context-off"},r.$init=function(e){this._.buttons={},this._.menus={},this._.infos={},this._.parts=this._layout(e),this._.label="self",this._listen()},r.addMenu=function(e,t,n,r){t&&(this._.buttons[e]=t,this._.menus.self.appendChild(t)),n&&(this._.menus[e]=n,this._.parts.menus.appendChild(n),n.classList.add(this.KLS.OFF)),r&&(this._.infos[e]=r,this._.parts.info.appendChild(r),r.classList.add(this.KLS.OFF))},r.open=function(e){BIF.objects.modality.open("contexting"),this._toggleMore("hide"),this._.label!=e&&(this._toggleLabel(this._.label,"hide"),this._.label=e||"self",this._toggleLabel(this._.label,"show"),t.DataClass.set(this._.parts.anchor,"context-open",this._.label),this._reposition())},r.expand=function(e,t){this.open(e),this._toggleMore("show"),t&&t.max&&this._.parts.bar.classList.add(this.KLS.MAX)},r.setPosition=function(e,t){typeof e!="undefined"&&e&&(this._.position=e),this._.near=t,this._reposition()},r.setPositionNear=function(e){if(e.style){var n=e;e=n.ownerDocument.createRange(),e.selectNodeContents(n)}var r=t.getRangeRects(e),i=r[0],s=r[r.length-1],o=BIF.context.ruler.rangeToSpool(e,i.left,i.top),u=BIF.context.ruler.rangeToSpool(e,s.right,s.bottom);if(!o||!u)return this.setPosition();o=BIF.context.ruler.spoolToScene(o.x,o.y),u=BIF.context.ruler.spoolToScene(u.x,u.y);if(!o||!u)return this.setPosition();o.x<0&&(o.x=0,o.y=0),u.x>BIF.context.scene.dimensions.width&&(u.x=BIF.context.scene.dimensions.width,u.y=BIF.context.scene.dimensions.height),this.setPosition({top:o.y,bottom:u.y,lArrow:o.x,rArrow:u.x},e)},r.close=function(){BIF.objects.modality.closeIf("contexting")},r.shieldPage=function(){this._.parts.anchor.classList.remove(this.KLS.EXPOSE)},r.exposePage=function(){this._.parts.anchor.classList.add(this.KLS.EXPOSE)},r._layout=function(e){var n={};return n.anchor=t.element({parentNode:e,classes:"context-anchor"}),n.shield=t.element({parentNode:n.anchor,classes:"context-shield"}),n.bar=t.element({parentNode:n.anchor,classes:"context-bar"}),n.arrow=t.element({parentNode:n.bar,classes:"context-arrow"}),n.menus=t.element({parentNode:n.bar,classes:"context-menus"}),this._.menus.self=t.element({parentNode:n.menus,classes:"context-toolbar context-top-level"}),n.info=t.element({parentNode:n.bar,classes:"context-info"}),n},r._listen=function(e){BIF.events.onTap(this._.parts.shield,this.close.bind(this)),BIF.listen("bifocal:contexting:close",this._onClose.bind(this)),BIF.listen("bifocal:selection",this._onSelection.bind(this)),BIF.listen("bifocal:deselection",this._onDeselection.bind(this)),BIF.listen("bifocal:pince",this._onDeselection.bind(this)),BIF.listen("lens:scene:rebuild",this._onSceneRebuild.bind(this))},r._toggleLabel=function(e,t){var n={hide:"add",show:"remove"}[t],r=this._.menus[e];r&&r.classList[n](this.KLS.OFF);var i=this._.infos[e];i&&i.classList[n](this.KLS.OFF)},r._toggleMore=function(e){this._.showingMore={show:!0,hide:!1}[e],e=="show"?this._.parts.bar.classList.add(this.KLS.MORE):(this._.parts.bar.classList.remove(this.KLS.MORE),this._.parts.bar.classList.remove(this.KLS.MAX)),this._reposition()},r._onSelection=function(e){this.open(),this.exposePage(),this.setPositionNear(e.m.pincer.properties.range)},r._onDeselection=function(){this._.parts.anchor.classList.contains(this.KLS.EXPOSE)&&(this.close(),this.shieldPage())},r._onClose=function(){t.DataClass.clear(this._.parts.anchor,"context-open")},r._onSceneRebuild=function(){this._.near&&BIF.objects.modality.is("contexting")&&this.setPositionNear(this._.near)},r._reposition=function(){if(typeof this._.position=="undefined")return;t.DataClass.set(this._.parts.anchor,"context-position","above");var e=this._.position,n={w:this._.parts.bar.offsetWidth,h:this._.parts.bar.offsetHeight},r={w:this._.parts.arrow.offsetWidth,h:this._.parts.arrow.offsetHeight},i={x:BIF.context.scene.dimensions.width-10,y:BIF.context.scene.dimensions.height},s=e.lArrow,o="above",u=e.top-(n.h+r.h);u<=20&&(u=e.bottom+r.h,o="below",s=e.rArrow,u+n.h>i.y&&(o="forfeit",u=(i.y-n.h)*.5)),typeof s=="undefined"?(o="forfeit",s=(i.x-n.w)*.5):s-=r.w*.5;var a;if(this._.showingMore||o=="forfeit"){var f=s,l=s+r.w-n.w,c=i.x*.5-n.w*.5;i.x<=f||o=="forfeit"?(a=c,s=n.w*.5+a-r.w*.5):a=Math.max(l,Math.min(c,f))}else a=Math.max(0,Math.min(s,i.x-n.w));this._.parts.bar.style.setProperty("top",u+"px"),this._.parts.bar.style.setProperty("left",a+"px"),this._.parts.arrow.style.setProperty("left",s-a+"px"),t.DataClass.set(this._.parts.anchor,"context-position",o)},n}),define("bifocal/themes/read/default/src/parts/pincer_point",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this._.parts=this._layout(e),this._listen()},r._layout=function(e){var n={};return n.point=t.element({parentNode:e,classes:"pincer-point"}),n},r._listen=function(){BIF.listen("bifocal:pince",this._show.bind(this)),BIF.listen("bifocal:pincing",this._move.bind(this)),BIF.listen("bifocal:pinced",this._hide.bind(this))},r._show=function(e){this._updatePosition(e.m.pincer),setTimeout(this._shrink.bind(this),10),this._.parts.point.classList.add("pincer-point-on")},r._move=function(e){this._.parts.point.classList.remove("pincer-point-vanishing"),this._.parts.point.classList.add("pincer-point-line"),this._updatePosition(e.m.pincer)},r._hide=function(e){this._.parts.point.classList.remove("pincer-point-vanishing"),this._.parts.point.classList.remove("pincer-point-line"),this._.parts.point.classList.remove("pincer-point-on")},r._shrink=function(){this._.parts.point.classList.add("pincer-point-vanishing")},r._updatePosition=function(e){var n=e.properties.state.dir,r=e.properties.range,i=t.getRangeRects(r),s=i[0],o=i[i.length-1],u,a=BIF.context.ruler.rangeToSpool(r,s.left,s.top),f=BIF.context.ruler.spoolToScene(a.x,a.y),l=f.x,c=f.y;n=="left"?u=s:(u=o,l+=(u.right-s.left)*a.scaleX,c+=(u.top-s.top)*a.scaleY),c+=u.height*a.scaleY*.5,this._.parts.point.style.setProperty("left",l+"px"),this._.parts.point.style.setProperty("top",c+"px")},n}),define("bifocal/themes/read/default/src/features/context_bar",["require","../parts/quirks","../parts/pincer","../parts/context_bar","../parts/pincer_point"],function(e){var t=e("../parts/quirks"),n=e("../parts/pincer");return function(r){return BIF.state.clipboardable?!1:t("cannot-disable-native-selection")?!1:(r.runSheet.append(["bifocal:reveal","loadPincer"],["bifocal:reader:ready","loadContextBar"]),r.loadPincer=function(){BIF.objects.pincer=new n},r.loadContextBar=function(){var t=e("../parts/context_bar");BIF.objects.contextBar=new t(BIF.elements.bookWidgets),BIF.dispatch("bifocal:context:register",BIF.objects.contextBar)},r.loadPincerPoint=function(){var t=e("../parts/pincer_point");BIF.objects.pincerPoint=new t(BIF.elements.bookWidgets)},!0)}}),define("text!bifocal/themes/read/default/resources/spinner.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='none' stroke-width='1' fill='#000000' fill-rule='evenodd' class='icon-solid'>\n    <rect x='31.0625' y='12' width='1.875' height='5' />\n    <rect opacity='0.25' x='31.0625' y='47' width='1.875' height='5' />\n    <path d='M52,31.0625 L52,32.9375 L47,32.9375 L47,31.0625 L52,31.0625 L52,31.0625 Z' opacity='0.25' />\n    <path d='M17,31.0625 L17,32.9375 L12,32.9375 L12,31.0625 L17,31.0625 L17,31.0625 Z' opacity='0.25' />\n    <path d='M41.1881012,14.2107419 L42.8118988,15.1482419 L40.3118988,19.4783689 L38.6881012,18.5408689 L41.1881012,14.2107419 L41.1881012,14.2107419 Z' opacity='0.25' />\n    <path d='M23.6881012,44.5216311 L25.3118988,45.4591311 L22.8118988,49.7892581 L21.1881012,48.8517581 L23.6881012,44.5216311 L23.6881012,44.5216311 Z' opacity='0.25' />\n    <path d='M49.7892581,41.1881012 L48.8517581,42.8118988 L44.5216311,40.3118988 L45.4591311,38.6881012 L49.7892581,41.1881012 L49.7892581,41.1881012 Z' opacity='0.25' />\n    <path d='M19.4783689,23.6881012 L18.5408689,25.3118988 L14.2107419,22.8118988 L15.1482419,21.1881012 L19.4783689,23.6881012 L19.4783689,23.6881012 Z' opacity='0.5' />\n    <path d='M48.8517581,21.1881012 L49.7892581,22.8118988 L45.4591311,25.3118988 L44.5216311,23.6881012 L48.8517581,21.1881012 L48.8517581,21.1881012 Z' opacity='0.25' />\n    <path d='M18.5408689,38.6881012 L19.4783689,40.3118988 L15.1482419,42.8118988 L14.2107419,41.1881012 L18.5408689,38.6881012 L18.5408689,38.6881012 Z' opacity='0.25' />\n    <path d='M42.8118988,48.8517581 L41.1881012,49.7892581 L38.6881012,45.4591311 L40.3118988,44.5216311 L42.8118988,48.8517581 L42.8118988,48.8517581 Z' opacity='0.25' />\n    <path d='M25.3118988,18.5408689 L23.6881012,19.4783689 L21.1881012,15.1482419 L22.8118988,14.2107419 L25.3118988,18.5408689 L25.3118988,18.5408689 Z' opacity='0.75' />\n  </g>\n</svg>\n"}),define("bifocal/themes/read/default/src/parts/spinner",["require","common","text!../../resources/spinner.text.svg"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return n.install=function(e){return e.spinner=e.spinner||new n(e)},r.SVG=e("text!../../resources/spinner.text.svg"),r.HEIGHT=200,r.$init=function(e){this._.parts=this._layout(e)},r.spin=function(){return this._.parts.box.style.removeProperty("display"),this},r.stop=function(){return this._.parts.box.style.setProperty("display","none"),this},r.isSpinning=function(){return this._.parts.box.style.display!="none"},r._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"spinner-box",pos:"prepend"}),n.icon=t.element({parentNode:n.box,classes:"spinner-icon",html:this.SVG}),n},n}),define("bifocal/themes/read/default/src/parts/dictionary_abstract",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this._.context=e},r.lookup=function(e){},r._layoutResult=function(e){this._.box=t.element();var n=t.element({tag:"h2",parentNode:this._.box,html:e.word});e.pronunciation&&t.element({tag:"i",parentNode:n,html:"("+e.pronunciation+")"});var r=t.element({tag:"dl",parentNode:this._.box});for(var i=0,s=e.definitions.length;i<s;++i){var o=this._spannify(e.definitions[i].text),u=t.element({tag:"dd",parentNode:r,html:o}),a=e.definitions[i].part;a&&t.element({tag:"em",parentNode:u,html:a+". ",pos:"prepend"})}e.forms&&e.forms.length&&t.element({tag:"p",parentNode:this._.box,html:"["+e.forms.join(", ")+".]"}),e.synonyms&&e.synonyms.length&&(t.element({tag:"h3",parentNode:this._.box,html:"Synonyms"}),t.element({tag:"p",parentNode:this._.box,html:this._spannify(e.synonyms.join(", ")+".")}));if(e.example){t.element({tag:"h3",parentNode:this._.box,html:"Example"});var f=t.element({tag:"p",parentNode:this._.box,classes:"dict-example-text",html:this._spannify(e.example.text)});if(e.example.source){var l=" &#8212; "+e.example.source;if(e.example.href){var c=t.element({tag:"a",parentNode:f,classes:"dict-example-link",html:l});c.setAttribute("href",e.example.href),this._externalLink(c)}else t.element({tag:"span",parentNode:f,classes:"dict-example-link",html:l})}}e.etymology&&(t.element({tag:"h3",parentNode:this._.box,html:"Etymology"}),t.element({tag:"p",parentNode:this._.box,classes:"dict-etym",html:e.etymology}));var f=t.element({parentNode:this._.box,classes:"dict-context-credit",html:"Definitions&nbsp;by&nbsp;"});this._credit(f),f.innerHTML+=".",this._.context.result(this,this._.box,!0)},r._credit=function(e){this.SRC_ICON&&t.element({tag:"img",parentNode:e,attributes:{src:this.SRC_ICON}});if(this.SRC_URI&&this.SRC_NAME){var n=t.element({tag:"a",parentNode:e,html:this.SRC_NAME,attributes:{href:this.SRC_URI}});this._externalLink(n)}else this.SRC_NAME&&(e.innerHTML+=this.SRC_NAME)},r._layoutNoResult=function(e){this._.box=t.element({tag:"i",classes:"dict-not-found-msg",html:"No definitions for <b>"+e+"</b>."}),this._.context.result(this,this._.box,!1)},r._spannify=function(e){var t=this._.context.CLS_HOTDEF;return e.replace(/\b([\w-]+)\b/g,function(e){return e.length>3?'<span class="'+t+'">'+e+"</span>":e})},r._inlineLink=function(e){BIF.events.onTap(e,function(t){BIF.events.stop(t);var n=e.href.replace("en.wikipedia","en.m.wikipedia");this._.context.browse(n)}.bind(this))},r._externalLink=function(e){e.setAttribute("target","_blank")},n}),define("bifocal/themes/read/default/src/ext/jsonp",["require"],function(e){var t={};return t.get=function(e,n,r){arguments[2]||(r=arguments[1],n={});var i,s=t._requests;t._requests++,t.callbacks["request_"+s]=function(e){i.parentNode.removeChild(i),delete t.callbacks["request_"+s],r(e)},n.callback="JSONP.callbacks.request_"+s,i=t.raw(e,n)},t.raw=function(e,t){var n=[];for(var r in t)n.push(r+"="+encodeURIComponent(t[r]));e+=e.indexOf("?")+1?"&":"?",e+=n.join("&");var i=document.createElement("script");i.type="text/javascript",i.src=e;var s=document.getElementsByTagName("head")[0];return s.appendChild(i),i},t.callbacks={},t._requests=0,t}),define("bifocal/themes/read/default/src/parts/dictionary_overdrive",["require","./dictionary_abstract","common","../ext/jsonp","dervish/src/urls"],function(e){var t=e("./dictionary_abstract"),n=e("common"),r=window.JSONP=e("../ext/jsonp"),i=e("dervish/src/urls"),s=t.new(),o=s.prototype;return o.API_URI=i.uilink("DICTIONARYAPI","https://dictionary.svc.overdrive.com/v2/en-us/word.jsonp/"),o.SRC_NAME="Dictionary.com",o.SRC_URI=i.uilink("DICTIONARYCOM","http://dictionary.reference.com/"),o.MAX_WORDS=1,o.lookup=function(e){this._.term=e;var t=this.API_URI+this._.term;r.get(t,this._handleResponse.bind(this))},o._handleResponse=function(e){e&&e.words&&e.words.length?this._layoutResult(this._processResult(e)):this._layoutNoResult(this._.term)},o._processResult=function(e){var t=e.words[0],r={word:t.text,pronunciation:null,definitions:[],forms:[],synonyms:[],example:null,etymology:null};return n.each(t.pronunciations,function(e){e.type=="ipa"&&(r.pronunciation=e.text)}),n.each(t.partOfSpeech,function(e){n.each(e.definitions,function(t){var n={},i=e.partOfSpeech.match(/^([^\]]+)(\[(.*)\.?\])?$/);if(i){n.part=i[1].replace(/\s+$/,"");if(i[3]){var s=i[3].replace(/\.$/,"").split(/,\s*/);for(var o=0,u=s.length;o<u;++o)r.forms.indexOf(s[o])<0&&r.forms.push(s[o])}}n.text=t.text,r.definitions.push(n)})}),n.each(t.relateds,function(e){e.relationshipType=="synonym"&&(r.synonyms=r.synonyms.concat(e.words))}),r},s}),define("bifocal/themes/read/default/src/parts/dictionary_ddg",["require","./dictionary_abstract","common","../ext/jsonp"],function(e){var t=e("./dictionary_abstract"),n=e("common"),r=window.JSONP=e("../ext/jsonp"),i=t.new(),s=i.prototype;return s.API_URI="https://api.duckduckgo.com/",s.SRC_NAME="Duck Duck Go",s.SRC_URI="https://duckduckgo.com/?q=",s.SRC_ICON="https://duckduckgo.com/favicon.png",s.APP_IDENTITY="overdrive-read",s.lookup=function(e,t){this._.term=e,this._.target=t;var n=this.API_URI+"?"+["q="+encodeURIComponent(e),"format=json","skip_disambig="+(t?1:0),"no_redirect=1","t="+this.APP_IDENTITY].join("&");r.get(n,this._handleResponse.bind(this))},s._handleResponse=function(e){console.log("[DDG]",e),this._.box=this._.target||n.element(),this._.box.innerHTML="";var t=!1;if(e.Abstract){t=!0,n.element({parentNode:this._.box,classes:"dict-ddg-abstract",html:this._spannify(e.Abstract)});var r=n.element({tag:"a",parentNode:this._.box,classes:"dict-ddg-abstract-link",html:"<i>"+e.Heading+"</i> on "+e.AbstractSource,attributes:{href:e.AbstractURL}});this._externalLink(r)}else if(e["Type"]=="D"){var i=[],s=function(e){for(var t=0,n=e.length;t<n;++t)e[t].Result?i.push(e[t]):e[t].Name&&e[t].Topics&&s(e[t].Topics)};s(e.RelatedTopics),n.each(i,function(e){t=!0;var r=n.element({parentNode:this._.box,classes:"dict-ddg-topic",html:e.Result}),i=r.querySelectorAll("a[href]");i[0]&&(n.each(i,this._externalLink.bind(this)),i[0].innerHTML.match(/ Meanings$/)?r.classList.add("meanings"):(r._onTapDefine=function(){this.lookup(i[0].innerHTML,r),r.classList.remove("linked"),delete r._onTapDefine}.bind(this),r.classList.add("linked")))},this)}else n.element({tag:"i",parentNode:this._.box,classes:"dict-not-found-msg",html:"No topics found for <b>"+this._.term+"</b>."});if(!this._.target){if(t){var o=n.element({parentNode:this._.box,classes:"dict-context-credit",html:"Topic results from "});this._credit(o),o.innerHTML+="."}this._.context.result(this,this._.box,t)}},s._credit=function(e){var t=this.SRC_URI+encodeURIComponent(this._.term);n.element({tag:"img",parentNode:e,attributes:{src:this.SRC_ICON}}),this._externalLink(n.element({tag:"a",parentNode:e,html:this.SRC_NAME,attributes:{href:t}}))},i}),define("bifocal/themes/read/default/src/parts/dictionary_links",["require","./dictionary_abstract","common","dervish/src/urls"],function(e){var t=e("./dictionary_abstract"),n=e("common"),r=e("dervish/src/urls"),i=t.new(),s=i.prototype;return s.BROWSE_LINKS=[{name:"OverDrive",uri:r.uilink("ODSEARCH","https://www.overdrive.com/search?q="),iframe:!1},{name:"Wikipedia",uri:r.uilink("SEARCHWIKIPEDIA","https://en.m.wikipedia.org/wiki/"),iframe:!0},{name:"Google",uri:r.uilink("SEARCHGOOGLE","https://www.google.com/search?q="),iframe:!1},{name:"Translate",uri:"https://translate.google.com/#auto/en/",iframe:!1}],s.lookup=function(e){this.BROWSE_LINKS&&this.BROWSE_LINKS.length?(this._.box=n.element({classes:"dict-links-list"}),this._browseLinks(this._.box,e),this._.context.result(this,this._.box,!0)):(this._.box=n.element({tag:"i",classes:"dict-not-found-msg",html:"No dictionary links for <b>"+e+"</b>"}),this._.context.result(this,this._.box,!1))},s._browseLinks=function(e,t){var r=[];n.each(this.BROWSE_LINKS,function(i){var s=i.uri+encodeURIComponent(t),o=n.element({tag:"a",parentNode:e,html:"<span>"+i.name+":</span>"+t});o.setAttribute("href",s),o.setAttribute("target","_blank"),i.iframe?this._inlineLink(o):this._externalLink(o),r.push(o)},this)},i}),define("bifocal/themes/read/default/src/parts/dictionary_context",["require","common","core/src/locator","./spinner","./quirks","./dictionary_overdrive","./dictionary_ddg","./dictionary_links"],function(e){var t=e("common"),n=e("core/src/locator"),r=e("./spinner"),i=e("./quirks"),s=t.Class.new(),o=s.prototype;return o.DICTIONARIES={"English Dictionary":e("./dictionary_overdrive"),Topics:e("./dictionary_ddg"),Explore:e("./dictionary_links")},o.CLS_HOTDEF="dict-hot-def",o.$init=function(e){this._.contextBar=e,this._.dictionaries=[],t.each(this.DICTIONARIES,function(e,t,n){this._.dictionaries.push({index:n,label:e,object:new t(this)})},this),this._.primaryDictionaryIndex=0,this._.parts=this._layout(),this._listen(),this._.contextBar.addMenu("dict",this._.parts.button,this._.parts.menu,this._.parts.info)},o.result=function(e,n,r){var i;for(var s=0;s<this._.dictionaries.length;++s){i=this._.dictionaries[s];if(i.object===e)break}(r||i.index==this._.primaryDictionaryIndex)&&this._resultRow(i,n),i.index==this._.primaryDictionaryIndex&&(this._clearInfo(),this._.parts.content.appendChild(i.row),t.each(this._.dictionaries,function(e){if(e.index==i.index)return;this._.parts.content.appendChild(e.row)},this),this._.contextBar.setPosition())},o.browse=function(e){this._pendingInfo(),this._.parts.info.classList.add("browsing"),this._.contextBar.setPosition();var n=this._.parts.content,r={src:e,parentNode:n,width:"100%"};i.ask("ios")?(r.width=this._.parts.info.offsetWidth+"px",r.height="100%"):(r.height=this._.parts.info.offsetHeight+"px",r.scrolling="auto");var s=window.innerHeight-this._.parts.info.offsetTop-20;this._.parts.info.style.setProperty("max-height",s+"px"),t.iframe(r,this._browsed.bind(this))},o._layout=function(){var e={};return e.button=t.element({classes:"context-button dict-context-button",html:"Define"}),e.menu=t.element({classes:"dict-context-menu"}),e.title=t.element({parentNode:e.menu,classes:"dict-title",html:"Definition"}),e.doneBtn=t.element({parentNode:e.menu,classes:"context-button context-done-button dict-done-button",html:"Done"}),e.info=t.element({classes:"dict-context-info"}),e.spinner=r.install(e.info).stop(),e.content=t.element({classes:"dict-context-content",parentNode:e.info}),BIF.events.scrollable(e.info),e},o._listen=function(){BIF.listen("bifocal:selection",this._prepareSelection.bind(this)),BIF.events.onTap(this._.parts.button,this._lookupDefinition.bind(this)),BIF.events.onTap(this._.parts.info,this._onInfoTap.bind(this)),BIF.events.onTap(this._.parts.doneBtn,this._close.bind(this))},o._prepareSelection=function(e){this._setPhrase(e.m.text),this._.locator=e.m.locatorA,this._.primaryDictionaryIndex=this._.words.length==1?0:1},o._setPhrase=function(e){var n=[],r=new RegExp("["+t.regExpPunctuation()+"]","g"),i="-'â",s=function(e){return i.indexOf(e)>=0?e:" "};t.each(e.replace(r,s).split(/\s+/),function(e){e&&n.push(e)}),this._.words=n},o._getPhrase=function(e){if(this._.words&&this._.words.length){var t=this._.words;return e&&(t=t.slice(0,e)),t.join(" ")}},o._lookupDefinition=function(e){e&&BIF.events.stop(e);var n={phrase:this._.words.join(" "),timestamp:t.epochSeconds()};BIF.objects.activity.record("define",n);if(!BIF.dispatch("bifocal:dictionary:define",n,!0))return this._.contextBar.close();this._.contextBar.expand("dict",{max:!0}),this._positionContextBar();if(!BIF.network.online)return this._clearInfo(),t.element({tag:"i",parentNode:this._.parts.content,classes:"dict-offline-msg",html:"Definitions are unavailable when offline."});this._pendingInfo(),this._.parts.secondaryContent=t.element(),t.each(this._.dictionaries,function(e){e.row=t.element({classes:"dict-context-result-row"}),e.object.lookup(this._getPhrase(e.object.MAX_WORDS))},this)},o._positionContextBar=function(){var e=BIF.context.spine.byPosition(this._.locator.spinePosition),t=e.frameBox.contentDocument,r=(new n).locatorToRange(this._.locator,t);this._.contextBar.setPositionNear(r)},o._clearInfo=function(){this._.parts.spinner.stop(),this._.parts.info.classList.remove("browsing"),this._.parts.content.innerHTML="",this._.parts.info.scrollTop=0,this._.parts.info.style.removeProperty("max-height")},o._pendingInfo=function(){this._clearInfo(),this._.parts.spinner.spin(),this._.contextBar.setPosition()},o._onInfoTap=function(e){var t=e.target||e.srcElement;t&&t.classList.contains(this.CLS_HOTDEF)?(this._setPhrase(t.innerHTML),this._lookupDefinition(e)):t&&t._onTapDefine&&t._onTapDefine()},o._resultRow=function(e,n){t.element({parentNode:e.row,classes:"dict-context-label",html:e.label}),n.classList.add("dict-context-result"),e.row.appendChild(n)},o._browsed=function(){this._.parts.spinner.stop()},o._close=function(){BIF.dispatch("bifocal:pincer:reset"),this._.contextBar.close()},s}),define("bifocal/themes/read/default/src/features/dictionary",["require","./context_bar","../parts/dictionary_context"],function(e){return function(t){return t.addFeature(e("./context_bar"))?(t.runSheet.append(["bifocal:context:register","loadDictionaryContext"]),t.loadDictionaryContext=function(t){var n=e("../parts/dictionary_context");BIF.objects.dictionaryContext=new n(t.m)},!0):!1}}),define("bifocal/themes/read/default/src/parts/sheet_anchor",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.STYLE_ID_PREFIX="_SHEET_ANCHOR_RULES_",r.applyStyleRules=function(e,t,n){typeof n.join=="function"&&(n=n.join("\n"));var i=e.querySelector("#"+r.STYLE_ID_PREFIX+t);i?this._updateStyleTag(e,i,n):this._addStyleTag(e,t,n)},r.removeStyleRules=function(e,t){var n=e.querySelector("#"+r.STYLE_ID_PREFIX+t);n&&n.parentNode.removeChild(n)},r._addStyleTag=function(e,t,n){var i=e.getElementsByTagName("head")[0];i||(i=e.createElement("head"),e.documentElement.appendChild(i)),typeof n.join=="function"&&(n=n.join("\n"));var s=e.createElement("style");s.type="text/css",s.id=r.STYLE_ID_PREFIX+t,s.styleSheet?s.styleSheet.cssText=n:s.appendChild(e.createTextNode(n)),i.appendChild(s)},r._updateStyleTag=function(e,t,n){t.styleSheet?t.styleSheet.cssText=n:t.replaceChild(e.createTextNode(n),t.firstChild)},n}),define("bifocal/themes/read/default/src/parts/overlay_button",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.DEFAULT_DELAY_MS=120,r.$init=function(e,t,n){this._.box=e,this._onTap=t,this._.parts=this._layout(e),this._.delay=typeof n=="number"?n:this.DEFAULT_DELAY_MS,this._listenForPress()},r.icon=function(e){this.iconBox().appendChild(e)},r.iconBox=function(){return this._.parts.iconBox},r._layout=function(e){var n={};return n.button=t.element({parentNode:e,classes:"overlay-button"}),n.outerRing=t.element({parentNode:n.button,classes:"overlay-button-outer-ring"}),n.innerRing=t.element({parentNode:n.button,classes:"overlay-button-inner-ring"}),n.iconBox=t.element({parentNode:n.innerRing,classes:"overlay-button-icon-box"}),n},r._listenForPress=function(){typeof this._onTap=="function"&&BIF.events.onTap(this._.box,this._invokeAction.bind(this))},r._invokeAction=function(e){BIF.events.stop(e),setTimeout(this._onTap,this._.delay)},n}),define("bifocal/themes/read/default/src/parts/zoomerang",["require","common","./quirks","scroller","./sheet_anchor","./overlay_button"],function(e){var t=e("common"),n=e("./quirks"),r=e("scroller"),i=e("./sheet_anchor"),s=e("./overlay_button"),o=t.Class.new(),u=o.prototype;return u.MIN_ZOOM=1,u.MAX_ZOOM=3.5,u.INITIAL_ZOOM=1.5,u.SCALE_INTERVAL_MS=10,u.SCALE_INCREMENT=.015,u.$init=function(){this._.zoomLevel=1,this._.paintLevel=1,this._.scroller=this._createScroller(),this._.spoolSheetAnchor=new i,this._.parts=this._layout(BIF.elements.bookWidgets),this._listen()},u._layout=function(e){var n={};return n.film=t.element({parentNode:e,classes:"zoom-film hug-r hug-b hug-l"}),n.controls=t.element({parentNode:n.film,classes:"zoom-controls"}),n.buttons=t.element({parentNode:n.controls,classes:"zoom-buttons"}),n.plusButton=t.element({parentNode:n.buttons,classes:"zoom-plus-button"}),n.minusButton=t.element({parentNode:n.buttons,classes:"zoom-minus-button"}),n.zoomBar=t.element({parentNode:n.controls,classes:"zoom-bar"}),n.zoomLevelLabel=t.element({parentNode:n.zoomBar,classes:"zoom-level-label",html:"Zooming"}),n.zoomLevelDisplay=t.element({parentNode:n.zoomBar,classes:"zoom-level-display"}),n.zoomCloseButton=t.element({parentNode:n.zoomBar,classes:"zoom-close-button",html:"Done"}),n},u._listen=function(){BIF.listen("bifocal:modality:transition",this._viableModality.bind(this)),BIF.listen("bifocal:zooming:open",this._onOpen.bind(this)),BIF.listen("bifocal:zooming:close",this._startClosing.bind(this)),BIF.listen("lens:scene:invalidate",this._finishClosing.bind(this)),this._.handler=BIF.events.onContact(this._.parts.controls,{start:this._contactStart.bind(this),move:this._contactMove.bind(this),end:this._contactEnd.bind(this),cancel:this._contactCancel.bind(this)},{multitouch:!0});var e="onwheel"in document.body?"wheel":"mousewheel";BIF.events.on(this._.parts.controls,e,this._onWheel.bind(this)),this._.parts.buttons&&(this._.plusButton=new s(this._.parts.plusButton,null,0),this._scaleButtonHandler(this._.parts.plusButton,1),this._.minusButton=new s(this._.parts.minusButton,null,0),this._scaleButtonHandler(this._.parts.minusButton,-1)),BIF.events.onTap(this._.parts.zoomCloseButton,this._close.bind(this))},u._contactStart=function(e){if(!this._.state||this._.state.closing)return;e.target==this._.parts.controls&&(BIF.events.stop(e),this._scrollerDo("TouchStart",e),this._.state.tapping=!0,this._.state.touching=!0)},u._contactMove=function(e){this._.state&&this._.state.touching&&(BIF.events.stop(e),this._scrollerDo("TouchMove",e),this._.state.tapping=!1)},u._contactEnd=function(e){this._.state&&this._.state.touching&&(BIF.events.stop(e),this._stopContact(),this._.state.tapping&&(e.timeStamp-this._.state.lastTapTime<500&&this._close(),this._.state.lastTapTime=e.timeStamp))},u._contactCancel=function(e){this._.state&&this._.state.touching&&(BIF.events.stop(e),this._stopContact())},u._onWheel=function(e){if(this._.state&&!this._.state.closing){e.preventDefault();var t=0;typeof e.deltaY=="number"?t=e.deltaY:typeof e.wheelDelta=="number"&&(t=0-e.wheelDelta),t=t>0?1:t<0?-1:0,this._.scroller.doMouseZoom(t,e.timeStamp,e.pageX,e.pageY),this._pulseButton(0-t)}},u._viableModality=function(e){if(e.m.to=="zooming"&&!BIF.context.spool.dub.ambit.complete){BIF.events.stop(e);var t="Cannot zoom until page counting is complete.";BIF.dispatch("bifocal:notify:message",t)}},u._onOpen=function(e){if(!this._.state){var t=this.singlePointer?"add":"remove";this._.parts.film.classList[t]("zoom-film-single-pointer"),this._.state={lastTapTime:0},this._.state.limits=BIF.context.spool.dub.ambit.virtual,this._.panElement=BIF.context.spool._.box,BIF.context.spool._.pulley.stopAnimation(),this._setScrollerDimensions(),this._.scroller.options.scrollingComplete=this._finalizeScrolling.bind(this),this._.zoomLevel=this.INITIAL_ZOOM,this._.scroller.zoomTo(this._.zoomLevel,!0),BIF.objects.activity.record("zoom-enter")}},u._startClosing=function(){if(this._.state){this._.state.closing=!0,this._stopAnimations();var e=this._.dims.clientWidth,t=this._finishClosing.bind(this);if(this._.zoomLevel>1){var n=this._.dims.spoolLeft,r=e*this._.zoomLevel,i=n/r%1;i<0&&(i=1+i);var s=i<.5?"floor":"ceil",o=Math[s](n/r)*r,u=BIF.context.profile.reverse?-1:1,a=u/(this._.zoomLevel-1),f=(n-o)*a,l=this._.dims.clientHeight*100;this._.scroller.zoomTo(1,!0,f,l,t)}else{var c=Math.round(this._.dims.scrollLeft/e)*e;this._.scroller.options.scrollingComplete=t,this._.scroller.scrollTo(c,0,!0,1)}}},u._finishClosing=function(e){this._.state&&(this._.state.closing=!0,this._.state.touching&&this._stopContact(),this._.paintLevel=1,this._.zoomLevel!=1&&this._.scroller.zoomTo(1,!1),this._repaint(!0),this._.state=null,this._updateSpoolPosition(),BIF.objects.modality.closeIf("zooming"),BIF.objects.activity.record("zoom-exit"))},u._updateSpoolPosition=function(){var e=this._.dims.clientWidth,t=Math.round(this._.dims.spoolLeft/e)*e;BIF.context.spool._moveCursorToVirtualX(t,!1),BIF.context.spool._storeRegion()},u._createScroller=function(){var e={locking:!1,bouncing:!1,zooming:!0,minZoom:this.MIN_ZOOM,maxZoom:this.MAX_ZOOM,animationDuration:500,animating:!0},t=new r(this._render.bind(this),e);return t},u._setScrollerDimensions=function(){var e=BIF.context.spool,t=BIF.elements.scene.getBoundingClientRect();this._.dims={},this._.dims.barGap=this._.parts.zoomBar.offsetHeight-1,this._.dims.clientLeft=t.left,this._.dims.clientTop=t.top,this._.dims.clientWidth=BIF.context.scene.dimensions.width,this._.dims.clientHeight=BIF.context.scene.dimensions.height,this._.dims.scrollWidth=this._.state.limits.max-this._.state.limits.min,this._.dims.scrollHeight=this._.dims.clientHeight+this._.dims.barGap,this._.dims.scrollLeft=this._spoolLeftToScrollLeft(e.cursor.virtual),this._.dims.scrollTop=0,this._.scroller.__scrollLeft=this._.dims.scrollLeft,this._.scroller.__scrollTop=this._.dims.scrollTop,this._.scroller.__zoomLevel=1,this._.scroller.setPosition(this._.dims.clientLeft,this._.dims.clientTop),this._.scroller.setDimensions(this._.dims.clientWidth,this._.dims.clientHeight,this._.dims.scrollWidth,this._.dims.scrollHeight)},u._repaint=function(e){clearTimeout(this._.repaintTimer);if(!this._.state)return;var t=this._.zoomLevel;if(n("zoom-resamples-after-hide")){t!=this._.sharpenLevel&&(this._.panElement.style.setProperty("display","none"),this._.panElement.offsetHeight,this._.panElement.style.removeProperty("display"),this._.sharpenLevel=t);return}if(!n("zoom-does-not-resample"))return;if(!e&&this._.zoomLevel===this._.paintLevel)return;var r=document,i="zoom-scaling";this._stopContact();if(!this._.state||t===1)this._.painted&&(this._.spoolSheetAnchor.removeStyleRules(r,i),this._.painted=!1);else{var s=[],o=this._.dims.clientHeight,u=this._.dims.clientWidth*.5,a="left",f="right";if(BIF.context.profile.reverse){a="right",f="left";var l=0-this._.dims.clientWidth*(t-1);s.push("#spool { margin-right: "+l+"px; }")}BIF.context.spine.each(function(e){var n=e.metrics.widths.frame,r=n,i=o;e.meta["rendition-viewport"]&&(r=e.meta["rendition-viewport"].width||r,i=e.meta["rendition-viewport"].height||i);var l=Math.min(n/r,o/i),c=l*t,h=e.sheetBox.id;s.push.apply(s,["#"+h+" {",a+": "+e.metrics.heads.real*t+"px !important;",f+": auto !important;","width: "+e.metrics.widths.sheet*t+"px !important;","height: "+o*t+"px !important;",e.metrics.blanks[0]?"padding-"+a+": "+u*t+"px !important":"",e.metrics.blanks[1]?"padding-"+f+": "+u*t+"px !important":"","}","#"+h+" .bounds {","width: "+r*c+"px !important;","height: "+i*c+"px !important;","padding-top:"+(o*t-i*c)*.5+"px !important;","}","#"+h+" iframe {","-webkit-transform: scale("+c+") !important;","-moz-transform: scale("+c+") !important;","-ms-transform: scale("+c+") !important;","transform: scale("+c+") !important;","}"])}.bind(this)),this._.spoolSheetAnchor.applyStyleRules(r,i,s.join("\n")),this._.painted=!0}this._.paintLevel=t,this._render(this._.lastRender[0],this._.lastRender[1],t)},u._scheduleRepaint=function(e){clearTimeout(this._.repaintTimer),typeof e!="number"&&(e=500),this._.repaintTimer=setTimeout(this._repaint.bind(this),e)},u._render=function(e,n,r){this._.zoomLevel=r,this._.lastRender=[e,n,r],this._.dims.scrollLeft=e,this._.dims.scrollTop=n,this._.dims.spoolLeft=this._scrollLeftToSpoolLeft(e);var i=this._.dims.clientHeight,s=i*r-i+this._.dims.barGap,o=Math.max(0,Math.min(n,s)),u="scale("+this._.zoomLevel/this._.paintLevel+")",a=this._.dims.spoolLeft*(BIF.context.profile.reverse?1:-1),f="translate3d("+a+"px,"+(0-o)+"px,0)";this._updateZoomBar(),this._.state&&(t.prefixProperty(this._.panElement.style,"transform",f+" "+u),this._.zoomLevel!=this._.paintLevel&&!this._.state.touching&&!this._.state.closing&&this._scheduleRepaint())},u._spoolLeftToScrollLeft=function(e){var t=this._.state.limits.min*this._.zoomLevel;if(BIF.context.profile.reverse){var n=this._.dims.scrollWidth-this._.dims.clientWidth,r=n*this._.zoomLevel;return r-(e-t)}return e-t},u._scrollLeftToSpoolLeft=function(e){var t=this._.state.limits.min*this._.zoomLevel;if(BIF.context.profile.reverse){var n=this._.dims.scrollWidth-this._.dims.clientWidth,r=n*this._.zoomLevel;return t+(r-e)}return t+e},u._scrollerDo=function(e,n){return this._.scroller["do"+e](n.contactPointers,t.epochMilliseconds(),n.contactScale)},u._stopContact=function(){this._.state.touching=!1,this._.scroller.doTouchEnd(t.epochMilliseconds()),this._finalizeScrolling()},u._stopAnimations=function(){core.effect.Animate.cancel(this._.scroller.__isDecelerating),core.effect.Animate.cancel(this._.scroller.__isAnimating)},u._finalizeScrolling=function(){if(this._.scroller.__isDecelerating)return;var e=this._.dims.spoolLeft/this._.zoomLevel,t=BIF.context.spool._virtualXToLocus(e);t?BIF.context.spool.dub.focus(t.component,e):console.warn("[ZOOM] cannot find focal-component at",e)},u._updateZoomBar=function(){this._.zoomLevel!=this._.displayedLevel&&(this._.parts.zoomLevelDisplay.innerHTML=this._.zoomLevel.toFixed(2),this._.displayedLevel=this._.zoomLevel)},u._close=function(){BIF.objects.modality.close()},u._scaleButtonHandler=function(e,t){var n,r=this._.scroller,i=function(){var e=this._.zoomLevel+this.SCALE_INCREMENT*t;e=Math.max(this.MIN_ZOOM,Math.min(e,this.MAX_ZOOM)),e!=this._.zoomLevel&&this._.scroller.zoomTo(e,!1)}.bind(this),s=function(t){BIF.events.stop(t),this._.state.touching=!0,e.classList.add("tapping"),n=setInterval(i,this.SCALE_INTERVAL_MS)}.bind(this),o=BIF.events.stop,u=function(t){BIF.events.stop(t),this._.state.touching=!1,e.classList.remove("tapping"),clearTimeout(n),this._scheduleRepaint()}.bind(this);return BIF.events.onContact(e,{start:s,move:o,end:u,cancel:u})},u._pulseButton=function(e,t){e/=Math.abs(e);var n=this._.parts[e<0?"minusButton":"plusButton"];if(n){n.classList.add("tapping");var r="pulseTimer"+e;clearTimeout(this._[r]);var i=function(){n.classList.remove("tapping")};this._[r]=setTimeout(i,100)}},o}),define("text!bifocal/themes/read/default/resources/icons/icon-zoom.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <g>\n      <polygon fill='#000000' points='1.66246973 24.8571429 12.8140436 24.8571429 12.8140436 26.3771429 3.9811138 38.32 10.8266344 38.32 11.2682809 36.1485714 12.703632 40.0571429 1 40.0571429 1 38.5371429 9.83292978 26.5942857 3.64987893 26.5942857 3.09782082 28.7657143 1.66246973 28.7657143' class='icon-solid' />\n      <polygon fill='#000000' points='56.8169492 40.0571429 56.8169492 38.7542857 58.91477 38.32 58.91477 27.4628571 58.2523002 29.0914286 54.82954 35.9314286 53.1065063 35.9314286 50.0353062 28.141272 50.1922518 24.8571429 54.1891525 33.5428571 58.3627119 24.9657143 63 24.8571429 63 26.16 61.1230024 26.5942857 61.1230024 38.32 63 38.7542857 63 40.0571429' class='icon-solid' />\n      <ellipse stroke='#000000' stroke-width='3' cx='30.9152542' cy='33' rx='20.4830508' ry='20.5' class='icon-hollow' />\n      <path d='M44.9901704,23.7908564 C44.2083097,22.5961869 43.2787134,21.5071014 42.2273631,20.5496046 C40.8948024,20.6464175 39.665083,20.942262 38.5381805,21.4371429 C37.1372033,22.052384 35.9304973,22.9450735 34.9180264,24.1152381 C33.9055554,25.2854027 33.1344409,26.6907854 32.6046595,28.3314286 C32.0748782,29.9720717 31.8099916,31.8057042 31.8099916,33.832381 C31.8099916,37.9339888 32.7341518,41.0825287 34.5824999,43.2780952 C36.1393584,45.1274148 38.2683327,46.1978844 40.9694705,46.4895235 C42.1590893,45.5998366 43.2270824,44.5562071 44.143977,43.3881343 C43.7046339,43.4595369 43.2428919,43.4952381 42.7587505,43.4952381 C38.1673125,43.4952381 35.8716279,40.177811 35.8716279,33.5428571 C35.8716279,26.9079033 38.2850399,23.5904762 43.1119363,23.5904762 C43.7863003,23.5904762 44.4123782,23.6572695 44.9901704,23.7908564 L44.9901704,23.7908564 Z' fill='#000000' class='icon-solid' />\n    <path d='M17.7429855,43.4596558 C18.6002097,44.5396741 19.5872264,45.511848 20.6804301,46.3525509 C21.5294697,46.1873175 22.3353491,45.9285312 23.0980758,45.5761905 C24.5343718,44.9126951 25.7646232,43.9958789 26.7888671,42.8257143 C27.813111,41.6555497 28.607771,40.2561986 29.1728711,38.627619 C29.7379711,36.9990395 30.0205169,35.2076288 30.0205169,33.2533333 C30.0205169,31.2990378 29.7732893,29.5377856 29.2788268,27.9695238 C28.7843642,26.401262 28.0603406,25.0622278 27.1067343,23.952381 C26.1531279,22.8425341 24.9935129,21.9920664 23.6278544,21.4009524 C22.430142,20.8825324 21.0966173,20.5914487 19.6272489,20.5276952 C18.5537832,21.5015591 17.6065942,22.6123286 16.8131917,23.8324694 C17.4484984,23.6711405 18.1424894,23.5904762 18.8951651,23.5904762 C23.6043323,23.5904762 25.9588805,26.8475865 25.9588805,33.3619048 C25.9588805,36.7396994 25.3113798,39.2730074 24.0163588,40.9619048 C22.7213378,42.6508021 20.8965629,43.4952381 18.5419793,43.4952381 C18.26744,43.4952381 18.0011088,43.4833773 17.7429855,43.4596558 L17.7429855,43.4596558 Z' id='path-1' fill='#000000' class='icon-solid' />\n    </g>\n  </g>\n</svg>\n"}),define("bifocal/themes/read/default/src/features/zoom",["require","common","../parts/quirks","../parts/zoomerang","text!../../resources/icons/icon-zoom.text.svg"],function(e){var t=e("common"),n=e("../parts/quirks");return function(t){function r(){if(BIF.objects.zoomerang)return!0;if(BIF.context.profile.APPROX_MODE)return!1;if(BIF.objects.codex.fullyPrepaginated())return!0}function i(e){s(e),BIF.objects.modality.toggle("zooming")}function s(e){if(e&&typeof e.pointerType=="string"){var t=e.pointerType=="mouse";BIF.objects.zoomerang.singlePointer=t}else BIF.objects.zoomerang.singlePointer=!n("has-touch-pointers")}return n("zoom-unavailable")?!1:(t.runSheet.append(["bifocal:reader:ready","loadZoomerang"],["bifocal:reader:ready","flagBookAsZoomable"],["bifocal:reader:ready","addZoomButtonToMenuBar"]),t.loadZoomerang=function(){if(r()){var t=e("../parts/zoomerang");BIF.objects.zoomerang=new t,BIF.objects.keyManager.addBinding("z down",function(e){BIF.events.stop(e),BIF.objects.modality.toggle("zooming")})}},t.flagBookAsZoomable=function(){if(!r())return;var e=BIF.root.classList,t="zoomable-book";BIF.listen("lens:scene:invalidate",function(){e.remove(t)}),BIF.listen("bifocal:chapters",function(){e.add(t)})},t.addZoomButtonToMenuBar=function(){if(!r())return;var t=e("text!../../resources/icons/icon-zoom.text.svg");BIF.objects.iconator.register("zoom",t),setTimeout(function(){BIF.objects.readHeader.menuBar.addShortcut("zoom",i)},0)},!0)}}),define("bifocal/themes/read/default/src/parts/notifier",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.DURATION=5e3,r.HIDE_MS=500,r.$init=function(e){this._.parts=this._layout(e),this._.showing=null,this._listen(this._.parts)},r.message=function(e){this._notify(e)},r.dialog=function(e,n,r,i){this._.lockOpen=!0;var s=this._.parts;s.dialog.innerHTML="",t.element({tag:"h2",parentNode:s.dialog,classes:"notifier-dialog-heading",html:e}),t.element({tag:"p",parentNode:s.dialog,classes:"notifier-dialog-prompt",html:n});if(r){var o=t.element({parentNode:s.dialog,classes:"notifier-dialog-actions"});if(r.cancel){var u=t.element({parentNode:o,classes:"notifier-dialog-action notifier-dialog-action-cancel",html:r.cancel.html||"Cancel"});BIF.events.onTap(u,r.cancel.onTap||this.close.bind(this))}if(r.ok){var u=t.element({parentNode:o,classes:"notifier-dialog-action notifier-dialog-action-ok",html:r.ok.html||"OK"});BIF.events.onTap(u,r.ok.onTap||this.close.bind(this))}}s.box.classList.add("dialog"),i&&i.modal&&s.box.classList.add("modal"),this._show()},r.close=function(){this._.lockOpen=!1,this._hide()},r._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"notifier"}),n.conveyer=t.element({parentNode:n.box,classes:"notifier-conveyer"}),n.pillar=t.element({parentNode:n.conveyer,classes:"notifier-pillar"}),n.closeButton=t.element({parentNode:n.pillar,classes:"notifier-close"}),n.dialog=t.element({parentNode:n.pillar,classes:"notifier-dialog"}),n.message=t.element({parentNode:n.pillar,classes:"notifier-message"}),n},r._listen=function(e){BIF.listen("bifocal:notify:message",this._onMessage.bind(this)),BIF.listen("bifocal:notify:dialog",this._onDialog.bind(this)),BIF.listen("bifocal:notify:close",this.close.bind(this)),BIF.events.onTap(e.closeButton,this.close.bind(this))},r._notify=function(e){this._show();for(var n=0,r=this._.parts.message.children.length;n<r;++n)if(this._.parts.message.children[n].innerHTML==e)return;t.element({tag:"p",parentNode:this._.parts.message,html:e})},r._show=function(){this._.showing=t.epochMilliseconds(),this._.parts.box.classList.add("expand"),this._.parts.box.classList.add("reveal"),clearTimeout(this._.timer),this._.timer=setTimeout(this._hide.bind(this),this.DURATION)},r._hide=function(){clearTimeout(this._.timer),this._.timer=setTimeout(this._clear.bind(this),this.HIDE_MS);if(this._.lockOpen)return;this._.showing=null,this._.parts.box.classList.remove("reveal"),this._.parts.box.classList.remove("modal")},r._clear=function(){this._.parts.message.innerHTML="";if(this._.lockOpen)return;this._.parts.dialog.innerHTML="",this._.parts.box.classList.remove("expand"),this._.parts.box.classList.remove("dialog"),this._.parts.box.classList.remove("modal")},r._onMessage=function(e){this.message(e.m)},r._onDialog=function(e){this.dialog(e.m.headingText,e.m.promptText,e.m.actions,e.m.options)},n}),define("bifocal/themes/read/default/src/features/notify",["require","../parts/notifier"],function(e){return function(t){return t.runSheet.append(["bifocal:reveal","loadNotifier"]),t.loadNotifier=function(){var t=e("../parts/notifier");BIF.objects.notifier=new t(BIF.elements.bookWidgets)},!0}}),define("bifocal/themes/read/default/src/parts/location_bar",["require","common","./page_numbers"],function(e){var t=e("common"),n=e("./page_numbers"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this._.box=e,this._.parts=this._layout(e),this._.pageNumbers=new n(this._.parts.pageNumbersBox),BIF.listen("bifocal:seeker:place",this._onPlace.bind(this))},i._layout=function(e){var n={};return n.bar=t.element({parentNode:e,classes:"location-bar"}),n.pageNumbersBox=t.element({parentNode:n.bar,classes:"loc-page-numbers"}),n.chapterTickerBox=t.element({parentNode:n.bar,classes:"loc-chapter-ticker"}),n},i._onPlace=function(e){this._setCurrentChapter(e.m.place.chapter)},i._setCurrentChapter=function(e){var t=e?e.title:BIF.objects.codex.title();this._.parts.chapterTickerBox.innerHTML=t},r}),define("bifocal/themes/read/default/src/features/fast_pager",["require","common","../parts/location_bar"],function(e){var t=e("common"),n=e("../parts/location_bar"),r=750,i=3,s=750;return function(e){function o(){var e=[],n=BIF.elements.fastPagerBox.classList,o=!0,u,a=function(){n.add("disabled"),o=!0};BIF.listen("bifocal:place",function(f){if(f.m.restored||f.m.repeated||BIF.objects.modality.isNot("reading"))return e=[];var l=t.epochMilliseconds();e.push(l),e.length==i&&e.shift()+s>l&&(o&&(n.remove("disabled"),o=!1),clearTimeout(u),u=setTimeout(a,r))})}return e.runSheet.append(["bifocal:reader:ready","loadFastPager"]),e.loadFastPager=function(){BIF.elements.fastPagerBox=t.element({parentNode:BIF.elements.controlFilm,classes:"fast-pager-box disabled"}),BIF.objects.fastPager=new n(BIF.elements.fastPagerBox),o()},!0}}),define("bifocal/themes/read/default/src/parts/history_manager",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(){this.history=[],this._listen()},r.reset=function(){return this.history.length?(this.history.splice(0),this._announceHistory(),!0):!1},r.seekToHistory=function(e){var t;typeof e=="number"?t=this.history[e]:t=e,console.assert(t,"[HISTORY] cannot seek to "+e),t.seek()},r._listen=function(){BIF.listen("bifocal:jumping",this._onJumping.bind(this)),BIF.listen("bifocal:jumped",this._onJumped.bind(this))},r._onJumping=function(e){if(e.m&&e.m.silently)return;this._removeHereFromHistory();var t=this._buildHistoryObject();t&&this.history.unshift(t)},r._onJumped=function(){this._removeHereFromHistory(),this._announceHistory()},r._removeHereFromHistory=function(){var e=[];for(var n=0,r=this.history.length;n<r;++n)this._isWithinHistoryObject(this.history[n])&&e.push(this.history[n]);t.each(e,t.excise.bind(t,this.history))},r._buildHistoryObject=function(){var e=BIF.objects.compass.place;return e.isSeekable()?e:null},r._isWithinHistoryObject=function(e){if(e){var t=BIF.objects.compass.place;return e.floc>=t.flocA&&e.floc<t.flocZ}},r._announceHistory=function(){clearTimeout(this._.announceTimer),this._.announceFn=this._.announceFn||function(){BIF.dispatch("bifocal:history",{history:this.history})}.bind(this),this._.announceTimer=setTimeout(this._.announceFn,0)},n}),define("bifocal/themes/read/default/src/parts/history_manager_read",["require","./history_manager"],function(e){var t=e("./history_manager"),n=t.new(),r=n.prototype;return r.$init=function(e){t.prototype.$init.call(this,e),this._recording(!0),BIF.listen("bifocal:orienting:close",this._recording.bind(this,!0))},r.reset=function(){return this._recording(!0),t.prototype.reset.call(this)},r.seekToHistory=function(e){this._recording(!0),t.prototype.seekToHistory.call(this,e),this._recording(!0)},r._recording=function(e){this._.recording=e},r._onJumping=function(e){this._.recording&&t.prototype._onJumping.call(this,e),BIF.objects.modality.is("orienting")&&this._recording(!1)},n}),define("text!bifocal/themes/read/default/resources/icons/back-badge-large.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g fill='#000000' fill-rule='evenodd' class='icon-solid'>\n    <path d='M32.2958822,46.0467657 L32.2958822,40.644097 L23.843052,47.8893801 L32.2958822,53.9271159 L32.2958822,49.6707129 C39.7740835,49.7593485 46.8283074,45.1749604 49.531165,37.7489201 L46.1269956,36.5099038 C43.9595432,42.46493 38.2943437,46.1357586 32.2958822,46.0467657 Z M32,64 C49.673112,64 64,49.673112 64,32 C64,14.326888 49.673112,0 32,0 C14.326888,0 0,14.326888 0,32 C0,49.673112 14.326888,64 32,64 Z' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/back-badge-small.text.svg",[],function(){return"<svg viewBox='0 0 28 16' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g fill='#000000' fill-rule='evenodd' class='icon-solid'>\n    <path d='M13,10.3805891 L13,16 L0,8 L13,0 L13,6.37703948 C19.2791281,6.08713388 24,3.100164 24,0 L28,0 C28,5.7835273 21.2460065,10.0591578 13,10.3805891 Z' />\n  </g>\n</svg>\n"}),define("bifocal/themes/read/default/src/parts/back_badge",["require","common","./timeline"],function(e){var t=e("common"),n=e("./timeline"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this._.parts=this._layout(e),this._listen()},i._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"back-badge"}),n.semaphore=t.DataClass.semaphore(n.box),BIF.objects.iconator.make("back-badge-large",n.box),n},i._listen=function(){BIF.listen("bifocal:history",this._onHistory.bind(this)),BIF.listen("lens:component:measured",this._onComponentMeasured.bind(this)),BIF.events.onTap(this._.parts.box,this._onTap.bind(this),{propagate:!1})},i._onHistory=function(e){this._.dest=null;if(e.m.history.length){var t=BIF.objects.compass.place;this._.dest=e.m.history[0];if(this._.dest){this._.cmptIndex=Math.floor(t.floc),this._.cmptPercent=t.floc%1,this._updatePlacement();var n=t.floc<this._.dest.floc?"ahead":"behind";this._.parts.semaphore.set("dir-in-space",n)}}this._.dest||this._.parts.semaphore.clear("dir-in-space")},i._onComponentMeasured=function(e){e.m.component.index==this._.cmptIndex&&this._updatePlacement(e.m.component)},i._updatePlacement=function(e){e=e||BIF.context.spine.byIndex(this._.cmptIndex);var n=e.metrics.widths.virtual*this._.cmptPercent,r=e.metrics.heads.real+n;r=Math.floor(r/BIF.context.spool.aperture)*BIF.context.spool.aperture;var i="translateX("+r*(BIF.context.profile.reverse?-1:1)+"px)";t.prefixProperty(this._.parts.box.style,"transform",i)},i._onTap=function(e){BIF.events.stop(e);var t=this._.parts.semaphore.get("dir-in-space");this._.parts.semaphore.clear("dir-in-space"),this._.dest.seek(),BIF.objects.activity.record("jump-back",{dir:t})},r}),define("bifocal/themes/read/default/src/parts/panel_hst",["require","./panel_abstract","common"],function(e){var t=e("./panel_abstract"),n=e("common"),r=t.new(),i=r.prototype;return i.TITLE="History",i.ID="hst",i.NO_HISTORY_APOLOGY=["<p>","Whenever you jump within the book&nbsp;â&nbsp;","by searching, choosing a chapter, using the seek bar, ","or tapping a&nbsp;link&nbsp;â&nbsp;an entry is added here so ","you can&nbsp;easily&nbsp;return.","</p>"].join(""),i._innerLayout=function(e){this._.list=n.element({parentNode:e,classes:"panel-hst-list"}),this._.actions=n.element({parentNode:e,classes:"panel-hst-actions"}),this._.clearButton=n.element({parentNode:this._.actions,classes:"panel-hst-action-clear",html:"Clear history"}),this._.apology=n.element({parentNode:e,classes:"panel-hst-apology",html:this.NO_HISTORY_APOLOGY}),this._.entries=[],this._apologize()},i._listen=function(){t.prototype._listen.call(this),BIF.listen("bifocal:history",this._onHistory.bind(this)),BIF.events.onTap(this._.clearButton,this._onTapClear.bind(this))},i._onHistory=function(e){this._.history=e.m.history,this.isOpen()&&(this._.history.length?this._refreshInPlace():this._refresh())},i._onOpen=function(){this._refresh()},i._refresh=function(){this._.history&&this._.history.length?(this._.parts.body.classList.remove("panel-hst-empty"),this._.list.innerHTML="",this._.entries=[],this._buildOrUpdateEntry(BIF.objects.compass.place),n.each(this._.history,this._buildOrUpdateEntry.bind(this))):this._apologize()},i._refreshInPlace=function(){var e=[BIF.objects.compass.place].concat(this._.history);n.each(e,function(e){for(var t=0,n=this._.entries.length;t<n;++t){var r=this._.entries[t];if(r.place.percentageOfBook==e.percentageOfBook){r.place=e,this._updateEntry(r);break}}},this)},i._buildOrUpdateEntry=function(e){var t=this._buildEntry(e);this._updateEntry(t)},i._buildEntry=function(e){var t={place:e};return t.rail=n.element({parentNode:this._.list,classes:"menu-panel-rail"}),BIF.events.onTap(t.rail,this._onTapEntry.bind(this,t)),t.box=n.element({parentNode:t.rail,classes:"menu-panel-row panel-hst-entry",attributes:{"data-place-uuid":e.uuid}}),t.label=n.element({parentNode:t.box,classes:"panel-hst-entry-label"}),t.time=n.element({parentNode:t.box,classes:"panel-hst-entry-time"}),this._.entries.push(t),t},i._updateEntry=function(e){this._updateEntryLabel(e),this._updateEntryTime(e);var t=BIF.objects.compass.place.percentageOfBook;e.place.percentageOfBook==t&&this._updatePresentEntry(e)},i._updateEntryLabel=function(e){e.label.innerHTML="",e.place.isFinite()||e.place.refresh();var t=e.place.toHumanString()||"--";t.indexOf("%")<0&&(t=(e.place.spread?"pp.":"p.")+t),n.element({parentNode:e.label,classes:"panel-hst-entry-clock clocks",html:t}),e.place.chapter&&n.element({parentNode:e.label,classes:"panel-hst-entry-chapter",html:e.place.chapter.title})},i._updateEntryTime=function(e){var t=(n.epochMilliseconds()-e.place.timestamp)/1e3;e.time.innerHTML=this._secondsAgoToString(t)},i._secondsAgoToString=function(e){var t=Math.round(e);if(t<6)return"a moment ago";if(t<60)return t+" seconds ago";if(t<120)return"a minute ago";if(t<3600)return Math.round(t/60)+" minutes ago";var r=(n.epochSeconds()-t)*1e3;if(t<86400){var i=new Date(r),s=i.getHours()<12?"am":"pm",o=i.getHours()%12||12,u=i.getMinutes();return u<10&&(u="0"+u),"at "+o+":"+u+s}return n.timestampToHumanDate(r)},i._updatePresentEntry=function(e){var t="panel-hst-entry-active";this._.presentEntry&&this._.presentEntry.rail.classList.remove(t);if(this._.presentEntry=e)this._.presentEntry.rail.classList.add(t),this._.presentEntry.time.innerHTML="Now"},i._onTapEntry=function(e){BIF.objects.historyManager.seekToHistory(e.place)},i._onTapClear=function(){BIF.objects.historyManager.reset()},i._apologize=function(){this._.parts.body.classList.add("panel-hst-empty"),this._.list.innerHTML=""},r}),define("bifocal/themes/read/default/src/features/history",["require","../parts/history_manager_read","text!../../resources/icons/back-badge-large.text.svg","text!../../resources/icons/back-badge-small.text.svg","../parts/back_badge","../parts/panel_hst"],function(e){return function(t){return t.runSheet.append(["bifocal:reader:ready","loadHistoryManager"],["bifocal:reader:ready","loadBackBadge"],["bifocal:reader:ready","loadHistoryPanel"]),t.loadHistoryManager=function(){var t=e("../parts/history_manager_read");BIF.objects.historyManager=new t},t.loadBackBadge=function(){BIF.objects.iconator.register("back-badge-large",e("text!../../resources/icons/back-badge-large.text.svg")),BIF.objects.iconator.register("back-badge-small",e("text!../../resources/icons/back-badge-small.text.svg"));var t=e("../parts/back_badge"),n=BIF.objects.readerAffordance._.film;BIF.objects.backBadge=new t(n)},t.loadHistoryPanel=function(){var t=e("../parts/panel_hst");BIF.objects.panelHst=new t,BIF.objects.menuList.addPanel(BIF.objects.panelHst)},!0}}),define("bifocal/themes/read/default/src/parts/reading_time",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.MIN_SECONDS=60,r.BANK_KEY_CACHE="reading:time",r.SAVE_CACHE_INTERVAL=3e4,r.IS_READING_THRESHOLD_IN_SECONDS=900,r.$init=function(e){this._.parts={},this._.parts.box=e,this._layoutPartial(this._.parts),this._listenPartial(this._.parts),this._toggleEstimates(),this._.cache=BIF.bank.title.get(this.BANK_KEY_CACHE)},r.refresh=function(){var e=this._computeValues();this._.parts.box.classList.remove("sorry");if(typeof e.timeEffort=="undefined")return this._apologizeBecauseUninitialized();this._resetCache(),this._.parts.timeEffort.innerHTML=this._secondsToString(e.timeEffort);if(typeof e.percentEffort=="undefined")return this._apologizeBecauseTooEarlyInBook();this._.parts.percentEffort.innerHTML=[Math.round(e.percentEffort*100),"% through"].join(""),this._.parts.estimateEffort.innerHTML=this._secondsToString(e.estEffort),this._.parts.timeElapsed.innerHTML=[this._secondsToString(e.timeElapsed,!0)," ago"].join(""),this._.parts.estimateElapsed.innerHTML=this._secondsToString(e.estElapsed)},r._layoutPartial=function(e){e.box.classList.add("reading-time"),e.header=t.element({parentNode:e.box,classes:"reading-time-header",html:"Time spent reading"}),e.timeEffort=t.element({parentNode:e.box,classes:"reading-time-block-value"}),e.estimates=t.element({parentNode:e.box,classes:"reading-time-estimates"});var n=t.element({parentNode:e.estimates});e.percentEffortPrefix=t.element({tag:"span",parentNode:n,html:"As you are "}),e.percentEffort=t.element({tag:"span",parentNode:n,classes:"reading-time-inline-value"}),e.percentEffortPostfix=t.element({tag:"span",parentNode:n,html:",<br/>at this rate you&rsquo;ll be reading for another"}),e.estimateEffort=t.element({parentNode:n,classes:"reading-time-block-value"});var n=t.element({parentNode:e.estimates});e.timeElapsedPrefix=t.element({tag:"span",parentNode:n,html:"&hellip; and because you first opened this book<br/>"}),e.timeElapsed=t.element({tag:"span",parentNode:n,classes:"reading-time-inline-value"}),e.timeElapsedPostfix=t.element({tag:"span",parentNode:n,html:", you&rsquo;re on track to&nbsp;finish&nbsp;in"}),e.estimateElapsed=t.element({parentNode:n,classes:"reading-time-block-value"}),e.expando=t.element({parentNode:e.box,classes:"reading-time-expando"}),e.apology=t.element({parentNode:e.box,classes:"reading-time-apology"})},r._listenPartial=function(e){BIF.events.onTap(e.expando,this._toggleEstimates.bind(this)),BIF.listen("bifocal:possession:synchronized",this._onSync.bind(this)),BIF.listen("bifocal:place",this._onPlace.bind(this))},r._apologizeBecauseUninitialized=function(){this._.parts.box.classList.add("sorry"),this._.parts.timeEffort.innerHTML="",this._.parts.apology.innerHTML="(Not yet available.)"},r._apologizeBecauseTooEarlyInBook=function(){this._.parts.box.classList.add("sorry"),this._.parts.apology.innerHTML="(Not enough to make estimates.)"},r._toggleEstimates=function(){var e=this._.parts.box.classList;e.contains("collapse")?(e.remove("collapse"),this._.parts.expando.innerHTML="Conceal Estimates"):(e.add("collapse"),this._.parts.expando.innerHTML="Reveal Estimates")},r._secondsToString=function(e,n){var r,i=t.secondsToUnits(e),s=function(e){return e!=1?"s":""};return i.years?r=i.years+" year"+s(i.years):i.weeks?(r=i.weeks+" week"+s(i.weeks),!n&&i.days&&(r+=", "+i.days+" day"+s(i.days))):i.days?(r=i.days+" day"+s(i.days),!n&&i.hours&&(r+=", "+i.hours+" hour"+s(i.hours))):i.hours?(r=i.hours+" hour"+s(i.hours),!n&&i.minutes&&(r+=", "+i.minutes+" minute"+s(i.minutes))):r=i.minutes+" minute"+s(i.minutes),r},r._computeValues=function(){if(!BIF.objects.compass)return{};var e=BIF.objects.compass.place;if(!e)return{};var t={timeEffort:this._timeSpentReading()};return e.percentageOfBook>.01&&(t.percentEffort=e.percentageOfBook,t.estEffort=Math.max(this.MIN_SECONDS,t.timeEffort/t.percentEffort-t.timeEffort),t.timeElapsed=this._timeElapsedReading(),t.estElapsed=Math.max(t.estEffort,t.timeElapsed/t.percentEffort-t.timeElapsed)),t},r._timeSpentReading=function(){var e=0,t=BIF.objects.possession;t&&t.data&&t.data.statistics&&(e=t.data.statistics.readingTime||0);if(this._.cache){var n=this._.cache.acc||0;return e=Math.max(this._.cache.timeEffort||0,e),Math.round(e+n)}return e},r._timeElapsedReading=function(){var e=t.epochSeconds()-this._timeBeganReading();return Math.max(this.MIN_SECONDS,e)||0},r._timeBeganReading=function(){var e,n;this._.cache&&(e=this._.cache.timeBegan),BIF.objects.possession&&(n=BIF.objects.possession.data.timestamps.created);var r=e&&n?Math.min(e,n):e||n||Infinity;return Math.min(r,t.epochSeconds()-this._timeSpentReading())},r._resetCache=function(){this._.cache={timeBegan:this._timeBeganReading(),timeEffort:this._timeSpentReading(),at:t.epochMilliseconds(),acc:0,dirty:!0},this._saveCache()},r._saveCache=function(){if(!this._.cache)return;clearTimeout(this._.cacheSaveTimer),this._.cacheSaveTimer=setTimeout(this._saveCache.bind(this),this.SAVE_CACHE_INTERVAL);if(!this._.cache.dirty)return;delete this._.cache.dirty,BIF.bank.title.set(this.BANK_KEY_CACHE,this._.cache)},r._onSync=function(e){if(!this._.cache)return;this._resetCache()},r._onPlace=function(e){if(!this._.cache)return;var n=(t.epochMilliseconds()-this._.cache.at)/1e3;n<this.IS_READING_THRESHOLD_IN_SECONDS&&(this._.cache.acc+=n),this._.cache.at=t.epochMilliseconds(),this._.cache.dirty=!0},n}),define("bifocal/themes/read/default/src/parts/panel_ovw",["require","./panel_abstract","common","./reading_time"],function(e){var t=e("./panel_abstract"),n=e("common"),r=e("./reading_time"),i=t.new(),s=i.prototype;return s.TITLE="Overview",s.ID="ovw",s._innerLayout=function(e){var t=this._.parts;t.page=n.element({parentNode:e,classes:"overview-page"}),t.cover=n.element({parentNode:t.page,classes:"overview-cover cover-3d cover-3d-interactive"}),t.score=n.element({parentNode:t.page,classes:"overview-score"}),t.readingTime=new r(t.score),t.biblio=n.element({parentNode:t.page,classes:"overview-biblio"}),t.title=n.element({tag:"h1",parentNode:t.biblio,classes:"biblio-title",html:BIF.objects.codex.title()}),t.creator=n.element({tag:"h2",parentNode:t.biblio,classes:"biblio-creator",html:BIF.objects.codex.byline()}),t.description=n.element({parentNode:t.biblio,classes:"biblio-description",html:BIF.objects.codex.description()}),t.version=n.element({parentNode:t.page,classes:"overview-app-version",html:BIF.version}),BIF.events.onTap(t.version,this._openAppPanel.bind(this))},s._onOpen=function(){this._.parts.readingTime.refresh()},s._openAppPanel=function(){BIF.objects.panelApp&&BIF.objects.panelApp.open()},i}),define("bifocal/themes/read/default/src/features/overview",["require","../parts/panel_ovw"],function(e){return function(t){return t.runSheet.append(["bifocal:reader:ready","loadOverview"]),t.loadOverview=function(){var t=e("../parts/panel_ovw");BIF.objects.panelOvw=new t,BIF.objects.menuList.header(BIF.objects.codex.title(),BIF.objects.panelOvw),BIF.objects.menuPanel._adopt(BIF.objects.panelOvw._.parts.dialog)},!0}}),define("bifocal/themes/read/default/src/parts/marks_collection",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.SAVE_RECORDINGS_DELAY=200,r.$init=function(e,t,n){this.name=e,this.klass=t,this._.missing=[],this._.callbacks={change:n},this._.recordingsBankKey="possession:"+this.name+":recordings",this._.recordings=BIF.bank.title.get(this._.recordingsBankKey)||[],this._assignList(BIF.objects.possession),BIF.listen("bifocal:possession:synchronized",this._onPossessionSync.bind(this))},r.perform=function(e,t){var n=this._record(e,t),r={};return r[e+"d"]=[n],this._scheduleCallback(r),n},r._record=function(e,n){var r={operation:e,params:n,syncstamp:t.epochSeconds()},i=this._replay(r);if(i)return this._.recordings.push(r),this._saveRecordings(),BIF.objects.activity.record(this.name+"."+r.operation,i.serialize()),i},r._replay=function(e){return this["_operation_"+e.operation].call(this,e)},r._saveRecordings=function(){clearTimeout(this._.saveRecordingsTimer),this._.saveRecordingsTimer=setTimeout(function(){BIF.bank.title.set(this._.recordingsBankKey,this._.recordings)}.bind(this),this.SAVE_RECORDINGS_DELAY)},r._operation_create=function(e){var t=new this.klass(e.params);if(!t.place){this._.missing.push(t);return}return this._findMarkByUUID(t.uuid)&&console.warn("[MARKS] adding mark with duplicate UUID",t),t.collection=this,this.all.push(t),t},r._operation_update=function(e){var n=this._findMarkByUUID(e.params.uuid);if(!n){console.warn("[MARKS] cannot update mark for",e.params.uuid);return}return n.deserialize(t.absorb(e.params,n.serialize())),n},r._operation_delete=function(e){var n=this._findMarkByUUID(e.params.uuid);if(!n)return;typeof n.removed=="function"&&n.removed(),t.excise(this.all,n);var r=[];return t.each(this._.recordings,function(t){t.params.uuid==e.params.uuid&&t!=e&&r.push(t)},this),t.each(r,function(e){t.excise(this._.recordings,e)},this),n},r._findMarkByUUID=function(e){for(var t=0,n=this.all.length;t<n;++t){var r=this.all[t];if(r.uuid==e)return r}},r._onPossessionSync=function(e){this._assignList(e.m.possession)},r._assignList=function(e){var t=this.name+"s";this.all=e.data.marks[t],this.all||(this.all=e.data.marks[t]=[]);for(var n=0,r=this.all.length;n<r;++n)this.all[n]=new this.klass(this.all[n]),this.all[n].collection=this;console.assert(this.all,"[MARKS] possession marks not found:",this.name+"s"),this._replayRecordsSince(e.data.timestamps.stamped),this._scheduleCallback({synced:this.all})},r._replayRecordsSince=function(e){var n=[];t.each(this._.recordings,function(t){t.syncstamp>e&&(this._replay(t),n.push(t))},this),this._.recordings=n,this._saveRecordings()},r._scheduleCallback=function(e){var n=this._.callbacks.schedule=this._.callbacks.schedule||{};n.delta?t.each(e,function(e,t){n.delta[e]=n.delta[e]||[],n.delta[e]=n.delta[e].concat(t)}):n.delta=e,clearTimeout(n.timer),setTimeout(this._invokeCallback.bind(this),0)},r._invokeCallback=function(){var e=this._.callbacks.schedule;if(!e)return;clearTimeout(e.timer),this._.callbacks.change(e.delta),this._.callbacks.schedule=null},n}),define("bifocal/themes/read/default/src/parts/mark_bookmark",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this.type="bookmark",this.deserialize(e)},r.serialize=function(){return this._.savedAttributes||this.place.toHash()},r.deserialize=function(e){var t=BIF.context.spine.byPosition(e.spinePosition);return t?(this.place=BIF.objects.compass.at({region:t.index+e.percentageOfComponent,percentageOfBook:e.percentageOfBook}),this.uuid=this.place.uuid=e.uuid,this.place.timestamp=e.timestamp*1e3,this):(console.warn("[BOOKMARK] could not find place:",e),this._.savedAttributes=e,null)},r.meta=function(){return{title:this.place.chapter?this.place.chapter.title:"Bookmark",timestamp:this.place.timestamp}},r.refresh=function(){this.place.refresh()},n}),define("bifocal/themes/read/default/src/parts/mark_highlight",["require","common","core/src/locator"],function(e){var t=e("common"),n=e("core/src/locator"),r=t.Class.new(),i=r.prototype;return i.COLOR_GROUPS={"#FFB":"Y","#FFE0EC":"R","#DFC":"G"},i.EXCERPT_LENGTH=80,i.$init=function(e){this.type="highlight",this._.locator=new n,this.deserialize(e)},i.activate=function(){setTimeout(function(){BIF.dispatch("bifocal:highlight:active",{mark:this})}.bind(this),0)},i.serialize=function(){return t.absorb(this._.attributes,{})},i.deserialize=function(e){this._.attributes=e=t.absorb(e,{});var n=this._findComponent();return n?(e.timestamp=e.timestamp||t.epochSeconds(),e.quote=e.quote||this._grabQuote(),this.uuid=e.uuid,this.excerpt=this._excerpt(this.EXCERPT_LENGTH),this.colorGroup=this.COLOR_GROUPS[this._.attributes.color],this._reattach(),this):(console.warn("[HIGHLIGHT] could not find place:",e),null)},i.meta=function(){return{title:this.excerpt,note:this._.attributes.note,timestamp:this._.attributes.timestamp*1e3,colorGroup:this.colorGroup}},i.refresh=function(){this._findPlace()},i.removed=function(){this._.removed=!0,BIF.objects.stencil.remove("highlight-"+this.uuid),this._.onComponentBinding&&(BIF.deafen("lens:component:visible",this._.onComponentBinding),delete this._.onComponentBinding)},i.setColor=function(e){this.collection.perform("update",{uuid:this.uuid,color:e})},i.setNote=function(e){(e||"")!=(this._.attributes.note||"")&&this.collection.perform("update",{uuid:this.uuid,note:e})},i._excerpt=function(e){this._.attributes.quote=this._.attributes.quote||this._grabQuote();var t=this._.attributes.quote||"";return typeof e=="number"&&t.length>e&&(t=t.slice(0,e).replace(/ ([\w]+)?$/,"â¦")),"â"+t+"â"},i._reattach=function(){if(this._.removed)return;(this._.range=this._grabRange())&&BIF.objects.stencil.add("highlight-"+this.uuid,this._.range,{className:"mask-highlight mask-highlight-"+this.colorGroup,title:this.note||"Highlight",tap:this.activate.bind(this)}),this._.onComponentBinding||(this._.onComponentBinding=this._onComponentModify.bind(this),BIF.listen("lens:component:visible",this._.onComponentBinding)),this._findPlace()},i._grabRange=function(){var e=this._findComponent(),t=e&&e.frameBox?e.frameBox.contentDocument:null;if(t){var n={};n.A=this._.locator.locatorToRange(this._.attributes.locatorA,t),n.A||this._fixLocators(t,n),n.Z=this._.locator.locatorToRange(this._.attributes.locatorZ,t);if(n.A&&n.Z){var r=t.createRange();return r.setStart(n.A.startContainer,n.A.startOffset),r.setEnd(n.Z.endContainer,n.Z.endOffset),r}}},i._fixLocators=function(e,t){return console.warn("[HL] invalid locator:",this._.attributes.locatorA),this._.attributes.locatorA.elementIndex+=1,this._.attributes.locatorZ.elementIndex+=1,t.A=this._.locator.locatorToRange(this._.attributes.locatorA,e),t.A?console.warn("[HL] ... fixed by one ahead"):(this._.attributes.locatorA.elementIndex-=2,this._.attributes.locatorZ.elementIndex-=2,t.A=this._.locator.locatorToRange(this._.attributes.locatorA,e),t.A?console.warn("[HL] ... fixed by one behind"):console.warn("[HL] ... could not be fixed"))},i._findComponent=function(){var e=this._.attributes.locatorA.spinePosition;return BIF.context.spine.byPosition(e)},i._findPlace=function(){var e=this._.attributes,n=this._findComponent();this.place=null;if(this._.range&&n.isLoaded()){var r=t.getRangeRects(this._.range)[0],i=BIF.context.spool.rectangleToFloc(n,r);isFinite(i)&&(this.place=BIF.objects.compass.at(i))}if(!this.place||!this.place.isSeekable()){var s;typeof e.percentageOfComponent=="number"?s=e.locatorA.spinePosition+e.percentageOfComponent:typeof e.percentageOfBook=="number"&&(s={percentageOfBook:e.percentageOfBook}),this.place=BIF.objects.compass.at(s)}this.place.isSeekable()&&(e.percentageOfBook=this.place.percentageOfBook,e.percentageOfComponent=this.place.floc%1)},i._onComponentModify=function(e){e.m.component==this._findComponent()&&this._reattach()},i._grabQuote=function(){var e=this._.range||this._grabRange();if(e&&BIF.objects.pincer)return BIF.objects.pincer.toFormattedText(e)},r}),define("bifocal/themes/read/default/src/parts/marks_manager",["require","common","./marks_collection","./mark_bookmark","./mark_highlight"],function(e){var t=e("common"),n=e("./marks_collection"),r=t.Class.new(),i=r.prototype;return i.$init=function(){this.collections={bookmark:new n("bookmark",e("./mark_bookmark"),this._onBookmarksCollectionChange.bind(this)),highlight:new n("highlight",e("./mark_highlight"),this._onHighlightsCollectionChange.bind(this))},BIF.listen("bifocal:page:bookmarked",this._onPageBookmarked.bind(this)),BIF.listen("bifocal:page:unbookmarked",this._onPageUnbookmarked.bind(this)),BIF.listen("bifocal:place",this._checkPageForBookmarks.bind(this)),BIF.listen("bifocal:selection:highlighted",this._onHighlighted.bind(this)),BIF.listen("bifocal:chapters",this._refreshAllMarks.bind(this))},i.removeMark=function(e,t){this.collections[t].perform("delete",{uuid:e})},i._onPageBookmarked=function(e){var t=this._bookmarkAtPlace();if(t)return console.warn("[MM] place already bookmarked",t);this.collections.bookmark.perform("create",BIF.objects.compass.place.toHash()),this._checkPageForBookmarks()},i._onPageUnbookmarked=function(e){var t=e&&e.m?e.m.mark:this._bookmarkAtPlace();t?(this.collections.bookmark.perform("delete",{uuid:t.uuid}),this._onPageUnbookmarked()):this._checkPageForBookmarks()},i._checkPageForBookmarks=function(){BIF.dispatch("bifocal:page:bookmark",{mark:this._bookmarkAtPlace()})},i._bookmarkAtPlace=function(e){e=e||(BIF.objects.compass?BIF.objects.compass.place:null);if(!e)return;for(var t=0,n=this.collections.bookmark.all.length;t<n;++t){var r=this.collections.bookmark.all[t];if(e.overlaps(r.place))return r}},i._onBookmarksCollectionChange=function(){this._checkPageForBookmarks(),this._publish("bookmark")},i._onHighlighted=function(e){var n=BIF.objects.compass.place,r=this.collections.highlight.perform("create",{uuid:t.generateUUID(),color:e.m.color,quote:e.m.selection.text,locatorA:e.m.selection.locatorA,locatorZ:e.m.selection.locatorZ,percentageOfComponent:n.percentageOfComponent,percentageOfBook:n.percentageOfBook});r.activate()},i._onHighlightsCollectionChange=function(){var e=0;while(e<this.collections.highlight.all.length){var t=this.collections.highlight.all[e];this._mergeOverlappingHighlights(t)||(e+=1)}this._publish("highlight")},i._mergeOverlappingHighlights=function(e){var n=[],r=t.absorb(e._.attributes,{}),i=function(e,t){return e.spinePosition<t.spinePosition?e:t.spinePosition<e.spinePosition?t:e.elementIndex<t.elementIndex?e:t.elementIndex<e.elementIndex?t:t.charOffset<e.charOffset?t:e};t.each(this.collections.highlight.all,function(t){if(t===e)return;var s=t._.attributes.locatorA,o=t._.attributes.locatorZ;if(i(r.locatorA,o)===o||i(s,r.locatorZ)===r.locatorZ)return;r.locatorA=i(r.locatorA,s),r.locatorZ=i(r.locatorZ,o)===o?r.locatorZ:o,r.note=(r.note?r.note+"\n":"")+(t._.attributes.note||""),t._.attributes.timestamp>r.timestamp&&(r.color=t._.attributes.color,r.timestamp=t._.attributes.timestamp),n.push(t)});if(n.length)return t.each(n.concat([e]),function(e){this.collections.highlight.perform("delete",{uuid:e.uuid})},this),r.uuid=t.generateUUID(),r.quote=null,this.collections.highlight.perform("create",r)},i._refreshAllMarks=function(){this.collections.bookmark.all.length&&(t.each(this.collections.bookmark.all,function(e){e.refresh()}),this._publish("bookmark")),this.collections.highlight.all.length&&(t.each(this.collections.highlight.all,function(e){e.refresh()}),this._publish("highlight"))},i._publish=function(e){var n=this.collections[e].all.slice(0);n.sort(this._sortMarksByPlace.bind(this)),BIF.objects.compass.landmarks(e,function(e){t.each(n,function(t){e(t.uuid,t.place,t.meta())})}.bind(this))},i._sortMarksByPlace=function(e,t){var n=(e.place?e.place.floc:0)||0,r=(t.place?t.place.floc:0)||0;return n-r},r}),define("bifocal/themes/read/default/src/parts/menu_filter",["require","common","./quirks"],function(e){var t=e("common"),n=e("./quirks"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this._.list=e,this._.scrollBox=e.parentNode,this._.parts=this._layout(this._.scrollBox),this._listen(),this.update()},i.PLACEHOLDER_TEXT="FILTERâ¦",i.ANIMATE_MS=240,i.apply=function(){this._.filtered=0,t.each(this._.rows,function(e){this._rowMatchesPattern(e)?this._reappear(e):(this._disappear(e),this._.filtered+=1)}.bind(this)),this._.filtered&&n.ask("ios")&&setTimeout(this._refreshScrolling.bind(this),this.ANIMATE_MS+40),this._fixInPosition()},i.update=function(){this._.rows=this._findRows(),this.apply()},i.clear=function(e){this._.parts.input&&(this._.parts.input.blur(),this._.parts.input.value="",this._.textOriginal="",this._.textPattern=""),this.apply(),e&&BIF.events.stop(e)},i.hide=function(){if(!this._isFiltering()){var e=this._.parts.form.offsetHeight;this._.scrollBox.scrollTop=Math.max(this._.scrollBox.scrollTop,e)}},i._layout=function(e){var n={};return n.form=t.element({tag:"form",parentNode:e,classes:"menu-filter",pos:"prepend"}),n.field=t.element({parentNode:n.form,classes:"menu-filter-field"}),n.clearButton=t.element({parentNode:n.field,classes:"menu-filter-clear-button"}),BIF.objects.iconator.make("search-reset",n.clearButton),n},i._listen=function(){BIF.events.onTap(this._.parts.clearButton,this.clear.bind(this)),BIF.listen(this._.parts.form,"submit",this._onSubmit.bind(this)),BIF.listen("bifocal:menuing:level",this._onMenuLevel.bind(this))},i._rowMatchesPattern=function(e){if(!this._.textPattern)return!0;var t=this._.textPattern.replace(/[^\w\s]/g,"*"),n=e.textContent.toLowerCase().replace(/[^\w\s]/g,"*");return n.indexOf(t)>=0},i._isFiltering=function(){return this._.textPattern?!0:!1},i._onSubmit=function(e){BIF.events.stop(e),this._.parts.input&&this._.parts.input.blur()},i._onKeyUp=function(e){this._.textOriginal=this._.parts.input.value,this._.textPattern=this._.parts.input.value.toLowerCase(),this.apply()},i._disappear=function(e){var n=e._filter=e._filter||{};if(n.hidden)return;n.hidden=!0,n.trueHeight=e.offsetHeight,e.style.setProperty("max-height",n.trueHeight+"px"),e.style.setProperty("overflow-y","hidden");var r="max-height "+this.ANIMATE_MS+"ms ease-in-out";t.prefixProperty(e.style,"transition",r),clearTimeout(n.timer),n.timer=setTimeout(function(){e.style.setProperty("max-height",0)},10)},i._reappear=function(e){var n=e._filter=e._filter||{};if(!n.hidden)return;n.hidden=!1,e.style.setProperty("max-height",n.trueHeight+"px"),clearTimeout(n.timer),n.timer=setTimeout(function(){e.style.removeProperty("max-height"),e.style.removeProperty("overflow-y"),t.prefixProperty(e.style,"transition")},this.ANIMATE_MS)},i._refreshScrolling=function(){this._.list.style.setProperty("display","none"),this._.list.offsetHeight,this._.list.style.removeProperty("display")},i._findRows=function(){var e=[];return t.each(this._.list.children,function(t){t!=this._.parts.form&&e.push(t)}.bind(this)),e},i._onMenuLevel=function(e){if(e.m.level==2){var t=this._.scrollBox;while(t=t.parentNode)t===BIF.objects.menuPanel.activeChild&&this._createSearchInput()}else this._.parts.input&&this._destroySearchInput()},i._createSearchInput=function(){if(this._.parts.input)return;this._.parts.input=t.element({parentNode:this._.parts.field,tag:"input",classes:"menu-filter-input",attributes:{type:"search",autocapitalize:"off",autocorrect:"off",placeholder:this.PLACEHOLDER_TEXT,value:this._.textOriginal||""}}),BIF.listen(this._.parts.input,"keyup",this._onKeyUp.bind(this))},i._destroySearchInput=function(){this._.parts.input.blur(),this._.parts.field.removeChild(this._.parts.input),delete this._.parts.input},i._fixInPosition=function(){var e=this._.scrollBox.classList.contains("menu-filtered");if(this._isFiltering()){if(e)return;this._.scrollBox.classList.add("menu-filtered"),this._isPositionFixed()?(this._updatePositionFixed(),this._.onResizeFn=this._updatePositionFixed.bind(this),BIF.listen(window,"resize",this._.onResizeFn)):(this._.parts.form.style.top=0,this._.parts.form.style.left=0)}else e&&(this._.onResizeFn&&(BIF.deafen(window,"resize",this._.onResizeFn),this._removePositionFixed()),this._.scrollBox.classList.remove("menu-filtered"))},i._isPositionFixed=function(){var e=window.getComputedStyle(this._.parts.form);return e.getPropertyValue("position")=="fixed"},i._updatePositionFixed=function(){var e=this._.scrollBox.getBoundingClientRect();this._.parts.form.style.setProperty("width",e.width+"px");var t=this._.parts.form.offsetHeight;this._.scrollBox.style.setProperty("padding-top",t+"px"),this._.parts.form.style.setProperty("margin-top",0-t+"px")},i._removePositionFixed=function(){this._.scrollBox.style.removeProperty("padding-top"),this._.parts.form.style.removeProperty("margin-top")},r}),define("bifocal/themes/read/default/src/parts/menu_filter_marks",["require","./menu_filter","common"],function(e){var t=e("./menu_filter"),n=e("common"),r=t.new(),i=r.prototype;return i.SELECTOR_FILTERS=[{html:"Bookmarks",selector:".panel-mrk-row-type-bookmark"},{html:"Highlights",selector:".panel-mrk-row-type-highlight"},{html:"Notes",selector:".panel-mrk-row-note:not(:empty)"},{html:"All"},{html:'<span class="menu-filter-color menu-filter-color-Y"></span>',selector:".panel-mrk-row-color-Y"},{html:'<span class="menu-filter-color menu-filter-color-R"></span>',selector:".panel-mrk-row-color-R"},{html:'<span class="menu-filter-color menu-filter-color-G"></span>',selector:".panel-mrk-row-color-G"}],i.DATA_ATTR="data-mark-selector",i.apply=function(){t.prototype.apply.call(this);var e=this._.selectorPattern?"add":"remove";this._.scrollBox.classList[e]("menu-filtered-by-selector"),e=this._.textPattern?"add":"remove",this._.scrollBox.classList[e]("menu-filtered-by-text")},i._layout=function(e){var r=t.prototype._layout.call(this,e);return r.form.classList.add("menu-filter-marks"),r.shield=n.element({parentNode:e,classes:"menu-filter-shield",pos:"prepend"}),r.dropdown=n.element({parentNode:r.form,classes:"menu-filter-dropdown",html:"All"}),r.selectorOptions=n.element({parentNode:r.form,classes:"menu-filter-selector-options"}),n.each(this.SELECTOR_FILTERS,function(e){var t={};t[this.DATA_ATTR]=e.selector||"";var i=n.element({parentNode:r.selectorOptions,classes:e.classes,html:e.html,attributes:t});BIF.events.onTap(i,this._selectFilterOption.bind(this))},this),BIF.events.onTap(r.dropdown,this._toggleOptions.bind(this)),BIF.events.onTap(r.shield,this._toggleOptions.bind(this)),BIF.listen("bifocal:menuing:level",this._hideOptions.bind(this)),r},i._isFiltering=function(){return this._.selectorPattern||t.prototype._isFiltering.call(this)},i._rowMatchesPattern=function(e){return this._.selectorPattern&&!e.querySelector(this._.selectorPattern)?!1:t.prototype._rowMatchesPattern.call(this,e)},i._selectFilterOption=function(e){BIF.events.stop(e),this._toggleOptions();var t=e.tappedElement;this._.parts.dropdown.innerHTML=t.innerHTML,this._.selectorPattern=t.getAttribute(this.DATA_ATTR),this.apply()},i._toggleOptions=function(){this._.scrollBox.classList.toggle("menu-filter-show-selector-options")},i._hideOptions=function(){this._.scrollBox.classList.remove("menu-filter-show-selector-options")},r}),define("bifocal/themes/read/default/src/parts/panel_mrk",["require","./panel_abstract","common","./menu_filter_marks"],function(e){var t=e("./panel_abstract"),n=e("common"),r=e("./menu_filter_marks"),i=t.new(),s=i.prototype;return s.TITLE="Bookmarks",s.ID="mrk",s._innerLayout=function(e){this._.list=n.element({parentNode:e,classes:"menu-filter-scroll-hider panel-mrk-marks-list"}),this._.filter=new r(this._.list),this._.rows={all:[]},this._.dirtyGroups={},this._listenForLandmarks()},s._onOpen=function(){n.each(this._.dirtyGroups,this._populateMarks.bind(this)),this._.dirtyGroups={},this._.filter.update(),this._.filter.hide()},s._populateMarks=function(e,t){n.each(this._.rows.all,function(e){e.rail.parentNode.removeChild(e.rail)});var r=this._.rows[e]||[],i=[];n.each(t,function(e){var t;for(var s=0,o=r.length;s<o;++s)if(r[s].item.id==e.id){t=r[s],n.excise(r,t);break}t||(t=this._createRow(e),this._.rows.all.push(t)),t.item=e,this._updateRowToItem(t),i.push(t)},this),n.each(r,function(e){n.excise(this._.rows.all,e)},this),this._.rows[e]=i,this._.rows.all.sort(this._sortRows),n.each(this._.rows.all,function(e){this._.list.appendChild(e.rail)},this)},s._createRow=function(e){var t={item:e},r=this._snippets(e);return t.rail=n.element({parentNode:this._.list,classes:"menu-panel-rail"}),t.element=n.element({parentNode:t.rail,classes:"menu-panel-row panel-mrk-row"}),t.desc=n.element({parentNode:t.element,classes:"panel-mrk-row-desc",html:r.desc}),t.descType=n.element({tag:"span",parentNode:t.desc,html:r.type}),t.noteElement=n.element({parentNode:t.element,classes:"panel-mrk-row-note"}),n.element({parentNode:t.element,classes:"panel-mrk-row-title",html:r.title}),t.pos=n.element({parentNode:t.element,classes:"panel-mrk-row-pos-box"}),t.remove=n.element({parentNode:t.element,classes:"panel-mrk-row-remove"}),n.element({parentNode:t.remove,html:"Remove"}),this._listenForRowInteraction(t),t},s._listenForRowInteraction=function(e){var t={},r=-100,i=function(r){r||n.prefixProperty(e.element.style,"transition","none"),n.prefixProperty(e.element.style,"transform","translate3d("+t.slidePosition+"px, 0, 0)")},s=function(r){t.slidePosition=0,n.prefixProperty(e.element.style,"transition",null),n.prefixProperty(e.element.style,"transform",null)};e.slideHandler=BIF.events.onContact(e.element,{start:function(e){t={startX:e.screenX,startY:e.screenY,startPosition:t.slidePosition||0,slidePosition:t.slidePosition||0}},move:function(e){var n=e.screenX-t.startX,o=e.screenY-t.startY;if(t.exceededY)return;!t.exceededX&&Math.abs(o)>8&&(t.exceededY=!0,t.slidePosition&&s());if(t.exceededX||Math.abs(n)>8){t.exceededX=!0;var u=t.startPosition+n;t.slidePosition=Math.max(Math.min(0,u),r),i(!1),t.sliding=!0,BIF.events.stop(e)}},end:function(o){t.slidePosition<t.startPosition?(n.prefixProperty(e.element.style,"transition",null),t.slidePosition=r,i(!0),BIF.events.stop(o)):t.startPosition?s():t.exceededY||(this._seekToMark(e.item)?this._closePolitely():console.warn("Mark place not yet seekable. Wait for pagination!"))}.bind(this),cancel:s}),BIF.events.onTap(e.remove,function(t){BIF.objects.marksManager.removeMark(e.item.id,e.item.type),e.rail.parentNode.removeChild(e.rail),n.excise(this._.rows.all,e),n.excise(this._.rows[e.item.type],e),BIF.events.stop(t)}.bind(this))},s._snippets=function(e){return{desc:n.timestampToHumanDate(e.meta.timestamp)+". ",type:e.meta.note?"note":e.type,title:e.meta.title||"[Untitled "+e.type+"]"}},s._updateRowToItem=function(e){var t=this._snippets(e.item);e.descType.innerHTML=t.type,e.noteElement.innerHTML=(e.item.meta.note||"").trim(),e.pos.innerHTML=this._describePosition(e)||" â¢ ",e.descType.className=["panel-mrk-row-type-"+e.item.type,"panel-mrk-row-color-"+(e.item.meta.colorGroup||0)].join(" ")},s._describePosition=function(e){return e.item.place.toHumanString()},s._sortRows=function(e,t){return e.item.place.floc-t.item.place.floc},s._seekToMark=function(e){if(e.place.isSeekable())return e.place.seek(),!0},s._listenForLandmarks=function(){BIF.listen("bifocal:landmarks:group",this._onLandmarksGroup.bind(this))},s._onLandmarksGroup=function(e){if(e.m.name!="bookmark"&&e.m.name!="highlight")return;this.isOpen()?(this._populateMarks(e.m.name,e.m.items),this._.filter.update()):this._.dirtyGroups[e.m.name]=e.m.items},i}),define("bifocal/themes/read/default/src/features/marks",["require","../parts/marks_manager","../parts/panel_mrk"],function(e){return function(t){return t.runSheet.append(["bifocal:reader:ready","loadMarksManager"],["bifocal:reader:ready","loadMarksPanel"]),t.loadMarksManager=function(){var t=e("../parts/marks_manager");BIF.objects.marksManager=new t},t.loadMarksPanel=function(){var t=e("../parts/panel_mrk");BIF.objects.panelMrk=new t,BIF.objects.menuList.addPanel(BIF.objects.panelMrk)},!0}}),define("text!bifocal/themes/read/default/resources/bookmark-tall.text.svg",[],function(){return'<svg viewBox="0 0 25 48" version="1.1" xmlns="http://www.w3.org/2000/svg">\n  <g fill="#000000" fill-rule="evenodd">\n    <path d="M0,-1.11022302e-16 L25,-1.11022302e-16 L25,45.9305078 C25,47.3618118 24.0419519,47.8812774 22.8557622,47.0878386 L14.6709313,41.6130293 C13.4867015,40.8209014 11.5645448,40.8195905 10.3732781,41.6130293 L2.15341538,47.0878386 C0.964116905,47.8799665 0,47.3705418 0,45.9305078 L0,-1.11022302e-16 Z" />\n  </g>\n</svg>\n'}),define("bifocal/themes/read/default/src/parts/bookmark_button",["require","common","text!../../resources/bookmark-tall.text.svg"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.ICON_SVG=e("text!../../resources/bookmark-tall.text.svg"),r.KLS_ACTIVE="bookmark-active",r.$init=function(e){this._.parts=this._layout(e),this._.handler=this._listen(),BIF.listen("bifocal:page:bookmark",this._checkPage.bind(this))},r.toggle=function(){var e=this._.parts.target.classList;e.contains(this.KLS_ACTIVE)?BIF.dispatch("bifocal:page:unbookmarked"):BIF.dispatch("bifocal:page:bookmarked")},r._layout=function(e){var n={};return n.target=t.element({parentNode:e,classes:"bookmark-target"}),n.button=t.element({parentNode:n.target,classes:"bookmark-button",html:this.ICON_SVG}),n},r._listen=function(){return BIF.events.onTap(this._.parts.target,this.toggle.bind(this))},r._checkPage=function(e){this._.mark=e.m.mark;var t=this._.mark?"add":"remove";this._.parts.target.classList[t](this.KLS_ACTIVE)},n}),define("text!bifocal/themes/read/default/resources/icons/icon-bookmark.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='#000000' stroke-width='3' fill='none' fill-rule='evenodd' class='icon-hollow'>\n    <path d='M16,53 L16,15.0081112 C16,12.7912518 17.7927672,11 20.0042577,11 L43.9957423,11 C46.2109725,11 48,12.7944925 48,15.0081112 L48,53 L32,46.625 L16,53 Z' />\n  </g>\n</svg>\n"}),define("bifocal/themes/read/default/src/features/bookmarks",["require","common","./marks","../parts/bookmark_button","text!../../resources/icons/icon-bookmark.text.svg"],function(e){var t=e("common");return function(n){return n.addFeature(e("./marks"))?(n.runSheet.append(["bifocal:reader:ready","loadBookmarkButton"]),n.loadBookmarkButton=function(){var n=e("../parts/bookmark_button"),r=t.element({parentNode:BIF.elements.bookWidgets,classes:"bookmark-button-box"}),i=e("text!../../resources/icons/icon-bookmark.text.svg");BIF.objects.bookmarkButton=new n(r);var s=document.querySelector(".menu-bar-right");BIF.objects.orientBookmarkButton=new n(s),BIF.objects.orientBookmarkButton._.parts.button.innerHTML=i},!0):!1}}),define("bifocal/themes/read/default/src/parts/search_spider",["require","common","core/src/locator"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype,i=e("core/src/locator");return r.MAX_RESULTS=99,r.PHASES=["fetch","scan","parse"],r.DEFAULT_EXCERPT_RADIUS=65,n.BODY_CACHE={},r.$init=function(e,n){this.resultCount=0,this.query=e.trim(),this._.onResults=n;if(!this.query)return this._complete();this.pattern=new RegExp(t.regExpEscape(this.query),"i");if(typeof DOMParser=="undefined")return this._complete();this.parser=new DOMParser,this.locator=new i,this.tasks={},this.timers={},this.queues={},t.each(this.PHASES,function(e){this.queues[e]=[]},this),BIF.context.spine.each(this._task.bind(this,"fetch"))},r.halt=function(){this.halted=!0,t.each(this.PHASES,function(e){clearTimeout(this.timers[e]),this.tasks[e]&&(this.queues[e].unshift(this.tasks[e]),this.tasks[e]=null)},this)},r.resume=function(){this.halted=!1,t.each(this.PHASES,this._continue,this)},r._task=function(e,t){this.queues[e].push(t),this._work(e)},r._work=function(e){if(this.halted)return;if(this.tasks[e])return;this.tasks[e]=this.queues[e].shift();if(this.tasks[e]){clearTimeout(this.timers[e]);var t=this["_"+e].bind(this,this.tasks[e]);this.timers[e]=setTimeout(t,0)}},r._continue=function(e){this.tasks[e]=null,this._completionCheck()||this._work(e)},r._skip=function(e,t,n){console.warn("[SEARCH-SPIDER] SKIP %s %s",e,t,n),this._.skipped=this._.skipped||[],this._.skipped.push(t)},r._cache=function(e,t){if(typeof t!="string")return n.BODY_CACHE[e];n.BODY_CACHE[e]=t},r._fetch=function(e){var t=this._cache(e.id);t?this._fetched(e):e.fetch(this._fetched.bind(this,e))},r._fetched=function(e){try{var t=this._cache(e.id);!t&&!e.healthy?(this._skip("fetching",e.id,"unhealthy"),this._results([],0)):(e.frameBox&&e.frameBox.contentDocument&&this._cache(e.id,e.frameBox.contentDocument.body.innerHTML),this._task("scan",e))}catch(n){this._skip("fetching",e.id)}this._continue("fetch")},r._scan=function(e){try{var t=this._cache(e.id);t.search(this.pattern)>0&&this._task("parse",e)}catch(n){this._skip("scanning",e.id,n)}this._continue("scan")},r._parse=function(e){try{this._walk(e)}catch(t){this._skip("parsing",e.id,t)}this._continue("parse")},r._walk=function(e){var n=this._cache(e.id),r=this.parser.parseFromString(n,"text/html"),i=[],s,o={},u=BIF.objects.compass.chapters[0];while(u){var a=u.place.floc;a<e.index?s=u:a==e.index&&(a%1>0?o[u.path.replace(/^[^#]*#/,"")]=u:s=u),u=u.next}var f=this.query.toLowerCase(),l=f.length,c=0;t.walk(r,function(n){if(n.nodeType==3&&n.nodeValue.search(this.pattern)>=0){var u=n.nodeValue.toLowerCase(),a=u.indexOf(f);while(a>=0){var h=r.createRange();h.setStart(n,a),h.setEnd(n,a+l);var p=this.locator.rangeToLocator(h,e.spinePosition);p.excerpt=this._excerpt(n.nodeValue,a,l);var d=s?s.title:"",v=t.last(i);if(!v||v.chapter!=d)v={chapter:d,results:[]},i.push(v);v.results.push(p),c+=1;if(!(this.resultCount+c<this.MAX_RESULTS))throw this._results(i,c,!0),i=[],"halt";a=u.indexOf(f,a+l)}}else n.nodeType==1&&o[n.id]&&(s=o[n.id])}.bind(this)),c&&this._results(i,c)},r._excerpt=function(e,t,n){var r=e,i=t+n;r=r.slice(0,i)+"</b>"+r.slice(i),r=r.slice(0,t)+"<b>"+r.slice(t);var s="&hellip;",o=Math.max(t-this.DEFAULT_EXCERPT_RADIUS,0),u=Math.min(i+this.DEFAULT_EXCERPT_RADIUS+7,r.length),a=o>0?s:"",f=u<e.length?s:"",l=a+r.slice(o,u).trim()+f;return l},r._completionCheck=function(){if(this.halted)return;for(var e=0,t=this.PHASES.length;e<t;++e){var n=this.PHASES[e];if(this.queues[n].length)return!1;if(this.tasks[n])return!1}return this._results([],0,!0),!0},r._results=function(e,t,n){var r={};r.source="spider",r.query=this.query,r.chapters=e,r.range=[this.resultCount,this.resultCount+t],n||(r.pending=!0),this._.skipped&&(r.skipped=this._.skipped.length),this._.onResults(r),this.resultCount+=t,n&&(this.halted=!0)},n}),define("bifocal/themes/read/default/src/parts/search_result",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e,n){this.query=e,this.excerpt=n.excerpt;var r=n.extent;delete n.excerpt,delete n.extent,this.locatorA={},t.each(n,function(e,n){this.locatorA[t.camelize(e)]=n},this),r&&(this.locatorZ={},t.each(r,function(e,n){this.locatorZ[t.camelize(e)]=n},this)),this.component=BIF.context.spine.byPosition(this.locatorA.spinePosition),this.reachable=this.component?!0:!1},r.seek=function(){BIF.objects.searchManager.seekToResult(this)},n}),define("bifocal/themes/read/default/src/parts/search_manager",["require","common","core/src/locator","./search_spider","./search_result"],function(e){var t=e("common"),n=e("core/src/locator"),r=e("./search_spider"),i=e("./search_result"),s=t.Class.new(),o=s.prototype;return o.STENCIL_OPTIONS={className:"mask-search-result",padding:1},o.$init=function(){this._.locator=new n,BIF.listen("bifocal:search:clear",this._onClear.bind(this))},o.searchFor=function(e){this._.activeSearch={},this._.activeSearch.query=e,this._.activeSearch.resultCount=0,this._.activeSearch.spider=new r(e,this._onResults.bind(this)),this._.activeSearch.query=this._.activeSearch.spider.query,this._.activeSearch.request=BIF.network.sendRequest("/_d/search?query="+e,{method:"GET",accept:"application/json",success:this._reqReady.bind(this),failure:this._reqFailed.bind(this)})},o.seekToResult=function(e){if(!e.reachable){this._jumpError(e,"Search result is not in sample.");return}var t={component:e.component,finder:function(t){var n=t.frameBox.contentDocument,r;return e.locatorZ?r=this._.locator.locatorsToRange(e.locatorA,e.locatorZ,n):r=this._.locator.locatorToRange(e.locatorA,n),r?(BIF.objects.stencil.add("search-result",r,this.STENCIL_OPTIONS),BIF.context.spool.rectangleToFloc(t,r.getClientRects()[0])):(this._jumpError(e,"Search result not found."),t.spinePosition)}.bind(this)};BIF.dispatch("bifocal:search:jump",{result:e,locus:t}),BIF.objects.compass.seek(t)||this._jumpError(e,"Search result not found.")},o._reqReady=function(e){var n=JSON.parse(e),r=0;t.each(n.chapters,function(e){r+=e.results.length}),n.range=[0,r],n.source="server",this._onResults(n)},o._onResults=function(e){if(!this._.activeSearch)return;t.each(e.chapters,function(n){var r=[];t.each(n.results,function(t){r.push(new i(e.query,t))},this),n.results=r},this),BIF.dispatch("bifocal:search:results",e);if(e.pending)return;(e.source=="server"||!this._.activeSearch.request||e.query.match(/^[\w- ]+$/)&&BIF.state.accessPercent===1)&&this._onComplete()},o._onComplete=function(){BIF.objects.activity.record("search",{query:this._.activeSearch.query,resultCount:this._.activeSearch.resultCount,timestamp:t.epochSeconds()}),this._.activeSearch.spider.halted||this._.activeSearch.spider.halt(),this._.activeSearch.request&&this._.activeSearch.request.abort(),this._.activeSearch=null},o._reqFailed=function(e,t){if(!this._.activeSearch)return;this._.activeSearch.request=null,this._.activeSearch.spider.halted&&this._onComplete()},o._jumpError=function(e,t){console.warn("Search jump error:",t,e.query,e),BIF.dispatch("bifocal:notify:message",t)},o._onClear=function(){BIF.objects.stencil.remove("search-result"),this._cancelSearch()},o._cancelSearch=function(){this._.req&&(this._.req.abort(),this._.req=null)},s}),define("bifocal/themes/read/default/src/parts/panel_sch",["require","./panel_abstract","common","./spinner"],function(e){var t=e("./panel_abstract"),n=e("common"),r=e("./spinner"),i=t.new(),s=i.prototype;return s.TITLE="Search",s.ID="sch",s.PLACEHOLDER_TEXT="Find within this book...",s.BANK_KEY="search:recent",s.focus=function(){BIF.objects.keyManager&&BIF.objects.keyManager.disableKeyCmds(),this._.parts.searchInput.focus()},s.searchFor=function(e){this._resetResults(),this._.query=e,this._.parts.searchInput&&(this._.parts.searchInput.value=e),e.trim()&&this._addRecentSearch(e),this._.parts.spinner.spin(),BIF.objects.searchManager.searchFor(e),this._updateState()},s._innerLayout=function(e){var t=this._.parts;t.searchForm=n.element({tag:"form",parentNode:e,classes:"search-form"}),t.searchButton=n.element({parentNode:t.searchForm,classes:"search-button"}),t.searchSubmit=n.element({parentNode:t.searchButton,classes:"search-submit"}),BIF.objects.iconator.make("search",t.searchSubmit),BIF.events.onTap(t.searchSubmit,function(e){BIF.events.stop(e),setTimeout(this._submitSearch.bind(this),50)}.bind(this)),t.clearButton=n.element({parentNode:t.searchButton,classes:"search-clear"}),BIF.objects.iconator.make("search-reset",t.clearButton),BIF.events.onTap(t.clearButton,function(e){BIF.events.stop(e),setTimeout(function(){BIF.dispatch("bifocal:search:clear")},50)}.bind(this)),t.searchField=n.element({parentNode:t.searchForm,classes:"search-field"}),this._createSearchInput(),t.recent=n.element({parentNode:e,classes:"search-recent"}),t.output=n.element({parentNode:e,classes:"search-output"}),t.results=n.element({parentNode:t.output,classes:"search-results"}),t.message=n.element({parentNode:t.output,classes:"search-message"}),t.pending=n.element({parentNode:t.output,classes:"search-pending"}),t.spinner=r.install(t.pending).stop()},s._listen=function(){t.prototype._listen.call(this),BIF.listen(this._.parts.searchForm,"submit",this._submitSearch.bind(this)),BIF.listen("bifocal:search:results",this._onSearchResults.bind(this)),BIF.listen("bifocal:search:clear",this._onClearSearch.bind(this))},s._initialized=function(){this._loadRecentSearches(),this._populateRecentSearches()},s._submitSearch=function(e){e&&BIF.events.stop(e),this._.parts.searchInput.blur();var t=this._.parts.searchInput.value.trim();t&&this.searchFor(t)},s._onSearchResults=function(e){if(!e.m.range||!e.m.query)return this._resetWithMessage("Search server error.");if(!e.m.pending&&!e.m.range[1])return this._resetWithMessage("No matches.");e.m.skipped&&this._searchMessage(["Some parts of the book cannot be searched.","Check your network connection."].join("<br/>")),e.m.pending||this._.parts.spinner.stop(),this._.query=e.m.query;var t=e.m.chapters;e.m.range[0]||(this._.parts.results.innerHTML="",this._.parts.message.innerHTML="",this._.cursor=1);if(t&&t.length)for(var n=0,r=t.length;n<r;++n)this._addChapterList(t[n]);this._updateState()},s._searchMessage=function(e){this._.parts.message.innerHTML=e},s._resetWithMessage=function(e){this._resetResults(),this._searchMessage(e),this._updateState()},s._resetResults=function(){this._.parts.results.innerHTML="",this._.parts.message.innerHTML="",this._.parts.spinner.stop()},s._addChapterList=function(e){var t=n.element({tag:"h3",parentNode:this._.parts.results,classes:"search-chapter-title",html:e.chapter.match(/^\d+/)?"Chapter "+e.chapter:e.chapter}),r=n.element({tag:"ol",parentNode:this._.parts.results,classes:"search-chapter-results"});r.setAttribute("start",this._.cursor);for(var i=0,s=e.results.length;i<s;++i)e.results[i].query=this._.query,this._addResultToChapterList(r,e.results[i]),this._.cursor+=1},s._addResultToChapterList=function(e,t){var r=n.element({tag:"li",parentNode:e,classes:"search-result"});r.setAttribute("data-result-order",this._.cursor),t.reachable||(r.classList.add("inaccessible"),BIF.objects.iconator.make("lock",r)),n.element({tag:"p",parentNode:r,html:t.excerpt}),BIF.events.onTap(r,this._onTapResult.bind(this,t))},s._onTapResult=function(e){e.seek(),this._closePolitely()},s._updateState=function(){var e=document.activeElement===this._.parts.searchInput;this._.parts.body.classList[e?"add":"remove"]("search-focused");var t=this._.parts.spinner.isSpinning()||this._.parts.results.innerHTML||this._.parts.message.innerHTML;this._.parts.body.classList[t?"add":"remove"]("search-searched")},s._deferUpdateState=function(){setTimeout(this._updateState.bind(this),250)},s._onClearSearch=function(e){this._.query="",this._.parts.searchInput&&(this._.parts.searchInput.value=""),this._resetResults(),this._updateState()},s._onClose=function(){this._destroySearchInput(),setTimeout(this._createSearchInput.bind(this),0)},s._createSearchInput=function(){this._.parts.searchInput=n.element({parentNode:this._.parts.searchField,tag:"input",classes:"search-input",attributes:{type:"search",autocapitalize:"off",placeholder:this.PLACEHOLDER_TEXT,value:this._.query||""}}),BIF.listen(this._.parts.searchInput,"focus",this._updateState.bind(this)),BIF.listen(this._.parts.searchInput,"blur",this._deferUpdateState.bind(this))},s._destroySearchInput=function(){this._.parts.searchInput.blur(),this._.parts.searchField.removeChild(this._.parts.searchInput),delete this._.parts.searchInput},s._addRecentSearch=function(e){n.excise(this._.recentSearches,e),this._.recentSearches.splice(9),this._.recentSearches.unshift(e),this._saveRecentSearches(),this._populateRecentSearches()},s._populateRecentSearches=function(){this._.parts.recent.innerHTML="";if(!this._.recentSearches.length)return;n.each(this._.recentSearches,function(e){var t=n.element({parentNode:this._.parts.recent,classes:"search-recent-query",html:e});BIF.events.onTap(t,function(){this.searchFor(e)}.bind(this))},this);var e=n.element({parentNode:this._.parts.recent,classes:"search-recent-reset",html:"Clear recent searches"});BIF.events.onTap(e,this._resetRecentSearches.bind(this))},s._resetRecentSearches=function(){this._.recentSearches.splice(0),this._saveRecentSearches(),this._populateRecentSearches()},s._saveRecentSearches=function(){BIF.bank.title.set(this.BANK_KEY,this._.recentSearches)},s._loadRecentSearches=function(){return this._.recentSearches=BIF.bank.title.get(this.BANK_KEY)||[]},i}),define("bifocal/themes/read/default/src/parts/search_bar",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this._.parts=this._layout(e),this._listen()},r._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"search-bar-box disabled"}),n.query=t.element({parentNode:n.box,classes:"search-bar-query"}),n.queryIcon=BIF.objects.iconator.make("search",n.query),n.queryTerm=t.element({tag:"span",parentNode:n.query}),n.controls=t.element({parentNode:n.box,classes:"search-bar-controls"}),n.backButton=t.element({parentNode:n.controls,classes:"search-bar-dir-button search-bar-back-button"}),n.forwardButton=t.element({parentNode:n.controls,classes:"search-bar-dir-button search-bar-forward-button"}),n.stats=t.element({parentNode:n.controls,classes:"search-bar-stats",html:"<span>0</span> of <span>0</span>"}),n.clearButton=t.element({parentNode:n.box,classes:"search-bar-clear-button",html:"Clear"}),n},r._listen=function(){BIF.listen("bifocal:search:results",this._onResults.bind(this)),BIF.listen("bifocal:search:jump",this._onJump.bind(this)),BIF.listen("bifocal:place",this._onPlace.bind(this)),BIF.listen("bifocal:search:clear",this._onClear.bind(this)),BIF.events.onTap(this._.parts.query,this._showPanel.bind(this)),BIF.events.onTap(this._.parts.backButton,this._back.bind(this)),BIF.events.onTap(this._.parts.forwardButton,this._forward.bind(this)),BIF.events.onTap(this._.parts.clearButton,this._clear.bind(this))},r._onResults=function(e){if(!e.m)return;this._.query=e.m.query;if(e.m.range[0]==0||!this._.results)this._.results=[];t.each(e.m.chapters,function(e){t.each(e.results,function(e){e.reachable&&this._.results.push(e)},this)},this),this._.parts.stats.lastChild.innerHTML=this._.results.length,this._.parts.queryTerm.innerHTML=this._.query;var n=this._.results.length==1?"add":"remove";this._.parts.box.classList[n]("solo")},r._onJump=function(e){var t=e.m.result;this._.place="pending",this._.cursor=this._.results.indexOf(t),this._.parts.stats.firstChild.innerHTML=this._.cursor+1,this._show()},r._onPlace=function(e){this._.place=="pending"?(this._.place=e.m.place,this._show()):this._.place&&(this._.place.overlaps(e.m.place)?this._show():this._hide())},r._onClear=function(){this._.place=null,this._hide()},r._show=function(){this._.showing||(this._.showing=!0,this._.parts.box.classList.remove("disabled"))},r._hide=function(){this._.showing&&(this._.showing=!1,this._.parts.box.classList.add("disabled"))},r._back=function(){var e=this._.cursor?this._.cursor-1:this._.results.length-1;this._goToResult(e)},r._forward=function(){var e=(this._.cursor+1)%this._.results.length;this._goToResult(e)},r._goToResult=function(e){typeof e=="number"&&(e=this._.results[e]),e.seek()},r._showPanel=function(){BIF.objects.panelSch.open()},r._clear=function(){BIF.dispatch("bifocal:search:clear")},n}),define("bifocal/themes/read/default/src/parts/search_context",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){this._.contextBar=e,this._.parts=this._layout(),this._listen(),this._.contextBar.addMenu("sch",this._.parts.button)},r._layout=function(){var e={};return e.button=t.element({classes:"context-button sch-context-button",html:"Search"}),e},r._listen=function(){BIF.listen("bifocal:selection",this._inspectSelection.bind(this)),BIF.events.onTap(this._.parts.button,this._searchForSelected.bind(this))},r._inspectSelection=function(e){e.m.text.length>36?this._.selectedText=e.m.text.substring(0,36).replace(/\s[^\s]+$/,""):this._.selectedText=e.m.text},r._searchForSelected=function(){this._search(this._.selectedText),BIF.dispatch("bifocal:pincer:reset")},r._search=function(e){BIF.objects.modality.closeIf("contexting"),BIF.objects.panelSch.open(),BIF.objects.panelSch.searchFor(e)},n}),define("bifocal/themes/read/default/src/features/search",["require","../parts/search_manager","../parts/panel_sch","../parts/search_bar","../parts/search_context"],function(e){return function(t){function n(){BIF.objects.panelSch.open()}return t.runSheet.append(["bifocal:reader:ready","loadSearchPanel"],["bifocal:reader:ready","loadSearchBar"],["bifocal:context:register","loadSearchContext"]),t.loadSearchPanel=function(){var t=e("../parts/search_manager");BIF.objects.searchManager=new t;var r=e("../parts/panel_sch");BIF.objects.panelSch=new r,BIF.objects.menuList.addPanel(BIF.objects.panelSch),BIF.objects.readHeader.menuBar.addShortcut("sch",n)},t.loadSearchBar=function(){var t=e("../parts/search_bar");BIF.objects.searchBar=new t(BIF.elements.controlFilm)},t.loadSearchContext=function(t){var n=e("../parts/search_context");setTimeout(function(){BIF.objects.searchContext=new n(t.m)},0)},!0}}),define("bifocal/themes/read/default/src/parts/panel_toc",["require","./panel_abstract","common","./menu_filter"],function(e){var t=e("./panel_abstract"),n=e("common"),r=e("./menu_filter"),i=t.new(),s=i.prototype;return s.TITLE="Chapters",s.ID="toc",s.SUB_LEVEL_PAD_PX=10,s.NO_CHAPTERS_APOLOGY=['<div class="panel-toc-empty">',"<p>","Unfortunately this book does not provide a table of contents.","</p><p>","Tap the center of the page and drag the seekometer to jump","through the&nbsp;book.","</p>","</div>"].join(" "),s._innerLayout=function(e){this._.list=n.element({parentNode:e,classes:"menu-filter-scroll-hider panel-toc-list"}),this._.list.innerHTML=this.NO_CHAPTERS_APOLOGY,this._.rows=[]},s._listen=function(){BIF.listen("bifocal:chapters",this._onChapters.bind(this)),BIF.listen("bifocal:place",this._onPlace.bind(this)),t.prototype._listen.call(this)},s._onOpen=function(){this._refresh(),this._scrollPresentChapterIntoView(),this._.filter&&this._.filter.hide()},s._refresh=function(){if(this._.pendingChapters&&this._.pendingChapters.length){this._.rows.length||(this._.list.innerHTML="",this._.filter=new r(this._.list),this._.filter._createSearchInput());var e=this._.pendingChapters[0];while(e)this._buildOrUpdateEntry(e),e=e.next;this._.activeChapters=this._.pendingChapters,this._.pendingChapters=null,this._.filter.update()}this._updatePresentChapter()},s._onChapters=function(e){this._.pendingChapters=e.m.chapters,this.isOpen()&&this._refresh()},s._onPlace=function(e){e.m.place.chapter&&(this._.presentChapterIndex=e.m.place.chapter.index)},s._buildOrUpdateEntry=function(e){this._.rows[e.index]?this._updateEntry(e,this._.rows[e.index]):this._buildEntry(e)},s._updateEntry=function(e,t){this._updatePosition(e,t)?t.handler?t.handler.listen():t.handler=BIF.events.onTap(t.box,this._onTapRow.bind(this)):t.handler&&t.handler.deafen()},s._buildEntry=function(e){var t={};return t.rail=n.element({parentNode:this._.list,classes:"menu-panel-rail"}),t.box=n.element({parentNode:t.rail,classes:"menu-panel-row panel-toc-chapter",attributes:{"data-chapter-index":e.index}}),t.title=n.element({parentNode:t.box,classes:"panel-toc-chapter-title",html:this._chapterTitle(e)}),t.title.style.paddingLeft=e.level*this.SUB_LEVEL_PAD_PX+"px",t.posBox=n.element({parentNode:t.box,classes:"panel-toc-chapter-pos-box"}),this._updateEntry(e,t),this._.rows[e.index]=t},s._updatePresentChapter=function(){var e="panel-toc-chapter-active";this._.presentChapterRow&&this._.presentChapterRow.classList.remove(e);var t='[data-chapter-index="'+this._.presentChapterIndex+'"]';this._.presentChapterRow=this._.list.querySelector(t),this._.presentChapterRow&&this._.presentChapterRow.classList.add(e)},s._scrollPresentChapterIntoView=function(){var e=this._.presentChapterRow;if(!e)return;var t=this._.list.parentNode,n=t.scrollTop+t.clientHeight;if(e.offsetTop<t.scrollTop||e.offsetTop+e.offsetHeight>n){var r=e.offsetTop-(t.clientHeight/2-e.offsetHeight);t.scrollTop=Math.max(0,r)}},s._onTapRow=function(e){var t=parseFloat(e.tappedElement.getAttribute("data-chapter-index")),n=this._.activeChapters[0];while(n){if(n.index==t)break;n=n.next}n&&this._seekToChapter(n)?(this._.presentChapterIndex=t,this._updatePresentChapter(),this._closePolitely()):console.warn("Chapter place is not yet seekable. Wait for pagination!")},s._chapterTitle=function(e){var t=e.title;return(t.match(/ /g)||[]).length>2&&(t=t.replace(/\s([^\s<]{0,10})\s*$/,"&nbsp;$1")),t},s._updatePosition=function(e,t){return e.path?(t.box.classList.remove("panel-toc-inaccessible"),t.posBox.innerHTML=e.place.toHumanString()||" â¢ ",!0):(t.box.classList.add("panel-toc-inaccessible"),t.posBox.innerHTML="",BIF.objects.iconator.make("lock",t.posBox),!1)},s._seekToChapter=function(e){if(e.place.isSeekable())return e.place.seek(),!0},i}),define("bifocal/themes/read/default/src/features/table_of_contents",["require","../parts/panel_toc"],function(e){return function(t){return t.runSheet.append(["bifocal:reader:ready","loadTableOfContents"]),t.loadTableOfContents=function(){var t=e("../parts/panel_toc");BIF.objects.panelToc=new t,BIF.objects.menuList.addPanel(BIF.objects.panelToc)},!0}}),define("bifocal/themes/read/default/src/parts/highlight_context",["require","common","./mark_highlight"],function(e){var t=e("common"),n=e("./mark_highlight"),r=function(e){function u(){BIF.listen("bifocal:selection",a),BIF.listen("bifocal:highlight:active",f),BIF.listen("bifocal:contexting:close",l),BIF.listen("bifocal:contexting:close",E),o.hl_colors={},t.each(n.prototype.COLOR_GROUPS,function(e,t){o.hl_colors[t]=e}),o.button=t.element({classes:"context-button highlight-context-button",html:"Highlight"}),BIF.events.onTap(o.button,c),o.menu=t.element({classes:"highlight-context-menu"}),o.info=t.element({classes:"highlight-context-info"}),o.circles=t.element({parentNode:o.menu,classes:"highlight-circles"}),o.doneButton=t.element({parentNode:o.circles,classes:"context-button note-done-button",html:"Done"}),BIF.events.onTap(o.doneButton,x);var e="highlight-button highlight-color-button";o.colorYBtn=t.element({parentNode:o.circles,classes:e+" color-y-button"}),t.DataClass.set(o.colorYBtn,"highlight-color","Y"),BIF.events.onTap(o.colorYBtn,v("Y")),o.colorRBtn=t.element({parentNode:o.circles,classes:e+" color-r-button"}),t.DataClass.set(o.colorRBtn,"highlight-color","R"),BIF.events.onTap(o.colorRBtn,v("R")),o.colorGBtn=t.element({parentNode:o.circles,classes:e+" color-g-button"}),t.DataClass.set(o.colorGBtn,"highlight-color","G"),BIF.events.onTap(o.colorGBtn,v("G")),o.noteBtn=t.element({parentNode:o.circles,classes:"context-button note-button",html:"Note"}),BIF.events.onTap(o.noteBtn,p),o.noteArea=t.element({tag:"textarea",parentNode:o.info,classes:"note-area"}),o.noteArea.setAttribute("placeholder","Enter a note..."),d(s.DEFAULT_COLOR),o.contextBar.addMenu("highlight",o.button,o.menu,o.info)}function a(e){o.lastSelection=e.m}function f(e){o.highlight=e.m.mark;var t=o.highlight.meta();t.note?(o.noteArea.value=t.note,T()):N(),o.contextBar.setPositionNear(o.highlight._.range),d(t.colorGroup)}function l(e){o.highlight&&(o.highlight.setNote(o.noteArea.value),o.highlight=null,o.noteArea.blur(),o.noting=!1)}function c(e){BIF.events.stop(e),BIF.dispatch("bifocal:pincer:reset");var t={selection:o.lastSelection,color:o.hl_colors[o.color]};BIF.dispatch("bifocal:selection:highlighted",t)}function h(){o.highlight.collection.perform("delete",{uuid:o.highlight.uuid}),x()}function p(){o.noting?setTimeout(m,s.CONFIRM_DELAY):(T(),o.noteArea.focus())}function d(e){o.color=e,t.DataClass.set(o.circles,"active-highlight-color",e)}function v(e){return function(){o.color==e?setTimeout(g,s.CONFIRM_DELAY):(d(e),o.highlight.setColor(o.hl_colors[o.color]))}}function m(){y()?b():w("Delete note text?",b)}function g(){y()?h():w("Delete note text and highlight?",h)}function y(){return!o.noting||o.noteArea.value.match(/^\s*$/)}function b(){N(),o.highlight.setNote(null)}function w(e,n){o.noteArea.blur(),o.menu.classList.add("asking"),o.conf=t.element({parentNode:o.info,classes:"highlight-context-confirm"});var r=t.element({parentNode:o.conf}),i=t.element({tag:"p",parentNode:r,html:e}),s=t.element({tag:"button",parentNode:r,html:"Yes"}),u=t.element({tag:"button",parentNode:r,html:"No"});BIF.events.onTap(s,function(){E(),n()}),BIF.events.onTap(u,E)}function E(){o.conf&&(o.menu.classList.remove("asking"),o.conf.parentNode.removeChild(o.conf),delete o.conf)}function S(){o.noting=!1,o.contextBar.open("highlight")}function x(){o.contextBar.close()}function T(){o.noting=!0,o.contextBar.expand("highlight")}function N(){S(),o.noteArea.value="",o.noteArea.blur()}var i={constructor:r},s=i.constants=i.constructor,o=i.properties={contextBar:e};return u(),i};return r.DEFAULT_COLOR="Y",r.CONFIRM_DELAY=20,r}),define("bifocal/themes/read/default/src/features/highlights",["require","common","./marks","./context_bar","../parts/highlight_context"],function(e){var t=e("common");return function(t){return!t.addFeature(e("./marks"))||!t.addFeature(e("./context_bar"))?!1:(t.runSheet.append(["bifocal:context:register","loadHighlightContext"]),t.loadHighlightContext=function(t){var n=e("../parts/highlight_context");BIF.objects.highlightContext=new n(t.m)},!0)}}),define("bifocal/themes/read/default/src/parts/audio/quirks",["require","../quirks"],function(e){var t=e("../quirks");return t.add("audio-incompatible","android-stock","iexplore<11"),t.add("audio-context-breaks-media-elements","safari !ios","gecko","iexplore","chrome","edge"),t.add("audio-unlock-on-interaction","ios","android-chrome"),t.add("audio-recycle-media-elements","ios","android-chrome"),t.add("audio-requires-audio-buffers","ios","android-chrome","chrome<48"),t.add("audio-playback-rate-unavailable","ios webkit<600 !quirk:audio-requires-audio-buffers","android-chrome chrome<51 !quirk:audio-requires-audio-buffers"),t.add("audio-highlights-must-force-repaint","chrome macosx","chrome windows"),t.add("cors-required-for-webaudio","gecko"),t.add("audio-reload-on-load-problem","safari"),t}),function(e,t,n){function r(e){if(!e)return;e.setTargetAtTime||(e.setTargetAtTime=e.setTargetValueAtTime)}window.hasOwnProperty("webkitAudioContext")&&!window.hasOwnProperty("AudioContext")&&(window.AudioContext=webkitAudioContext,AudioContext.prototype.hasOwnProperty("createGain")||(AudioContext.prototype.createGain=AudioContext.prototype.createGainNode),AudioContext.prototype.hasOwnProperty("createDelay")||(AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode),AudioContext.prototype.hasOwnProperty("createScriptProcessor")||(AudioContext.prototype.createScriptProcessor=AudioContext.prototype.createJavaScriptNode),AudioContext.prototype.internal_createGain=AudioContext.prototype.createGain,AudioContext.prototype.createGain=function(){var e=this.internal_createGain();return r(e.gain),e},AudioContext.prototype.internal_createDelay=AudioContext.prototype.createDelay,AudioContext.prototype.createDelay=function(){var e=this.internal_createDelay();return r(e.delayTime),e},AudioContext.prototype.internal_createBufferSource=AudioContext.prototype.createBufferSource,AudioContext.prototype.createBufferSource=function(){var e=this.internal_createBufferSource();return e.start||(e.start=function(e,t,n){t||n?this.noteGrainOn(e,t,n):this.noteOn(e)}),e.stop||(e.stop=e.noteOff),r(e.playbackRate),e},AudioContext.prototype.internal_createDynamicsCompressor=AudioContext.prototype.createDynamicsCompressor,AudioContext.prototype.createDynamicsCompressor=function(){var e=this.internal_createDynamicsCompressor();return r(e.threshold),r(e.knee),r(e.ratio),r(e.reduction),r(e.attack),r(e.release),e},AudioContext.prototype.internal_createBiquadFilter=AudioContext.prototype.createBiquadFilter,AudioContext.prototype.createBiquadFilter=function(){var e=this.internal_createBiquadFilter();return r(e.frequency),r(e.detune),r(e.Q),r(e.gain),e},AudioContext.prototype.hasOwnProperty("createOscillator")&&(AudioContext.prototype.internal_createOscillator=AudioContext.prototype.createOscillator,AudioContext.prototype.createOscillator=function(){var e=this.internal_createOscillator();return e.start||(e.start=e.noteOn),e.stop||(e.stop=e.noteOff),r(e.frequency),r(e.detune),e}))}(window),define("bifocal/themes/read/default/src/ext/audio_context_shim",function(){}),define("bifocal/themes/read/default/src/parts/audio/audio_proxy_buffer",["require","common","./quirks","dervish/src/urls"],function(e){var t=e("common"),n=e("./quirks"),r=e("dervish/src/urls"),i=t.Class.new(),s=i.prototype;return s.$init=function(e){this._.stage=e,this._.callbacks={},this._.seeking=!1,this._.playing=!1,this._.stamp=null,this._.playbackRate=1,this._.currentTimeAtStamp=0,this._.pollRequest=null,this._.pollFunction=this._pollPosition.bind(this)},s.setPlaybackRate=function(e){this._.sound&&this._stamp(t.epochMilliseconds()),typeof e=="number"&&(this._.playbackRate=e);if(this._.stage.pitchShift){var n=1-Math.max(0,Math.min(2,this._.playbackRate));this._.stage.pitchShift.transpose=12*n}this._.sound&&(this._.sound.playbackRate.value=this._.playbackRate)},s.play=function(){this._.playing=!0,this._.loadRequest?console.warn("[APB] not ready to play"):this._startSound()},s.pause=function(){this._.playing=!1,this._stopSound()},s.position=function(){return this._currentTime()*1e3},s.seek=function(e,t){this._stamp(null),this._.currentTimeAtStamp=t/1e3,this._stopSound(),e!=this._.mediaPath?(this._.seeking=!0,this._load(e),this._reportPosition()):this._.playing?this._startSound():this._reportPosition()},s.on=function(e){this._.callbacks.position=e.position,this._.callbacks.ended=e.ended,this._.callbacks.error=e.error},s.hangup=function(){this._.loadRequest&&(this._.loadRequest.abort(),delete this._.loadRequest),this._.callbacks.position=null,this._.callbacks.ended=null,this._.callbacks.error=null},s._load=function(e){r.toSrcCORS(e,function(t){this._.mediaPath=e,this._.mediaSource=t,this._.loadRequest=new XMLHttpRequest,BIF.listen(this._.loadRequest,"load",this._onFetched.bind(this)),BIF.listen(this._.loadRequest,"error",this._onFetchError.bind(this)),this._.loadRequest.responseType="arraybuffer",this._.loadRequest.open("GET",this._.mediaSource,!0),this._.loadRequest.send()}.bind(this))},s._onFetchError=function(e){var t={request:this._.loadRequest,error:e};console.warn("[APB] ERR (FETCH): %s",this._.mediaPath,t),this._.callbacks.error&&this._.callbacks.error(t)},s._onFetched=function(e){this._.stage.context.decodeAudioData(this._.loadRequest.response,this._onDecoded.bind(this),this._onDecodeError.bind(this))},s._onDecoded=function(e){this._.buffer=e,this._onReady()},s._onDecodeError=function(e){var t={response:this._.loadRequest.response,error:e};console.warn("[APB] ERR (DECODE): %s",this._.mediaPath,t),BIF.objects.audioManager.compatibilityError(),this._.callbacks.error&&this._.callbacks.error(t),delete this._.loadRequest},s._onReady=function(){delete this._.loadRequest,this._.seeking=!1,this._.playing?this._startSound():this._reportPosition()},s._startSound=function(){this._.sound&&this._stopSound(),this._stamp(t.epochMilliseconds()),this._.sound=this._.stage.context.createBufferSource(),this._.sound.buffer=this._.buffer,this._.sound.connect(this._.stage.entry),this._.sound.onended=this._onEnded.bind(this),this._.sound.playbackRate.value=this._.playbackRate,this._.sound.start(0,this._currentTime()),this._.pollFunction()},s._stopSound=function(){if(!this._.sound)return;this._stamp(null),this._.sound.onended=null,this._.sound.stop(0),this._.sound=null},s._currentTime=function(){var e=0;if(typeof this._.stamp=="number"){var n=t.epochMilliseconds()-this._.stamp;e=n*this._.playbackRate/1e3}return this._.currentTimeAtStamp+e},s._stamp=function(e){this._.currentTimeAtStamp=this._currentTime(),this._.stamp=e},s._pollPosition=function(e){this._.sound?(this._reportPosition(),this._.pollRequest=requestAnimationFrame(this._.pollFunction)):this._.pollRequest=null},s._reportPosition=function(){this._.callbacks.position&&this._.callbacks.position({playing:this._.playing,seeking:this._.seeking,path:this._.mediaPath,ms:this.position()})},s._onEnded=function(){this._.callbacks.ended&&this._.callbacks.ended({ms:this.position()}),this._.sound=null},i}),define("bifocal/themes/read/default/src/parts/audio/audio_proxy_element",["require","common","./quirks","dervish/src/urls"],function(e){var t=e("common"),n=e("./quirks"),r=e("dervish/src/urls"),i=t.Class.new(),s=i.prototype;return s.APPLY_PBR_DELAY_MS=200,s.MAX_LOAD_ATTEMPTS=5,s.$init=function(e,t){this._.stage=e,this._.seeking=!1,this._.playing=!1,this._.callbacks={},this._.loadAttempts=0,t&&(this._.pollFn=this._pollPosition.bind(this))},s.setPlaybackRate=function(e){this._.playbackRate=e||1,this._.element&&this._applyPlaybackRate()},s.play=function(){this._.element&&this._.element.play(),this._.playing=!0,this._reportPosition()},s.pause=function(){this._.element&&!this._.element.paused&&this._.element.pause(),this._.playing=!1,this._reportPosition()},s.position=function(){var e=this._.element;return this._.seeking?this._.seekTime*1e3:this._.ended?(e?e.duration*1e3:0)||this._.lastPosition:this._.lastPosition=e?e.currentTime*1e3:0},s.seek=function(e,t){if(!isFinite(t))return console.error("[APE] refusing to seek to ",t);this._.ended=!1,this._.seeking=!0,this._.seekTime=t/1e3,e!=this._.mediaPath?this._load(e):this._atSoughtTime()?(console.log("[APE] SEEK to %o ... and already here.",this._.seekTime),this._.seeking=!1):(console.log("[APE] SEEK to %o ... underway.",this._.seekTime),this._.element.currentTime=this._.seekTime,this._checkForTimeMismatch()),this._reportPosition()},s.on=function(e){this._.callbacks.position=e.position,this._.callbacks.ended=e.ended,this._.callbacks.error=e.error},s.hangup=function(){this._.callbacks.position=null,this._.callbacks.ended=null,this._.callbacks.error=null},s._spawnElement=function(){return this._.element=new Audio(this._.mediaSource),n("cors-required-for-webaudio")&&(this._.element.crossOrigin="anonymous"),this._.element.webkitPreservesPitch=!0,this._.element.mozPreservesPitch=!0,this.mediaListen("error",this._onError),this.mediaListen("loadedmetadata",this._onLoadedMetadata),this.mediaListen("canplay",this._onSeeked),this.mediaListen("seeked",this._onSeeked),this.mediaListen("playing",this._onPlaying),this.mediaListen("pause",this._onPause),this.mediaListen("ended",this._onEnded),this._.stage&&(this._.mes=this._.stage.context.createMediaElementSource(this._.element),this._.mes.connect(this._.stage.entry)),this._.element},s._load=function(e){r.toSrcMedia(e,function(t){this._.mediaPath=e,this._.mediaSource=t,this._reload(this._.element)}.bind(this))},s._reload=function(e){this._.loadAttempts+=1,this._.element=e||this._spawnElement(),this._.element.pause(),this._.element.setAttribute("src",this._.mediaSource),this._.element.load()},s._atSoughtTime=function(){return Math.abs(this._.element.currentTime-this._.seekTime)<=.1},s._applyPlaybackRate=function(){if(!isFinite(this._.playbackRate))return;if(this._.playbackRate==this._.element.playbackRate)return;this._.element.playbackRate=this._.playbackRate,this._reportPosition(),clearTimeout(this._.applyPBRTimer),this._.applyPBRTimer=setTimeout(this._applyPlaybackRate.bind(this),this.APPLY_PBR_DELAY_MS)},s._onLoadedMetadata=function(e){this.seek(this._.mediaPath,this._.seekTime*1e3),this.setPlaybackRate(this._.playbackRate)},s._onError=function(e){console.warn("[APE] ERR: %s",this._.mediaPath,this._.element.error),BIF.objects.audioManager&&BIF.objects.audioManager.compatibilityError(),this._.mediaPath=null,this._.mediaSource=null,this._.callbacks.error&&this._.callbacks.error({error:this._.element.error})},s._onSeeked=function(){this._.seeking&&(this._.seeking=!1,this._reportPosition()),this._.playing&&this._.element.paused&&this._.element.play()},s._onPlaying=function(){this._.playing=!0,this._.pollFn?this._.pollFn():this.mediaListen("timeupdate",function(){this._reportPosition()}.bind(this)),this.mediaDeafen("waiting"),this._reportPosition()},s._pollPosition=function(){this._reportPosition(),cancelAnimationFrame(this._.pollFn.request),this._.pollFn.request=requestAnimationFrame(this._.pollFn)},s._reportPosition=function(){this._.callbacks.position&&this._.callbacks.position({playing:this._.playing,seeking:this._.seeking,path:this._.mediaPath,ms:this.position()})},s._onPause=function(e){this._.pollFn&&cancelAnimationFrame(this._.pollFn.request)},s._onEnded=function(e){this._.ended=!1,this._.element.pause(),this._.callbacks.ended&&this._.callbacks.ended({path:this._.mediaPath,ms:this.position()}),this._.pollFn&&cancelAnimationFrame(this._.pollRequest)},s._checkForTimeMismatch=function(){this._atSoughtTime()||console.warn("[APE] currentTime mismatch. Is the server honoring byte-range requests?[Path:%s | Expected:%s | Actual:%s]",this._.mediaPath,this._.seekTime,this._.element.currentTime)},s._listenForAnyAudioEvents=function(e){var t=function(e){console.log("[APE] EVT: %s",this._.mediaPath,e.type)}.bind(this),n=["abort","canplay","canplaythrough","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","mozaudioavailable","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"];for(var r=0,i=n.length;r<i;++r)BIF.listen(e,n[r],t)},s.mediaListen=function(e,t){this.mediaDeafen(e),this._.bindings[e]=t.bind(this),BIF.listen(this._.element,e,this._.bindings[e])},s.mediaDeafen=function(e){this._.bindings=this._.bindings||{},this._.bindings[e]&&BIF.deafen(this._.element,e,this._.bindings[e])},i}),define("bifocal/themes/read/default/src/parts/audio/audio_sprite",["require","common","./quirks","./audio_proxy_buffer","./audio_proxy_element"],function(e){var t=e("common"),n=e("./quirks"),r=e("./audio_proxy_buffer"),i=e("./audio_proxy_element"),s=t.Class.new(),o=s.prototype;return s.collection={},s.newAudioProxy=function(e){if(n("audio-requires-audio-buffers"))return new r(e);if(this._recycledProxyElement)return this._recycledProxyElement;var t=new i(e,!0);return n("audio-recycle-media-elements")&&(this_recycledProxyElement=t),t},s.find=function(e,t){return s.collection[e]||new s(e,t)},o.$init=function(e,t){this.resourcePath=e,this.mediaPath=t,this._.playbackPositionMS=0,this._.triggers=[],s.collection[this.resourcePath]=this},o.setStage=function(e){this._.stage=e,this._.audioProxy||(this._.audioProxy=s.newAudioProxy(e)),this._.audioProxy.on({position:this._onPosition.bind(this),ended:this._onEnded.bind(this)})},o.load=function(e){this.loaded?e():(this._.onLoadedCallback=e,this.seek(this._.playbackPositionMS))},o.configure=function(e){typeof e.playbackRate=="number"&&this._.audioProxy.setPlaybackRate(e.playbackRate)},o.at=function(e,t){this._.triggers.push({offsetMS:e,callback:t}),this._.triggers.sort(function(e,t){return e.offsetMS-t.offsetMS}),this._checkTriggers(this._.playbackPositionMS)},o.clear=function(){this._.triggers=[]},o.seek=function(e){this._.audioProxy.seek(this.mediaPath,e),this._.playbackPositionMS=e},o.play=function(){this._.playing||(this._.playing=!0,this._.audioProxy.play())},o.stop=function(){this._.playing&&(this._.audioProxy.pause(),this._.playing=!1)},o.reset=function(){this.stop(),this.clear(),this._.audioProxy.hangup()},o._onPosition=function(e){!e.seeking&&!this.loaded&&(this.loaded=!0,this._.onLoadedCallback&&(this._.onLoadedCallback(),delete this._.onLoadedCallback)),e.playing&&(this._.playing?(this._.playbackPositionMS=e.ms,this._checkTriggers(this._.playbackPositionMS)):console.warn("[AUD] notified of position when not playing!"))},o._onEnded=function(e){this._.playing?(this._.playbackPositionMS=e.ms,this._checkTriggers(Infinity)):console.warn("[AUD] notified of end when not playing!")},o._checkTriggers=function(e){var t=this._.triggers;while(t===this._.triggers&&t[0]&&t[0].offsetMS<=e)t.shift().callback(this.mediaPath,this._.playbackPositionMS)},s}),define("bifocal/themes/read/default/src/parts/audio/audio_range",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e,t,n,r){this.clip=e,this.rectangles=t,this.begin=n,this.end=r,this.next=null},r.summonIntoPortal=function(){if(!this.isVisible()){var e=BIF.context.spool.rectangleToFloc(this.clip.overlay.component,this.rectangles[0]);this.clip.overlay.speechtrack.turn(e)}},r.isVisible=function(){if(BIF.objects.modality.is("zooming"))return!0;var e=BIF.context.spool,t=this.clip.overlay.component,n=this.rectangles[0];if(t.block.layout!=="reflowable")return e.focus===t||e._.headFocus===t;if(n){var r=t.metrics.heads.virtual-e.cursor.virtual,i=r+n.left+n.width*.5;return i>=0&&i<e.aperture}return!0},n}),define("bifocal/themes/read/default/src/parts/audio/audio_clip",["require","common","./audio_range"],function(e){var t=e("common"),n=e("./audio_range"),r=t.Class.new(),i=r.prototype;return i.$init=function(e,t){this._.data=t,this.overlay=e,this.id=this.overlay.component.index+"-"+this._.data.selector,this.resourcePath=this._.data.filepath,this.mediaPath=this._.data.src.replace(/^https?:/,""),this.ranges=[]},i.element=function(){var e=this._.data.selector;try{var t=this.overlay.component.frameBox.contentDocument;return t.querySelector(e)}catch(n){}console.warn("[AUD] WARN: no element for %s",e)},i.generateRanges=function(){if(this.overlay.component.block.layout!="reflowable"){if(!this.ranges.length){var e=this.element(),t=e?e.getClientRects():[];this.ranges=[new n(this,t,this._.data.begin,this._.data.end)]}}else console.error("[AUD] AudioClip not yet implemented for reflowables")},r}),define("bifocal/themes/read/default/src/parts/audio/audio_overlay",["require","common","./audio_sprite","./audio_clip"],function(e){var t=e("common"),n=e("./audio_sprite"),r=e("./audio_clip"),i=t.Class.new(),s=i.prototype;return s.BLANK_PAGE_DELAY=3e3,s.EPSILON=500,s.$init=function(e,t,n){this.speechtrack=e,this.component=t,this._.state={},this._.clipSrc=n,this._.clips=this._.clipSrc?null:[],this._.loadSettings={},BIF.listen("bifocal:audio:playbackrate",this._onPlaybackRate.bind(this)),BIF.listen("lens:component:visible",this._onComponentVisible.bind(this))},s.load=function(e){this._loadPoint("overlay-loading"),e&&t.absorb(e,this._.loadSettings),this._.loadSettings.loaded?this._onClipsReady():this._whenComponentIsLoaded(this._fetchClips.bind(this,this._.clipSrc))},s.play=function(){this._whenComponentIsLoaded(function(){this._.clips!==null?(!this._.clips.length&&!this._.emptyLoadPoint&&(this._loadPoint("empty-overlay"),this._.emptyLoadPoint=!0),this.enableHotspots(),this._continue()||this._findNewPosition()):this.load({play:!0})}.bind(this))},s.keepPlaying=function(){this._.clips!==null&&this._findSamePosition()},s.pause=function(){this._.state.sprite&&this._.state.sprite.stop(),this.speechtrack.unhighlight(!0),this._stopCountdown(),this._.loadSettings.play&&(this._.loadSettings.play=!1)},s.stop=function(){this._.state.sprite&&this._.state.sprite.reset(),this.speechtrack.unhighlight(!0),this._stopCountdown(),this._.loadSettings={},this._.state={}},s.enableHotspots=function(){this._whenComponentIsLoaded(function(){if(this._.hotspots)return;if(this._.clips===null)return this.load({hotspots:!0});this._.hotspots=!0,t.each(this._.clips,function(e){var t=e.element();if(t&&e.ranges[0]){var n=t.ownerDocument.createRange();n.selectNodeContents(t),BIF.objects.stencil.add("audio-hotspot-"+e.id,n,{className:this.speechtrack.HOTSPOT_CLASS,priority:2,tap:function(){this._playRange(e.ranges[0])}.bind(this)})}},this)}.bind(this))},s.disableHotspots=function(){delete this._.loadSettings.hotspots,this._.hotspots&&(this._.hotspots=!1,t.each(this._.clips,function(e){BIF.objects.stencil.remove("audio-hotspot-"+e.id)}))},s.isBlank=function(){var e=this._firstRange();while(e){if(e.isVisible())return!1;e=e.next}return!0},s._whenComponentIsLoaded=function(e){this.component.isLoaded()?e():this._.componentLoadedCallback=e},s._onComponentVisible=function(e){if(e.m.component.index!=this.component.index)return;var t=this._.componentLoadedCallback;this._.componentLoadedCallback=null,t&&t()},s._playRange=function(e){this.speechtrack.nowPlaying(this),this._.state.range=e,this._.state.clip=e.clip;var t=this._.state.sprite;!t||t.resourcePath!=e.clip.resourcePath?this._loadSprite(e):this._onSpriteReady(this.EPSILON)},s._loadSprite=function(e){this._.state.sprite&&this._.state.sprite.reset();var t=this._.state.sprite=n.find(e.clip.resourcePath,e.clip.mediaPath);return t.setStage(this.speechtrack.stage),t.configure({playbackRate:this.speechtrack.playbackRate}),this._loadPoint("loading-sprite"),t.load(function(){this._loadPoint("loaded-sprite"),this._onSpriteReady(this.EPSILON)}.bind(this)),t},s._onSpriteReady=function(e){var t=this._.state.sprite,n=this._.state.range,r=Math.abs(n.begin-t._.playbackPositionMS);(typeof e!="number"||r>e)&&t.seek(n.begin),this._continue()},s._continue=function(){var e=this._.state.sprite,t=this._.state.range;if(e&&t)return e.clear(),e.at(t.begin,this._onRangeStart.bind(this)),e.at(t.end,this._onRangeEnd.bind(this)),e.play(),!0},s._onRangeStart=function(){this.speechtrack.highlight(this._.state.clip.element()),this._.state.range.summonIntoPortal()},s._onRangeEnd=function(){this._.state.range.next?this._playRange(this._.state.range.next):this._handover()},s._findSamePosition=function(){if(!this._.state.sprite||!this._.state.clip)return this._findNewPosition();var e=this._.state.sprite._.playbackPositionMS,t=this._firstRange();while(t){if(t.clip===this._.state.clip)if(t.begin<=e||t.end>=e)return this._.state.range=t,this._continue();t=t.next}console.warn("[AUD] Could not find same position!"),this._findNewPosition()},s._findNewPosition=function(){var e=this._firstRange();while(e){if(e.isVisible())return this._playRange(e);e=e.next}this._onBlankPage()},s._onBlankPage=function(){var e=this._isEndOfBlankSpread()&&this.component.next,t=e?this.BLANK_PAGE_DELAY:0;this._.turnTimer||(this._.turnTimer=setTimeout(this._handover.bind(this),t),BIF.dispatch("bifocal:audio:speechtrack:turning",t))},s._isEndOfBlankSpread=function(){var e=BIF.context.spool._.headFocus,t=BIF.context.spool.focus;if(e===t)return!0;if(e===this.component)return!1;if(!this.component.prev)return!0;var n=this.speechtrack._.overlays[this.component.prev.index];return!n||n.isBlank()},s._firstRange=function(){if(this._.clips[0])return this._.clips[0].ranges[0]},s._fetchClips=function(e){if(this._.clips&&!this._.clips.length)this._loadPoint("empty-overlay");else if(!this._.clipRequest){this._loadPoint("fetching-smil");var n=t.absoluteURL(e);this._.clipRequest=BIF.network.sendRequest(n,{accept:"application/json",success:this._prepareClips.bind(this)})}},s._prepareClips=function(e){this._loadPoint("parsing-smil"),this._.clips=[],t.each(JSON.parse(e),function(e){this._.clips.push(new r(this,e))},this),this._generateRanges(),this._onClipsReady()},s._onClipsReady=function(){var e=this._.loadSettings;this._.loadSettings={loaded:!0},e.hotspots&&this.enableHotspots(),e.play&&this.play()},s._generateRanges=function(){var e;t.each(this._.clips,function(t){t.generateRanges();if(e&&t.ranges[0]){var n=e.ranges[e.ranges.length-1];n.next=t.ranges[0]}e=t})},s._onPlaybackRate=function(e){this._.state.sprite&&this._.state.sprite.configure({playbackRate:e.m})},s._handover=function(){this._stopCountdown(),this.speechtrack.overlayComplete()},s._stopCountdown=function(){this._.turnTimer&&(BIF.dispatch("bifocal:audio:speechtrack:turning",0),clearTimeout(this._.turnTimer),this._.turnTimer=null)},s._loadPoint=function(e,t){t=t||0,this.speechtrack.updateLoadState(this,{"overlay-loading":.05,"fetching-smil":.1+t*.1,"parsing-smil":.2,"empty-overlay":1,"loading-sprite":.25+t*.75,"loaded-sprite":1}[e])},i}),define("bifocal/themes/read/default/src/parts/audio/audio_speechtrack",["require","common","./quirks","./audio_overlay"],function(e){var t=e("common"),n=e("./quirks"),r=e("./audio_overlay"),i=t.Class.new(),s=i.prototype;return s.ACTIVE_DOCUMENT_CLASS="-epub-media-overlay-playback-active",s.ACTIVE_ELEMENT_CLASS="-epub-media-overlay-active",s.ACTIVE_ELEMENT_RULES=["background: #FFC !important"].join(";"),s.DEFAULT_RATE=1,s.BANK_KEY_RATE="narration:pbr",s.$init=function(e){this._.manager=e,this._.overlay=null,this._.overlays=this._loadOverlays(),this._.state={present:!1,playing:!1,loading:!1,ended:!1},this._updateState({present:!0});var t=e.getContext();this.stage=t?this._setStage(t):null,this._loadSettings(),this._.zooming=0,BIF.listen("bifocal:place",this._onPageChange.bind(this)),BIF.listen("bifocal:audio:playbackrate",this._onPlaybackRate.bind(this)),BIF.listen("bifocal:modality:transition",this._onModality.bind(this)),BIF.listen("bifocal:component:modify",this._onComponentModify.bind(this)),BIF.listen("lens:component:visible",this._onComponentVisible.bind(this))},s.play=function(){this._.manager.panderToMobileSafari(),this._.state.playing||(this._updateState({playing:!0}),this._updateHotspots(this._assembleHotspots(this._.overlay.component)),this._.overlay.play())},s.nowPlaying=function(e){this._.state.playing||this._updateState({playing:!0}),e!==this._.overlay&&(this._.overlay.stop(),this._.overlay=e,this._updateHotspots(this._assembleHotspots(e.component)))},s.pause=function(){this._.state.playing&&(this._.overlay.pause(),this._updateHotspots([])),this._updateState({playing:!1})},s.highlight=function(e){this._.activeElement!==e&&(this.unhighlight(e?!1:!0),this._.activeElement=e,this._.activeElement&&(this._addClass(this._.activeElement,this._activeElementClass()),this._.activeDocument!==e.ownerDocument.documentElement&&(this._removeClass(this._.activeDocument,this._activeDocumentClass()),this._.activeDocument=e.ownerDocument.documentElement,this._addClass(this._.activeDocument,this._activeDocumentClass()))))},s.unhighlight=function(e){if(this._.activeElement){if(n("audio-highlights-must-force-repaint")&&this._.overlay.component.block.layout!=="reflowable"){var t=this._.activeElement.ownerDocument.body;t.style.setProperty("display","none"),t.offsetHeight,t.style.removeProperty("display")}this._removeClass(this._.activeElement,this._activeElementClass()),this._.activeElement=null,e&&(this._removeClass(this._.activeDocument,this._activeDocumentClass()),this._.activeDocument=null)}},s.overlayComplete=function(){var e=this._.overlay.component.next;this._.overlay.stop(),e?(this.turn(e.index),this._switchComponentWhenReady(e)):(this.pause(),this._updateState({ended:!0}))},s.turn=function(e){this._beenZooming()||(this._.turning=!0,BIF.context.spool.seek(e,!0))},s.updateLoadState=function(e,t){if(e!=this._.overlay)return;this._updateState({loading:t||!1})},s._onPageChange=function(e){if(this._.state.playing){if(e.m.restored||e.m.repeated)return setTimeout(this._retainComponent.bind(this),0);if(this._beenZooming()&&this._inFocus(this._.overlay.component))return this._.zooming=0}this._movePlaybackToSpoolFocus()},s._movePlaybackToSpoolFocus=function(){var e=BIF.context.spool._.headFocus;this._.turning?this._.turning=null:e&&(this._switchComponent(e),this._updateState({ended:!1}))},s._retainComponent=function(){this._.state.playing&&this._.overlay.keepPlaying()},s._switchComponentWhenReady=function(e){e.isLoaded()?this._switchComponent(e):this._.waitingForComponentToSwitch=e},s._switchComponent=function(e){this._.overlay&&this._.overlay.stop(),this._.overlay=this._.overlays[e.index],this._.state.playing?(this._updateHotspots(this._assembleHotspots(e)),this._.overlay.play()):n("audio-unlock-on-interaction")&&this._.overlay.load()},s._assembleHotspots=function(e){var t=[this._.overlays[e.index]];return e.prev&&t.push(this._.overlays[e.prev.index]),e.next&&t.push(this._.overlays[e.next.index]),t},s._updateHotspots=function(e){t.each(this._.hotspotOverlays,function(t){e.indexOf(t)<0&&t.disableHotspots()}),this._.hotspotOverlays=e,t.each(this._.hotspotOverlays,function(e){e.enableHotspots()})},s._loadOverlays=function(){var e={};return BIF.context.spine.each(function(t){var n=BIF.map.spine[t.index]["audio-overlay"];e[t.index]=new r(this,t,n)},this),e},s._updateState=function(e){t.each(e,function(e,t){this._.state[e]=t},this),this._.manager.setState("speechtrack",this._.state)},s._addClass=function(e,t){if(!e||!t)return;if(e.classList)return e.classList.add(t);var n=e.getAttribute("class")||"";n.match(t)||e.setAttribute("class",n+" "+t)},s._removeClass=function(e,t){if(!e||!t)return;if(e.classList)return e.classList.remove(t);var n=e.getAttribute("class")||"";n.match(t)&&e.setAttribute("class",n.replace(t,""))},s._activeElementClass=function(){return BIF.map["audio-overlay-active-class"]||this.ACTIVE_ELEMENT_CLASS},s._activeDocumentClass=function(){return BIF.map["audio-overlay-playback-active-class"]||this.ACTIVE_DOCUMENT_CLASS},s._onComponentModify=function(e){this._prepareComponent(e.m.component)},s._onComponentVisible=function(e){if(this._.waitingForComponentToSwitch!=e.m.component)return;delete this._.waitingForComponentToSwitch,this._switchComponent(e.m.component)},s._prepareComponent=function(e){this._activeElementClass()===this.ACTIVE_ELEMENT_CLASS&&(this._componentHasStylesFor(e,this.ACTIVE_ELEMENT_CLASS)||e.stylizeContent("audio-overlay-active",["."+this.ACTIVE_ELEMENT_CLASS+" { "+this.ACTIVE_ELEMENT_RULES+" }"]))},s._componentHasStylesFor=function(e,t){var n=e.frameBox.contentDocument;for(var r=0,i=n.styleSheets.length;r<i;++r)if(this._stylesheetHasStylesFor(n.styleSheets[r],t))return!0},s._stylesheetHasStylesFor=function(e,t){for(var n=0,r=e.cssRules.length;n<r;++n)if(this._ruleHasStylesFor(e.cssRules[n],t))return!0},s._ruleHasStylesFor=function(e,t){var n=e.selectorText;if(e.selectorText)return e.selectorText.match("\\."+t);if(e.styleSheet)return this._stylesheetHasStylesFor(e.styleSheet,t)},s._setStage=function(e){var t={context:e};return t.gainNode=e.createGain(),t.exit=t.gainNode,t.entry=t.gainNode,t.exit.connect(e.destination),t},s._onPlaybackRate=function(e){this.playbackRate=e.m,this._saveSettings()},s._loadSettings=function(){this.playbackRate=parseFloat(BIF.bank.global.get(this.BANK_KEY_RATE)),isFinite(this.playbackRate)||(this.playbackRate=this.DEFAULT_RATE)},s._saveSettings=function(){BIF.bank.global.set(this.BANK_KEY_RATE,this.playbackRate),BIF.dispatch("bifocal:speechtrack:settings",{speechtrack:this})},s._beenZooming=function(){return this._.zooming===!0||Date.now()-this._.zooming<2e3},s._inFocus=function(e){var t=BIF.context.spool;return e===t.focus||e===t._.headFocus},s._onModality=function(e){e.m.to=="zooming"?this._.zooming=!0:this._.zooming&&(this._.zooming=Date.now())},i}),define("bifocal/themes/read/default/src/parts/audio/audio_soundtrack",["require","common"],function(e){var t=e("common"),n=function(e){function o(){if(s.context=s.manager.getContext())s.gainNode=s.context.createGain(),s.gainNode.connect(s.context.destination);BIF.listen("bifocal:component:active",u),BIF.listen("bifocal:audio:volume",p)}function u(e){var t=BIF.map.spine[e.m.component.index]["audio-soundtrack"];t?s.src!=t&&(c(),s.src=t,h({present:!0}),s.state.playing&&a()):(c(),h({present:!1,loading:!1,playing:!1}))}function a(){h({playing:!0}),s.manager.panderToMobileSafari(),s.buffer?(s.sound=s.manager.properties.context.createBufferSource(),s.sound.buffer=s.buffer,s.sound.connect(s.gainNode),s.sound.loop=!0,s.sound.start(0)):s.src&&(h({loading:!0}),s.manager.fetchBuffer(s.src,function(e){s.buffer=e,h({loading:!1}),s.state.playing&&a()}))}function f(){l(),h({playing:!1})}function l(){s.sound&&(s.sound.stop(0),s.sound.disconnect())}function c(){l(),s.sound=null,s.buffer=null,s.src=null}function h(e){t.each(e,function(e,t){s.state[e]=t}),s.manager.setState("soundtrack",s.state)}function p(e){d(e.m)}function d(e){s.gainNode&&(s.gainNode.gain.value=e*e*i.RELATIVE_VOLUME)}var r={constructor:n},i=r.constants=r.constructor,s=r.properties={manager:e,src:null,buffer:null,sound:null,sources:{},state:{present:!1,loading:!1,playing:!1}};return r.play=a,r.pause=f,o(),r};return n.RELATIVE_VOLUME=.25,n}),define("bifocal/themes/read/default/src/parts/audio/audio_manager",["require","../../ext/audio_context_shim","common","./quirks","./audio_speechtrack","./audio_soundtrack"],function(e){e("../../ext/audio_context_shim");var t=e("common"),n=e("./quirks"),r=e("./audio_speechtrack"),i=e("./audio_soundtrack"),s=function(){function a(){if(n("audio-incompatible"))return c("audio",{incompatible:!0});BIF.listen("bifocal:network",p),o.WEB_AUDIO_ENABLED&&(u.context=new AudioContext),u.speechtrack=new r(e),u.soundtrack=new i(e)}function f(){return u.context}function l(){return u.state}function c(e,n){var r=!1;t.each(n,function(t,n){u.state[e][t]!==n&&(u.state[e][t]=n,r=!0)}),(r||!0)&&h()}function h(){BIF.dispatch("bifocal:audio:state",l())}function p(e){e.m=="offline"?(u.speechtrack.pause(),u.soundtrack.pause(),c("audio",{offline:!0})):c("audio",{offline:!1})}function d(){BIF.bank.global.set(o.INCOMPAT_BANK_KEY,o.INCOMPAT_VERSION),u.speechtrack.pause(),u.soundtrack.pause(),c("audio",{incompatible:!0}),BIF.dispatch("bifocal:notify:dialog",{headingText:"Audio unavailable",promptText:"This browser is unable to play the audio in this book. You could try another browser."})}function v(){if(!u.context||!n("audio-unlock-on-interaction")||u.pandered)return;m(u.context),u.pandered=!0}function m(e){var t=[255,243,20,196,0,0,0,3,72,1,64,0,0,76,65,77,69,51,46,57,54,46,49,85,255,243,20,196,11,0,0,3,72,1,128,0,0,85,85,85,85,85,85,85,85,85,85,85],n=new ArrayBuffer(t.length),r=new Uint8Array(n);for(var i=0,s=t.length;i<s;++i)r[i]=t[i];try{e.createBuffer(n,!1)}catch(o){}var u=e.createBufferSource();u.connect(e.destination),u.start(0)}function g(){return e.constructor.hasOverlays()}var e={constructor:s},o=e.constants=e.constructor,u=e.properties={state:{audio:{},speechtrack:{},soundtrack:{}}};return e.getContext=f,e.getState=l,e.setState=c,e.compatibilityError=d,e.panderToMobileSafari=v,e.hasOverlays=g,a(),e};return s.hasOverlays=function(){for(var e=0,t=BIF.map.spine.length;e<t;++e)if(BIF.map.spine[e]["audio-overlay"])return!0;return!1},s.INCOMPAT_VERSION="1",s.INCOMPAT_BANK_KEY="audio:incompatible",s.WEB_AUDIO_ENABLED=typeof AudioContext!="undefined"&&(n("audio-requires-audio-buffers")||!n("audio-context-breaks-media-elements")),s}),define("bifocal/themes/read/default/src/parts/slider",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e,t,n,r){this._.parts=this._layout(e),this.notches(t),typeof n=="number"?this.setValue(n):this.setValue(this._.notchMax/2),this.onChange(r),this._listen()},r.notches=function(e){this._.parts.control.classList[e?"add":"remove"]("slider-notched"),this._.parts.notches.innerHTML="",this._.notchMax=Math.max(0,e-1);var n=100/e,r=100/this._.notchMax;for(var i=0;i<this._.notchMax;++i)t.element({parentNode:this._.parts.notches,attributes:{style:"width: "+n+"%"}});if(this._.notchMax)this._.parts.carriage.style.setProperty("width",100-n+"%"),this._.parts.needle.style.setProperty("width",r+"%");else{var s=24;this._.parts.carriage.style.setProperty("width","calc(100% - "+s+"px)"),this._.parts.needle.style.removeProperty("width")}},r.setValue=function(e){var t;this._.notchMax?(e=Math.max(0,Math.min(Math.round(e),this._.notchMax)),t=e/this._.notchMax):t=Math.max(0,Math.min(e,1)),this._moveNeedle(t)},r.onChange=function(e){this._.onChangeCallback=e},r._layout=function(e){var n={};return n.control=t.element({parentNode:e,classes:"slider-control"}),n.track=t.element({parentNode:n.control,classes:"slider-track"}),n.notches=t.element({parentNode:n.track,classes:"slider-notches"}),n.carriage=t.element({parentNode:n.track,classes:"slider-carriage"}),n.needle=t.element({parentNode:n.carriage,classes:"slider-needle"}),n},r._listen=function(){this._.handler=BIF.events.onContact(this._.parts.control,{start:this._onContactStart.bind(this),move:this._onContactMove.bind(this),end:this._onContactMove.bind(this)})},r._onContactStart=function(e){BIF.events.stop(e);var t=this._.parts.track.getBoundingClientRect();this._.dims={left:t.left,width:t.width}},r._onContactMove=function(e){BIF.events.stop(e);var t=e.pageX-this._.dims.left,n=Math.max(0,Math.min(t/this._.dims.width,1));this._moveNeedle(n)},r._moveNeedle=function(e){this._.notchMax&&(e=Math.round(this._.notchMax*e)/this._.notchMax);if(e!==this._.needlePercent){var n="translate3d("+e*100+"%,0,0)";t.prefixProperty(this._.parts.carriage.style,"transform",n);var r=typeof this._.needlePercent=="number";this._.needlePercent=e,r&&this._changed()}},r._changed=function(){if(typeof this._.onChangeCallback=="function"){var e=this._.needlePercent;this._.notchMax&&(e=Math.round(this._.notchMax*e)),this._.onChangeCallback(e)}},n}),define("bifocal/themes/read/default/src/parts/panel_nar",["require","./panel_abstract","common","./audio/quirks","../../../../read/default/src/parts/slider","dervish/src/urls"],function(e){var t=e("./panel_abstract"),n=e("common"),r=e("./audio/quirks"),i=e("../../../../read/default/src/parts/slider"),s=e("dervish/src/urls"),o=t.new(),u=o.prototype;return u.TITLE="Narration",u.ID="nar",u.PLAYBACK_RATE_LEVELS=[.6,.7,.8,.85,.9,.95,1,1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2,2.2,2.4,2.6,2.8,3],u.APOLOGIES={offline:"Audio playback is only available when you&nbsp;are&nbsp;online.",absent:"No audio track available for&nbsp;this&nbsp;chapter.",incompatible:["Audio playback is unavailable in this browser.",s.uilink("HELPAUD")?'<a href="'+s.uilink("HELPAUD")+'">Learn more.</a>':""].join(" ")},u._innerLayout=function(e){var t=this._.parts,i=BIF.objects.audioManager,s=i.getState();t.box=n.element({parentNode:e,classes:"nar-box"}),t.apology=n.element({parentNode:t.box,classes:"nar-apology"});if(s.audio.incompatible)this._apologize("incompatible");else{t.controls=n.element({parentNode:t.box,classes:"nar-controls"}),t.buttons=n.element({parentNode:t.controls,classes:"nar-buttons"}),t.soundtrackBtn=n.element({parentNode:t.buttons,classes:"nar-button nar-soundtrack-button"}),BIF.events.onTap(t.soundtrackBtn,this._toggleSoundtrack.bind(this)),t.speechtrackBtn=n.element({parentNode:t.buttons,classes:"nar-button nar-speechtrack-button"}),BIF.objects.iconator.make("nar",t.speechtrackBtn),BIF.events.onTap(t.speechtrackBtn,this._toggleSpeechtrack.bind(this));if(!r("audio-playback-rate-unavailable")){var o=i.properties.speechtrack.playbackRate;t.playbackRate=this._createSliderRow(t.controls,"Speed",this.PLAYBACK_RATE_LEVELS.indexOf(o),this.PLAYBACK_RATE_LEVELS.length,this._onPlaybackRateChange.bind(this),function(e){return e+"x"})}else t.playbackRate=this._createExplanationRow(t.table,"Speed",["Adjusting playback speed is not yet","supported by&nbsp;Android&nbsp;Chrome."].join(" "));BIF.listen("bifocal:audio:speechtrack:turning",this._onTurning.bind(this)),BIF.listen("bifocal:audio:state",this._onStateChange.bind(this)),this._onStateChange({m:s})}},u._toggleSpeechtrack=function(){var e=BIF.objects.audioManager,t=e.getState();t.speechtrack.present?t.speechtrack.playing?e.properties.speechtrack.pause():(e.properties.speechtrack.play(),BIF.objects.modality.close()):console.warn("[AUD] WARN: cannot toggle when speechtrack unavailable.")},u._toggleSoundtrack=function(){var e=BIF.objects.audioManager,t=e.getState();t.soundtrack.present?t.soundtrack.playing?e.properties.soundtrack.pause():e.properties.soundtrack.play():console.warn("[AUD] WARN: cannot toggle when soundtrack unavailable.")},u._onTurning=function(e){var t=e.m||0,n=function(){t-500>0?(this._.parts.box.setAttribute("data-countdown",Math.round(t/1e3)),this._.turnTimer=setTimeout(n,1e3),t-=1e3):(clearTimeout(this._.turnTimer),this._.parts.box.removeAttribute("data-countdown"))}.bind(this);n()},u._onStateChange=function(e){var t=e.m;if(t.audio.incompatible)this._apologize("incompatible");else if(t.audio.offline)this._apologize("offline");else if(!t.speechtrack.present&&!t.soundtrack.present)this._apologize("absent");else{var n=function(e,t){this._.parts.box.classList[t?"add":"remove"](e)}.bind(this);this._.parts.box.classList.remove("nar-apologize");var r=t.speechtrack;n("nar-speechtrack-present",r.present),n("nar-speechtrack-playing",r.playing),r=t.soundtrack,n("nar-soundtrack-present",r.present),n("nar-soundtrack-loading",r.loading),n("nar-soundtrack-playing",r.playing&&!r.loading)}},u._apologize=function(e){this._.parts.apology.innerHTML=this.APOLOGIES[e],this._.parts.box.classList.add("nar-apologize")},u._createControlRow=function(e,t){var r={};return r.row=n.element({parentNode:e,classes:"menu-panel-row"}),r.label=n.element({parentNode:r.row,classes:"nar-label",html:t}),r.labelValue=n.element({tag:"span",parentNode:r.label,classes:"nar-label-value"}),r.control=n.element({parentNode:r.row,classes:"nar-control"}),r},u._createSliderRow=function(e,t,n,r,s,o){var u=this._createControlRow(e,t),a=function(e){e=s(e),u.labelValue.innerHTML=o(e)};return u.slider=new i(u.control,r,n,a),u},u._createExplanationRow=function(e,t,r){var i=this._createControlRow(e,t);return i.explanation=n.element({parentNode:i.row,classes:"nar-explanation",html:r}),i},u._onPlaybackRateChange=function(e){var t=this.PLAYBACK_RATE_LEVELS[e];return BIF.dispatch("bifocal:audio:playbackrate",t),t},o}),define("bifocal/themes/read/default/src/parts/audio/narration_footer",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.$init=function(e){BIF.listen("bifocal:audio:state",this._onStateChange.bind(this)),BIF.listen("bifocal:audio:speechtrack:turning",this._onTurning.bind(this)),this._.parts=this._layout(e),BIF.objects.audioManager.getState().audio.incompatible&&this._hide()},r.toggle=function(e){e&&BIF.events.stop(e);var t=BIF.objects.audioManager,n=t.getState();n.speechtrack.playing?(this._.wasSoundtracking=n.soundtrack.playing,t.properties.speechtrack.pause(),t.properties.soundtrack.pause()):(t.properties.speechtrack.play(),this._.wasSoundtracking&&t.properties.soundtrack.play())},r._layout=function(e){var n={};return n.runner=t.element({parentNode:e,classes:"nar-footer"}),n.inner=t.element({parentNode:n.runner,classes:"nar-footer-inner"}),n.progress=t.element({parentNode:n.inner,classes:"nar-footer-progress"}),n.status=t.element({parentNode:n.inner,classes:"nar-footer-status"}),t.DataClass.set(n.runner,"nar-audio","opening"),BIF.events.onTap(n.runner,this.toggle.bind(this)),n},r._onStateChange=function(e){var n=e.m;if(n.audio.incompatible)return this._hide();var r=n.speechtrack,i="idle";r.ended?i="ended":r.playing&&r.loading<1?i="loading":r.playing&&(i="playing"),t.DataClass.set(this._.parts.runner,"nar-audio",i),this._.parts.progress.style.width=(r.loading||0)*100+"%"},r._onTurning=function(e){this._.turningAt=Date.now()+(e.m||0),this._turnPolling()},r._turnPolling=function(){var e=this._.turningAt-Date.now();if(e>500){var t=Math.round(e/1e3);this._.parts.status.setAttribute("data-countdown",t),this._.turnTimer=setTimeout(this._turnPolling.bind(this),1e3)}else clearTimeout(this._.turnTimer),this._.parts.status.removeAttribute("data-countdown")},r._hide=function(){this._.parts.runner.style.setProperty("display","none")},n}),define("bifocal/themes/read/default/src/features/narration",["require","../parts/audio/quirks","../parts/audio/audio_manager","../parts/panel_nar","../parts/audio/narration_footer"],function(e){var t=e("../parts/audio/quirks"),n=e("../parts/audio/audio_manager");return function(r){return n.hasOverlays()?(r.runSheet.append(["bifocal:reader:ready","loadAudioManager"],["bifocal:reader:ready","loadNarrationPanel"],["bifocal:reader:ready","loadNarrationFooter"],["bifocal:reader:ready","narrationKeyBinding"]),r.loadAudioManager=function(){BIF.objects.audioManager=new n},r.loadNarrationPanel=function(){var t=e("../parts/panel_nar");BIF.objects.panelNar=new t,BIF.objects.menuList.addPanel(BIF.objects.panelNar)},r.loadNarrationFooter=function(){if(t("audio-incompatible"))return;var n=e("../parts/audio/narration_footer");BIF.objects.narrationFooter=new n(BIF.elements.bookWidgets)},r.narrationKeyBinding=function(){BIF.objects.narrationFooter&&BIF.objects.keyManager.addBinding("p down",function(e){BIF.objects.narrationFooter.toggle(e)})},!0):!1}}),define("bifocal/themes/read/default/src/parts/book_design",["require"],function(e){var t=function(e,t,n,r){var i={};return i.humanName=e,i.machineName=t,i.readerStylesheet=function(){return n},i.componentStylesheet=function(){return r},i.serialize=function(){return i.machineName},i.deserialize=function(e){return e===i.machineName},i.options=function(){},i};return t.REGISTRY=[],t.byName=function(e){var n=t.REGISTRY;for(var r=0,i=n.length;r<i;++r)if(n[r].machineName==e)return n[r]},t}),define("bifocal/themes/read/default/src/designs/publisher",["require","common","../parts/book_design"],function(e){var t=e("common"),n=e("../parts/book_design"),r=[],i=[],s=n("Publisher's Default","publisher",r,i);return s.scaleText=!0,s.options=function(){var e=document.createElement("label"),n=t.element({tag:"input",parentNode:e});n.setAttribute("type","checkbox"),n.checked=s.scaleText,BIF.listen(n,"change",function(){s.scaleText=n.checked,BIF.dispatch("bifocal:readability:bookdesign",s)});var r=t.element({tag:"span",parentNode:e,html:" Apply a consistent text scale."});return e},s.serialize=function(){return"publisher:"+(s.scaleText?1:0)},s.deserialize=function(e){var t=e.match(/^publisher:(1|0)$/);if(t)return s.scaleText=t[1]==="1",!0},s.scaleCorrection=function(e){return s.scaleText?e:null},s}),define("text!bifocal/themes/read/default/styles/designs/_reset.text.css",[],function(){return"html.RS-BIFOCAL *{margin-left:0;margin-right:0;text-indent:0}html.RS-BIFOCAL p{margin-top:0;margin-bottom:.75em;-webkit-hyphens:auto;-moz-hyphens:auto;hyphens:auto}"}),define("text!bifocal/themes/read/default/styles/designs/legible_component.text.css",[],function(){return"html.RS-BIFOCAL *{line-height:1.4}.-rdy-tag-container,body,body>article,body>div,body>section{padding-left:0!important;padding-right:0!important}.-rdy-justified,li,p{text-align:justify!important;-webkit-hyphens:auto;-moz-hyphens:auto;hyphens:auto}h1,h2,h3,h4,h5,h6{text-align:center;overflow:hidden}@media screen and (max-device-width:600px){.-rdy-justified,li,p{text-align:left!important}}"}),define("bifocal/themes/read/default/src/designs/legible",["require","../parts/book_design","text!../../styles/designs/_reset.text.css","text!../../styles/designs/legible_component.text.css"],function(e){var t=e("../parts/book_design"),n=[],r=[e("text!../../styles/designs/_reset.text.css"),e("text!../../styles/designs/legible_component.text.css")].join("\n");return t("Legible","legible",n,r)}),define("text!bifocal/themes/read/default/styles/designs/scholarly_component.text.css",[],function(){return"html.RS-BIFOCAL *{line-height:1.5;font-family:Seravnek,Thonburi,Helvetica Neue,sans-serif}.-rdy-tag-container,body,body>article,body>div,body>section{padding-left:0!important;padding-right:0!important}div{text-align:left}li,p{text-align:left!important}html.RS-BIFOCAL center,html.RS-BIFOCAL h1,html.RS-BIFOCAL h2,html.RS-BIFOCAL h3,html.RS-BIFOCAL h4,html.RS-BIFOCAL h5,html.RS-BIFOCAL h6{font-family:Futura,Candara,Gill Sans,serif!important;font-weight:700;color:#004;text-align:left!important;margin:3em 0 2em;border:none}html.RS-BIFOCAL center *,html.RS-BIFOCAL h1 *,html.RS-BIFOCAL h2 *,html.RS-BIFOCAL h3 *,html.RS-BIFOCAL h4 *,html.RS-BIFOCAL h5 *,html.RS-BIFOCAL h6 *{font-family:Futura,Candara,Gill Sans,serif!important;border:none}h1 a,h2 a,h3 a,h4 a,h5 a,h6 a{color:inherit!important}"}),define("bifocal/themes/read/default/src/designs/scholarly",["require","../parts/book_design","text!../../styles/designs/_reset.text.css","text!../../styles/designs/scholarly_component.text.css"],function(e){var t=e("../parts/book_design"),n=[],r=[e("text!../../styles/designs/_reset.text.css"),e("text!../../styles/designs/scholarly_component.text.css")].join("\n"),i=t("Scholar","scholarly",n,r);return i.scaleCorrection=function(e){return Math.round(e*.888)},i}),define("text!bifocal/themes/read/default/styles/designs/bookish_reader.text.css",[],function(){return""}),define("text!bifocal/themes/read/default/styles/designs/bookish_component.text.css",[],function(){return"html *{background-color:transparent!important}html.RS-BIFOCAL *{font-family:Athelas,Baskerville,Bookman Old Style,Palatino Linotype,Cochin,serif;line-height:1.3}html.RS-BIFOCAL p{margin-bottom:.25em;text-indent:1em}html.RS-BIFOCAL p:first-of-type{text-indent:0}body{-webkit-hyphens:auto;-moz-hyphens:auto;hyphens:auto}div{text-align:justify}li,p{text-align:justify!important}center,h1,h2,h3,h4,h5,h6{margin:0 0 5em;text-align:center}"}),define("bifocal/themes/read/default/src/designs/bookish",["require","../parts/book_design","text!../../styles/designs/bookish_reader.text.css","text!../../styles/designs/_reset.text.css","text!../../styles/designs/bookish_component.text.css"],function(e){var t=e("../parts/book_design"),n=[e("text!../../styles/designs/bookish_reader.text.css")],r=[e("text!../../styles/designs/_reset.text.css"),e("text!../../styles/designs/bookish_component.text.css")].join("\n");return t("Paperback","bookish",n,r)}),define("text!bifocal/themes/read/default/styles/designs/assistive_component.text.css",[],function(){return"@font-face{font-family:OpenDyslexic;font-style:normal;font-weight:400;src:url(data:application/font-woff;base64,d09GRgABAAAAAED8ABEAAAAAaqAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABgAAAABwAAAAcaAKKv0dERUYAAAGcAAAAVwAAAHQINQbIR1BPUwAAAfQAAAeDAAAL%2Bvx7s4tHU1VCAAAJeAAAAUMAAAJKhpaXl09TLzIAAAq8AAAATQAAAGB9BrFQY21hcAAACwwAAAGIAAAB4tENdWJjdnQgAAAMlAAAAAQAAAAEAEQFEWdhc3AAAAyYAAAACAAAAAgAAAAQZ2x5ZgAADKAAACvrAABH5A%2Fzgh9oZWFkAAA4jAAAADMAAAA2A16qk2hoZWEAADjAAAAAHgAAACQR2wVLaG10eAAAOOAAAAIFAAADpG3xevhsb2NhAAA66AAAAckAAAHUK8Y9mm1heHAAADy0AAAAIAAAACABMAB4bmFtZQAAPNQAAAIuAAAHoPH7%2FPVwb3N0AAA%2FBAAAAe0AAALaPPCU9XdlYmYAAED0AAAABgAAAAb%2BflG8AAAAAQAAAADMPaLPAAAAAM3iOPIAAAAAzeKu%2FXjaHY1RDkMAEAVH13cdCpfBDxIE0dTdVI%2FiGB3dyUsmm80%2BEuBpGu55kJGQm0KCkkqvJbxo9U6CnkEfJZiY9UWClU1%2F8fbTzqF%2FON1%2FufT038APyy0O%2FgB42mVWC3BWxRX%2Bzt77JxKkJhlEoTViJhEIzxiEJD8JNRJCXhCSEEIgCMqv5Q%2BvCZRAw%2FBIhBojKlBIJEFF8AEiio1Sk45CE1CsZiolULROA1OEjpZ2OrR2GHK33938Jbdldr57z549rz17zt0LARCBx%2FEMrClT84ox8InKQAVilyxctQzjYHMVWkPxJf83GwTr4YeKhyI2f0Yen4Uz8vk065ZZVx5Z67EVK1dgYEWgchmGLF1YWYGhhg%2FzlJC8hdsQiSGh%2BRCjq5AevsR4lvBr5EbAxxFBvg%2FxSCe%2FFi9Qtgl7kYh2jmSc4EiBhLUYPT82YgvewGFcw3U6i5E4SZBxMkGmyHxZIzXyshyWX8lp6VaxqlRtV5%2Bo06pbXVU3rBhrvJVjFVhl1gIraK2w1lv7rYNWi9VqdVtXrRt2tB1nJ9jJdrp9xve0r8XX6jvmO%2Bn7jNRpxhrv%2FJY7CtN3or%2B%2BA9P0ARToESjR92C2TkGpPoUyQjAQkxCFMOcU%2BjsfYJhuxkgiiXiQSNbJSNFrkcq3n0jT9yFLdyJbt6JIv4c5uoF2gpirl9NWpLEYqfchnM85iKbHeEqkEn69lNpBlOvVrozTbiRf5bOI9gRj6M0i5whtHyFvH8IYTR0jWUtOkJwgvWVQP5krYdTv77xt4kulpp%2BraaQVLQTps8tE4FJBygQpEzQyk4xc0PXk5CLaeYUSR6kVTV6KfoeWk%2BgzWb%2FN2UJqBag1kj5Pmdjeo1wFShHDSol0%2FoIo52vaaEKMjse9egdtpVD%2FLWTqyYx5MmOeyIwnMeNu7FnMUgNtLcUhZm8ALXxFC5dpYQctzKGFE7RwF%2FO%2Fg1bqaWUrreQjn%2F6KdDYtVOMHIb%2FnQ35HUGsntZKo8Qg1HqJGCvL0SuTrPdRKpFY2fS43%2Fi5Q86%2FUfIGaM6n5ETXvoebPMVG%2FSe3F1J5FrRmhiFcyM3MZazlhce%2B%2FZx11crbFzDpRqP%2FF2RHOZjKKMv05pTe4faTbuN6GXO6oULdw5ShXNmEeT6qcVn2U2EqJ0ZiBMhSigD6bDfclcscy9gCms3tK9N9ZGZmYyjjceQGmcZ5jOjObp1Fk6q2UNizk6NOMYjPtJ6IfhnOWyXhz9UVyv0Mxo52FB1j3HYymmdG8Rs153KV79l2mToQ73krdSGYySteSfy9rvYl7DtLbKuQyjiLql%2BunTDW0M8%2BP0tKrnGXSdhZ9ldKPu4%2FRzPJlRtBMzWazO5vcYeTUh3pnLf1ls9ZcS6xE3Y85byZvN%2BskHk%2FIfCwjlhOriCqnE2v4%2FhlRTawnapz3Ues04kliM7GFqHMWYqcuwC6igWgkdlO2SafjZezHAdKtRBtxzKlAu45CB%2BkTXDvL9zniS%2BJr4k%2FEBeIi8Wd9P0ZjkR5vIlush%2FdFd2MPo%2FP%2FT2Sb9KeM7lFG9zCjO87IbNT1fI5t%2BBY7nT3YRTQ4N9DI9%2B7r%2B9Hk1JvIfqnn9UXXcw7tznoT3Uk96mZ0f9C34bz2myi%2FcrpvjdSpxCUdh8s6AVf0UH6tV2Meqmih2nGwjlWwgdhIsB5xjOd5Fh%2FiHCGm6gWp1BF%2Byaea2nrGPFs4X8S%2BWex8hgptY6kux7KeL0wGKtnHVU4a1rg%2B3AxwZxt41huJTazmmp5vmIkAMxHgOQWYjQDPaTrqdTi2Es8Szznf43nnb9jm%2FBPb2aM72OU76WMX0UA0Ek06B806BnuIF4m91Dugf8isAa09UWjTETiuB%2FFMy9HBnZ%2BkvY%2Bd657M5TBzMb2Z07Emcxd6vsdF3g%2BXnDru08%2FvX38MZv3dj2EYjgSMxCie%2BxiM5X38AJIwHg9iAiYyG6mUTjO9mcWuzGZX5iKP36rp7OkCzGRXF6GYWS7BbNOhc5ntcvwEFahCHWvxTRzCB%2FiIlXeJPbjO3JajKBdu7u5mopNoDaH25lxRIo0jjJ7dE8riUMaX0FcJ7ZSZ78FcDp%2B5qTM5XLls967hEEY1y%2B1%2BDvf%2B70dr7i5cGyWhSMUKU4ehrLtxO7NwEO%2Fgffwav8En6MQZfIlufIPv8A%2F8G47YEiGRMkh%2BJLEyXMbIeEmVH8tUyZNCKeUtv0iCskJWyzre9k%2FJs%2FIL2c1b%2FzU5JO%2Fy5v9QOuRT%2BZ2clT%2FKRbkiV%2BWaXFdQYep2Fa3uVjEqTiWocWqCmqQy1DQ1XRWrMrVAPa6WqEq1Rq1XT6qn1fNql%2BLXw8r3rfzvn411h6%2FLfbq0OuPSvXw127ePz9eNjN%2FI%2BA3%2FfJ%2BMDPbIx3vooy6tjhqZJA%2F%2FQh9tZXv4NUa%2BxtDbDL3NyAwwfgcY%2Fhd98naGx06Eh47z2Ky3F9ykq11aVRt6gV19k7%2FX8Pca%2BqBHPq6PDnEGm73c53N1v73FZmOfvGx3adlu%2BIlGJtHwN%2FtYWSrD8Kv65K0tHr%2BPeGhP%2FPZkzx5%2F6snDLI%2F8cY%2F8cx6ZTZ69JLBn3Y4dcUvH9nZriunWdHZCb7e6ver2qdulvR06h3VfjvnszSYcQBv%2FZTtoNxxT2LGV7NlqnMTHnIN%2FI0AckUCMo8wEvicRGcxFtzWWzy6TqeP2Ea5esUaRDphMddm1RibpP9sLSFEAeNptUE1LAlEUPW9mnEIGiZpUokAiJcKF6KaFBNHUIhyUctVusJJoUhm1RdjXf%2BgX9Gta9Tdq3R%2Bw451XBs3inXfvOee%2Be%2B%2BDApDGA95gekeNNtxudHGN7TAY9VCHRRXTKVK8FAzmqUQuC%2FNgv11AyW82CsieNH3iP9cst3VuCmMHQThC6TIKOiiHV90A1bDfCbHbj8572BuOB0N4UgFBUzB%2BUwla%2Br0FLCGPTeygyrk9rdaln4EzTDTzoitetfKOr5hRTuxQW2RdvjfBGLe4wb0cRWaVO%2BVQRA2HOJVZDHbNUlvXE7UE73Sc5Kj8cVSoOnTFnWbbxR0UylTSKBBtZPBEZYXKo9x52fr5NzZYlWOmsMazrH%2FLFqXISQ1GLjbIJXtq3GXuiR2L0tnBJ%2B8WPoi%2BTHzMKMPu81%2Bxfv7jGxzNNh0AeNpjYGZ5xTiBgZWBhdWY5QwDA8NMCM10hsEIzAdKQYACAwM7AxII9Q73Y3Bg4P3NxJb2L42BgbOYJUSBgXEySI4lgfUqWAszAJLSDXkAAAB42mNgYGBmgGAZBkYGELgD5DGC%2BSwMB4C0DoMCkMUDZPEy1DH8ZwxmrGA6xnRHgUtBREFKQU5BSUFNQV%2FBSiFeYY2i0gOG30z%2F%2F4PN4QXqW8AYBFXNoCCgIKEgA1VtCVfNCFTN%2FP%2Fr%2Fyf%2FD%2F8v%2FO%2F7j%2BHv6wcnHhx%2BcODB%2Fgd7Hux8sPHBigctDyzuH1Z4xvoM6kKiASMbxGtgNhOQYEJXwMDAwsrGzsHJxc3Dy8cvICgkLCIqJi4hKSUtIysnr6CopKyiqqauoamlraOrp29gaGRsYmpmbmFpZW1ja2fv4Ojk7OLq5u7h6eXt4%2BvnHxAYFBwSGhYeERkVHRMbF5%2BQmMTQ3tHVM2Xm%2FCWLly5ftmLVmtVr121Yv3HTlm1bt%2B%2FcsXfPvv0MxalpWfcqFxXmPC3PZuiczVDCwJBRAXZdbi3Dyt1NKfkgdl7d%2FeTmthmHj1y7fvvOjZu7GA4dZXjy8NHzFwxVt%2B4ytPa29HVPmDipf9p0hqlz581hOHa8CKipGogBn7CJTwBEBREAAQAB%2F%2F8AD3japVwHXFPX93%2FnvvfyGAqEBOIiEEIISsVKCFFBQLSIqLgBFRUB66zWSS1uVBxVVBQVF26K1F1FVKxa695SZ6tW66pV6uhPIbn%2B730vQVzVz%2BdfmxCS984999xzvmcGBjEtGAal8l0YlhGYgC3ANAjdKnDM34FbZPy10K0sIi%2BZLSx9m6dvbxVkYA7dCvR9g1wj12nkmhbIC%2FvAItyP71K%2BoQV3kiEkmRyGgXV8KcMz9gyj0DiCllXotUIOuKgd9iufKkuVcBP6oCzLUHMxxox0DzsDPSb3UF4YhYHVAnnkHHXcBlOOOm4nH7a2%2FIhaMzb6Mme%2BhKnNeJKVNG4alj4MCvFh1IgPLUsf5C00FC%2BEyM44D0L6rewLur55%2FaAPPtAReuEjffP642v9VoV3Bm1HzjMXb12Mk2E5fSyG2FxYgXvDCvNoiMVbybosk4OvcD1lHowH48N8TlZmw8AUAHqFu8rkqzfpBScQ1KBiffWCu4pVsAFgDApWsGpwUzrx6Ljz3j9Y4chtu90r2by9XCp34jdWKDkrnD7OnTpew89h7JQ5DxzGfFvdRV8n3AdfgQbVDqxbslYP5xzjlzR2vIf%2BcihavWiTHo%2FkJ5f1kOHz%2FHkc5jYirutYcz0YWaN%2FfE2%2FOjWqO8kYIvWcV7eEWL6MSL86o2K0TADh3kvmpnT3CjYGsaAFFOjuppR5%2BxqDwJu%2BbwgkH%2FgKge5KmZa%2BG4y%2Bwz8X74Kw3ZfYTSvNHUyFqSkbk7n9K3YX5y3bXby8S0pKl%2FiUFL7sWvGeq1f2FpefllV%2F%2BZSfnT1u4ty5E8fjhlf37L56rXj3tfEzn8ycOfrbGdZze3VLpiB86Zj6DGMPvnq6lCGQSE9L2VBxbkrG4GVSGSAMmYJNWiewB4khbpjlWo%2Fa6oz%2B07ZEFawu%2Bj0ZP4PAfwBOZZnxfVMzFwcExYLeEoDc5%2B1b%2BSusQHWSAg2GhCFJs6MPrUqb%2BAu%2BiP%2FenA0eMcVDRigcJhdCN8u1CT9nb6J8AdG9AogQdY9onlybU1DAFiB%2F62f4Cdokq8k4kF%2F0DOuiUPki1hVtysOFuj3n%2BrarppA5OuGWOBrXx%2F5OV2AnKGEXuU%2F3qhoKkxkYJ3qfu6scgSqMNfoiSFnRr309fP7PVt2SG0Bvmc7pBg7Hr3Aw7uSU%2BePj3wc%2BhyPiuiiGSyaykpNf5IJCJ1QHlU5uYnlTfdCjzbl%2BeHMCTMGLk8Ev1w%2FaJ%2BOh0NeVS4PRfnjT8Zm5B2c8xZlq6H58xpIDM0V6RDEWETN2lCxGTgzYqJFr0UHLeVQ%2FH9W3nM9HFwvoLwWovrjvG%2FA%2F5hnRJiIThVHrljPxRgV5L%2BLCBUkucB0VoVlUZmDiBbRFsPwpwL21DmusciNP%2B6E5%2FZzAhBz241JojvdKn71qwg7mD9DPeNADjIEnOZaSX2QZ%2FMsJVj3hlov6q6CaS6ROnhQu4CV3AK03kruwy3E1%2FK8DMPAMHBywDJq4rchdMoMvwyPxZDwFj4SZkE7Ihliu4Pv4CQigRr6VfHHO5KwdJL60vJuO%2FOCc8Y5jeAn0xTugBrc3uii6ogLfs10fQ3ipQ%2BUWTLQyjFi1j9ZbcCOaS6yIGr1MkGu4GCz3njrBs2tL%2FPDexhePd09d7%2Bu%2FdO3Glex28J7w3WTt4LU9D9xLOTElJy26Tef8cZOn4N8lWdzivhJtglHI3Q1ePsQQ9W%2BtIfMHN2kxYg05pcVQG%2BqvzcqYjZ%2Fd2XL7t3WLVi9fsGNjXklKasnv0A8finn%2BaN4BR82GMVvPRuTFpA%2F%2FOm3d3AFBcV1s2Mn9Ku6%2FOsVmlmCmUUvQ1gRsDpqtBGfl8eMO2JK9BrADrMPdYF0%2Bm2mO9Wc9zLds%2FCaS%2B2tTfiX2nJDWW095Z4xBDOGaaFbp6tWb9xq6ZnU8t%2B10McjhM3ytvMUENIIvtbjG5ObqE9oF9caHI8DxnwfgqoZJOTZ84JYRWbiT42bA6Kv1YuQujCZQoisTaoEhkPGiAvGimBCan43%2FxJvBFdg%2FwAVX3By4NcT5%2FJGFOANcVqzAZSs4c1Eo7o6X40w8HNzv%2FAXyHvGEGSfL8%2BJVfUaO7LPKer5tyH5kFJE0YNS4sQssV6A%2FjDDH8OHl%2B%2FnxcTki9hPeSvhrhDdvil7gRFCde31aEoK5K4KsJ0ZQCwJtnAbDjQU%2FkkN7ArW3Lxg%2FvuzypX8mGOdPGJ%2BTPSljLijnrt2Iy35Yy9b2PjLr4oMHF2cd8fbalLHm%2BPE1GZuge8r4CckjJk3CO3MzO8yY3jEztxJLuaVEVrUoN6LmiLLyZiiGBgabnHitt8I7gDNaOXJi%2F82fT3hohx9jyx%2B4DPgbg7Y24T2Mkcl9oxf%2BGda5a%2BMGbgfWrT3g3Si5N7nqTCishd7wLczCD%2B78hf9JjOs%2BtWeIphrS8HKvoHbGlbt3rwzvaqhtZ%2FX3S7i2ku8Gau30sQRXAI8r2M%2FBA98yn4FAfIpei4vgOhdNrrWn12rlrIgucP1pXNaOB0QRdfhqxQJI2bfPZq9y%2FjQ3h56PQgCTPZgKlFypm7k25%2BPCNvzDcuAfOATKHyWZQBK%2FiF1l5YMcJX3wi8oxj8oxKs%2FPx18eOSLSnM6f5u1tNAk8bHDjfRUVn7kQRfr2H%2Bj1BwrfgRtb5fwv%2Bz2Rs5qcO6EZRBAgOBysR241UCdwJvrgAXTbqCsr83T2jO3W8dedJ4oPL%2B0%2F1T6iS2p8CAB%2BCXPTg9Sh%2FkpjXO%2FJUXn7hy6fPq1HQFRU184z%2BufiPlAH37aeLV4qTOBXMU2YKIbRufkw8iC9L8EDTpAhN6VrNWIGPia9TOPtqw9gjUGuJsIFp6LaJsi1blQVXYhLhyq6yNeDGhCWm44XXNiLN04cN20qwc7oXYtAP7bbcXx%2FXUWflh0ia21ZdqBiM%2Fj3G792XtaoIxsuXSw8ioOzRn87Z1b6mNmPcmXwOQgvj%2BVtzBw%2FFu%2FYsRfvLM%2Fo2%2FvH5Z1SW6eOGt1uP7T%2BcuLMjLyLW667oxsZC8vx1y%2BRYlz2%2FLHjs%2BfZsId%2FRGxNENHXpFFpQGvPwvo2aGUj8LZs22vZCrnEnBVPn%2FKl5f5wkw01%2F0xtj9joSXKfk4QMBk1gFbsjVOgu64KbJlCUgVaTg2pYwLvkwJgJ5XdxwDHwn7MAXyX%2Bp8Wq9rE5BXjP1cNLD3spV03f8tO0GSNvrolsHjg11YptPMV6NxF9NJJFeZnkMo2Xj56%2B5GPO4Of4B%2FwtTIVOIFw4hivw%2F7CFAxciTp6bVTob98aL8GLcew702vsrBj9obN33WMK%2FHfVnBoluXVBRk3Vi%2FSEHVsBmEkMPwLG49wUS2IB37VYzjix%2FBgNgEkyA%2FuvwX%2FhOWlYvrRWvEggtR8l%2FUSdOH1yCxQ4dtjRGd8ztIRjmFkBxQbm%2FdD1bRq4n1kbAXgqOWZinRKGWYiXqZz7lh1aeg43by23xDpHBRhFXGHAjqhOA9C4aL1VVcWjcuCPRZbP3z2rBIx2obvyBr%2BCVeBTMgF7Q%2FKHlCnJf2cZ%2FwI7pqPe%2Bg7NxXzwPZ%2BO%2B%2BSjlki0OqfOafxLkUy%2FMwji0457ygiXmghKeY0fiJxqhI5U8kadpks8OAV8H0GtlDijnSTVHGRQiO97pJpxE%2B%2FqNwWr8K%2B4txi7tWTv%2BohjrsMQ%2F6xWqMAJ9KCiYnTT2S27k49N8MH%2BxfGT0YJk73lGNuw7V%2BBlW3lpbYwMWNNQfkBwClvpBBVwz30F%2FYrMlWXnMD522NGQ9UJFlOkqrwiPXTMx5GCJjsiOuvtJiOKaEYG5FlWtkSnJNNZG%2BAYjzpYuwkOMHXz2Fr%2FwA1PguTsOz8Hk171lxigssv8mXmmewo2xnySttZwmi2Mj%2FOaEoB3yK1ZZxZj%2FuZoUnX1rRkltS3qrST%2FBmcp4OTA3CghdDj5AeJEeeiecm52t0YWPwIZwJoyEEmsA3eJrlARQBNJu07t76jGYkqOpuCcWJojtIhrVr8E58Z%2BiSOB%2BfuCVDoZYtpvhOlJuC7t5AzdNHS7co4Y8GpimfvQQWv6rAkaHgYlm4du1C%2FBi1eHrj6q1yf378vKmZ80TceyEj6zFKGg3ZQxhnlLhVunKGQJMK9AH0HfqG4KuXNcM%2F120aVV%2BNp%2BFfKP8bwHisZsh5vK9nvY59WhHp0k3s%2BfYb%2FAJ6BbQfM3FbKmWfxgP3MUnAHqMeTrxbow4zE6AWtKKbutfPxVSJUxqyH1eS6RFJVyINCZrJjlQKsi81EsMyXnMyffzAtJd%2F4kZPcr6d0WqhZRgO79%2FT%2BHMahkXl9XS7Z5ZeLvdHaanz8UR%2BoGdURmLX6ZV2xm0he9VKkY43yX3cPYHmijIaTXFSJNgAxCSSwHv8rXPP8f1jf6TPmXtk5c0XgC5CTdBeuvntmtHb1hZz1w%2B1uf3Lhp%2Fq1%2FD4JjJmwkx8oNeNyzsv%2BddU90kdNcFmd1NE7GWo3vHEM6J8P6jth1wr5GKgE64sKHiNAdXJtXIaWYhHQJZSuFNHYlLkEKuoTUSmKVXIig%2F9sptqtDkRX8O%2FQj3wYddY4OHFiw%2FRK%2Buaj6TYigA9yTs1%2FKNz2BfrzyM7aEX0dDXXo4ptCC%2BstkENj15PbyHpcz1QgC%2BkHcTf4z1b8Ap85gDEsr7mK4TAHnTE0ob7XCQirTdfwhYDJWIlkQPR0JiAYkushBOX8Uw86zLsRSrLfVTEelimoHTz7Uoe%2BIkiThN4lks3o3Hk1ZPLuA9Ovgz34BX7q4VDZnM92%2FVdJXu0p75fDB%2B5KHN77qC5Mbu5YiDvX%2FEPvg2fcc65BdZcMkymlKITrdxAcBuFlZXhBPzkOr8968XvouzrsdX5C2JuRDQehZzDhoJTdrK1vMRjKqFRTaJBc1WSyWlSHz%2BGfJzATymPLBW8xXw2n%2BR6otwVkjBzSJQTQ%2F6ZLCeXsvlwGDcmSZ41v%2F2CK8EvxNzXTWPM4fzwi23brJ%2FxEWikbIeY4xEikApyfOcQHwGjXseg0Vw68cq%2BFM1drBGRmoRCGi%2B5ksSkJjdWyg%2BIGwlDBi667Om2Y9%2FvJ9E5xnbHCwFN7FuredeYxq1a1hWg0fypaDww5ticRIfsia44Y9X%2BvXkotG63waFKuxpBdVt1qCetW0DWnUBk4ErXpVUYkha4SItQ70BshkbjasEQxkKKstEPE08wr16dGLSwd2M311qaamxvWU5W9jqZnVzh5R8aGxjZo11DmdKyI6kD3m15gnerw9uH6KEXKjtv%2FuLwpd%2BPNQhqofUnyRevjhxRabvVyL5rVslSCECxTqyvNgD0or1Wy%2FkBl%2BPzUM%2FyYy6nbtqmXu%2FqO1Y7lWxZzmaviiKA9Qg%2FwQeiQeOitEPIIW32mQevZZpN9lZd9MCEoDdycSXE3QwKGtB5KZxYYobsVeWw5ycwPvF8WJHSnLl%2BHqgcWZ%2FYlHZzvyM7WXVI2sihfJnS3OD4XZyYOCzUbVwl%2FVzCew0JeQi73jS%2F5gNNekI5gNPrNEHkpAjAcbmKu7cr8HUHojtO509wDXp907x1%2B8H9w3wBrbF83TBuUkyz4bEG1DPq7xsO%2BCf8AL%2FAZxzicE0PR8QpA2LHJeQZ%2BnQwGDsnW22FDSAKSWMrvbcTchO0bgZWDEmowFSsdk3zwfENHdatU4O9mmYBDsHR6%2FiHSl3bqd1id5rj2e93pqRGKMU9WO5x2WQPaqYhoSb4ijUBV5r1uDlxUi4aGAauJgUoqbTIpsRQmAht6L%2BnK8ynRm032GvC2o%2F6Ys2yFfsyi6dEytT4tldg97gvTC1a%2BunchLXzF6zlkgoOkXMyYwv%2BpUdMU%2F%2F4ni0D4nBRSORS4PazpZZ7sQNDNXa8UhfRo%2FmRa9dsMUA%2FUS%2BJ1xDzAxI%2BGFhxcYHl%2Bil%2F2X83Q7nL76ZyY3bGWDs1WnPv8VGU%2FPIhGr3%2BdO5OS7I1l6K6LeVHeq3AGpBC6wrJDmsclA9CFGt43v%2F%2B%2FfJS1Ax5WvIknQnEwShavMdVvMeZRD2coGVJ1GNSoGhyp%2BZz1tk9wBjQjk%2Fdvp7zoyTOmLno7uGezix%2BiIQzF7kRr%2BOYHEKrMgbSijHQTDX8AGMsCyD%2FLzzFYZcfcrb8gzqjavgLdsjLh9J9yJcvprikMWpdFVrEIt9LnM%2FGuva3US20x1xmibPhvD85O41NRjKBmqtg0hJlkDIWVqMIE0MHVvBXlmwavzGq7t4xf6crdwUyr5RbZ6YN68a8UtstnjE0IQqt%2BeP5iHEjxh3dWJGHRq%2B7vWSVpQkaXXhhQb6lxev9TCXrKel6SEM0TzBWWYqbqlbiDNOAXs3q7lITsuvWjh7oh9bAxVqB%2Fl5TK3JQRn4xIZrwhu040rgAvCWzp8%2BClGETVWNp8XTRP%2FgxyP8pA1f8qCy7UG3o3C2iWffOgepCLh0fwQ%2Fx3%2Fgw8UhEPaHRtFv7234VqateXRf5VduDN635XxxXTNZxEtdRuFvhjchIzoIVTsk6Xu4w0W7YMxHcng3z3NWV3ejbqW%2B79oO6f7YefNbjONTxEHyBnOCLQ4vNP1o6si9TxzdX1Wg2MeX43bvWdfgmZB1nsY5u0iu0QiXesEAXsO4Kcdnr%2FwjfqrZhTiPLRLJCvjowLqFZhz7xetx11iVuVYENdiwb2adkiePtv47UVVOGj7XZfyjXl8SfUrxDTsEVkXNwIdkbG2pUb19f4Fg7DLz8QBfUhM3b65AxjKQNX%2BEC9DlMt6%2BMS9hHhF8xE%2FcVK9qe4K5yVymtRh9cNWRity7CqTfmb4ooVNX0Kj9w%2FNdtF1%2Bs%2FiU8%2B6v507axa3NDC5ePz9A5%2B9byCMkZgJ9E7Vg6bU49J03H1p172vjtwI%2BiegMUqZTuISAnogCj1F4Aj8xMh4KLe%2Fe2b6txIKGtxeEgl5RlyTuzEly9uvWAe1ngbvMVMVwStUwFdYmBJsFADMqJ6LyvXp5zZP%2Bfkx2KlCeUDmuzR4904JIs3e6WHS3kkrBu%2Fe6lq%2BCVTYcvERoEPjXWqCgMcg%2FiVXjVQcjlkswn2KCKvNc5xkhyLY2jalOv7Qi0AQNo64WjAKAr%2BvMcfnX2ThHowIw5cm8ZbXiwLlXu58zkfkca02jFIIqCADqMTx6Cybg51CVay0Bd3AZm7kYL4LilyHIPpuJvUXXUSYwnIkVeSSZgj7Qg0ATXjcAxMgHnhs%2FgEQfhejsv76BGugnrmycmxTUEcrVlJJpZYVnhp%2FN3eVYzetpX3JFKXrSEljW%2BMkrluZ6WRmyGZR76xpzHXrQY8bP%2Fof3506VYZg27TyYwBhI7UVdGmzNhEA5hvMlg0jrxtEojaAUSoKgENa8ysHktGrX5vI4jxwkdBn6dyHIgU9Zp1NzYgg2LT0sNqScHjh04tylqOjNF4JCLb%2BOeaXERWeBSyxBc%2F8XsmXVUs5a%2BCAw31nazQ3OQk1fDjgPalGX3l81hh%2Bc%2BajsgIUjngqwxlgfkyjwYjugAa6gNZd1K1H4yDxJ0PeGcyOcj8VaW%2BG2mHo3piKiaEtsLIRGity95FYCk6q8HKN1VtMpEAMAfRoZPzE3WDpodFjZ7kDY5d2J41Hddug0Z0k0e1KlVFN7qGT992OOFI7KGLygbNj3OMyt%2B9oulWTVrz573onVno1yq3%2F%2FIL2IbEh9KbIlqYwMQwdgtmFaTVNSqRC9qCuYX9f0%2BrsdSXfbg3tv6Zxp6te2Va%2BdkL8wb3CijTYISZS%2Fv3CbMKfSLdmeGeYd1RDKW7drY0NxJwkszHOQtki8jO2cVAqvQsdvVT9Xux%2BzJWXjzFvwIXC3lAl5iGWqHsmz1rz2cO59F4kqKfyZfvULPyhgWMSpWpQgOB5mgcNezAWAKA06JJmZzX%2FJP8BOeA66M%2F5LPmcTPy3TOfOQ0byXi1rMLZ4c5gifCN13xeUz%2FO1oD30BQp5qpPEZgAwTefEW5Z%2B7xv0RbfczN5G%2BLkRdZ1QlYQS%2BoWL3Am3QK8jARLXbnpvJrx%2Fx1RRAOs4erPZSxN2WW89Ugk8WjZVyjIX1HcX%2FvCEeyu9jyiE1ncVvumvyaPWwT0oWLsxeHyUDKLztyz7itTG2a54rxC12HdsAElYlChMqkJ1CmN4FS4yUVcLlJp0d9M2Hg6eGn28ScHnr625HfjDg97Gxsq1P4d%2FwUP1n%2B9bAl3NazMW1ODz%2F19ZihY08NPx0TS677Ov3bUadwiwMHhizJfZ3j1Ca5Aa0GGE3UpqTMzE2jchM7qSQiY6M6Q2uSNoedx3Nx1jkwkNdt%2BuEkyFMDr4RlKNKwJB3FWFqgPZYd6UsMq2mfdLXt7CRdl2qwJPwhAYwCcgv0BRsCS9QyD3PiQLMz%2B4%2FVnzZlr5Ec2J8xWb0ClQF9UFyXMmE3CdZFeRBslzqGFPTdaBGA%2FMqmLV2w9uiooojICzV%2FGzgobePGWT%2BcSNvVrMVZv1ODeg%2FHf%2F4b3XJsRYso3nVNkxWTpiekFH3Zpt0op%2FSO0U1if22SP3tcyoAtfdq2G6ka0bVle5w0tXmL1j26ZjaPbNNd4pGPYhUyT1tNmSRctFr99RU09gofdZn8J9UnZUn8SRKze1DsYbwEmdxF5e5lCpa76HVeKne5C%2B3cEG5dTMG2fdJzNlrbrSRfKLQsv3r58lWUTJ4tz8B%2BT3HxiZf%2FO1FSsgcFTpl1qaLi0pxJ48dmbyuYN5k%2FefUyPoFPX7569TI0hKDLI%2Fbswf%2FDf8%2BdObOgHISSPTg%2FxfTk7JlnjXc3Wzcw75jUu4ZStqdY29SIWievrF97gNZL8kw0WZM4IhggYm3itp3fZc%2BY8GAHnrJowt5Eh0n9OiaHh68EL0t7dBJ%2B2ra50fgWOzj8eGhmxtfws8ewOW0j2nlrLC3S0yU9j%2BLiOTnxW7TXJBbvgZd%2B5MAvn%2BPfIFjAdWAqfX0NTDLsgQQc%2ByeoAPbhwZn0pTsg8lLEK09%2BB9uT1teAIAnJs8sCX6jLMdqOB6Lwkk%2FoSXJVzqkOyRyavO%2BkyEFpvPSiBFha7aGaaNATRRNrQLRoa23Ive%2FA9pIMqHxvScnuuicbOel8QiYWTm%2Fg5eOe1J946lsn0wd1jR%2Bc%2Fu7hbdyIaxRu2rS57MnmjRUPIbVmraSz12N89YL867gyY3ib1mFSLp6MHvL%2FinujtZuHlgI%2Bef586%2BzESNaFnG01hoYcrzv6eqmlL6oYnJ9StD1z6q7ErtPaDRmcN3gwX1Y8NXP7zsmZ3Xq1%2B3JOSkp0qz622pfUJ3Z%2Bs1Msrlq1W1xajtmJBXgsZBRARrm5xHoGaCnhs0xCbuJLqvZJlE68QDyMxggt4g8Exm%2BaM2RpVt8u%2Fap7aSObpNRt%2BDmKY5u1Xmfo1mzQ5EbpUR0iq3vofUIC43z8P1u5VqI9iwWpZqYQrOGe%2Fs1WjLVXKurxCvtZQ7aU9Ens2O37OYPmZ7Xvldq7Z8%2B4q6nfTGO7r607dUzHr1xdk75IGaUdXrdpk9DwQTnN%2FGx1Dz%2B0QXaMyppiI0TAwN%2FwEd4PVmEpNiTx%2BStugLhHlhoOfQQTayZW7msk0Z2LhsicFRQka%2Bt8%2FKc%2B6mnaxqZ63g5yu68dihzwxcwZJOQj4XndpcuX%2B%2Fio5juxMiGU7Ym%2FwJvnz4Uyh5f%2F2uLdEJ4lWC2eBK0QqpGKFQ%2BE0%2BOYi9gc2W%2B4KQoit0N%2FvvReSfzSfpH25q0yz5c3rfejaOjPRkk6Q1Cr%2F3kULc3b0D2MREHkFbFMjZbIzQq1xiA4nJaQlhge1%2B1RWkhPr4wa27tXnus5%2Fro4B2HUyrWCm0mudUPnTk6%2Fc%2F0EWlqEZupH1LXcLbJhTS45J9rvUL2ePXHRVY6dBIvadALnnjkDX57C4weMGXtu3DjYb2nPl%2F22r%2BTaVRiXlTliaGbm0OHTzAaKJpJu9uHaciESngAtj4Fg%2B3EWH6oDDzS4mQM68%2Fplb%2FN9mD4GivfhU7ZXFAde3SLxXxnh1ImpSTv7PM1yX%2B%2BKqL3BaKC%2FEyiSo2x2TZ458bq4U%2FYnWD4nM3Md%2FqY%2FGD3o1AvaNRiV0r0vG4y9iou%2FQnUsZdVgNe7BMNa%2BsaC3ruUjrmRfRX5gYt7QXhDNA%2FUWVwS5uCT3azy0ttkKzqdm8vbClkutofZ3VqvpiU%2F7fzZ4mHWfrqK96JlAxkgrfB%2B3GqrxujcEkPNeMxo9aBpsE%2FlEsVVkwjYY%2FT7Timpnvk%2BZvvymhMScmt0mzt5oaMfJYGTpmIOz2F%2Bv4iJJEM82BXh%2B7OfqLrEJCTE3io4XH1o2aPJX3T7z0Ap8KYnrhqT38vu8bVyXGW1WHBj6Yvrgrr36JDTUhocELWUkH80%2FsisnrxzFmRwS97C2DiQ6KxY2E9%2FpQwqTYdT%2FZG90Iytp2ctttMQ8yUaLXSuCBS58l9gQih8v5r5FzkZPiCN67STO%2B5hIakLytkr2Fm%2FfPvP5%2FOd93yHJ%2F%2F78OW3YlHu%2Fn0e7NKLfGqp3QKP5YJOWQpQt1DeIof5rzl0at2jZ%2FUs0FhSuvrXqVf0F7393N2dNTbMzO%2Bh0evqzvd7nhd1bPHDWfQWKsZOzWJuyxU%2BVW7tHAynLv%2B%2BQl3WlsdXL9e%2BnaVeTUFSQ%2BJlkL0yQr7dM6R6oUFYGU%2B6V9LleK%2B6sWHFHlxDRLD6%2BWUSC5cC7K82nV%2BSBIiKBXBGf8KL4rTUR05dhhPUiDov9W1ZsvNpar0STDH0hzQG5sAetPdg%2FK1pANWyEmIkg4JfAQc0ClFpQcYWdVom9Yp%2BZ1jHcxMaqOyf2mQUJiI0iEOt9pIYrH3MMV7xicBkHLNgDf%2Bzoiy6PusWFJ6a1xJfxVrEV7cgnl%2B7Fh%2FEl%2FOtevHK60K%2Fj9hoZXj2NfTxhIbSGfrDC1qdLsK9HzsPZWtGv0kGGq6IRsK1fN5KF7TDq31%2BrtJMraTSTaIiaX4UG2iQqP%2BpUhcYKUet7V6VSSUeYSnTe1abx7BvsrJaUno14TUvmJKn7yydVqbFWWsminimqaFlVck%2BoosGyKsSmixqW9gZj6NVpcv9G%2B0QRrxkFkZHCYOs4LxMFdPh131m4Q%2BSz5s3us3Vv6Jr9cImGWK6ppAFDRQk1rELkrCigBm%2BTIbxcIU8JQhGREe3ESTJ6zU4fSUB7XpOSRVjl89PbxFiRVrwwX5QRrUVZZfSas%2B1UQHerENstyueLd%2FlippI4Oljs1WmoTyHxiHWkQa4wiG1lO3%2BxXDP1KOTBZliIB%2BB2OOn4UzCCp2MNT4OxbZsBqc2fQnu8mW0zx9LCNudgSYNb%2BD6%2BEJraIaKhT01nexZmzLHGpEq7ywTLtP%2BFZI5g64mjNR%2BEsttVuuV2hrcw7H%2Fr3mqgs1L%2F3KoPdaxW8%2F4uOkmIqH6QzPnDzXSqMeb5%2F91Qt6053LamWIP%2FQOd%2BpahOnf5rSVG%2FsOdHuviVe7Xqm2elVfIf2O4CSf8g4j8Wt2lk%2B4%2Bsbl1bPGMfEqv8xyl%2FSBLVPnjk%2Ff6DwXdUwJLzMUFxVjnZbMnrNeIIHxDVbWpbKf8lJ9HYjn%2F0jGj9Zih3lzsk1WcFe1DZ04Raj3bhxfmQiqflQzqkf08WyviejYC%2BG%2FBiOhmRjqdsIEtP2WA950LeLAti3Ij%2F1NMKlLurG50d1At6ky8SRy5VhCgROtmDuz0JvYxBiLtUP28LnbVooHW9o9tznu5keIo3ToDYVl2uYUsuGoKfD1o2OrSHrMGiRLzsMV6Bu3Mhdv07wijiAsl%2B1MkVoeyBWnRXG7ewXcyTkV%2F8oq%2FWAdjmVKqLduZmjc7emTxAXUQD%2B%2BedAQTRqka%2FdwiBeU17uERb8llv02brSmGb6l3ikv1w7yVvpS3aTI1KixHeZd1DMhbzO%2BRtFjLwvfRZK31J12q%2B1jT%2B3SUGiaFU73dXEHXrzof4pzMPomyqWX2Vxjr5wCaLImlSdf7B5qyqzkFIvrybOHdB53%2FkhkAfFx9%2FOtupILGYC8ktIAlXANDxn2PH8OzFubMwdPwDim6CXbk%2Fp5%2BLn80TdbuU7JWVKWllRiN29dW8yonkA2pQSY2eN0qCAcja6jFJ%2FX4WHgQqp072rd9IV19Xzz15clSduvX0Atexj9rjmxHjly8Yc%2F6msvGXnRo3a5K%2FkL165srjUO6r72exDm4%2BptggpyYJqS2MA5sG2vOmsHr%2B9Zo2C3nWcGehsU2nTkZdvQ4Nkobb3bh39UhFlnUWOFq4S17VojV7KZL6%2BPQDcpYiLOEjQxCyoTDqRc2PjkJIfMQK2MaHVbM%2FzsctKUpz%2FhgfifSwX675hKEMq0xkzYkdeIjz0baI7uPswEXJNpD5I%2FxwxyVTqTB%2BomyihVRiM58zEf%2BZ%2F3yKxGI%2F6FyQz8ekWPKWh3lZ%2B%2BMC5azylOrOavoNntdR7Sfw6ytGu10%2FwppUwC4v%2FmR%2BBJkYYdcTa6fvy7s%2BgTd22ZspGeg%2BxuXENxO0lyc%2Fzi%2FL3Hh1S7jApRNeg5hIcXKboISXNGtAix5qRBkUS6VeJncN7XTJ6Ub0Ok0YSz4G3lYLJ78KF0bemof%2FXRRcOpuy2nJs7GeEWfOzc3vBc%2B4S6BCZl5R4%2BOSm89XRAstQwZQwISY%2BK9r807YVQybWDkr5theK6Dbh8rSihKTYSYmGtp20roef5O8uK%2FPT6cFuwE8zs0KH9WzSd%2F4GTfG2xNiQdkF1HCrzRHHOyFfME8WZJlAFuochk%2BKtVNGXoaOSgVy1Zcu3lDit3lG9d702TdXcpJw4KVP84ga2QH2Q%2FcAZV8U9ODObpKvITumCrze1799JTBWDk92hUQVJiJtUxoJcrohxdcQYgWLcf00LIZ0Ebs0%2FaWiIQlx52scHh2x8YBsfIsb9Jx8vJXBr%2FWl8iBBnRp8wwmTjRcQ4TxH3rRj3X%2BzA39Y0ttEn8WODOEv2xznirPxIGOHF%2BFfBiP%2BUUKgIDgs%2BiSEJIiw1PkFAUt6bLvvS2isTvaJWbp0ahD%2BLuDIY9TKXS6rIs167wXat5LnItVKlHXRF3M%2F0YCpCxauttFkluV4mVqBt3oXcorGmIeeKuEdW%2F%2BAq3iXWBSp7d46vpcPS28QOnkORDQJfryPKVMmoxG946nm9VsWrdCoaC7sp6exxEAk7FGIvgyCaIDXv6mvwtvG3f8R3NRC%2Bor3Xb%2FghicFOQe1h49b0GeRS8%2FP6bUIb%2BjYM92tQR%2B3ssGt9J35u7yFzTySmDNzugI%2BWv8JHwcS8%2BgG8sopx6vR%2FjB1Mvm6OLMgcFLX1hhZ1D16yxlhTRX8W8J%2Fe7D0zTijsw95r2HvGn97nsd4zEVUVI5zF6i098Q9PRdWR9CDmg8NRFBRIcvyxAamqmCCuK%2BbHH163TNSpjh9eNtGaIH9k4ar27yrWVK358QeXhttW3Qz%2F8EDYcVuC%2FNG5MNu%2BqQ7oxI75h3PkD0uj%2Bwd1oe%2BHJVTybpL8UXbfwieF2HW25ckf5s9A7TL1g6xI9nr8E86KCeSPcSsrbZ9%2BI41%2BI4z8ZH%2FGl9iA8hNsAPk5GvzwJTzp2jVsAj2%2BbJXzKu4Bt0esMGsZRpzJoN%2FBMukFKSdWkcRbCnnsrXMK%2F84cv5%2BwO3Ber5lTign3gxagclxD%2F%2F3CMXgb3K1bmD2hZ35fym3Zkm3t8vtS%2Fh%2Fn7mCXWTYnfHf%2BL%2FMT1L7r4iP3rPgTI9qUuy0PfmdqDCpEU1r41vCYaD%2Bj3xkgs9HEEk0Ja9%2BhiU5LCfDQt4lK1sG9O5dmpSvaQ80que%2B77B6UzGDV28NuVt0f%2BC5t1kpb0p1aVfPedzl3FRPf3W9RlzTlznv5pjNqojxUkjzYNwfV0E4phrB7%2F7xapUjenVpDoMBxnEWc36Z1DHnl7CbxOYyLzMvXJdgLTlQObe5i%2Fdfja%2BvXg0%2FVaU3U80UktwYPuHsXcu6Kf3eA8GuVRe0qsqDAV5VvKBc9e8f3s20TyPtm7RBzgGHsupMc3kWqctoKutYKOojmSUJMg12rivu4PY6AfbCFq2uxQ1ctOlpOnzj2fE7%2FQAiBqIl8KZ6C5%2BE5eDLUgOcFsLTikKHrN5mtoDn4iPZ17dUtuwAS1%2FowDWgmQWNzloKXr0bCBTEgFzt%2FATJbPI50tu8yugTbBfjHD8uLy7oXOxX%2FKUEFuM9eDRHnThw6HRTVwdhY6ylnaSxuZ4rLiG42snX9igHZhYXZCzYUotxudb%2FsH9%2Fo64FXbSBy9Wrcg36cU50GLZOndJ7i06FNw6A2HfZe3Fn0aykMK7X20iZaazAuVeIIW6UEraVyL6taKLFVz6sUSkg8zz2yxjCVEYw1erGFLrb5Aw%2B2nswkWtWHPf3qDyI5P%2FctvP6U7%2Bv%2Fvz%2B%2Fz%2BWg0bb5FC7HzMD9OXNsn9lV%2Bcwu50WVz9h5gPnH4lyPlqWzIXjFUeD4xzjtwgXx8w3wkr9j%2BzsEGrecpYdfMeTNSbt2STMSrrCbwfRzlfXvFKw5%2FwgiCgttf1dkKMeI38tzrFxBfEYo7wTIUCp9Jho7%2FOJFmEWfxXsWs4dt90h%2F%2FQAk2jn7%2FoWxOfues4thxJEj%2BDv6bKsxunL2MEa6RyVyChK%2Fq07h%2F8FS%2BvwI5l26hAfTZ6tczqJ7nIZGtAqSSUuzMrKcwvLCDWPG%2FYDKxxYWjh2zYYOtnyt8BoNs%2FszaghT%2FwWW8l32IS8hjLwzC820Pa714FhrIacXvAoGR5E6QA6X4PNTH%2FqgB7rkPqkG1fXSs5c1r7YEkEeRxkFxaSi5NwM%2F2waqOsGqf9fthOr6MWK80tcewWsHgRuf23MgLd%2FpdGDkFZ5Lwa0waOkxFfogj%2Fbzuh0MP8TG%2FpaYDADNNv3lCo%2Fv7tn35fZ%2BYGT1CZTCoEY5kWVTLZNnnfXJR3%2B%2B5fatn49%2Fxq%2FQAF38%2F5warb%2BBbc6D%2BgK4hXTp7rvaKauWVfuBpd9s5Z%2FPnxe%2B3KcW%2FH0P%2BGTVgYMnxsWI3XZtzVL1RfdxSjrpuVO%2FstUn9g7Jg45pCPg3Xgds9LSVwG7eDLbgOisTFECXKgwYxSVwS1VsqaJojVM1HuMuyKLKaOEkZZDAZBTqdS2fF6fdaDGxT8hrZb968a9eWzZuVz9XwUvmXeheXlHLAb7HSc9vW2ClmHXvVrOOSjt6%2FXzmb6SnmHnTeR%2FbWV2QoFAvcFszs3Sh%2BS0YfKn5Lpm0KtAL9YJlyw%2B7YLHMD9mxWWr%2F25UPP0dHj%2FwN%2FQuw7AHjaY2BkYGBgYnB8cXdJdzy%2FzVcGeQ4GEDj7aN1fGP3%2F%2FN8XHNM4i4FcDqBaIAAAxcgQigB42mNgZGDgLP69BkT%2BP%2F%2FfiWMaA1AEBbwEAJ7wBzgAAHjabZNNSFRRFMfPvHvf8w2tRLCFMqhRYIiYugwkFEIwMQgiKBAs0oiCwqUuBptFkILiDTcKDokOboooogKVVm4U%2BgIJ8SNokZZIiCvtd%2B8dQcsHP%2F7%2Fd9655505502wIU3CFYu%2FVJlIcF6MeiQmeiZG%2FxFT8B0%2FJSbxRUzwyXFa7xKrxj8htxW9Sq4WE9aj9twKXsFd%2FDZah66hV6CW%2FHPQTY1bvo5V3SAmLsb3kdMB1IiKiP%2BCDL6J2AvOpXjnKH6V%2BFfiOTxEg2gFSix8DRfxJWjW14z70bNwkthv6oxTJ%2Bv0pu3B9qZOUHMZXyw5zfOwEmqIf%2FBe75FPj8Gy1IZV6DvmM8uzUp8XtsEi%2BR%2FJ5Z3qR34W98ijdjjovX4Dp5gp9dSAdLsZNDL7a8SnySmHx%2FDcz10%2FII8dRDsoO9Gb%2BBY%2FexdLw4SfpfNP4QLnh2GEGvv0Ok%2Bsk7P0qdfp5yW8h0num%2F2MjiPukdt2F24PhwhS%2Bwt2F%2BiSJfopmYM9%2FEvYk9fsUewu9Ba%2BXz7buR9HnJMVt4uao6hC%2FxtVzs%2FGxUv%2Fz7NE7Wja7%2BIwbhd7iSKryZTMJQP5ZntyNWfcniT5UORA1Rl2dF0kMZSnGtb542R41ur3YbHfRtJ%2BH3fgElymloEbMEZOL3OfYy%2BcVQnuwdYN39JrFznt%2BPvUeSXmL2S9%2BN4AAAB42mNgYNCBQzeGGIYZDG8YLRhbGCcxrmM8x%2FiNiY9JjkmPyYbJh6mKaRLTIaZfzFLMHsxNzNOY77GosFixBLFksNSwTGI5w2rBGsLawbqF9RbrJzYuNiu2ELYctg62ZWw72G6wfWJXYfdg72Hfx%2F6Ng4fDgMONI4Ojg2MBxw6OUxy3ON5wMnEKcCpwxnDO4TzF%2BYvLjCuGawXXKa4n3FzcatxW3EXcM7jP8DDwmPFE8PTxbOK5wvOKl4tXizeAN4N3C%2B8R3n98BkDow9fBt4fvF78WvwP%2FJP4l%2FN8EDATCBDIEKgSuCTwR5BLUEowQ7BGcI3hB8IPgPyExIR2hCKEaoU1CH4SdhMuE5wgfEX4nYiASJTJFZI%2FID1EpUTvRFNEu0TWiF0S%2FicmIhYhNEjsjziHuJj5H%2FJb4Hwk3iRKJRRKXJJkkVSQ9JOdIPpBSk8qTOictJp0nfUGGTyZIZobMA1kNWTvZMNkC2S7Za3IKcjFyM%2BRuyBvI58n3yJ%2BS%2F6KgoOCnUKOwSuGKIpuijeIUxR2KZxS%2FYYdKbEpiSmpKJkpOSkFKSUpFSj1Ky5QOKF1T%2BqT0SZlDWQYI05QnKM9TPqH8CQDObIdLAAAAAAEAAADpAEcABQAAAAAAAgAAAAEAAQAAAEAALgAAAAB42u1UwW7TQBB9tUOkosKx4mihCnHBLYkiaCpVgiKQANGKCnp2YjexSO2ocUrLh3DmypUDX8AB%2BALEgW%2FhzfPGNEYRPXKoLO%2FOzs7Mm3kzNoAVvIePpcYy4H0CnLyEGzyVsofr3ncn%2B9j2fji5gdv%2BqpOv4NTfdnKT%2Bs9OXsZN%2F5eTV7DWmMW%2F5n1orDn5K1abX5z8DRvNn9jFMVIM%2BGaIMEKAx8gpF5hQjnibcP%2FI9yFtTFtIF%2BEIIbW7GPOU4RHOeDeifEq7Pm%2F6GNIqY%2BzExcoQa4%2F5WKxUSCXqgOsZYw1l26Mc4AH3hHrLIqZtgCfyeCefhPufDEdCtUwmXA1nKryE92YVYMflbbgn8tlhtCM%2BubwMr1B1KXGnVX4B2qx0g%2FsrnsbUHfOuxHg%2BhxriKlmKqgxKb8N%2BK683OhVch0Iao4t1PnGNu8OqAyFPecn0rQgtZnGX68X5CV2VY9qn6kXAfdYNW%2FvKJyemcZiLGfPaU4SylkBZWIyywvoc1Nm3uCd8U%2BXWUySrOZFH96%2F6czdDdR5CsTaghekGqmp94cS9lM3U8dFSz4yvLfbtGQ7wgtIi3zs178VTPW%2F3WjVNqkk5j7qHfWrsdF47pGUhPjNyFFBndyHucd0ilxGnJJHNIbUjzaL5d%2FTe5yy2sHnhOv49IfOdsG71GClRhjEx7du9%2FCNc%2FhH%2B5z%2FCAeVexdHsm9p3zD5V303b0bpJjA472OXb1jdrHLZ%2FA4UKSaYAAHjabdBHbFNBEMbx%2FySOnTi999BrKO89xyl0G9v03hJ6IIltCElwMBA6oleBkLiBaBdA9CoQcABEC00UAQfOdHEAruDwlhtz%2Benb1c6Mlij%2B1m8PBv%2BrjyBREi0WorEQgxUbscRhJ54EEkkimRRSSSOdDDLJIpsccskjnwIKKaId7elARzrRmS50pRvd6UFPiulFb%2FrQFw09Mt1BCU5KKaOcCvrRnwEMZBCDGYILN0Px4MXHMIYzgpGMYjRjGMs4xjOBiUxiMlOYyjQqqWI6M5jJLGYzh7lUSwxH2cgmbrCfD2xmNzs4wHGOiZXtvGMD%2B8QmseySOLZym%2Fdi5yAn%2BMkPfnGEUzzgHqeZx3z2UMMjarnPQ57SymOeRP6pjhc84zln8POdvbzmJa8I8JmvbGMBQRayiHoaOEQji2kiRDNhlrCUZXxiOStoYSWrWcVVDrOWNaxjPV%2F4xjXOco7rvOGtxEuCJEqSJEuKpEqapEuGZEqWZEsO57nAZa5wh4tc4i5bOCm53OSW5Ek%2BO6VACqXI6q9vaQrotnBDUNM0jxkdZnRpSo%2Bp21Cqe7dTWdGmEXmv1JWG0qEsUTqVpcoyZbnyXz%2BXqa766rq9LugPh2prqpsD5pHhM3X6LN5wqLEteNUePre5R0TjD2o8nDAAAAAAAVG8%2Fn0AAA%3D%3D) format('woff')}html.RS-BIFOCAL *{line-height:1.75!important;font-family:OpenDyslexic,serif!important}.-rdy-tag-container,body,body>article,body>div,body>section{padding-left:0!important;padding-right:0!important}.-rdy-tag-justified,li,p{text-align:left!important}"}),define("bifocal/themes/read/default/src/designs/assistive",["require","common","module","text!../../styles/designs/assistive_component.text.css","../parts/book_design","text!../../styles/designs/_reset.text.css"],function(e){var t=e("common"),n=t.assetPath(e("module"),"../../resources/fonts"),r=e("text!../../styles/designs/assistive_component.text.css").replace("<FONTDIR>",n),i=e("../parts/book_design"),s=[],o=[e("text!../../styles/designs/_reset.text.css"),r].join("\n"),u=i("OpenDyslexic","assistive",s,o);return u.scaleCorrection=function(e){return e*.95},u.options=function(){return t.element({tag:"p",html:["This book design uses the OpenDyslexic font to increase the","readability of text for readers with dyslexia. Learn more",'at <a href="http://opendyslexic.org" target="_blank">opendyslexic.org</a>.'].join(" ")})},u}),define("bifocal/themes/read/default/src/designs/diy",["require","common","../parts/quirks","../parts/book_design"],function(e){function f(e){a.font=e,u.font&&p("data-rdy-diy-font",e||"")}function l(e){a.align=e,u.align&&p("data-rdy-diy-align",e)}function c(e){a.leading=e,u.leading&&p("data-rdy-diy-leading",e)}function h(e){a.weight=e,u.weight&&p("data-rdy-diy-weight",e)}function p(e,n){var r=u.all.querySelectorAll("["+e+"]");t.each(r,function(t){var r=t.getAttribute(e)===n?"add":"remove";t.classList[r]("on")})}function d(){BIF.dispatch("bifocal:readability:bookdesign",o)}var t=e("common"),n=e("../parts/quirks"),r=e("../parts/book_design"),i=[],s=[],o=r("Custom","diy",i),u={},a={};return o.options=function(){u.all=document.createElement("div");var e=t.element({parentNode:u.all,classes:"rdy-diy-option"});t.element({parentNode:e,classes:"rdy-diy-label",html:"Font"}),u.font=t.element({tag:"ul",parentNode:e,classes:"rdy-diy-control vert"});var r={"&mdash;":""};n("plain-fonts-only")||(r.Palatino="palatino",r.Georgia="Georgia",r["Old style"]="old-style",n.ask("macosx","ios")?r.Cochin="cochin":n.ask("windows")&&(r.Constantia="constantia",r.Cambria="cambria")),r.Serif="serif",r["Sans serif"]="sans-serif",t.each(r,function(e,n){var r=t.element({tag:"li",parentNode:u.font,attributes:{"data-rdy-diy-font":n},html:e});BIF.events.onTap(r,function(){f(n),d();var e=u.font.querySelectorAll(".on");t.each(e,function(e){e.classList.remove("on")}),r.classList.add("on")})});var i="data-rdy-diy-align",s=function(e){var t=e.tappedElement,n=t.getAttribute(i);l(t.classList.contains("on")?null:n),d()},o=t.element({parentNode:u.all,classes:"rdy-diy-option"});t.element({parentNode:o,classes:"rdy-diy-label",html:"Justification"}),u.align=t.element({tag:"ul",parentNode:o,classes:"rdy-diy-control horiz"});var p=t.element({tag:"li",parentNode:u.align,classes:"rdy-diy-align-left"});p.setAttribute(i,"left"),BIF.events.onTap(p,s);var v=t.element({tag:"li",parentNode:u.align,classes:"rdy-diy-align-justify"});v.setAttribute(i,"justify"),BIF.events.onTap(v,s);var m="data-rdy-diy-leading",g=function(e){var t=e.tappedElement,n=t.getAttribute(m);c(t.classList.contains("on")?null:n),d()},y=t.element({parentNode:u.all,classes:"rdy-diy-option"});t.element({parentNode:y,classes:"rdy-diy-label",html:"Line spacing"}),u.leading=t.element({tag:"ul",parentNode:y,classes:"rdy-diy-control horiz"});var b=t.element({tag:"li",parentNode:u.leading,classes:"rdy-diy-leading-tight"});b.setAttribute(m,"tight"),BIF.events.onTap(b,g);var w=t.element({tag:"li",parentNode:u.leading,classes:"rdy-diy-leading-normal"});w.setAttribute(m,"normal"),BIF.events.onTap(w,g);var E=t.element({tag:"li",parentNode:u.leading,classes:"rdy-diy-leading-loose"});E.setAttribute(m,"loose"),BIF.events.onTap(E,g);var S="data-rdy-diy-weight",x=function(e){var t=e.tappedElement,n=t.getAttribute(S);h(t.classList.contains("on")?null:n),d()},T=t.element({parentNode:u.all,classes:"rdy-diy-option"});t.element({parentNode:T,classes:"rdy-diy-label",html:"Weight"}),u.weight=t.element({tag:"ul",parentNode:T,classes:"rdy-diy-control horiz"});var N=t.element({tag:"li",parentNode:u.weight,classes:"rdy-diy-weight-normal"});N.setAttribute(S,"normal"),BIF.events.onTap(N,x);var k=t.element({tag:"li",parentNode:u.weight,classes:"rdy-diy-weight-heavy"});return k.setAttribute(S,"heavy"),BIF.events.onTap(k,x),f(a.font),l(a.align),c(a.leading),h(a.weight),u.all},o.componentStylesheet=function(){var e=s;e+=["body, body > div, body > section, body > article, .-rdy-tag-container {","padding-left: 0 !important;","padding-right: 0 !important;","}"].join("");if(a.font){var t={"old-style":"Athelas, Baskerville, Bookman Old Style, Palatino Linotype, Cochin, serif",palatino:"Palatino Linotype, Book Antiqua, Palatino, serif",cochin:"Cochin, serif",constantia:"Constantia, serif",cambria:"Cambria, serif",georgia:"Georgia, serif",serif:"Times New Roman, serif","sans-serif":"Helvetica Neue, sans-serif"}[a.font],n=["body, body * {","font-family: "+t+" !important;","}"];e+=n.join("\n")}a.align&&(e+=["p, li, div, .-rdy-tag-justified { text-align: "+a.align+" !important; }"].join("\n"),a.align==="justify"&&(e+=["body {","-webkit-hyphens: auto;","-moz-hyphens: auto;","hyphens: auto;","}"].join("\n")));if(a.leading){var t={tight:1.1,normal:1.3,loose:1.6}[a.leading];e+="body * { line-height: "+t+" !important; }"}return a.weight=="heavy"&&(e+="body * { font-weight: bold !important; }"),e},o.serialize=function(){return["diy",a.font||"",a.align||"",a.leading||"",a.weight||""].join(":")},o.deserialize=function(e){var t=e.match(/^diy:([^:]*):([^:]*):([^:]*):?([^$]*)/);if(t)return f(t[1]),l(t[2]),c(t[3]),h(t[4]||""),!0},o}),define("bifocal/themes/read/default/src/parts/readability_tagger",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.tag=function(e){this._applyTag(e.body,"container"),t.walk(e.body,this._tagElement.bind(this))},r._tagElement=function(e){if(!e.style)return;var t=e.ownerDocument.defaultView.getComputedStyle(e);this._tagJustified(e,t),this._tagContainer(e,t)},r._tagJustified=function(e,t){t.getPropertyValue("text-align")=="justify"&&this._applyTag(e,"justified")},r._tagContainer=function(e,t){if(e.parentNode.children.length!=1)return;if(!e.children.length)return;for(var n=0,r=e.childNodes.length;n<r;++n){var i=e.childNodes[n].nodeValue;if(i&&i.match(/[^\s]/))return}this._applyTag(e,"container")},r._applyTag=function(e,t){e.classList.add("-rdy-tag-"+t)},n}),define("bifocal/themes/read/default/src/parts/font_scaler",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.PROPS=["font-size","line-height"],r.BASE_FONT_SIZE_PX=16,r.APPLIED_SCALE_PROPERTY="-bif-applied-font-scale",r.PREVALENT_SIZE_PROPERTY="-bif-prevalent-font-size",r.ELEMENT_DATA_PROPERTY="-bif-font-scale-data",r.applyScale=function(e,t,n){this._isAttachedToDocument(e)||this._attachToDocument(e);var r=e[this.PREVALENT_SIZE_PROPERTY],i=e[this.APPLIED_SCALE_PROPERTY],s=parseFloat(t);typeof n=="number"&&(s*=n/r),i!=s&&this._applyTargetScale(e,s)},r.removeScale=function(e){this._isAttachedToDocument(e)&&this._detachFromDocument(e)},r._applyTargetScale=function(e,n){var r=this.BASE_FONT_SIZE_PX*n+"px";t.each(this.PROPS,function(t){e.documentElement.style.setProperty(t,r)}),e[this.APPLIED_SCALE_PROPERTY]=n},r._isAttachedToDocument=function(e){return e[this.PREVALENT_SIZE_PROPERTY]?!0:!1},r._attachToDocument=function(e){this._.walkData={elements:[],sizes:{}},t.walk(e.documentElement,this._attachToNode.bind(this));var n={fontSize:0,count:0};t.each(this._.walkData.sizes,function(e,t){t>n.count&&(n.fontSize=e,n.count=t)}),e[this.PREVALENT_SIZE_PROPERTY]=n.fontSize,t.each(this._.walkData.elements,function(e){var n=e[this.ELEMENT_DATA_PROPERTY];t.each(this.PROPS,function(t){if(!n[t])return;var r=n[t].base/this.BASE_FONT_SIZE_PX;e.style.setProperty(t,r+"rem",n[t].priority)},this)},this),this._applyTargetScale(e,1),delete this._.walkData},r._attachToNode=function(e){e.nodeType==1?this._attachToElement(e):e.nodeType==3&&this._weighTextNode(e)},r._attachToElement=function(e){if(e.getCTM||!e.style)return;var n=e.ownerDocument.defaultView.getComputedStyle(e,null),r=e[this.ELEMENT_DATA_PROPERTY]={};t.each(this.PROPS,function(t){var i=n.getPropertyValue(t);if(t=="line-height"&&!i.match(/px$/)){var s=parseFloat(i)||1.2,o=r["font-size"].base||16;i=s*o}var u=parseFloat(i);isNaN(u)||(r[t]={base:u,inline:e.style.getPropertyValue(t),priority:e.style.getPropertyPriority(t)})},this),this._.walkData.elements.push(e)},r._weighTextNode=function(e){var t=e.parentNode[this.ELEMENT_DATA_PROPERTY];if(!t)return;if(e.nodeValue.match(/^\s*$/))return;var n=t["font-size"].base;if(typeof n!="undefined"){var r=e.nodeValue.length,i=this._.walkData.sizes;i[n]=(i[n]||0)+r}},r._detachFromDocument=function(e){t.walk(e.documentElement,this._detachFromNode.bind(this)),delete e[this.PREVALENT_SIZE_PROPERTY],delete e[this.APPLIED_SCALE_PROPERTY]},r._detachFromNode=function(e){var n=e[this.ELEMENT_DATA_PROPERTY];if(!n)return;var r=e;t.each(n,function(e,t){t.inline?r.style.setProperty(e,t.inline,t.priority):r.style.removeProperty(e)}),delete r[this.ELEMENT_DATA_PROPERTY]},n}),define("text!bifocal/themes/read/default/styles/designs/_generic_lighting_reader.text.css",[],function(){return'.data-lighting_bright .rdy-preview-box,.data-lighting_bright .sheet{background-color:#FFF!important}.data-lighting_dark .rdy-preview-box,.data-lighting_dark .sheet{background-color:#000!important}.data-lighting_dark .book-portal>.page-ghost,.data-lighting_dark .sheet>.page-ghost{background-image:url("data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA4MDAgNDgnPjxnIGZpbGw9JyMyOTI5MjknIGZpbGwtcnVsZT0nZXZlbm9kZCc%2BPHJlY3QgeD0nNzAnIHk9JzAnIHdpZHRoPSc2NjAnIGhlaWdodD0nMjInIHJ4PScxMScvPjwvZz48L3N2Zz4%3D")}.data-lighting_dark .jumping-jack-flash{background-color:#000}.data-lighting_dark .book-layer{border-color:#000}.mea.data-lighting_dark .book-bounds{border-color:#333}.data-lighting_dark body{background:#000!important}.data-lighting_dark body,.data-lighting_dark body a{color:#999}.data-lighting_sepia .book-layer,.data-lighting_sepia .book-surface,.data-lighting_sepia .jumping-jack-flash,.data-lighting_sepia .menu-bar,.data-lighting_sepia .rdy-preview-box,.data-lighting_sepia .read-header,.data-lighting_sepia .sheet{background:#FBF3E6!important}.data-lighting_sepia .book-layer{border-color:#FBF3E6}.data-lighting_sepia .rdy-preview-shield:before{color:#A98}.data-lighting_sepia .book-portal>.page-ghost,.data-lighting_sepia .sheet>.page-ghost{background-image:url("data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA4MDAgNDgnPjxnIGZpbGw9JyNGM0U2RDAnIGZpbGwtcnVsZT0nZXZlbm9kZCc%2BPHJlY3QgeD0nNzAnIHk9JzAnIHdpZHRoPSc2NjAnIGhlaWdodD0nMjInIHJ4PScxMScvPjwvZz48L3N2Zz4%3D")}.data-lighting_dark .orient-film{-webkit-font-smoothing:antialiased;color:#DDD}.data-lighting_dark .orient-film svg .icon-hollow{stroke:#999}.data-lighting_dark .orient-film svg .icon-solid{fill:#999}.data-lighting_dark .orient-board,.data-lighting_dark .orient-orb-shadow{border-color:#333;color:#999;background-color:#090909}.data-lighting_dark .orient-orb{background-color:#090909;border-color:#090909}.data-lighting_dark .orient-orb img{-webkit-filter:grayscale(1);filter:grayscale(1)}.data-lighting_dark .orient-surface{background:#101010}.data-lighting_dark .orient-midpoint:empty{border-left-color:#090909;border-right-color:#222}.data-lighting_dark .seekometer-needle,.data-lighting_dark .seekometer-ribbon{background-color:#484848}.data-lighting_dark .seekometer-landmark-chapter{background:#EEE}.data-lighting_dark .pagination-progress{color:#676767}.hug-t{border-top-color:#FFF}.hug-r{border-right-color:#FFF}.hug-b{border-bottom-color:#FFF}.hug-l{border-left-color:#FFF}.data-lighting_dark .hug-t{border-top-color:#000}.data-lighting_dark .hug-r{border-right-color:#000}.data-lighting_dark .hug-b{border-bottom-color:#000}.data-lighting_dark .hug-l{border-left-color:#000}.data-lighting_sepia .hug-t{border-top-color:#FBF3E6}.data-lighting_sepia .hug-r{border-right-color:#FBF3E6}.data-lighting_sepia .hug-b{border-bottom-color:#FBF3E6}.data-lighting_sepia .hug-l{border-left-color:#FBF3E6}'}),define("text!bifocal/themes/read/default/styles/designs/_generic_lighting_component.text.css",[],function(){return".data-lighting_bright *{color:#000!important;border-color:#000!important;background-color:transparent!important}.data-lighting_dark *{color:#999!important;border-color:#BBB!important;background-color:transparent!important}.data-lighting_sepia *{color:#410;border-color:#410!important;background-color:transparent!important}"}),define("bifocal/themes/read/default/src/parts/readability_manager",["require","common","./book_design","./readability_tagger","./font_scaler","./sheet_anchor","text!../../styles/designs/_generic_lighting_reader.text.css","text!../../styles/designs/_generic_lighting_component.text.css"],function(e){var t=e("common"),n=e("./book_design"),r=e("./readability_tagger"),i=e("./font_scaler"),s=e("./sheet_anchor"),o=t.Class.new(),u=o.prototype;return u.TAGGER_ENABLED=!1,u.BANK_KEY="rdby",u.ALLOW_SCALING=!0,u.ALLOW_LIGHTING=!0,u.ALLOW_BOOK_DESIGNS=!0,u.DEFAULT_BOOK_DESIGN=null,u.STYLESHEET_LIGHTING_READER=e("text!../../styles/designs/_generic_lighting_reader.text.css"),u.STYLESHEET_LIGHTING_COMPONENT=e("text!../../styles/designs/_generic_lighting_component.text.css"),u.$init=function(){this._.tagger=new r,this._.fontScaler=new i,this._.sheetAnchor=new s,this._.previewFrames=[],this._initializeAbilities(),this.fontScale=1,this.lighting=null,this.bookDesign=null,BIF.context&&BIF.context.scene?this._configureScene():BIF.listen("bifocal:context:scene",this._configureScene.bind(this))},u.addPreviewFrame=function(e){this._.previewFrames.push(e),this._applyToPreviewFrame(e)},u.enable=function(){var e=!1;t.each(this.abilities,function(t,n){if(n)return;this.abilities[t]=!0,e=!0},this),e&&(this.commit(!0),BIF.dispatch("bifocal:readability:enabled",{manager:this}))},u.disable=function(){var e=!1;t.each(this.abilities,function(t,n){if(!n)return;this.abilities[t]=!1,e=!0},this),e&&(this.commit(!0),BIF.dispatch("bifocal:readability:disabled",{manager:this}))},u.commit=function(e){if(this._save()||e)this._setTextScaleDataOnScene(),this._applyToDocuments(),BIF.context.scene.rebuild()},u._initializeAbilities=function(){var e=BIF.objects.codex.fullyPrepaginated();this.abilities={},this.abilities.scaling=this.ALLOW_SCALING&&!BIF.map["-bifocal-disable-scaling"]&&!e,this.abilities.lighting=this.ALLOW_LIGHTING&&!BIF.map["-bifocal-disable-lighting"],this.abilities.bookDesign=this.ALLOW_BOOK_DESIGNS&&!BIF.map["-bifocal-disable-book-designs"]&&!e},u._configureScene=function(){this._load(),this._setTextScaleDataOnScene(),this._applyToWorld(),BIF.listen("lens:scene:factors",this._onSceneFactors.bind(this)),BIF.listen("bifocal:mode:resizing",this._onSceneResizing.bind(this)),BIF.listen("lens:component:stylize",this._onComponentStylize.bind(this)),BIF.listen("bifocal:readability:fontscale",this._onFontScale.bind(this)),BIF.listen("bifocal:readability:lighting",this._onLighting.bind(this)),BIF.listen("bifocal:readability:bookdesign",this._onBookDesign.bind(this)),BIF.dispatch("bifocal:readability:ready",{manager:this})},u._onSceneFactors=function(e){var t=[this.abilities.scaling?"y":"n",this.abilities.lighting?"y":"n",this.abilities.bookDesign?"y":"n"].join();e.m.factors.dub[this.BANK_KEY]=this._.serial+","+t},u._onSceneResizing=function(e){var t=this._setTextScaleDataOnScene();BIF.context.spine.each(function(e){if(this._isApplicableToComponent(e)){var n=e.frameBox.contentDocument;this._.fontScaler.applyScale(n,t[0],t[1])}}.bind(this))},u._onComponentStylize=function(e){var t=e.m.component;this.TAGGER_ENABLED&&this._isApplicableToComponent(t)&&this._.tagger.tag(t.frameBox.contentDocument),this._applyToComponent(t)},u._onFontScale=function(e){this.fontScale!==e.m&&(this.fontScale=e.m,this._applyToDocuments())},u._onLighting=function(e){this.lighting!==e.m&&(this.lighting=e.m,this._applyToDocuments())},u._onBookDesign=function(e){this.bookDesign=e.m,this._applyToDocuments()},u._applyToDocuments=function(){var e={styles:this._readabilityStylesheets(),correction:this._scaleCorrection()};this._applyToWorld(e),t.each(this._.previewFrames,function(t){this._applyToPreviewFrame(t,e)},this),BIF.context.spine.each(function(t){this._applyToComponent(t,e)}.bind(this))},u._applyToWorld=function(e){this._applyToDocument(document,t.absorb(e,{sheets:["reader"]}))},u._applyToPreviewFrame=function(e,n){this._applyToDocument(e.contentDocument,t.absorb(n,{sheets:["reader","component"],scaling:!0}))},u._applyToComponent=function(e,n){this._isApplicableToComponent(e)&&this._applyToDocument(e.frameBox.contentDocument,t.absorb(n,{sheets:["component"],scaling:!0}))},u._applyToDocument=function(e,n){if(!e)return;var r=e.documentElement,i=n.styles||this._readabilityStylesheets();if(n.scaling&&this.abilities.scaling){var s=n.correction||this._scaleCorrection();this._.fontScaler.applyScale(e,this.fontScale,s)}else this._.fontScaler.removeScale(e);this.lighting&&this.abilities.lighting?t.DataClass.set(r,"lighting",this.lighting):t.DataClass.set(r,"lighting","neutral"),t.each(n.sheets,function(t){this._.sheetAnchor.applyStyleRules(e,"lighting_"+t,i.lighting[t])},this);var o=this._trueBookDesign();t.each(n.sheets,function(t){this._.sheetAnchor.applyStyleRules(e,"design_"+t,i.bookDesign[t])},this),t.DataClass.set(r,"bookdesign",o.machineName)},u._isApplicableToComponent=function(e){return e&&e.isLoaded()&&e.block.layout=="reflowable"},u._scaleCorrection=function(){var e=window.innerWidth<600||window.innerHeight<600?18:24,t=this._trueBookDesign();return typeof t.scaleCorrection=="function"&&(e=t.scaleCorrection(e)),e},u._readabilityStylesheets=function(){var e=this._trueBookDesign();return{lighting:{reader:this.STYLESHEET_LIGHTING_READER,component:this.STYLESHEET_LIGHTING_COMPONENT},bookDesign:{reader:e.readerStylesheet(),component:e.componentStylesheet()}}},u._trueBookDesign=function(){return this.abilities.bookDesign&&this.bookDesign?this.bookDesign:this._.noopDesign=this._.noopDesign||this._loadBookDesignFromRepresentation("publisher:0")},u._setTextScaleDataOnScene=function(){return BIF.context.scene.textScaleData=[this.fontScale,this._scaleCorrection()]},u._save=function(){var e=this._serialize();return BIF.bank.global.set(this.BANK_KEY,e),e!==this._.serial?(this._.serial=e,!0):!1},u._load=function(){this._.serial=BIF.bank.global.get(this.BANK_KEY),this._.serial?this._deserialize(this._.serial):(this._deserialize(""),this._.serial=this._serialize())},u._serialize=function(){return[this.fontScale,this.lighting?this.lighting:"",this.bookDesign?this.bookDesign.serialize():""].join(",")},u._deserialize=function(e){var t=e.split(/,/);this.fontScale=parseFloat(t.shift())||1,this.lighting=t.shift()||null,this.bookDesign=this._loadBookDesignFromRepresentation(t.shift());if(!this.bookDesign){var r=n.REGISTRY;r.length||console.warn("[RDY] No book designs found in the registry.");var i=this.DEFAULT_BOOK_DESIGN||r[0].serialize();this._.noopDesign=this._loadBookDesignFromRepresentation(i)}},u._loadBookDesignFromRepresentation=function(e){if(!e)return;var t=n.REGISTRY;for(var r=0,i=t.length;r<i;++r)if(t[r].deserialize(e))return t[r]},o}),define("text!bifocal/themes/read/default/resources/quotes.text.json",[],function(){return'[\n  {\n    "text": "What an unreliable thing is timeâwhen I want it to fly, the hours stick to me like glue.<a href=\'#\'>*</a> And what a changeable thing, too. Time is the twine to tie our lives into parcels of years and months. Or a rubber band stretched to suit our fancy.",\n    "title": "A Fine Balance",\n    "author": "Rohinton Mistry",\n    "url": "https://www.overdrive.com/media/211418/a-fine-balance",\n    "buid": "a3917e8a219176e025a937b013a664e9"\n  },\n  {\n    "text": "I believe that life is a game, that life is a cruel joke,<a href=\'#\'>*</a> and that life is what happens when youâre alive and that you might as well lie back and enjoy it.",\n    "title": "American Gods",\n    "author": "Neil Gaiman",\n    "url": "https://www.overdrive.com/media/577443/american-gods",\n    "buid": "cf021293e32aae75addeb68cccb53744"\n  },\n  {\n    "text": "Maybe the truth is, thereâs a little bit of loser in all of us.<a href=\'#\'>*</a> Being happy isnât having everything in your life be perfect. Maybe itâs about stringing together all the little things.",\n    "title": "The Sisterhood of the Traveling Pants",\n    "author": "Ann Branshares",\n    "url": "https://www.overdrive.com/media/20521/the-sisterhood-of-the-traveling-pants",\n    "buid": "3702ec2212732a7992a779378c5b3af7"\n  },\n  {\n    "text": "He saw things in a way that others did not, so that a city<a href=\'#\'>*</a> I had lived in all my life seemed a different place, so that a woman became beautiful with the light on her face.",\n    "title": "Girl With A Pearl Earring",\n    "author": "Tracy Chevalier",\n    "url": "https://www.overdrive.com/media/125977/girl-with-a-pearl-earring",\n    "buid": "18acc34621a11e34d802cce5942b9aff"\n  },\n  {\n    "text": "Without a driver this bus is lost. Our lives are over.<a href=\'#\'>*</a> Come aboard if your destination is oblivionâ It should be our next stop. We can sit together. You can have the window seat, if you want.",\n    "title": "Life of Pi",\n    "author": "Yann Martel",\n    "url": "https://www.overdrive.com/media/573797/life-of-pi",\n    "buid": "3dfbfc238f470c5bae0f3c16c9651bcf"\n  },\n  {\n    "text": "No one wants to admit weâre addicted to music. Thatâs just not possible.<a href=\'#\'>*</a> No oneâs addicted to music and television and radio. We just need more of it, more channels, a larger screen, more volume.",\n    "title": "Lullaby",\n    "author": "Chuck Palahniuk",\n    "url": "https://www.overdrive.com/media/60536/lullaby",\n    "buid": "dbf9ca334d58ce251ed05c80aa229cc7"\n  },\n  {\n    "text": "I had jumped off the edge, and then, at the very last moment,<a href=\'#\'>*</a> something reached out and caught me in midair. That something is what I define as love. It is the one thing that can stop a man from falling, powerful enough to negate the laws of gravity.",\n    "title": "Moon Palace",\n    "author": "Paul Auster",\n    "url": "https://www.overdrive.com/media/636399/moon-palace",\n    "buid": "302e579e72a4626569e4e1b0245fbb87"\n  },\n  {\n    "text": "I always think of each night as a song. Or each moment as a song.<a href=\'#\'>*</a> But now Iâm seeing we donât live in a single song. We move from song to song, from lyric to lyric, from chord to chord. There is no ending here. Itâs an infinite playlist.",\n    "title": "Nick & Norah\'s Infinite Playlist",\n    "author": "David Leviathan",\n    "url": "https://www.overdrive.com/media/148478/nick-norahs-infinite-playlist",\n    "buid": "d3d38f0e2b04ccfa27004a3ab06289ac"\n  },\n  {\n    "text": "The words were on their way, and when they arrived,<a href=\'#\'>*</a> she would hold them in her hands like the clouds, and she would wring them out like the rain.",\n    "title": "The Book Thief",\n    "author": "Markus Zusak",\n    "url": "https://www.overdrive.com/media/347660/the-book-thief",\n    "buid": "a6da3b9e79949b94f88c49477049315c"\n  },\n  {\n    "text": "People aim for the stars, and they end up like goldfish in a bowl.<a href=\'#\'>*</a> I wonder if it wouldnât be simpler just to teach children right from the start that life is absurd.",\n    "title": "The Elegance of the Hedgehog",\n    "author": "Muriel Barbery",\n    "url": "https://www.overdrive.com/media/584920/the-elegance-of-the-hedgehog",\n    "buid": "f0f628258e891709ca0d5a473e9ce17c"\n  },\n  {\n    "text": "They wore blouses with buttons down the front<a href=\'#\'>*</a> that suggested the possibilities of the word undone. These women could be undone; or not. They seemed to be able to choose.",\n    "title": "The Handmaid\'s Tale",\n    "author": "Margaret Atwood",\n    "url": "https://www.overdrive.com/media/574458/the-handmaids-tale",\n    "buid": "df8fe69f555a4d899a2a46ed5936e2dd"\n  },\n  {\n    "text": "Standing on the fringes of life offers a unique perspective.<a href=\'#\'>*</a> But there comes a time to see what it looks like from the dance floor.",\n    "title": "The Perks of Being a Wallflower",\n    "author": "Stephen Chbosky",\n    "url": "https://www.overdrive.com/media/353685/the-perks-of-being-a-wallflower",\n    "buid": "77bb8b5361d29fc1d3f50a9c82f3c333"\n  },\n  {\n    "text": "Parents are apt to see no injustice in the fact that they are often<a href=\'#\'>*</a> annoyed with their offspring for possessing attributes, both of character and appearance, with which they themselves have endowed them.",\n    "title": "The Rosary",\n    "author": "Florence Barclay",\n    "url": "https://www.overdrive.com/media/78989/the-rosary",\n    "buid": "c8a06bcea2f0f863c04791bc42981cdf"\n  },\n  {\n    "text": "Spinners take out the bad stuff, leave in the good.<a href=\'#\'>*</a> Iâve always thought how nice it would be to have spinners like this for human beings. Just toss them in and let the spinner do its work.",\n    "title": "The Secret Life of Bees",\n    "author": "Sue Monk Kidd",\n    "url": "https://www.overdrive.com/media/204691/the-secret-life-of-bees",\n    "buid": "d7d7b27ecf0a7da0cdb251412ca17ff8"\n  },\n  {\n    "text": "There are all kinds of silences and each of them means a different thing.<a href=\'#\'>*</a> There is the silence that comes with morning in a forest, and this is different from the silence of a sleeping city.",\n    "title": "West With the Night",\n    "author": "Beryl Markham",\n    "url": "https://www.overdrive.com/media/1006698/west-with-the-night",\n    "buid": "cfa814f4d677b22afa2988ee64059fee"\n  }\n]\n'}),define("bifocal/themes/read/default/src/parts/panel_rdy",["require","./panel_abstract","common","./slider","./book_design","text!../../resources/quotes.text.json"],function(e){var t=e("./panel_abstract"),n=e("common"),r=e("./slider"),i=e("./book_design"),s=t.new(),o=s.prototype;return o.TITLE="Reading Settings",o.ID="rdy",o.COVER_URL="https://covers-read.svc.overdrive.com/cover/buid/<BUID>/ph.jpg",o.QUOTES=JSON.parse(e("text!../../resources/quotes.text.json")),o.QUOTE=o.QUOTES[Math.floor(Math.random()*o.QUOTES.length)],o.TEXT_SCALE_STEPS=[.75,.85,.9,.95,1,1.05,1.1,1.2,1.3,1.5,1.7,1.9],o.$init=function(e){this.manager=e,t.prototype.$init.call(this);var n=this._updateAvailabilities.bind(this);BIF.listen("bifocal:readability:disabled",n),BIF.listen("bifocal:readability:enabled",n)},o._innerLayout=function(e){this._populateControls(e),this._updateAvailabilities()},o._populateControls=function(e){e.classList.add("rdy-container"),this._.previewBox=n.element({parentNode:e.parentNode,classes:"rdy-preview-box"}),this._.previewShield=n.element({parentNode:this._.previewBox,classes:"rdy-preview-shield"}),this._.previewFrame=n.element({tag:"iframe",attributes:{width:"100%",frameborder:"0",scrolling:"no",src:"about:blank"}}),this._.previewFrame.onload=this._populatePreview.bind(this),this._.previewShield.appendChild(this._.previewFrame);var t=n.element({parentNode:this._.previewBox,classes:"rdy-preview-citation"});if(this.QUOTE.buid)var s=this.COVER_URL.replace("<BUID>",this.QUOTE.buid),o=n.element({tag:"div",parentNode:t,classes:"rdy-preview-cover",attributes:{style:"background-image: url("+s+");"}});var u=n.element({parentNode:t,classes:"rdy-preview-biblio"}),a=n.element({tag:"a",parentNode:u,html:this.QUOTE.title,attributes:{href:this.QUOTE.url,target:"_blank"}});if(this.QUOTE.author)var f=n.element({tag:"span",parentNode:u,html:this.QUOTE.author});BIF.events.onTap(this._.previewShield,this._togglePreviewBox.bind(this)),this._.scalingControl=this._section("Text scale","rdy-text-scale"),this._.scalingSlider=new r(this._.scalingControl,this.TEXT_SCALE_STEPS.length,this.TEXT_SCALE_STEPS.indexOf(this.manager.fontScale),this._onScalingChange.bind(this)),this._explainUnavailability(this._.scalingControl),this._.lightingControl=this._section("Lighting","rdy-lighting"),this._.lightingOptions=n.element({parentNode:this._.lightingControl,classes:"rdy-lighting-options"}),this._createLightingControl("bright",this._.lightingOptions),this._createLightingControl("sepia",this._.lightingOptions),this._createLightingControl("dark",this._.lightingOptions),this._explainUnavailability(this._.lightingControl),this._.bookDesignControl=this._section("Book design","rdy-book-design"),n.each(i.REGISTRY,function(e){var t=n.element({parentNode:this._.bookDesignControl,classes:"rdy-book-design-button",attributes:{"data-book-design-name":e.machineName}}),r=n.element({parentNode:t,classes:"rdy-book-design-label menu-panel-row",html:e.humanName});BIF.events.onTap(r,this._onTapBookDesign.bind(this));var i=e.options();if(i){var s=n.element({parentNode:t,classes:"rdy-book-design-options"});s.appendChild(i),t.classList.add("rdy-book-design-has-options")}this.manager.bookDesign===e&&t.classList.add("on")}.bind(this)),this._explainUnavailability(this._.bookDesignControl)},o._section=function(e,t){var r=n.element({parentNode:this._.parts.body,classes:"rdy-section "+t}),i=n.element({tag:"div",parentNode:r,classes:"rdy-label-container"}),s=n.element({tag:"h3",parentNode:i,classes:"rdy-label",html:e});return r},o._explainUnavailability=function(e,t){var r=n.element({parentNode:e,classes:"rdy-section-unavailability"}),i=n.element({tag:"p",parentNode:r,html:t||"Not available for this book."});return r},o._updateAvailabilities=function(){var e=this.manager.abilities,t=e.scaling?"remove":"add";this._.scalingControl.classList[t]("disabled"),t=e.lighting?"remove":"add",this._.lightingControl.classList[t]("disabled"),t=e.bookDesign?"remove":"add",this._.bookDesignControl.classList[t]("disabled")},o._populatePreview=function(){var e=this._.previewFrame.contentDocument;typeof window._SHIM_addClassListToView=="function"&&window._SHIM_addClassListToView(e.defaultView),e.querySelector("head").innerHTML="<base href="+location.href+" />",e.documentElement.classList.add("RS-BIFOCAL"),e.documentElement.style.margin="0 16px 0 22px",e.documentElement.style.overflow="auto",e.documentElement.style.fontSize="11pt",e.body.classList.add("reflowable"),e.body.innerHTML='<p style="line-height:1.4">'+this.QUOTE.text+"</p>";var t=e.body.querySelectorAll("a");n.each(t,function(e){e.style["text-decoration"]="none"}),this.manager.addPreviewFrame(this._.previewFrame),setTimeout(this._resizePreviewFrame.bind(this),50)},o._createLightingControl=function(e,t){var r=this.manager.lighting===e,i=n.element({parentNode:t,classes:"rdy-lighting-control rdy-lighting-"+e+(r?" on":""),attributes:{"data-rdy-lighting":e},html:"<div></div><span>"+n.capitalize(e)+"</span>"});return BIF.events.onTap(i,this._toggleLightingCtrl.bind(this)),i},o._onScalingChange=function(e){clearTimeout(this._.scalingTimer),this._.scalingValue=this.TEXT_SCALE_STEPS[e],this._.scalingTimer=setTimeout(this._updateTextScale.bind(this),100)},o._updateTextScale=function(){this._reconfigure("fontscale",this._.scalingValue),BIF.objects.activity.record("readability-scale",{scale:this._.scalingValue},!0)},o._toggleLightingCtrl=function(e){var t=null,r="data-rdy-lighting",i=document.querySelectorAll("div["+r+"]");n.each(i,function(n){var i=n.getAttribute(r);n==e.tappedElement?(n.classList.toggle("on"),i=n.classList.contains("on")?i:null,t=i):n.classList.remove("on")}.bind(this)),this._reconfigure("lighting",t),BIF.objects.activity.record("readability-lighting",{lighting:t})},o._onTapBookDesign=function(e){BIF.events.stop(e);var t=e.tappedElement.parentNode,n=t.getAttribute("data-book-design-name"),r=i.byName(n);this._setBookDesign(r)},o._setBookDesign=function(e){var t="data-book-design-name";n.each(document.querySelectorAll("div["+t+"]"),function(n){n.classList.remove("on"),n.getAttribute(t)==e.machineName&&n.classList.add("on")}),this._reconfigure("bookdesign",e),BIF.objects.activity.record("readability-bookdesign",{design:e.machineName})},o._reconfigure=function(e,t){BIF.dispatch("bifocal:readability:"+e,t),setTimeout(this._resizePreviewFrame.bind(this),50)},o._togglePreviewBox=function(){this._.previewBox.classList.toggle("open")?this._.parts.panelDone.innerHTML="Back":this._.parts.panelDone.innerHTML="Done"},o._resizePreviewFrame=function(){var e=this._.previewFrame.contentDocument;e&&(this._.previewFrame.style.removeProperty("height"),this._.previewFrame.style.setProperty("height",e.body.scrollHeight+"px"))},o._onTapDone=function(e){this._.previewBox.classList.contains("open")?this._togglePreviewBox():t.prototype._onTapDone.call(this,e)},o._onClose=function(){this._.previewBox.classList.contains("open")&&this._togglePreviewBox()},s}),define("bifocal/themes/read/default/src/features/readability",["require","../parts/book_design","../designs/publisher","../designs/legible","../designs/scholarly","../designs/bookish","../designs/assistive","../designs/diy","../parts/readability_manager","../parts/panel_rdy"],function(e){return function(t){return t.runSheet.append(["bifocal:reveal","loadBookDesigns"],["bifocal:reveal","loadReadabilityManager"],["bifocal:readability:ready","loadReadabilityPanel"]),t.loadBookDesigns=function(){var t=e("../parts/book_design");t.REGISTRY.push(e("../designs/publisher")),t.REGISTRY.push(e("../designs/legible")),t.REGISTRY.push(e("../designs/scholarly")),t.REGISTRY.push(e("../designs/bookish")),t.REGISTRY.push(e("../designs/assistive")),t.REGISTRY.push(e("../designs/diy"))},t.loadReadabilityManager=function(){var t=e("../parts/readability_manager");BIF.objects.readabilityManager=new t},t.loadReadabilityPanel=function(t){var n=e("../parts/panel_rdy");BIF.objects.panelRdy=new n(t.m.manager),BIF.objects.menuList.addPanel(BIF.objects.panelRdy);var r=function(){t.m.manager.commit()};BIF.listen("bifocal:jumping",r),BIF.listen("bifocal:menuing:close",r)},!0}}),define("bifocal/themes/read/default/src/parts/offline_cache_state",["require","common","cookies"],function(e){var t=e("common"),n=e("cookies"),r=t.Class.new(),i=r.prototype;return i.IFRAME_URL="/_d/offline-cache",i.CHANGE_URL="/_d/offline-cache",i.BANK_KEY="offlinecachestate",i.$init=function(e){this._.parts={container:e},this._restore(),this.now||(this.now="uncached",this.progress=0,this.totalBytes=0,this.refresh()),this._listen()},i.changePreference=function(e){this.now="pending";var t=new XMLHttpRequest;t.onreadystatechange=function(){t.readyState==4&&this.refresh()}.bind(this),t.open("POST",this.CHANGE_URL,!0),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send("cache="+e)},i.refresh=function(){this.now="pending",this.progress=0,this._.parts.frame?this._.parts.frame.contentWindow.location.reload(!0):this._.parts.frame=t.iframe({parentNode:this._.parts.container,src:this.IFRAME_URL,classes:"offline-cache-state"})},i._save=function(){BIF.bank.title.set(this.BANK_KEY,{now:this.now,progress:this.progress,totalBytes:this.totalBytes})},i._restore=function(){var e=BIF.bank.title.get(this.BANK_KEY);e&&(this.now=e.now,this.progress=e.progress,this.totalBytes=e.totalBytes)},i._listen=function(){BIF.listen(window,"message",this._onWindowMessage.bind(this)),BIF.listen("bifocal:expired",this.refresh.bind(this))},i._cookieState=function(){var e=n.get("cache-manifest");return{Y:"enabled",N:"disabling"}[e]||"disabled"},i._onWindowMessage=function(e){var t;try{t=JSON.parse(e.data)}catch(n){return}if(!t||!t.name)return;var r=t.name.match(/^bifocal:offlinecache:(\w+)$/);r&&(delete t.name,this._onOfflineCacheMessage(r[1],t))},i._onOfflineCacheMessage=function(e,t){if(this.now=="pending"&&e!="greeting")return;e=="greeting"?(this.now="checking",this.progress=0,this.totalBytes=t.totalBytes):e=="progress"?(this.now="downloading",this.progress=t.percent):e=="uncached"?(this.now="uncached",this.progress=0,this._save()):e=="cached"?(this.now="cached",this.progress=1,this._save()):e=="error"?this.now="error":(this.now=e,this.progress=0),BIF.dispatch("bifocal:offlinecachestate",this)},r}),define("bifocal/themes/read/default/src/parts/panel_olc",["require","./panel_abstract","common","./spinner","./offline_cache_state"],function(e){var t=e("./panel_abstract"),n=e("common"),r=e("./spinner"),i=e("./offline_cache_state"),s=t.new(),o=s.prototype;return o.TITLE="Offline Access",o.ID="olc",o.CHANGE_URL="/_d/offline-cache",o.PENDING_ABORT_DELAY_MS=3e3,o.$init=function(e){t.prototype.$init.call(this,e),this.state=new i(document.body),BIF.listen("bifocal:offlinecachestate",this.update.bind(this)),BIF.listen(window,"offline",this._onOffline.bind(this)),BIF.listen(window,"online",this._onOnline.bind(this)),BIF.listen(applicationCache,"noupdate",this._onNoUpdate.bind(this)),this._mode("pending"),this.update()},o.update=function(){var e=this.state.now,t;if(!navigator.onLine)t="offline";else{if(e=="checking")return;e=="downloading"?t="progress":e=="error"?this._onError():t=e}t&&t!=this.mode&&this._mode(t),this._setProgress(this.state.progress)},o._innerLayout=function(e){this.state=BIF.objects.offlineCacheState,this._.parts.box=n.element({parentNode:e,classes:"panel-olc"}),this._.parts.section=n.element({parentNode:this._.parts.box,classes:"panel-olc-section"}),this._.parts.byteSize=n.element({parentNode:this._.parts.box,classes:"panel-olc-byte-size"})},o._mode=function(e){this.mode=e,n.DataClass.set(this._.parts.box,"mode",this.mode),this._.parts.section.innerHTML="",this._.parts.mode={},this["_"+this.mode+"Mode"](this._.parts.section,this._.parts.mode)},o._pendingMode=function(e,t){delete e.spinner,r.install(e),t.abortButton=n.element({parentNode:e,classes:"panel-olc-text-button",html:"Cancel"}),BIF.events.onTap(t.abortButton,this._onTapAbortPending.bind(this)),this._armAbortPendingButton(t.abortButton)},o._uncachedMode=function(e,t){t.startButton=n.element({parentNode:e,classes:"panel-olc-box-button",html:"Start Download"}),t.message=n.element({parentNode:e,classes:"panel-olc-message",html:["This book will download to your&nbsp;browser,","so that you can access&nbsp;it when you are not","connected to the&nbsp;internet."].join(" ")}),BIF.events.onTap(t.startButton,this._onTapStart.bind(this))},o._progressMode=function(e,t){t.progressBar=n.element({parentNode:e,classes:"panel-olc-progress-bar"}),t.progressNeedle=n.element({parentNode:t.progressBar,classes:"panel-olc-progress-needle"}),t.message=n.element({parentNode:e,classes:"panel-olc-message",html:"Downloading the book to your&nbsp;browser&hellip;"}),t.cancelButton=n.element({parentNode:e,classes:"panel-olc-text-button",html:"Cancel"}),BIF.events.onTap(t.cancelButton,this._onTapCancel.bind(this))},o._cachedMode=function(e,t){t.cachedBar=n.element({parentNode:e,classes:"panel-olc-cached-bar",html:"Downloaded"}),t.message=n.element({parentNode:e,classes:"panel-olc-message",html:["This book is downloaded to your&nbsp;browser.","You can now access&nbsp;it even when you have","no internet&nbsp;connection."].join(" ")}),t.deleteButton=n.element({parentNode:e,classes:"panel-olc-text-button",html:"Delete"}),BIF.events.onTap(t.deleteButton,this._onTapDelete.bind(this))},o._confirmMode=function(e,t){t.message=n.element({parentNode:e,classes:"panel-olc-message",html:"Are you sure you want to delete&nbsp;this&nbsp;download?"}),t.confirmButton=n.element({parentNode:e,classes:"panel-olc-text-button warning",html:"Yes"}),t.cancelButton=n.element({parentNode:e,classes:"panel-olc-text-button",html:"No"}),BIF.events.onTap(t.confirmButton,this._onConfirmDelete.bind(this)),BIF.events.onTap(t.cancelButton,this._onCancelDelete.bind(this))},o._offlineMode=function(e,t){t.offline=n.element({parentNode:e}),t.icon=n.element({parentNode:t.offline,classes:"panel-olc-offline-icon",html:"&#x2708;&#xFE0E;"}),t.message=n.element({parentNode:t.offline,classes:"panel-olc-message",html:"You are offline."}),this.state.progress<1&&(t.offline.classList.add("warning"),t.message.innerHTML=["You are offline, but some of the&nbsp;book is&nbsp;not&nbsp;downloaded."].join(" "))},o._onError=function(){this.mode!="progress"&&this._mode("progress");if(this._.parts.mode.progressBar.classList.contains("error"))return;this._.parts.mode.progressBar.classList.add("error"),this._.parts.mode.message.innerHTML=["An error occurred while attempting to download","this&nbsp;book to your&nbsp;browser."].join(" "),this._.parts.mode.cancelButton.style.display="none",this._.parts.mode.retryButton=n.element({parentNode:this._.parts.section,classes:"panel-olc-text-button",html:"Retry"}),BIF.events.onTap(this._.parts.mode.retryButton,this._onTapRetry.bind(this))},o._onTapStart=function(e){this._mode("progress"),this.state.changePreference("Y")},o._onTapCancel=function(e){this._mode("pending"),this.state.changePreference("N")},o._onTapRetry=function(e){this._mode("pending"),this.state.refresh()},o._onTapDelete=function(e){this._mode("confirm")},o._onConfirmDelete=function(e){this._mode("pending"),this.state.changePreference("N")},o._onCancelDelete=function(e){this._mode("cached")},o._onTapAbortPending=function(e){this._armAbortPendingButton(this._.parts.mode.abortButton),this.state.refresh()},o._armAbortPendingButton=function(e){e.classList.add("hide"),setTimeout(function(){e===this._.parts.mode.abortButton&&e.classList.remove("hide")}.bind(this),this.PENDING_ABORT_DELAY_MS)},o._onOffline=function(){this._mode("offline")},o._onOnline=function(){this.mode=="offline"&&this.update()},o._onNoUpdate=function(){this._mode("cached")},o._setProgress=function(e){this._.parts.mode.progressNeedle&&(this._.parts.mode.progressNeedle.style.width=e*100+"%");var t=function(e){var t=e/1048576;return Math.ceil(t*10)/10+"MB"};this.state.totalBytes<=0?this._.parts.byteSize.innerHTML="":e<=0||e>=1?this._.parts.byteSize.innerHTML=t(this.state.totalBytes):this._.parts.byteSize.innerHTML=['<span class="panel-olc-byte-box">',t(this.state.totalBytes*e),"</span>",'<span class="panel-olc-byte-sep">of</span>',t(this.state.totalBytes)].join("")},s}),define("bifocal/themes/read/default/src/features/offline_cache",["require","../parts/panel_olc"],function(e){return function(t){if(!window.applicationCache||!BIF.map["-odread-msg-offline"])return;t.runSheet.append(["bifocal:reader:ready","loadOfflineCachePanel"]),t.loadOfflineCachePanel=function(){var t=e("../parts/panel_olc");BIF.objects.panelOlc=new t,BIF.objects.menuList.addPanel(BIF.objects.panelOlc)}}}),define("bifocal/themes/read/default/src/parts/fullscreener",["require","common","./quirks"],function(e){var t=e("common"),n=e("./quirks"),r=t.Class.new(),i=r.prototype;return i.$init=function(){this.doc=document,this.elem=this.doc.documentElement,this._.swipe=null},i.isSupported=function(){return this._fullscreenSupport()},i.isFullscreen=function(){return this._fullscreenActive()},i.enter=function(){this.elem.requestFullscreen?this.elem.requestFullscreen():this.elem.msRequestFullscreen?this.elem.msRequestFullscreen():this.elem.mozRequestFullScreen?this.elem.mozRequestFullScreen():this.elem.webkitRequestFullscreen?this.elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):console.warn("Cannot enter full-screen via HTML5 API."),this._forceResize()},i.exit=function(){this.doc.exitFullscreen?this.doc.exitFullscreen():this.doc.msExitFullscreen?this.doc.msExitFullscreen():this.doc.mozCancelFullScreen?this.doc.mozCancelFullScreen():this.doc.webkitExitFullscreen?this.doc.webkitExitFullscreen():console.warn("Cannot exit full-screen via HTML5 API."),this._forceResize()},i.toggle=function(){this.isFullscreen()?this.exit():this.enter()},i.swipeClient=function(){return{onContactStart:this._onContactStart.bind(this),onContactMove:this._onContactMove.bind(this),onContactEnd:this._onContactEnd.bind(this),onContactCancel:this._onContactCancel.bind(this),options:{priority:!0,multitouch:!0}}},i._onContactStart=function(e){this._.swipe=null;var t=e.originalEvent;return t.contactPointers.length==2?(this._.swipe={y:[t.contactPointers[0].clientY,t.contactPointers[1].clientY],dir:0,on:!1},!0):!1},i._onContactMove=function(e){var t=e.originalEvent;if(!this._.swipe||t.contactPointers.length!=2)return!1;var n=[t.contactPointers[0].clientY,t.contactPointers[1].clientY];if(this._.swipe.dir==1)this._.swipe.on=n[0]<=this._.swipe.y[0]&&n[1]<=this._.swipe.y[1];else if(this._.swipe.dir==2)this._.swipe.on=n[0]>=this._.swipe.y[0]&&n[1]>=this._.swipe.y[1];else{var r=10;n[0]<this._.swipe.y[0]-r&&n[1]<this._.swipe.y[1]-r?(this._.swipe.dir=1,this._.swipe.on=!0):n[0]>this._.swipe.y[0]+r&&n[1]>this._.swipe.y[1]+r&&(this._.swipe.dir=2,this._.swipe.on=!0)}return!0},i._onContactEnd=function(e){if(this._.swipe&&this._.swipe.on)return this._.swipe.dir==1?this.enter():this._.swipe.dir==2&&this.exit(),!0},i._onContactCancel=function(e){this._.swipe=null},i._fullscreenSupport=function(){return n.ask("silk")?!1:this.elem.requestFullscreen||this.elem.msRequestFullscreen||this.elem.mozRequestFullScreen||this.elem.webkitRequestFullscreen},i._fullscreenActive=function(){return this.doc.fullscreenElement||this.doc.mozFullScreenElement||this.doc.webkitFullscreenElement||this.doc.msFullscreenElement},i._forceResize=function(){setTimeout(function(){BIF.dispatch("bifocal:resize:force")},200)},r}),define("bifocal/themes/read/default/src/features/fullscreen",["require","common","../parts/fullscreener"],function(e){var t=e("common"),n=e("../parts/fullscreener");return function(e){var t=new n;return t.isSupported()?(e.runSheet.prepend(["bifocal:reveal","assignFullscreener"]),e.runSheet.append(["bifocal:reader:ready","fullscreenSwipe"],["bifocal:reader:ready","fullscreenKeyBinding"]),e.assignFullscreener=function(){BIF.objects.fullscreener=t},e.fullscreenKeyBinding=function(){BIF.objects.keyManager.addBinding("f down",function(e){BIF.events.stop(e),t.toggle()})},e.fullscreenSwipe=function(){BIF.objects.readerAffordance.glaze.addClient(t.swipeClient())},!0):!1}}),define("text!bifocal/themes/read/default/resources/icons/icon-spread-one.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <circle stroke='#000000' stroke-width='3' cx='32' cy='32' r='22.5' class='icon-hollow' />\n    <polygon fill='#000000' points='16.483871 25 16.483871 23 47.516129 23 47.516129 25' class='icon-solid' />\n    <polygon fill='#000000' points='16.483871 30 16.483871 28 47.516129 28 47.516129 30' class='icon-solid' />\n    <polygon fill='#000000' points='16.483871 35 16.483871 33 47.516129 33 47.516129 35' class='icon-solid' />\n    <polygon fill='#000000' points='16.483871 40 16.483871 38 47.516129 38 47.516129 40' class='icon-solid' />\n    <path d='M18.1435112,45 C17.5540172,44.3719167 17.0067398,43.7037402 16.5062083,43 L47.4937917,43 C46.9932602,43.7037402 46.4459828,44.3719167 45.8564888,45 L18.1435112,45 L18.1435112,45 Z' fill='#000000' class='icon-solid' />\n    <path d='M25.9011203,50 C24.4275362,49.5008772 23.0350744,48.825881 21.7487238,48 L42.2512762,48 C40.9649256,48.825881 39.5724638,49.5008772 38.0988797,50 L25.9011203,50 L25.9011203,50 Z' fill='#000000' class='icon-solid' />\n  </g>\n</svg>\n"}),define("text!bifocal/themes/read/default/resources/icons/icon-spread-two.text.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <circle stroke='#000000' stroke-width='3' cx='32' cy='32' r='22.5' class='icon-hollow' />\n    <path d='M14.3310226,25 C14.6035236,24.312749 14.9149612,23.6451751 15.2626134,23 L29,23 L29,25 L14.3310226,25 L14.3310226,25 Z' fill='#000000' class='icon-solid' />\n    <path d='M13.1040078,30 C13.1749254,29.3220894 13.2814901,28.6547867 13.4217938,28 L29,28 L29,30 L13.1040078,30 Z' fill='#000000' class='icon-solid' />\n    <path d='M13.2355035,35 C13.1314352,34.3439091 13.0609499,33.6766369 13.0258641,33 L29,33 L29,35 L13.2355035,35 Z' fill='#000000' class='icon-solid' />\n    <path d='M14.7612927,40 C14.4602082,39.3523075 14.1945516,38.6848109 13.9668128,38 L29,38 L29,40 L14.7612927,40 L14.7612927,40 Z' fill='#000000' class='icon-solid' />\n    <path d='M18.1435112,45 C17.5540172,44.3719167 17.0067398,43.7037402 16.5062083,43 L29,43 L29,45 L18.1435112,45 L18.1435112,45 Z' fill='#000000' class='icon-solid' />\n    <path d='M48.7373866,23 C49.0850388,23.6451751 49.3964764,24.312749 49.6689774,25 L34,25 L34,23 L48.7373866,23 L48.7373866,23 Z' fill='#000000' class='icon-solid' />\n    <path d='M50.5782062,28 C50.7185099,28.6547867 50.8250746,29.3220894 50.8959922,30 L34,30 L34,28 L50.5782062,28 L50.5782062,28 Z' fill='#000000' class='icon-solid' />\n    <path d='M50.9741359,33 C50.9390501,33.6766369 50.8685648,34.3439091 50.7644965,35 L34,35 L34,33 L50.9741359,33 L50.9741359,33 Z' fill='#000000' class='icon-solid' />\n    <path d='M50.0331872,38 C49.8054484,38.6848109 49.5397918,39.3523075 49.2387073,40 L34,40 L34,38 L50.0331872,38 L50.0331872,38 Z' fill='#000000' class='icon-solid' />\n    <path d='M47.4937917,43 C46.9932602,43.7037402 46.4459828,44.3719167 45.8564888,45 L34,45 L34,43 L47.4937917,43 L47.4937917,43 Z' fill='#000000' class='icon-solid' />\n    <path d='M25.9011203,50 C24.4275362,49.5008772 23.0350744,48.825881 21.7487238,48 L29,48 L29,50 L25.9011203,50 L25.9011203,50 Z' fill='#000000' class='icon-solid' />\n    <path d='M42.2512762,48 C40.9649256,48.825881 39.5724638,49.5008772 38.0988797,50 L34,50 L34,48 L42.2512762,48 Z' fill='#000000' class='icon-solid' />\n  </g>\n</svg>\n"}),define("bifocal/themes/read/default/src/parts/spread_toggle",["require","common","text!../../resources/icons/icon-spread-one.text.svg","text!../../resources/icons/icon-spread-two.text.svg"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.SVG={one:e("text!../../resources/icons/icon-spread-one.text.svg"),two:e("text!../../resources/icons/icon-spread-two.text.svg")},r.$init=function(e){BIF.objects.iconator.register("spread-1",this.SVG.one),BIF.objects.iconator.register("spread-2",this.SVG.two),this._.parts=this._layout(e),BIF.listen(this._.parts.pg1,"click",this._1up.bind(this)),BIF.listen(this._.parts.pg2,"click",this._2up.bind(this))},r._layout=function(e){var n={};return n.box=t.element({parentNode:e,classes:"menu-bar-shortcut menu-bar-shortcut-spread"}),n.pg1=BIF.objects.iconator.make("spread-1",n.box,"spread-1up"),n.pg1.setAttribute("title","Display 1 page"),n.pg2=BIF.objects.iconator.make("spread-2",n.box,"spread-2up"),n.pg2.setAttribute("title","Display 2 pages"),n},r._1up=function(){BIF.objects.mode.spread(!1),BIF.objects.activity.record("pagespread",{count:1})},r._2up=function(){BIF.objects.mode.spread(!0),BIF.objects.activity.record("pagespread",{count:2})},n}),define("bifocal/themes/read/default/src/features/spread_toggling",["require","../parts/spread_toggle"],function(e){return function(t){var n=e("../parts/spread_toggle");return t.runSheet.append(["bifocal:reader:ready","loadSpreadToggle"]),t.loadSpreadToggle=function(){if(BIF.objects.codex.spreadability()===0){var e=document.querySelector(".menu-bar-right");BIF.objects.spreadToggle=new n(e)}},!0}}),define("bifocal/themes/read/default/src/parts/brand_whitelabel",["require","./brand","common","./connect_link"],function(e){var t=e("./brand"),n=e("common"),r=t.new(),i=r.prototype;return i._customize=function(e){e=e||t.prototype,e._customize.call(this);if(BIF.tData["brand-name"]||typeof BIF.tData["connect-text"]=="string")this["connect-icon"]=null;BIF.tData["brand-name"]&&(this.name=BIF.tData["brand-name"],this.tag="whitelabel",BIF.tData["logo-url"]&&(this["logo-cover"]='<img src="'+BIF.tData["logo-url"]+'" />'),this["connect-link"]={text:this.name,url:BIF.tData["connect-url"],icon:BIF.tData["icon-url"]?'<img src="'+BIF.tData["icon-url"]+'" />':null},this["panel-title"]=this.name),typeof BIF.tData["connect-text"]=="string"&&(this["connect-link"]={text:BIF.tData["connect-text"],url:BIF.tData["connect-url"]}),BIF.tData["pop-color"]&&(this["pop-color"]=n.hexToRGB(BIF.tData["pop-color"]))},i.get=function(r){if(BIF.tData["panel-url"]&&r=="panel-html"){var i=e("./connect_link"),s=i.contextualizeURL(BIF.tData["panel-url"]),o=n.DataClass.get(BIF.root,"lighting");return o&&(s+="&lighting="+o),'<iframe src="'+s+'"></iframe>'}return t.prototype.get.call(this,r)},r}),define("bifocal/themes/read/default/src/features/whitelabel",["require","common","../parts/brand_overdrive_read","../parts/brand_whitelabel"],function(e){var t=e("common");return function(t){return t.runSheet.append(["bifocal:reveal","setBrandPopColor"]),t.loadBrand=function(){var t=e("../parts/brand_overdrive_read"),n=e("../parts/brand_whitelabel");BIF.objects.brand=new n(new t)},t.setBrandPopColor=function(){BIF.objects.brand["pop-color"]&&(BIF.state.coverColor=BIF.objects.brand["pop-color"])},!0}}),define("bifocal/themes/read/default/src/parts/cover_3d",["require","common","./quirks"],function(e){var t=e("common"),n=e("./quirks"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){if(n("useless-3d-transforms"))return this._fallback2d(e);this._.parts=this._layout(e),e.classList.contains("cover-3d-interactive")&&this._listen()},i._layout=function(e){var n={};n.box=e,n.lining=t.element({parentNode:e,classes:"cover-3d-lining"}),n.shadow=t.element({parentNode:n.lining,classes:"cover-3d-shadow"}),n.frame=t.element({parentNode:n.lining,classes:"cover-3d-frame"});var r=(n.frame.offsetWidth||200)/BIF.objects.codex.coverRatio();return n.frame.style.setProperty("height",r+"px"),n.bounds=t.element({parentNode:n.frame,classes:"cover-3d-bounds"}),n.back=t.element({parentNode:n.bounds,classes:"cover-3d-back"}),n.spine=t.element({parentNode:n.bounds,classes:"cover-3d-spine"}),n.leaves=t.element({parentNode:n.bounds,classes:"cover-3d-leaves"}),n.front=t.element({parentNode:n.bounds,classes:"cover-3d-front cover-2d-img"}),n},i._listen=function(){var e,n=-24,r=this._.parts.bounds;this._.contactHandler=BIF.events.onContact(this._.parts.frame,{start:function(n){t.prefixProperty(r.style,"transition","none"),e={firstX:n.pageX,firstY:n.pageY,moving:!1},BIF.events.dispatch("cover-3d:interaction:start",{cover:this})},move:function(i){if(!e)return;var s=i.pageX-e.firstX,o=i.pageY-e.firstY;e.moving||(e.moving=Math.abs(s)>Math.abs(o));if(e.moving){var u="translateZ(-300px) rotateY("+(n+s)+"deg)";t.prefixProperty(r.style,"transform",u),BIF.events.stop(i)}},end:function(n){e&&(t.prefixProperty(r.style,"transform"),t.prefixProperty(r.style,"transition"),e=null,BIF.events.dispatch("cover-3d:interaction:stop",{cover:this}))}})},i._fallback2d=function(e){this._.parts={front:t.element({parentNode:e,classes:"cover-2d-img cover-3d-fallback"})}},r}),define("bifocal/themes/read/default/src/parts/cover_stylesheet",["require","common","./sheet_anchor"],function(e){var t=e("common"),n=e("./sheet_anchor"),r=t.Class.new(),i=r.prototype;return i.KEY="COVER_STYLESHEET",i.VERY_DARK=[40,40,40],i.VERY_LIGHT=[255,255,255],i.NEUTRAL_DEFAULT=[72,72,80],i.YIQ_THRESHOLD=190,i.$init=function(e,t){this._.sheetAnchor=new n;if(!e){e=BIF.objects.codex.coverColor();if(!e||this._isColorLight(e))e=this.NEUTRAL_DEFAULT}this._.color=e,this.applyRules(t),BIF.listen("bifocal:cover:color",this._onCoverColor.bind(this))},i.applyRules=function(e){typeof e=="string"&&(this._.css=e),t.DataClass.set(BIF.root,"cover-yiq",this._isColorLight(BIF.objects.codex.coverColor())?"light":"dark");if(this._.css){var n=this._interpolateRules(this._.css);this._.sheetAnchor.applyStyleRules(BIF.root.ownerDocument,this.KEY,n)}},i.hues=function(e){var n={};return n.cover=e,n.contrast=this._contrastColor(n.cover),n.trueColor=BIF.objects.codex.coverColor()||this.NEUTRAL_DEFAULT,n.trueContrast=this._contrastColor(n.trueColor),n.hivisDay=this._hivisColorAgainst(n.cover,[255,255,255]),n.hivisNight=this._hivisColorAgainst(n.cover,[20,20,20]),n.darkColor=t.shadeColor(n.hivisDay,-0.25),n},i._onCoverColor=function(e){this._.color=e.m.color,this.applyRules()},i._interpolateRules=function(e){var n=this.hues(this._.color);return e=e.replace(/<COLOR (\w+)(\s+alpha=([\d\.]+))?>/g,function(e,r,i,s){return typeof s=="string"?"rgba("+n[r].join(",")+","+parseFloat(s)+")":t.rgbToString(n[r])}),e},i._hivisColorAgainst=function(e,n){var r=t.colorYIQ(e),i=t.colorYIQ(n),s=45,o,u;return Math.abs(r-i)<s&&(i<s?o=i+s:i>255-s?o=i-s:o=i+(r>i?s:0-s),u=(o-r)/255),u?t.shadeColor(e,u):e},i._isColorLight=function(e){return t.colorYIQ(e)>this.YIQ_THRESHOLD},i._contrastColor=function(e){return this._isColorLight(e)?this.VERY_DARK:this.VERY_LIGHT},r}),define("text!bifocal/themes/read/default/styles/parts/cover_stylesheet.text.styles",[],function(){return'/* UTILITY */\n\n.cover-color-fg {\n  color: <COLOR hivisDay> !important;\n}\n\n.cover-color-bg {\n  background-color: <COLOR hivisDay> !important;\n}\n\n\n/* ORIENT */\n\n.orient-board,\n.orient-orb-shadow {\n  border-color: <COLOR hivisDay>;\n  color: <COLOR hivisDay>;\n}\n\n.app-link-label {\n  border-bottom-color: <COLOR hivisDay alpha=0.4>;\n}\n\n\n/* SEEKO */\n\n.seekometer-ribbon,\n.seekometer-needle {\n  background-color: <COLOR hivisDay>;\n}\n\n.seekometer-clocks {\n  color: <COLOR contrast>;\n}\n\n\n/* TIMELINE */\n\n.timeline-needle\n.timeline-progress {\n  background-color: <COLOR contrast>;\n}\n\n.timeline-track.timeline-reset:after {\n  color: <COLOR contrast>;\n}\n\n\n/* PAGINATION PROGRESS */\n\n.pagination-progress {\n  color: <COLOR hivisDay>;\n}\n\n\n/* OVERLAY BUTTON */\n\n.tapping .overlay-button {\n  color: <COLOR hivisDay>;\n}\n.tapping .overlay-button-outer-ring {\n  background-color: <COLOR hivisDay>;\n}\n.tapping .zoom-icon-glass {\n  border-color: <COLOR hivisDay>;\n}\n.tapping .zoom-icon-glass:after,\n.tapping .zoom-icon-plus:before,\n.tapping .zoom-icon-plus:after {\n  background-color: <COLOR hivisDay>;\n}\n\n\n/* 3D COVER */\n\n.cover-3d-back,\n.cover-3d-spine,\n.cover-3d-front {\n  background-color: <COLOR trueColor>;\n}\n\n\n/* MENU BAR */\n\n.max .menu-bar-inner { border-bottom-color: <COLOR hivisDay>; }\n.max .menu-bar.lighting-adjustable { color: <COLOR hivisDay>; }\n.max .menu-bar.lighting-adjustable .icon-hollow { stroke: <COLOR hivisDay>; }\n.max .menu-bar.lighting-adjustable .icon-solid { fill: <COLOR hivisDay>; }\n\n.max.data-lighting_dark .menu-bar { background-color: #000; }\n.max.data-lighting_dark .menu-bar-inner { border-bottom-color: #333; }\n.max.data-lighting_dark .menu-bar { color: #999; }\n.max.data-lighting_dark .menu-bar .icon-hollow { stroke: #999; }\n.max.data-lighting_dark .menu-bar .icon-solid { fill: #999; }\n\n.max .menu-bar .bookmark-target:active .icon-hollow {\n  fill: <COLOR hivisDay>;\n}\n.max.data-lighting_dark .menu-bar .bookmark-target:active .icon-hollow {\n  fill: #999;\n}\n\n\n/* MENU DONE BTN */\n\n.menu-panel-done-button:active {\n  color: <COLOR hivisDay>;\n}\n\n.data-lighting_dark .menu-panel-done-button:active {\n  color: <COLOR hivisDay>;\n}\n\n\n/* READING TIME */\n\n.reading-time-expando {\n  color: <COLOR hivisDay>;\n}\n\n\n/* READING SETTINGS */\n\nul.rdy-diy-control li.on {\n  background-color: <COLOR hivisDay>;\n}\n\n\n/* NOTIFIER */\n.notifier-dialog-heading {\n  color: <COLOR hivisDay>;\n}\n\n.data-lighting_dark .notifier-dialog-heading {\n  color: <COLOR hivisDay>;\n}\n\n\n/* BOOKMARK INDICATOR */\n\n.max .book-widgets .bookmark-button svg g,\n.mea .book-widgets .bookmark-active .bookmark-button svg g {\n  stroke: none;\n  fill: <COLOR hivisDay>;\n}\n\n.data-lighting_dark.max .book-widgets .bookmark-button svg g,\n.data-lighting_dark .book-widgets .bookmark-active .bookmark-button svg g {\n  fill: <COLOR hivisDay>;\n}\n\n.menu-bar .bookmark-button svg g {\n  stroke: <COLOR hivisDay>;\n}\n\n.menu-bar .bookmark-active .bookmark-button svg g {\n  stroke: none !important;\n  fill: <COLOR hivisDay>;\n}\n\n.data-lighting_dark .menu-bar .bookmark-active .bookmark-button svg g {\n  fill: #999;\n}\n\n\n/* BOOKMARK LANDMARKS */\n\n.seekometer-landmark-bookmark:after {\n  background-color: <COLOR hivisDay>;\n}\n\n\n/* BACK BADGE */\n\n.back-badge:active svg g {\n  fill: <COLOR hivisDay>;\n}\n\n.data-lighting_dark .back-badge:active svg g {\n  fill: <COLOR hivisDay>;\n}\n\n\n/* SPINNER */\n\n.spinner-line {\n  stroke: <COLOR hivisDay>;\n}\n\n\n/* NARRATION FOOTER */\n\n.nar-footer-progress {\n  background-color: <COLOR hivisDay>;\n}\n\n\n/* SPREAD TOGGLE */\n\n.spread-pg:hover {\n  border-color: <COLOR hivisDay>;\n}\n\n.spread-pg:hover > div {\n  background-image: url(\'data:image/svg+xml,<svg width="30" height="3" viewBox="0 0 30 3" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h30" stroke="<COLOR hivisDay>"/></svg>\');\n}\n'}),define("bifocal/themes/read/default/src/features/covers",["require","common","../parts/cover_3d","../parts/cover_stylesheet","text!../../styles/parts/cover_stylesheet.text.styles"],function(e){var t=e("common"),n=e("../parts/cover_3d");return function(r){return r.runSheet.append(["bifocal:reveal","loadCoverStylesheet"],["bifocal:reader:ready","find3dCovers"],["bifocal:reader:ready","find2dCovers"]),r.loadCoverStylesheet=function(){var t=e("../parts/cover_stylesheet"),n=BIF.state.coverColor,r=e("text!../../styles/parts/cover_stylesheet.text.styles");BIF.objects.coverStylesheet=new t(n,r)},r.find3dCovers=function(){var e=document.querySelectorAll(".cover-3d");t.each(e,function(e){BIF.state.outlet=="Listen"?e.classList.add("cover-3d-audiobook"):BIF.objects.codex&&BIF.objects.codex.fullyPrepaginated()?e.classList.add("cover-3d-magazine"):e.classList.add("cover-3d-book"),new n(e)})},r.find2dCovers=function(){var e=document.querySelectorAll(".cover-2d-img"),n=BIF.objects.codex.coverPath("ph");t.each(e,function(e){t.element({parentNode:e,tag:"img",attributes:{src:n}})})},!0}}),define("bifocal/themes/read/default/src/features/tailoring",["require","common","../parts/mode"],function(e){var t=e("common");return function(t){return t.runSheet.prepend(["bifocal:reveal","setMeasuredMaxDimensions"]),t.setMeasuredMaxDimensions=function(){var t=320,n=320,r=BIF.map.spine[0]["rendition-viewport"];for(var i=0,s=BIF.map.spine.length;i<s;++i){var o=BIF.map.spine[i];if(o["rendition-layout"]!="pre-paginated")return;var u=o["rendition-viewport"];r["width"]!=u["width"]&&r["height"]!=u["height"]&&u.width/u.height<r.width/r.height&&(r=u)}var a=e("../parts/mode"),f=a.prototype.MEA_DIMENSIONS;f.lock=!0,f[1].x=f[1].y-2;for(var i=1;i<=2;++i){var l=f[i].x/(r.width*i),c=f[i].y/r.height;l<c?f[i].y=Math.max(n,r.height*l):f[i].x=Math.max(t,r.width*c*i)}f[1].y=Math.max(f[1].y,f[1].x+2),f[2].x=Math.max(f[2].x,f[2].y+2)},t.setComponentSheetColor=function(e){var t=null,n=e.m.component,r=n.frameBox.contentDocument;if(r.body){var i=r.defaultView.getComputedStyle(r.body,null);i&&(t=i.getPropertyValue("background-color"))}var s="-bifocal-page-color",o=r.querySelector('head meta[name="'+s+'"]');o&&(t=o.getAttribute("content")),t&&t!="transparent"&&!t.match(/rgba\(.*0\)/)&&(n.sheetBox.style.backgroundColor=t)},!0}}),define("bifocal/themes/read/default/src/features/content_protection",["require"],function(e){return function(e){function t(e){var t="if(!document.__BIF){document.body.innerHTML=null;}";e.__BIF=!0,e.body&&e.body.setAttribute("onload",t)}function i(e,t){if(e.naturalWidth)t(e);else{var n=function(){BIF.events.deafen(e,"load",n),t(e)};BIF.events.on(e,"load",n)}}function s(e){var t=u(e);e.src=t.toDataURL("image/png")}function o(e){var t=u(e);a(t,e),e.parentNode.insertBefore(t,e),e.parentNode.removeChild(e)}function u(e){var t=e.ownerDocument.createElement("canvas");return t.width=e.naturalWidth,t.height=e.naturalHeight,t.getContext("2d").drawImage(e,0,0),t}function a(e,t){t.className&&(e.className=t.className),t.style.cssText&&(e.style.cssText=t.style.cssText);var n,r;t.width&&(n=t.width/t.naturalWidth),t.height&&(r=t.height/t.naturalHeight),n=n||r,r=r||n,n&&(e.style.transformOrigin="top left",e.style.transform="scale3d("+n+","+r+",1)")}e.runSheet.append(["lens:component:modify","bifLockComponent"]),e.bifLockComponent=function(e){var n=e.m.component.frameBox.contentDocument;setTimeout(t.bind(this,n),1e3)};var n=BIF.tData["protect-images"]||BIF.map["-odread-protect-images"],r={full:s,half:o}[n];return r&&e.runSheet.append(["lens:component:modify","swizzleImages"]),e.swizzleImages=function(e){var t=e.m.component.frameBox.contentDocument,n=t.querySelectorAll("img");for(var s=0,o=n.length;s<o;++s)i(n[s],r)},!0}}),define("bifocal/themes/read/default/src/parts/billboard",["require","common"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype;return r.CLS={box:"billboard-box",content:"billboard-content",closeButton:"billboard-close",oversized:"billboard-oversized"},r.ANIM_MS=240,r.$init=function(){this._.parts={container:document.body},this._.bindings={align:this.align.bind(this)}},r.show=function(e,n){BIF.dispatch("bifocal:billboard:up");if(this._.parts.box)return console.warn("Modal billboard already showing.");n=n||{};var r=e;this._.parts.box=t.element({parentNode:this._.parts.container,classes:this.CLS.box});if(typeof e=="string"){var i=e;this._.parts.content=t.element({tag:"iframe",parentNode:this._.parts.box,classes:this.CLS.content,attributes:{src:i}}),r=this._.parts.content}else this._.parts.content=t.element({parentNode:this._.parts.box,classes:this.CLS.content}),this._.parts.content.appendChild(r);this._.dims=[r.naturalWidth||r.offsetWidth,r.naturalHeight||r.offsetHeight],n.closeButton!==!1&&(this._.parts.closeButton=t.element({parentNode:this._.parts.box,classes:this.CLS.closeButton}),BIF.events.onTap(this._.parts.closeButton,this.hide.bind(this))),this.align(n.align||"left top"),BIF.listen("bifocal:mode:resize",this._.bindings.align),this._shrink(n.from),setTimeout(this._grow.bind(this),0)},r.hide=function(e){this._shrink(),setTimeout(this._remove.bind(this),this.ANIM_MS)},r.align=function(e){this._.alignment=typeof e=="string"?e:this._.alignment;if(!this._.alignment)return;var t=this._.parts.content;this._.dims[0]>t.offsetWidth||this._.dims[1]>t.offsetHeight?this._.parts.box.classList.add(this.CLS.oversized):this._.parts.box.classList.remove(this.CLS.oversized);var n=this._.alignment.split(/\s+/),r=0,i=0,s=t.scrollWidth-t.offsetWidth,o=t.scrollHeight-t.offsetHeight;n[0].match(/^\d+$/)?r=Math.max(0,parseInt(n[0],10)-t.offsetWidth/2):n[0]=="center"?r=s/2:n[0]=="right"&&(r=s),n[1]&&n[1].match(/^\d+$/)?i=Math.max(0,parseInt(n[1],10)-t.offsetHeight/2):!n[1]||n[1]=="center"?i=o/2:n[1]=="bottom"&&(i=o),t.scrollLeft=r,t.scrollTop=i},r._grow=function(){t.prefixProperty(this._.parts.box.style,"transition","transform "+this.ANIM_MS+"ms ease-in-out"),t.prefixProperty(this._.parts.box.style,"transform","translate(0,0) scale(1)")},r._shrink=function(e){this._.from=e||this._.from||[0,window.innerHeight/2,window.innerWidth,0];var n="translate("+this._.from[0]+"px, "+this._.from[1]+"px)",r="scale(0)";typeof this._.from[2]=="number"&&(r="scaleX("+this._.from[2]/this._.parts.box.offsetWidth+") ",r+="scaleY("+this._.from[3]/this._.parts.box.offsetHeight+")"),t.prefixProperty(this._.parts.box.style,"transform",n+" "+r)},r._remove=function(){this._.parts.box.parentNode.removeChild(this._.parts.box),this._.parts.box=null,this._.parts.content=null,BIF.deafen("bifocal:mode:resize",this._.bindings.align),BIF.dispatch("bifocal:billboard:down")},n}),define("bifocal/themes/read/default/src/features/compat",["require","common","../parts/quirks","../parts/billboard"],function(e){var t=e("common"),n=e("../parts/quirks"),r=e("../parts/billboard");return function(e){var i;n.ask("android<4")?i=t.element({classes:"bb-compat-warning",html:["<h2>Warning</h2>","<p>","We've found that your device does not work well with","OverDrive Read. <a",'href="http://help.overdrive.com/customer/portal/articles/1481258"',">You can learn about which devices work best","with OverDrive Read here</a>.","</p>","<p>","As an alternative, you may be able to download this ebook","directly to your device.","</p>","<p>",'If you\'re feeling lucky, <span class="bb-close">you can',"click here to start reading anyway</span>.","</p>"].join(" ")}):n.ask("android-stock")&&(i=t.element({classes:"bb-compat-warning",html:["<h2>Tip</h2>","<p>","We recommend reading this book in the Chrome web browser","for a better experience. <a",'href="https://play.google.com/store/apps/details?id=com.android.chrome"',">Here's a link to install Chrome.</a>","</p>","<p>",'Or, <span class="bb-close">click here to continue reading</span>',"in your current browser.","</p>"].join(" ")}));if(i){e.runSheet.prepend(["bifocal:intercept","showCompatWarning"]);var s=!1;e.showCompatWarning=function(e){if(!i)return;e.preventDefault();if(s)return;var n=function(){BIF.objects.billboard.hide(),i=!1,s=!1,BIF.dispatch("bifocal:intercept:continue")};BIF.objects.billboard=BIF.objects.billboard||new r;var o=i.querySelectorAll(".bb-close");t.each(o,function(e){BIF.listen(e,"click",n)}),BIF.objects.billboard.show(i,{closeButton:!o.length}),s=!0},deployed=!0}return i?!0:!1}}),define("bifocal/themes/read/default/src/parts/panel_tip",["require","../../../../read/default/src/parts/panel_abstract","common","./menu_filter"],function(e){var t=e("../../../../read/default/src/parts/panel_abstract"),n=e("common"),r=e("./menu_filter"),i=t.new(),s=i.prototype;return s.TITLE="Tips & Secrets",s.ID="tip",s.tip=function(e){var t=new e;t.evaluate()&&this._buildCard(t.title(),t.populate.bind(t))},s._innerLayout=function(e){this._.container=n.element({parentNode:e,classes:"menu-filter-scroll-hider"}),this._.filter=new r(this._.container)},s._buildCard=function(e,t){var r={};r.rail=n.element({parentNode:this._.container,classes:"menu-panel-rail"}),r.container=n.element({parentNode:r.rail,classes:"panel-tips-card"}),r.title=n.element({parentNode:r.container,classes:"panel-tips-card-title",html:e}),r.contents=n.element({parentNode:r.container,classes:"panel-tips-card-contents",html:typeof t=="string"?t:null}),typeof t=="function"&&t(r.contents);var i=r.contents.querySelector(".tip-expand");return i&&BIF.events.onTap(i,function(){r.container.classList.toggle("tip-compact")}),r},s._onOpen=function(){var e=this._.container.querySelectorAll(".panel-tips-card");n.each(e,function(e){e.classList.add("tip-compact")}),this._.filter.update(),this._.filter.hide()},i}),define("bifocal/themes/read/default/src/parts/tips/tip",["require","common","../string_interpolator"],function(e){var t=e("common"),n=e("../string_interpolator"),r=t.Class.new(),i=r.prototype;return i.$init=function(e){this._.title=e||this.TITLE,this._listen()},i.title=function(){return this._.title},i.evaluate=function(){return!0},i.populate=function(e){e.innerHTML=this._interp(this.CONTENTS||"[OVERRIDE ME]"),t.each(e.querySelectorAll(".tip-demonstrate"),function(e){BIF.events.onTap(e,function(){BIF.objects.menuList.hide(),setTimeout(this.demonstrate.bind(this),300)}.bind(this))},this)},i._listen=function(){},i._interp=function(e,t){var r=new n;return r.substitute(t),r.make(e)},r}),define("bifocal/themes/read/default/src/parts/tips/tip_page_numbers",["require","../../../../../read/default/src/parts/tips/tip"],function(e){var t=e("../../../../../read/default/src/parts/tips/tip"),n=t.new(),r=n.prototype;return r.TITLE="Pages and percentages",r.CONTENTS=["<p>","The page number appears above the timeline, and by default","it shows your place in the entire book. {_TAP} it to view","the number of pages remaining in the current&nbsp;chapter.","{_TAP} it again to see your position as a percentage of the book.","</p>"],n}),define("bifocal/themes/read/default/src/parts/tips/tip_fullscreen",["require","./tip","../quirks"],function(e){var t=e("./tip"),n=e("../quirks"),r=t.new(),i=r.prototype;return i.TITLE="Go full screen",i.BTN_STYLE=["text-align: center","padding: 9px","text-transform: uppercase","cursor: pointer","margin-bottom: 8px","font-weight: bold"].join(";"),i.CONTENTS=["<p>","Go full screen by hitting <b>F</b>","on the keyboard, or by swiping up with two fingers","on a touchscreen, or by {TAPPING} this button:","</p>",'<div class="fullscreen-button" style="'+i.BTN_STYLE+'">',"Toggle full screen","</div>"],i.evaluate=function(){return BIF.objects.fullscreener&&BIF.objects.fullscreener.isSupported()},i.populate=function(e){t.prototype.populate.call(this,e);var n=e.querySelector(".fullscreen-button");BIF.events.onTap(n,this._toggleFullscreen.bind(this))},i._toggleFullscreen=function(){BIF.objects.fullscreener.toggle()},r}),define("bifocal/themes/read/default/src/parts/tips/tip_bookmark_shortcut",["require","./tip"],function(e){var t=e("./tip"),n=t.new(),r=n.prototype;return r.TITLE="How to place a bookmark",r.CONTENTS=["<p>","The top-right corner of the page is an invisible bookmark","shortcut â {TAP} near that corner to place a bookmark,","or to remove a bookmark if you&rsquo;ve placed one there.","</p>",'<div class="tip-expand">','<div style="margin:12px;background:rgba(255,255,255,0.8);border:1px solid #DDD;border-bottom:none;box-shadow:0 -3px 4px rgba(0,0,0,0.1);height:100px;">','<div style="background:rgba(48,128,255,0.33);font:11px sans-serif;text-align:center;color:#FFF;border-radius:50%;margin:-8px;letter-spacing:0.1em;width:27.5%;padding:20px 0;float:right;">BOOK<br/>MARK</div>',"</div>","<p>","If you want to turn the page from the top-right region, simply","swipe instead of tapping.","</p>","</div>"],r.evaluate=function(){return BIF.objects.marksManager&&BIF.state.mode=="max"},n}),define("bifocal/themes/read/default/src/parts/tips/tip_keyboard_shortcut",["require","./tip"],function(e){var t=e("./tip"),n=t.new(),r=n.prototype;return r.TITLE="Keyboard shortcuts",r.CONTENTS=['<table class="tip-keyval-table">',"<tbody>","<tr>","<th>&rarr;<br/>PageDown<br/>Space</th>","<td>Turn ahead a page</td>","</tr>","<tr>","<th>&larr;<br/>PageUp<br/>Shift+Space</th>","<td>Turn back a page</td>","</tr>","<tr>","<th>&darr;</th>","<td>Show the menu</td>","</tr>","<tr>","<th>&uarr;</th>","<td>Show the seekometer</td>","</tr>","<tr>","<th>ESC</th>","<td>Dismiss the menu or seekometer</td>","</tr>","</tbody>","</table>"].join("\n"),r.populate=function(e){t.prototype.populate.call(this,e),e.style.paddingTop="0",BIF.objects.narrationFooter&&(e.querySelector("tbody").innerHTML+="<tr><th>P</th><td>Play or pause narration (where available)</td></tr>"),BIF.objects.fullscreener&&(e.querySelector("tbody").innerHTML+="<tr><th>F</th><td>Expand to full screen</td></tr>")},r.evaluate=function(){return navigator.userAgent.match(/iP(ad|hone|od).*OS/)?!1:navigator.userAgent.indexOf("Android")>=0?!1:!0},n}),define("bifocal/themes/read/default/src/parts/tips/tip_fast_pager",["require","../../../../../read/default/src/parts/tips/tip"],function(e){var t=e("../../../../../read/default/src/parts/tips/tip"),n=t.new(),r=n.prototype;return r.TITLE="Peek at the page count",r.CONTENTS=["<p>","When you move rapidly through a book you&rsquo;ll see","a bar pop up with the chapter title and page&nbsp;number:","</p>",'<div style="border:1px solid rgba(0,0,0,0.33);border-left:0;border-right:0;height:40px;line-height:40px;text-align:center;margin:2px 0 16px;">','<span style="padding: 0 10px;">Chapter 9</span>','<span style="padding: 0 10px;">117 of 356</span>',"</div>","<p>","If you want to check it while reading, just swipe up,","but don&rsquo;t let go. Once you&rsquo;ve peeked at the bar, ","swipe downward to dismiss&nbsp;it&nbsp;again.","</p>"],r.evaluate=function(){return BIF.objects.fastPager?!0:!1},n}),define("bifocal/themes/read/default/src/parts/tips/tip_marks_remove",["require","./tip"],function(e){var t=e("./tip"),n=t.new(),r=n.prototype;return r.TITLE="Delete your marks",r.REM_STYLE=["text-transform: uppercase","background: #F33","color: #FFF","padding: 0 3px","font-size: 12px","border-radius: 1px"].join(";"),r.CONTENTS=["<p>","You can delete bookmarks and highlights from","the Marks menu. {_SWIPE} from right-to-left on a mark to reveal a",'<span class="rem" style="'+r.REM_STYLE+'">REMOVE</span> button.',"</p>"],r.evaluate=function(){return BIF.objects.marksManager?!0:!1},n}),define("bifocal/themes/read/default/src/parts/tips/tip_clear_history",["require","./tip"],function(e){var t=e("./tip"),n=t.new(),r=n.prototype;return r.TITLE="A tidy history",r.CONTENTS=["<p>","You can triple-{TAP} the timeline to clear the back and forward","buttons, if you don&rsquo;t expect to return to those","parts&nbsp;of&nbsp;the&nbsp;book.","</p>"],n}),define("bifocal/themes/read/default/src/features/tips",["require","../parts/panel_tip","../parts/tips/tip_page_numbers","../parts/tips/tip_fullscreen","../parts/tips/tip_bookmark_shortcut","../parts/tips/tip_keyboard_shortcut","../parts/tips/tip_fast_pager","../parts/tips/tip_marks_remove","../parts/tips/tip_clear_history"],function(e){return function(t){return t.runSheet.append(["bifocal:reader:ready","loadTips"]),t.loadTips=function(){var t=e("../parts/panel_tip");BIF.objects.panelTip=new t,BIF.objects.menuList.addPanel(BIF.objects.panelTip),BIF.objects.panelTip.tip(e("../parts/tips/tip_page_numbers")),BIF.objects.panelTip.tip(e("../parts/tips/tip_fullscreen")),BIF.objects.panelTip.tip(e("../parts/tips/tip_bookmark_shortcut")),BIF.objects.panelTip.tip(e("../parts/tips/tip_keyboard_shortcut")),BIF.objects.panelTip.tip(e("../parts/tips/tip_fast_pager")),BIF.objects.panelTip.tip(e("../parts/tips/tip_marks_remove")),BIF.objects.panelTip.tip(e("../parts/tips/tip_clear_history"))},!0}}),define("bifocal/themes/read/default/src/parts/share_context",["require","common","./spinner"],function(e){var t=e("common"),n=t.Class.new(),r=n.prototype,i=e("./spinner");return r.$init=function(e){this._.contextBar=e,this._.parts=this._layout(),this._listen(),this._.contextBar.addMenu("share",this._.parts.button,null,this._.parts.info)},r._layout=function(){var e={};return e.button=t.element({classes:"context-button share-context-button",html:"Share"}),e.info=t.element({classes:"share-context-info"}),e.spinner=i.install(e.info).stop(),e.result=t.element({parentNode:e.info,classes:"share-context-result"}),e},r._listen=function(){BIF.listen("bifocal:selection",this._onSelection.bind(this)),BIF.events.onTap(this._.parts.button,this._expandWithShareLink.bind(this))},r._onSelection=function(e){this.anchor=this._generateAnchorFromSelection(e.m),this.excerpt=e.m.text},r._generateAnchorFromSelection=function(e){var n={};n.buid=BIF.state.buid,n.locator=t.absorb(e.locatorA,{}),n.locator.extent=t.absorb(e.locatorZ,{});try{n.chapter=BIF.objects.compass.place.chapter.title}catch(r){}return n},r._expandWithShareLink=function(){this._.tokenRequest&&this._.tokenRequest.abort();var e=JSON.stringify({anchor:this.anchor},null,3);this._.parts.spinner.spin(),this._.parts.result.innerHTML="<pre>"+e+"</pre>",this._.contextBar.expand("share"),this._.tokenRequest=BIF.network.sendRequest("/_d/anchor",{method:"POST",body:e,contentType:"application/json",accept:"application/json",success:this._onAnchorToken.bind(this),failure:this._onAnchorTokenFailed.bind(this)})},r._onAnchorToken=function(e){var n;try{n=JSON.parse(e).result}catch(r){return this._onAnchorTokenFailed("Invalid JSON response",this._.tokenRequest)}if(!n)return this._onAnchorTokenFailed("Missing result property",this._.tokenRequest);delete this._.tokenRequest,this._.parts.spinner.stop(),this._.parts.result.innerHTML="";var i=t.parameterizeURL(location.href,{a:n.token}),s=t.element({tag:"input",parentNode:this._.parts.result,attributes:{value:i}});s.select(),s.focus(),this._.contextBar.expand("share")},r._onAnchorTokenFailed=function(e,t){delete this._.tokenRequest,this._.parts.spinner.stop(),this._.parts.result.innerHTML='Failed to share: "'+e+'"',this._.contextBar.expand("share")},n}),define("bifocal/themes/read/default/src/features/sharing",["require","common","core/src/locator","../parts/share_context"],function(e){return function(t){function s(e,t,n){BIF.events.stop(n),setTimeout(function(){BIF.objects.stencil.remove("share-anchor"),BIF.objects.pincer.select(e,t)},0)}var n=e("common"),r=e("core/src/locator"),i=e("../parts/share_context");return t.runSheet.append(["bifocal:ready","restoreSharedAnchor"]),t.loadShareContext=function(e){setTimeout(function(){BIF.objects.shareContext=new i(e.m)},0)},t.restoreSharedAnchor=function(){var e=BIF.map["-odread-anchor"];if(!e)return;var t={},i={};n.each(e.locator,function(e,r){if(e=="extent")return;t[n.camelize(e)]=r}),n.each(e.locator.extent,function(e,t){i[n.camelize(e)]=t});var o=BIF.context.spine.byPosition(t.spinePosition);if(!o)return;var u={component:o,finder:function(e){var n=e.frameBox.contentDocument,o=new r,u=o.locatorsToRange(t,i,n);return u?(BIF.objects.stencil.add("share-anchor",u,{className:"mask-share-anchor",padding:1,tap:s.bind(this,e,u)}),BIF.context.spool.rectangleToFloc(e,u.getClientRects()[0])):e.spinePosition}.bind(this)};BIF.objects.compass.seek(u)},!0}}),define("bifocal/themes/read/default/default",["require","core","./src/features/world","./src/features/links","./src/features/dictionary","./src/features/zoom","./src/features/notify","./src/features/fast_pager","./src/features/history","./src/features/overview","./src/features/bookmarks","./src/features/search","./src/features/table_of_contents","./src/features/highlights","./src/features/narration","./src/features/readability","./src/features/offline_cache","./src/features/fullscreen","./src/features/spread_toggling","./src/features/whitelabel","./src/features/covers","./src/features/tailoring","./src/features/content_protection","./src/features/compat","./src/features/tips","./src/features/sharing"],function(e){var t=e("core"),n=new t.Theme;return n.addFeature(e("./src/features/world")),n.addFeature(e("./src/features/links")),n.addFeature(e("./src/features/dictionary")),n.addFeature(e("./src/features/zoom")),n.addFeature(e("./src/features/notify")),n.addFeature(e("./src/features/fast_pager")),n.addFeature(e("./src/features/history")),n.addFeature(e("./src/features/overview")),n.addFeature(e("./src/features/bookmarks")),n.addFeature(e("./src/features/search")),n.addFeature(e("./src/features/table_of_contents")),n.addFeature(e("./src/features/highlights")),n.addFeature(e("./src/features/narration")),n.addFeature(e("./src/features/readability")),n.addFeature(e("./src/features/offline_cache")),n.addFeature(e("./src/features/fullscreen")),n.addFeature(e("./src/features/spread_toggling")),n.addFeature(e("./src/features/whitelabel")),n.addFeature(e("./src/features/covers")),n.addFeature(e("./src/features/tailoring")),n.addFeature(e("./src/features/content_protection")),n.addFeature(e("./src/features/compat")),n.addFeature(e("./src/features/tips")),n.addFeature(e("./src/features/sharing")),n}),require(["bifocal/themes/read/default/default"],function(e){e.lightFuse()}),define("bifocal/themes/read/default/main",function(){});